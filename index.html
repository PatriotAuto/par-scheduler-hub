<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Patriot Auto Restyling – Scheduler Hub v1.3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --par-navy:#050b18;--par-navy-soft:#0b1f33;--par-red:#e30613;--par-light:#f5f7fb;
      --par-border:#2b3950;--par-text:#fdfdfd;--par-muted:#9ca7c0;
      --dept-tint:#e53935;--dept-ppf:#2962ff;--dept-ceramic:#00c853;--dept-detail:#ffb300;--dept-electronics:#ab47bc;--timeoff:#8d8d8d;
      --grid-bg:#f2f4fb;--grid-header-bg:#e3e7f1;--grid-border-strong:rgba(0,0,0,.25);--grid-border-light:rgba(0,0,0,.15);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystem,"Segoe UI",sans-serif;}
    body{margin:0;background:radial-gradient(circle at top,#101b2e,#02040a);color:var(--par-text);}
    .page{min-height:100vh;display:flex;flex-direction:column;}
    header{padding:16px 24px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;gap:16px;background:linear-gradient(90deg,#050b18,#0a1727);}
    header .title{display:flex;flex-direction:column;gap:2px;}
    header .title h1{margin:0;font-size:20px;letter-spacing:.08em;text-transform:uppercase;}
    header .title span{font-size:12px;color:var(--par-muted);}
    .header-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .header-btn{border-radius:999px;border:1px solid rgba(255,255,255,.25);background:rgba(227,6,19,.12);color:#fff;padding:6px 12px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;cursor:pointer;}
    .header-btn.active{background:rgba(227,6,19,.3);}
    .header-btn:hover{background:rgba(227,6,19,.25);}
    .main{flex:1;display:flex;min-height:0;}
    .left{flex:1.4;border-right:1px solid rgba(255,255,255,.08);background:#e6e9f3;padding:14px;display:flex;flex-direction:column;gap:10px;min-width:0;}
    .right{flex:1;background:radial-gradient(circle at top right,#121b2d,#050915);padding:16px;min-width:0;display:flex;flex-direction:column;gap:10px;}
    .left-top-row{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;}
    .chips{display:flex;flex-wrap:wrap;gap:6px;}
    .chip{border-radius:999px;padding:4px 10px;font-size:11px;border:1px solid rgba(0,0,0,.1);background:rgba(255,255,255,.9);color:#374151;display:inline-flex;align-items:center;gap:6px;cursor:pointer;}
    .chip.active{border-color:var(--par-red);background:rgba(227,6,19,.08);color:#111827;}
    .chip .dot{width:8px;height:8px;border-radius:50%;}
    .dot-detail{background:var(--dept-detail);} .dot-tint{background:var(--dept-tint);} .dot-ppf{background:var(--dept-ppf);}
    .dot-ceramic{background:var(--dept-ceramic);} .dot-electronics{background:var(--dept-electronics);} .dot-timeoff{background:var(--timeoff);}
    .date-controls{display:flex;flex-direction:column;align-items:flex-end;gap:4px;font-size:12px;color:#4b5563;}
    .date-row{display:flex;align-items:center;gap:6px;}
    .nav-btn{border-radius:999px;border:1px solid rgba(0,0,0,.2);background:#fff;color:#111827;padding:4px 8px;font-size:11px;cursor:pointer;}
    .nav-btn:hover{background:#f3f4f6;}
    .date-label{font-size:12px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:#111827;}
    #dayPicker{border-radius:999px;border:1px solid rgba(0,0,0,.2);background:#fff;color:#111827;font-size:11px;padding:4px 8px;cursor:pointer;}
    .cal-wrapper{flex:1;border-radius:12px;background:var(--grid-bg);border:3px solid var(--grid-border-strong);display:flex;flex-direction:column;overflow:hidden;min-height:260px;box-shadow:0 12px 24px rgba(15,23,42,.25);}
    .cal-header-row{display:grid;grid-template-columns:60px repeat(6,1fr);font-size:11px;padding:4px 4px 6px;border-bottom:3px solid var(--grid-border-strong);background:var(--grid-header-bg);}
    .cal-header-cell{text-align:center;font-weight:600;color:#111827;}
    .cal-body{flex:1;overflow:auto;}
    .cal-row{display:grid;grid-template-columns:60px repeat(6,1fr);border-bottom:2px solid var(--grid-border-light);font-size:11px;background:linear-gradient(to right,rgba(255,255,255,.9),rgba(255,255,255,.9));height:32px;}
    .cal-row:nth-child(2n){background:linear-gradient(to right,rgba(249,250,251,.95),rgba(249,250,251,.95));}
    .cal-time-cell{padding:2px 4px;text-align:right;color:#4b5563;font-weight:500;background:#e5e7eb;border-right:2px solid var(--grid-border-strong);}
    .cal-slot-cell{border-left:2px solid var(--grid-border-light);position:relative;cursor:pointer;background:transparent;transition:background .12s,box-shadow .12s,transform .05s;overflow:hidden;}
    .cal-slot-cell:hover{background:rgba(227,6,19,.06);box-shadow:inset 0 0 0 1px rgba(227,6,19,.35);}
    .cal-slot-cell.selected{background:rgba(227,6,19,.1);box-shadow:inset 0 0 0 2px rgba(227,6,19,.8);transform:translateY(-1px);}
    .cal-slot-cell.off-shift{background:repeating-linear-gradient(45deg,rgba(15,23,42,.02),rgba(15,23,42,.02) 4px,rgba(15,23,42,.07) 4px,rgba(15,23,42,.07) 8px);}
    .cal-slot-inner{padding:1px 4px;height:100%;display:flex;align-items:center;gap:2px;overflow:hidden;}
    .cal-slot-cell.timeoff-block{
      background:linear-gradient(to right, rgba(141,141,141,0.25), rgba(141,141,141,0.35));
    }
    .event-pill{border-radius:999px;padding:1px 6px;font-size:10px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;box-shadow:0 1px 2px rgba(15,23,42,.25);display:inline-flex;align-items:center;gap:3px;}
    .event-detailing{background:var(--dept-detail);}
    .event-tint{background:var(--dept-tint);color:#fff;}
    .event-ppf{background:var(--dept-ppf);color:#fff;}
    .event-ceramic{background:var(--dept-ceramic);}
    .event-electronics{background:var(--dept-electronics);color:#fff;}
    .event-timeoff{background:var(--timeoff);color:#fff;}
    .small-badge{font-size:9px;padding:0 4px;border-radius:999px;background:rgba(0,0,0,.2);color:#f9fafb;text-transform:uppercase;}
    .cal-legend{margin:6px 8px 4px;display:flex;flex-wrap:wrap;gap:8px;font-size:10px;color:#4b5563;}
    .legend-item{display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,.8);border-radius:999px;padding:2px 8px;border:1px solid rgba(0,0,0,.06);}
    .bottom-info-row{display:flex;gap:10px;padding:6px 8px 8px;border-top:1px solid rgba(0,0,0,.12);background:#e5e7f3;}
    .dealer-queue,.event-details{
      flex:1;
      background:#f9fafb;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.1);
      padding:6px 8px;
      font-size:11px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .dealer-queue{color:#000;}
    .dealer-queue-title,.event-details-title{font-weight:700;text-transform:uppercase;letter-spacing:.08em;font-size:10px;color:#111827;}
    .dealer-queue-empty,.event-details-empty{font-size:10px;color:#6b7280;font-style:italic;}
    .dealer-queue-item{padding:4px 6px;border-radius:6px;background:#eef2ff;border:1px solid rgba(79,70,229,.3);display:flex;justify-content:space-between;align-items:center;gap:6px;}
    .dq-badge{
      padding:1px 5px;
      border-radius:999px;
      background:#e5e7eb;
      color:#000;
      font-size:9px;
      text-transform:uppercase;
    }
    .event-details-row{display:flex;justify-content:space-between;gap:6px;}
    .event-details-label{font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:#6b7280;}
    .event-details-value{font-size:11px;color:#111827;font-weight:500;}
    .panel-title{font-size:13px;text-transform:uppercase;letter-spacing:.14em;color:var(--par-muted);}
    .panel-divider{height:1px;background:linear-gradient(90deg,rgba(255,255,255,.06),rgba(227,6,19,.6),rgba(255,255,255,.06));margin:4px 0 8px;}
    form{display:flex;flex-direction:column;gap:10px;flex:1;overflow-y:auto;padding-right:4px;}
    label{font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:var(--par-muted);}
    input,select,textarea{width:100%;border-radius:8px;border:1px solid var(--par-border);background:rgba(10,18,38,.95);color:var(--par-text);font-size:13px;padding:8px 10px;outline:none;}
    input:focus,select:focus,textarea:focus{border-color:var(--par-red);box-shadow:0 0 0 1px rgba(227,6,19,.3);}
    input.date-input{cursor:pointer;}
    textarea{min-height:60px;resize:vertical;}
    .field-group{display:flex;flex-direction:column;gap:6px;}
    .field-row{display:flex;gap:8px;}
    .field-row .field-group{flex:1;}
    .inline-checkbox{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--par-muted);}
    .inline-checkbox input[type=checkbox]{width:auto;}
    .status{font-size:11px;min-height:16px;color:var(--par-muted);}
    .actions{display:flex;gap:10px;margin-top:6px;flex-wrap:wrap;}
    .btn{border-radius:8px;padding:10px 14px;border:none;cursor:pointer;font-weight:600;text-transform:uppercase;letter-spacing:.06em;}
    .btn-primary{background:var(--par-red);color:#fff;flex:1;}
    .btn-clear{background:#263040;color:var(--par-muted);}
    .btn-danger{background:#7f1d1d;color:#fee2e2;}
    .btn-danger:hover{background:#991b1b;}
    .timeoff-note{font-size:11px;color:var(--par-muted);}
    .weekly-card{margin-top:8px;border-radius:10px;border:1px solid rgba(255,255,255,.12);padding:8px 10px;background:rgba(3,10,25,.9);display:flex;flex-direction:column;gap:6px;}
    .week-row{display:grid;grid-template-columns:90px 1fr 1fr 90px;gap:8px;align-items:center;font-size:12px;}
    .week-row-label{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--par-muted);}
    .week-row select{background:rgba(10,18,38,.95);border-radius:6px;border:1px solid var(--par-border);color:var(--par-text);font-size:12px;padding:4px 6px;}
    .week-row-off{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--par-muted);}
    @media(max-width:1000px){
      .main{flex-direction:column;}
      .left{border-right:none;border-bottom:1px solid rgba(255,255,255,.08);}
    }
    @media(max-width:768px){
      header{
        padding:12px 14px;
        flex-direction:column;
        align-items:flex-start;
        gap:8px;
      }
      .header-actions{
        width:100%;
        justify-content:flex-start;
        flex-wrap:wrap;
      }
      .left,.right{
        padding:10px;
      }
      .chips{
        width:100%;
      }
      .cal-wrapper{
        min-height:220px;
        overflow-x:auto;
      }
      .cal-header-row,
      .cal-row{
        min-width:650px;
        height:32px;
      }
      .bottom-info-row{
        flex-direction:column;
      }
      .dealer-queue,.event-details{
        width:100%;
      }
      .btn{
        padding:9px 10px;
        font-size:11px;
      }
      input,select,textarea{
        font-size:12px;
        padding:7px 9px;
      }
    }

    /* Custom date picker */
    .date-picker-popup{
      position:absolute;
      z-index:1000;
      width:230px;
      background:#111827;
      color:#f9fafb;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.15);
      box-shadow:0 12px 25px rgba(15,23,42,.6);
      padding:8px;
      font-size:12px;
      display:none;
    }
    .date-picker-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
    }
    .date-picker-header button{
      border:none;
      background:rgba(15,23,42,.8);
      color:#e5e7eb;
      border-radius:999px;
      padding:2px 6px;
      cursor:pointer;
      font-size:11px;
    }
    .date-picker-month{
      font-weight:600;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-size:11px;
    }
    .date-picker-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:2px;
    }
    .date-picker-cell{
      text-align:center;
      padding:4px 0;
      border-radius:6px;
      cursor:pointer;
    }
    .date-picker-cell.disabled{
      color:#6b7280;
      cursor:default;
    }
    .date-picker-cell.day-name{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#9ca3af;
      cursor:default;
    }
    .date-picker-cell.day{
      background:rgba(15,23,42,.9);
    }
    .date-picker-cell.day:hover{
      background:rgba(227,6,19,.6);
    }
    .date-picker-cell.selected{
      background:var(--par-red);
      font-weight:700;
    }
    .date-picker-cell.today{
      border:1px solid var(--par-red);
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <div class="title">
      <h1>PATRIOT AUTO RESTYLING</h1>
      <span>Internal Scheduler Hub · Daily Tech View</span>
    </div>
    <div class="header-actions">
      <button id="btnAppointmentsPanel" class="header-btn active">Appointments</button>
      <button id="btnTimeOffPanel" class="header-btn">Tech Time Off</button>
      <button id="btnSchedulesPanel" class="header-btn">Tech Schedules</button>
      <button id="btnServicesPanel" class="header-btn">Services</button>
    </div>
  </header>

  <div class="main">
    <div class="left">
      <div class="left-top-row">
        <div class="chips" id="chipsContainer"></div>
        
        <div class="date-controls">
          <div class="date-row">
            <button class="nav-btn" id="btnPrevDay">◀</button>
            <span class="date-label" id="dayLabel">Today</span>
            <button class="nav-btn" id="btnNextDay">▶</button>
          </div>
          <div class="date-row">
            <span style="font-size:10px;">Jump to date:</span>
            <input type="text" id="dayPicker" class="date-input" placeholder="YYYY-MM-DD" readonly />
          </div>
        </div>
      </div>

      <div class="cal-wrapper">
        <div class="cal-header-row" id="calHeaderRow"></div>
        <div class="cal-body" id="calBody"></div>
        <div class="cal-legend">
          <span class="legend-item"><span class="dot dot-detail"></span>Detailing</span>
          <span class="legend-item"><span class="dot dot-tint"></span>Tint</span>
          <span class="legend-item"><span class="dot dot-ppf"></span>PPF</span>
          <span class="legend-item"><span class="dot dot-ceramic"></span>Ceramic</span>
          <span class="legend-item"><span class="dot dot-electronics"></span>Electronics</span>
          <span class="legend-item"><span class="dot dot-timeoff"></span>Tech Time Off</span>
        </div>
        <div class="bottom-info-row">
          <div class="dealer-queue">
            <div class="dealer-queue-title">Dealer Queue (Today)</div>
            <div id="dealerQueueList" class="dealer-queue-empty">No dealer jobs queued for this day.</div>
          </div>
          <div class="event-details">
            <div class="event-details-title">Appointment Details</div>
            <div id="eventDetails" class="event-details-empty">Click an appointment pill to view details. Click again to edit.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="right">
      <!-- Appointments -->
      <div id="appointmentPanel">
        <div class="panel-title">Create / Edit Appointment</div>
        <div class="panel-divider"></div>
        <form id="appointmentForm" onsubmit="return false;">
          <div class="field-row">
            <div class="field-group">
              <label>Customer / Dealer Name</label>
              <input id="inputCustomerName" placeholder="Search or enter name" />
            </div>
            <div class="field-group">
              <label>&nbsp;</label>
              <div class="inline-checkbox">
                <input type="checkbox" id="checkboxDealer" />
                <span>Dealer Job (Dealer Queue)</span>
              </div>
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Phone</label>
              <input id="inputCustomerPhone" placeholder="(555) 123-4567" />
            </div>
            <div class="field-group">
              <label>Email</label>
              <input type="email" id="inputCustomerEmail" placeholder="email@example.com" />
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Appointment Date</label>
              <input type="text" id="datePicker" class="date-input" placeholder="YYYY-MM-DD" readonly />
            </div>
            <div class="field-group">
              <label>&nbsp;</label>
              <div class="inline-checkbox">
                <input type="checkbox" id="checkboxCustomerWaiting" />
                <span>Customer Waiting</span>
              </div>
            </div>
          </div>

          <div class="field-group">
            <label>Service & Technician Assignments</label>
            <div id="serviceAssignments"></div>
            <button type="button" class="btn btn-clear" id="btnAddServiceRow" style="margin-top:6px;">+ Add Service</button>
          </div>

          <div class="field-row">
            <div class="field-group">
              <label>Ride / Pickup Options</label>
              <div class="inline-checkbox">
                <input type="checkbox" id="checkboxRideNeeded" />
                <span>Ride Needed</span>
              </div>
              <div class="field-group">
                <label style="font-size:10px;text-transform:none;letter-spacing:0;">Ride Time</label>
                <select id="inputRideTime"></select>
              </div>
              <div class="inline-checkbox">
                <input type="checkbox" id="checkboxPickupDelivery" />
                <span>Pickup / Delivery</span>
              </div>
            </div>
            <div class="field-group">
              <label>Pickup / Delivery Times</label>
              <div class="field-group">
                <label style="font-size:10px;text-transform:none;letter-spacing:0;">Pickup Time</label>
                <select id="inputPickupTime"></select>
              </div>
              <div class="field-group">
                <label style="font-size:10px;text-transform:none;letter-spacing:0;">Delivery Time</label>
                <select id="inputDeliveryTime"></select>
              </div>
            </div>
          </div>
          <div class="field-group">
            <label>Notes</label>
            <textarea id="inputNotes" placeholder="Deposit paid? Keys in drop box?"></textarea>
          </div>
          <div class="status" id="statusText">Click a tech/time slot on the left or pick a date here to start. Click an existing pill to edit.</div>
          <div class="actions">
            <button type="button" class="btn btn-clear" id="btnClear">Clear</button>
            <button type="button" class="btn btn-danger" id="btnDeleteAppointment">Delete</button>
            <button type="button" class="btn btn-primary" id="btnCreateAppointment">Save to Zapier</button>
          </div>
        </form>
      </div>

      <!-- Time off -->
      <div id="timeOffPanel" style="display:none;">
        <div class="panel-title">Tech Time Off</div>
        <div class="panel-divider"></div>
        <form id="timeOffForm" onsubmit="return false;">
          <div class="field-row">
            <div class="field-group">
              <label>Technician</label>
              <select id="timeOffTechnician">
                <option value="">Select tech</option>
                <option>William</option><option>Limage</option><option>Kaiden</option><option>Luke</option><option>Fafa</option><option>Matt</option>
              </select>
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Start Date</label>
              <input type="text" id="timeOffStartDate" class="date-input" placeholder="YYYY-MM-DD" readonly />
            </div>
            <div class="field-group">
              <label>End Date</label>
              <input type="text" id="timeOffEndDate" class="date-input" placeholder="YYYY-MM-DD" readonly />
            </div>
          </div>

          <div class="field-row">
            <div class="field-group">
              <label>&nbsp;</label>
              <div class="inline-checkbox">
                <input type="checkbox" id="timeOffAllDay" />
                <span>All day (block full working hours for each date)</span>
              </div>
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Start Time</label>
              <select id="timeOffStartTime"></select>
            </div>
            <div class="field-group">
              <label>End Time</label>
              <select id="timeOffEndTime"></select>
            </div>
          </div>
          <div class="field-group">
            <label>Notes</label>
            <textarea id="timeOffNotes" placeholder="Reason for time off (optional)"></textarea>
          </div>
          <div class="timeoff-note">Leave Start/End Time empty to block the full working day for the date range.</div>
          <div class="actions">
            <button type="button" class="btn btn-clear" id="btnClearTimeOff">Clear</button>
            <button type="button" class="btn btn-danger" id="btnDeleteTimeOff">Delete Time Off</button>
            <button type="button" class="btn btn-primary" id="btnSaveTimeOff">Save Time Off</button>
          </div>
        </form>
      </div>

      <!-- Tech schedules -->
      <div id="schedulesPanel" style="display:none;">
        <div class="panel-title">Tech Schedules</div>
        <div class="panel-divider"></div>
        <form id="schedulesForm" onsubmit="return false;">
          <div class="field-group">
            <label>Select Technician</label>
            <select id="scheduleTechSelect">
              <option value="">Choose tech</option>
              <option>William</option><option>Limage</option><option>Kaiden</option><option>Luke</option><option>Fafa</option><option>Matt</option>
            </select>
          </div>
          <div class="weekly-card">
            <div class="week-row">
              <div class="week-row-label">Monday</div>
              <select id="sched_Monday_start"></select>
              <select id="sched_Monday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Monday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Tuesday</div>
              <select id="sched_Tuesday_start"></select>
              <select id="sched_Tuesday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Tuesday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Wednesday</div>
              <select id="sched_Wednesday_start"></select>
              <select id="sched_Wednesday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Wednesday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Thursday</div>
              <select id="sched_Thursday_start"></select>
              <select id="sched_Thursday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Thursday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Friday</div>
              <select id="sched_Friday_start"></select>
              <select id="sched_Friday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Friday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Saturday</div>
              <select id="sched_Saturday_start"></select>
              <select id="sched_Saturday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Saturday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Sunday</div>
              <select id="sched_Sunday_start"></select>
              <select id="sched_Sunday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Sunday_off" /><span>Off?</span></div>
            </div>
          </div>
          <div class="timeoff-note">These hours control which parts of the grid show as off-shift for each tech, per weekday. (Saved in this browser.)</div>
          <div class="actions">
            <button type="button" class="btn btn-primary" id="btnSaveSchedules">Save Tech Schedule</button>
          </div>
          <div class="status" id="scheduleStatus"></div>
        </form>
      </div>

      <!-- Services library -->
      <div id="servicesPanel" style="display:none;">
        <div class="panel-title">Service Library</div>
        <div class="panel-divider"></div>
        <form id="servicesForm" onsubmit="return false;">
          <div class="field-group">
            <label>Service Categories & Packages</label>
            <div id="serviceCategoriesList"></div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Add New Category</label>
              <input id="inputNewCategoryName" placeholder="e.g., Accessories" />
            </div>
            <div class="field-group" style="align-self:flex-end;">
              <button type="button" class="btn btn-primary" id="btnAddCategory">Add Category</button>
            </div>
          </div>
          <div class="timeoff-note">These services are saved in this browser and power the dropdowns in the appointment form.</div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Custom Date Picker element -->
<div id="datePickerPopup" class="date-picker-popup">
  <div class="date-picker-header">
    <button type="button" id="dpPrevMonth">◀</button>
    <div class="date-picker-month" id="dpMonthLabel">MONTH YYYY</div>
    <button type="button" id="dpNextMonth">▶</button>
  </div>
  <div class="date-picker-grid" id="dpGrid"></div>
</div>

<script>
const techs=["William","Limage","Kaiden","Luke","Fafa","Matt"];
const days=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
const workTimes=["08:00","08:30","09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30","18:00"];

const defaultServicePackages={
  "Detailing":["Interior Detail","Exterior Detail","Full Detail","Quick Clean"],
  "Tint":["Front Windows Only","Full Tint","Windshield Tint"],
  "PPF":["Full Front PPF"],
  "Ceramic":["1 Year Coating","3 Year Coating","5 Year Coating"],
  "Electronics":["Remote Start","Remote Start + Security"]
};
let servicePackages={};

const ZAPIER_WEBHOOK_URL="https://hooks.zapier.com/hooks/catch/23565840/uzuiw0k/";

let storageAvailable=true;
try{
  const testKey="__patriot_test";
  window.localStorage.setItem(testKey,"1");
  window.localStorage.removeItem(testKey);
}catch(e){
  storageAvailable=false;
}

let techSchedules={};
let events=[];
let currentDate=new Date();currentDate.setHours(0,0,0,0);
let selectedDeptFilter="All";
let selectedSlot=null;
let selectedEventId=null;
let editingJobGroupId=null;

// DOM refs
const headerBtnAppointments=document.getElementById("btnAppointmentsPanel");
const headerBtnTimeOff=document.getElementById("btnTimeOffPanel");
const headerBtnSchedules=document.getElementById("btnSchedulesPanel");
const headerBtnServices=document.getElementById("btnServicesPanel");
const appointmentPanel=document.getElementById("appointmentPanel");
const timeOffPanel=document.getElementById("timeOffPanel");
const schedulesPanel=document.getElementById("schedulesPanel");
const servicesPanel=document.getElementById("servicesPanel");
const headerRowEl=document.getElementById("calHeaderRow");
const bodyEl=document.getElementById("calBody");
const dayLabelEl=document.getElementById("dayLabel");
const dayPickerEl=document.getElementById("dayPicker");
const statusEl=document.getElementById("statusText");
const dealerQueueListEl=document.getElementById("dealerQueueList");
const eventDetailsEl=document.getElementById("eventDetails");
const scheduleTechSelect=document.getElementById("scheduleTechSelect");
const scheduleStatus=document.getElementById("scheduleStatus");
const btnCreateAppointment=document.getElementById("btnCreateAppointment");
const btnDeleteAppointment=document.getElementById("btnDeleteAppointment");

// Service assignments container
const serviceAssignmentsContainer=document.getElementById("serviceAssignments");
const btnAddServiceRow=document.getElementById("btnAddServiceRow");

// Services library refs
const serviceCategoriesList=document.getElementById("serviceCategoriesList");
const inputNewCategoryName=document.getElementById("inputNewCategoryName");
const btnAddCategory=document.getElementById("btnAddCategory");

// Custom date picker refs
const dpPopup=document.getElementById("datePickerPopup");
const dpGrid=document.getElementById("dpGrid");
const dpMonthLabel=document.getElementById("dpMonthLabel");
const dpPrevMonth=document.getElementById("dpPrevMonth");
const dpNextMonth=document.getElementById("dpNextMonth");
let dpActiveInput=null;
let dpYear=null;
let dpMonth=null;

function toISODate(d){return d.toISOString().slice(0,10);}
function getDayName(d){return d.toLocaleDateString("en-US",{weekday:"long"});}
function formatDateLabel(d){
  const dow=d.toLocaleDateString(undefined,{weekday:"short"}).toUpperCase();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  const y=d.getFullYear();
  return `${dow} ${m}/${day}/${y}`;
}
function timeToMinutes(t){if(!t)return null;const [h,m]=t.split(":").map(Number);return h*60+m;}
function formatTimeFriendly(t){
  if(!t) return "";
  const [hStr,mStr]=t.split(":");
  let h=parseInt(hStr,10), m=parseInt(mStr,10);
  const ampm=h>=12?"PM":"AM";
  if(h===0) h=12; else if(h>12) h-=12;
  return h+":"+(m<10?"0"+m:m)+" "+ampm;
}
function parseISODate(str){
  if(!str) return null;
  const m=str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return null;
  const year=parseInt(m[1],10),month=parseInt(m[2],10)-1,day=parseInt(m[3],10);
  const d=new Date(year,month,day);
  if(isNaN(d.getTime())) return null;
  return d;
}

// Time dropdowns
function populateTimeSelect(selectEl,allowEmpty=true){
  if(!selectEl) return;
  selectEl.innerHTML="";
  if(allowEmpty){
    const ph=document.createElement("option");ph.value="";ph.textContent="--";selectEl.appendChild(ph);
  }
  workTimes.forEach(t=>{
    const opt=document.createElement("option");opt.value=t;opt.textContent=formatTimeFriendly(t);selectEl.appendChild(opt);
  });
}
function initTimeDropdowns(){
  populateTimeSelect(document.getElementById("inputRideTime"));
  populateTimeSelect(document.getElementById("inputPickupTime"));
  populateTimeSelect(document.getElementById("inputDeliveryTime"));
  populateTimeSelect(document.getElementById("timeOffStartTime"));
  populateTimeSelect(document.getElementById("timeOffEndTime"));
  days.forEach(d=>{
    populateTimeSelect(document.getElementById(`sched_${d}_start`),false);
    populateTimeSelect(document.getElementById(`sched_${d}_end`),false);
  });
}

// Tech schedules storage
function initDefaultSchedules(){
  techs.forEach(t=>{
    techSchedules[t]={};
    days.forEach(d=>{
      const weekend=(d==="Saturday"||d==="Sunday");
      techSchedules[t][d]={start:"09:00",end:"17:00",off:weekend};
    });
  });
}
function loadSchedulesFromStorage(){
  if(!storageAvailable){initDefaultSchedules();return;}
  const raw=localStorage.getItem("patriotTechSchedules");
  if(!raw){initDefaultSchedules();return;}
  try{
    const parsed=JSON.parse(raw);
    techSchedules={};
    techs.forEach(t=>{
      techSchedules[t]={};
      days.forEach(d=>{
        const v=(parsed[t] && parsed[t][d])||null;
        if(v){techSchedules[t][d]=v;}
        else{
          const weekend=(d==="Saturday"||d==="Sunday");
          techSchedules[t][d]={start:"09:00",end:"17:00",off:weekend};
        }
      });
    });
  }catch(e){
    console.error("Failed to parse saved schedules",e);
    initDefaultSchedules();
  }
}
function saveSchedulesToStorage(){
  if(!storageAvailable) return;
  localStorage.setItem("patriotTechSchedules",JSON.stringify(techSchedules));
}

// Service packages storage
function loadServicePackagesFromStorage(){
  if(!storageAvailable){
    servicePackages=JSON.parse(JSON.stringify(defaultServicePackages));
    return;
  }
  const raw=localStorage.getItem("patriotServicePackages");
  if(!raw){
    servicePackages=JSON.parse(JSON.stringify(defaultServicePackages));
    return;
  }
  try{
    const parsed=JSON.parse(raw);
    if(parsed && typeof parsed==="object"){
      servicePackages=parsed;
    }else{
      servicePackages=JSON.parse(JSON.stringify(defaultServicePackages));
    }
  }catch(e){
    console.error("Failed to parse saved service packages",e);
    servicePackages=JSON.parse(JSON.stringify(defaultServicePackages));
  }
}
function saveServicePackagesToStorage(){
  if(!storageAvailable) return;
  localStorage.setItem("patriotServicePackages",JSON.stringify(servicePackages));
}

// Service helpers (per-row)
function populateServiceOptionsForSelect(deptSelect,serviceSelect,selectedValue){
  serviceSelect.innerHTML="";
  const ph=document.createElement("option");ph.value="";ph.textContent="Select service";serviceSelect.appendChild(ph);
  const dept=deptSelect.value;
  if(dept && servicePackages[dept]){
    servicePackages[dept].forEach(n=>{
      const o=document.createElement("option");
      o.value=n;o.textContent=n;
      serviceSelect.appendChild(o);
    });
  }
  if(selectedValue) serviceSelect.value=selectedValue;
}

// Service assignment rows
function addServiceRow(initial){
  const row=document.createElement("div");
  row.className="field-row service-row";

  const deptGroup=document.createElement("div");
  deptGroup.className="field-group";
  const deptSelect=document.createElement("select");
  deptSelect.className="sa-dept";
  const deptPh=document.createElement("option");deptPh.value="";deptPh.textContent="Service Category";deptSelect.appendChild(deptPh);
  Object.keys(servicePackages).sort().forEach(key=>{
    const opt=document.createElement("option");opt.value=key;opt.textContent=key;deptSelect.appendChild(opt);
  });
  deptGroup.appendChild(deptSelect);

  const svcGroup=document.createElement("div");
  svcGroup.className="field-group";
  const svcSelect=document.createElement("select");
  svcSelect.className="sa-service";
  const svcPh=document.createElement("option");svcPh.value="";svcPh.textContent="Select service";svcSelect.appendChild(svcPh);
  svcGroup.appendChild(svcSelect);

  const techGroup=document.createElement("div");
  techGroup.className="field-group";
  const techSelect=document.createElement("select");
  techSelect.className="sa-tech";
  const techPh=document.createElement("option");techPh.value="";techPh.textContent="Assign tech";techSelect.appendChild(techPh);
  const optDealer=document.createElement("option");optDealer.value="Dealer";optDealer.textContent="Dealer";techSelect.appendChild(optDealer);
  techs.forEach(t=>{
    const o=document.createElement("option");o.value=t;o.textContent=t;techSelect.appendChild(o);
  });
  techGroup.appendChild(techSelect);

  const timeGroup=document.createElement("div");
  timeGroup.className="field-group";
  const timeSelect=document.createElement("select");
  timeSelect.className="sa-time";
  populateTimeSelect(timeSelect,true);
  timeGroup.appendChild(timeSelect);

  const removeBtn=document.createElement("button");
  removeBtn.type="button";
  removeBtn.textContent="✕";
  removeBtn.className="btn btn-clear";
  removeBtn.style.padding="4px 8px";
  removeBtn.addEventListener("click",()=>{
    row.remove();
    if(serviceAssignmentsContainer.children.length===0){
      addServiceRow();
    }
  });

  row.appendChild(deptGroup);
  row.appendChild(svcGroup);
  row.appendChild(techGroup);
  row.appendChild(timeGroup);
  row.appendChild(removeBtn);
  serviceAssignmentsContainer.appendChild(row);

  deptSelect.addEventListener("change",()=>{
    populateServiceOptionsForSelect(deptSelect,svcSelect,null);
  });

  if(initial){
    if(initial.dept){
      deptSelect.value=initial.dept;
      populateServiceOptionsForSelect(deptSelect,svcSelect,initial.serviceName||"");
    }
    if(initial.tech) techSelect.value=initial.tech;
    if(initial.time) timeSelect.value=initial.time;
  }
}

function clearServiceAssignments(){
  serviceAssignmentsContainer.innerHTML="";
}
function ensureAtLeastOneServiceRow(){
  if(serviceAssignmentsContainer.children.length===0){
    addServiceRow();
  }
}
function refreshAllServiceAssignmentRows(){
  const rows=document.querySelectorAll(".service-row");
  rows.forEach(row=>{
    const deptSelect=row.querySelector(".sa-dept");
    const svcSelect=row.querySelector(".sa-service");
    const prevDept=deptSelect.value;
    const prevSvc=svcSelect.value;

    deptSelect.innerHTML="";
    const deptPh=document.createElement("option");deptPh.value="";deptPh.textContent="Service Category";deptSelect.appendChild(deptPh);
    Object.keys(servicePackages).sort().forEach(key=>{
      const opt=document.createElement("option");opt.value=key;opt.textContent=key;deptSelect.appendChild(opt);
    });
    if(prevDept && servicePackages[prevDept]) deptSelect.value=prevDept;

    populateServiceOptionsForSelect(deptSelect,svcSelect,prevSvc);
  });
}
function getServiceAssignmentsFromForm(){
  const rows=serviceAssignmentsContainer.querySelectorAll(".service-row");
  const result=[];
  rows.forEach(row=>{
    const dept=row.querySelector(".sa-dept")?.value||"";
    const serviceName=row.querySelector(".sa-service")?.value||"";
    const tech=row.querySelector(".sa-tech")?.value||"";
    const time=row.querySelector(".sa-time")?.value||"";
    if(!dept && !serviceName && !tech && !time) return;
    result.push({dept,serviceName,tech,time});
  });
  return result;
}

// Services library rendering & actions
function renderServiceLibrary(){
  serviceCategoriesList.innerHTML="";
  const cats=Object.keys(servicePackages).sort();
  if(!cats.length){
    const empty=document.createElement("div");
    empty.className="timeoff-note";
    empty.textContent="No categories yet. Add a new one below.";
    serviceCategoriesList.appendChild(empty);
    return;
  }
  cats.forEach(cat=>{
    const card=document.createElement("div");
    card.style.border="1px solid rgba(255,255,255,0.12)";
    card.style.borderRadius="8px";
    card.style.padding="8px";
    card.style.marginBottom="6px";
    card.style.background="rgba(3,10,25,0.9)";

    const header=document.createElement("div");
    header.style.display="flex";
    header.style.justifyContent="space-between";
    header.style.alignItems="center";

    const title=document.createElement("div");
    title.textContent=cat;
    title.style.fontWeight="600";
    title.style.fontSize="12px";

    const delBtn=document.createElement("button");
    delBtn.type="button";
    delBtn.textContent="Delete Category";
    delBtn.className="btn btn-clear";
    delBtn.style.padding="4px 8px";
    delBtn.style.fontSize="10px";
  delBtn.addEventListener("click",()=>{
  if(!confirm(`Delete category "${cat}" and all its services?`)) return;
  delete servicePackages[cat];
  saveServicePackagesToStorage();
  renderServiceLibrary();
  refreshAllServiceAssignmentRows();
  renderDeptChips();        // <-- NEW
});


    header.appendChild(title);
    header.appendChild(delBtn);
    card.appendChild(header);

    const svcList=document.createElement("div");
    svcList.style.display="flex";
    svcList.style.flexWrap="wrap";
    svcList.style.gap="4px";
    (servicePackages[cat]||[]).forEach(name=>{
      const chip=document.createElement("div");
      chip.style.borderRadius="999px";
      chip.style.padding="2px 8px";
      chip.style.fontSize="11px";
      chip.style.background="rgba(15,23,42,0.9)";
      chip.style.border="1px solid rgba(255,255,255,0.15)";
      chip.style.display="flex";
      chip.style.alignItems="center";
      chip.style.gap="4px";

      const span=document.createElement("span");
      span.textContent=name;

      const xBtn=document.createElement("button");
      xBtn.type="button";
      xBtn.textContent="✕";
      xBtn.style.border="none";
      xBtn.style.background="transparent";
      xBtn.style.color="#fca5a5";
      xBtn.style.cursor="pointer";
      xBtn.style.fontSize="11px";
      xBtn.addEventListener("click",()=>{
        const arr=servicePackages[cat]||[];
        const idx=arr.indexOf(name);
        if(idx!==-1){
          arr.splice(idx,1);
          saveServicePackagesToStorage();
          renderServiceLibrary();
          refreshAllServiceAssignmentRows();
        }
      });

      chip.appendChild(span);
      chip.appendChild(xBtn);
      svcList.appendChild(chip);
    });
    card.appendChild(svcList);

    const addRow=document.createElement("div");
    addRow.style.display="flex";
    addRow.style.gap="6px";
    addRow.style.marginTop="6px";

    const input=document.createElement("input");
    input.type="text";
    input.placeholder="Add service";
    input.style.flex="1";

    const addBtn=document.createElement("button");
    addBtn.type="button";
    addBtn.textContent="Add";
    addBtn.className="btn btn-primary";
    addBtn.style.padding="6px 10px";
    addBtn.style.fontSize="11px";
    addBtn.addEventListener("click",()=>{
      const val=input.value.trim();
      if(!val) return;
      if(!servicePackages[cat]) servicePackages[cat]=[];
      if(servicePackages[cat].includes(val)){
        alert("Service already exists in this category.");
        return;
      }
      servicePackages[cat].push(val);
      saveServicePackagesToStorage();
      renderServiceLibrary();
      refreshAllServiceAssignmentRows();
    });

    addRow.appendChild(input);
    addRow.appendChild(addBtn);
    card.appendChild(addRow);

    serviceCategoriesList.appendChild(card);
  });
}

btnAddCategory.addEventListener("click",()=>{
  const name=inputNewCategoryName.value.trim();
  if(!name) return;
  if(servicePackages[name]){
    alert("That category already exists.");
    return;
  }
  servicePackages[name]=[];
  saveServicePackagesToStorage();
  inputNewCategoryName.value="";
  renderServiceLibrary();
  refreshAllServiceAssignmentRows();
  renderDeptChips();         // <-- NEW
});


// Events utilities
function getEventsForDay(dateIso){return events.filter(ev=>ev.date===dateIso);}
function generateDeptColor(dept) {
  let hash = 0;
  for (let i = 0; i < dept.length; i++) {
    hash = dept.charCodeAt(i) + ((hash << 5) - hash);
  }
  const hue = Math.abs(hash) % 360;
  return `hsl(${hue}, 70%, 55%)`;
}

function renderDeptChips() {
  const container = document.getElementById("chipsContainer");
  if (!container) return;

  container.innerHTML = "";

  // "All" chip
  const allChip = document.createElement("div");
  allChip.className = "chip active";
  allChip.dataset.dept = "All";
  allChip.innerHTML = `<span class="dot" style="background:#000;"></span>All`;
  container.appendChild(allChip);

  // One chip per service category from servicePackages
  const categories = Object.keys(servicePackages).sort();

  categories.forEach(cat => {
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.dataset.dept = cat;

    const color = generateDeptColor(cat);

    chip.innerHTML = `
      <span class="dot" style="background:${color};"></span>${cat}
    `;

    container.appendChild(chip);
  });

  // Chip click handling
  container.querySelectorAll(".chip").forEach(ch => {
    ch.addEventListener("click", () => {
      container.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
      ch.classList.add("active");

      selectedDeptFilter = ch.dataset.dept;
      renderCalendar();
    });
  });
}

function renderDealerQueue(){
  const dateIso=toISODate(currentDate);
  const todays=getEventsForDay(dateIso).filter(ev=>ev.type==="job" && ev.tech==="Dealer");
  if(!todays.length){
    dealerQueueListEl.className="dealer-queue-empty";
    dealerQueueListEl.textContent="No dealer jobs queued for this day.";
    return;
  }
  dealerQueueListEl.className="";
  dealerQueueListEl.innerHTML="";
  todays.sort((a,b)=>a.time.localeCompare(b.time)).forEach(ev=>{
    const item=document.createElement("div");
    item.className="dealer-queue-item";
    item.dataset.eventId=ev.id;
    item.style.cursor="pointer";

    const main=document.createElement("div");
    main.style.display="flex";
    main.style.flexDirection="column";
    main.style.gap="2px";

    const t=document.createElement("span");
    t.textContent=ev.time;
    t.style.fontWeight="600";
    main.appendChild(t);

    const n=document.createElement("span");
    n.textContent=(ev.customerName||"Dealer Job");
    main.appendChild(n);

    const s=document.createElement("span");
    s.textContent=`${ev.dept||""} · ${ev.serviceName||ev.label||""}`;
    s.style.fontSize="10px";
    main.appendChild(s);

    const badges=document.createElement("div");
    badges.style.display="flex";
    badges.style.flexDirection="column";
    badges.style.gap="2px";
    badges.style.alignItems="flex-end";

    const db=document.createElement("div");
    db.className="dq-badge";
    db.textContent="Dealer";
    badges.appendChild(db);

    if(ev.customerWaiting){
      const b=document.createElement("div");
      b.className="dq-badge";
      b.textContent="Waiting";
      badges.appendChild(b);
    }
    if(ev.rideNeeded){
      const b=document.createElement("div");
      b.className="dq-badge";
      b.textContent="Ride";
      badges.appendChild(b);
    }
    if(ev.pickupDelivery){
      const b=document.createElement("div");
      b.className="dq-badge";
      b.textContent="Pickup/Delivery";
      badges.appendChild(b);
    }

    item.appendChild(main);
    item.appendChild(badges);
    dealerQueueListEl.appendChild(item);
  });
}

function renderEventDetails(ev){
  if(!ev){
    eventDetailsEl.className="event-details-empty";
    eventDetailsEl.textContent="Click an appointment pill to view details. Click again to edit.";
    return;
  }
  eventDetailsEl.className="";
  eventDetailsEl.innerHTML="";
  function row(label,val){
    const r=document.createElement("div");
    r.className="event-details-row";
    const l=document.createElement("div");
    l.className="event-details-label";
    l.textContent=label;
    const v=document.createElement("div");
    v.className="event-details-value";
    v.textContent=val||"—";
    r.appendChild(l);
    r.appendChild(v);
    eventDetailsEl.appendChild(r);
  }
  if(ev.type==="job"){
    row("Type","Appointment");
    row("Customer",ev.customerName||"");
    const groupKey=ev.jobGroupId||ev.id;
    const groupEvents=events.filter(x=>x.type==="job" && (x.jobGroupId||x.id)===groupKey);
    if(groupEvents.length>1){
      const summary=groupEvents.map(x=>{
        const base=`${x.dept||""}${x.serviceName?" – "+x.serviceName:""}`;
        const techPart=x.tech?` (${x.tech} @ ${x.time||""})`:"";
        return base+techPart;
      }).join(" | ");
      row("Services",summary);
    }else{
      row("Dept / Service",`${ev.dept||""}${ev.serviceName?" · "+ev.serviceName:""}`);
    }
  }else{
    row("Type","Time Off");
    row("Tech",ev.tech||"");
    row("Note",ev.notes||"");
  }
  row("Tech",ev.tech||"");
  row("Date",ev.date||"");
  row("Time",ev.time||"");
  if(ev.type==="job"){
    row("Dealer",ev.dealer?"Yes":"No");
    row("Customer Waiting",ev.customerWaiting?"Yes":"No");
    row("Ride Needed",ev.rideNeeded?"Yes":"No");
    row("Ride Time",ev.rideTime||"");
    let pdVal=ev.pickupDelivery?"Yes":"No";
    if(ev.pickupDelivery){
      const p=ev.pickupTime?`Pickup: ${ev.pickupTime}`:"";
      const d=ev.deliveryTime?`Delivery: ${ev.deliveryTime}`:"";
      pdVal=[p,d].filter(Boolean).join(" · ")||"Yes";
    }
    row("Pickup/Delivery",pdVal);
    row("Notes",ev.notes||"");
  }
}

// Calendar rendering
function renderCalendar(){
  const dateIso=toISODate(currentDate);
  const dayName=getDayName(currentDate);
  const todays=getEventsForDay(dateIso);

  headerRowEl.innerHTML="";
  const timeHead=document.createElement("div");
  timeHead.className="cal-header-cell";
  timeHead.textContent="";
  headerRowEl.appendChild(timeHead);
  techs.forEach(t=>{
    const c=document.createElement("div");
    c.className="cal-header-cell";
    c.innerHTML=`<strong>${t}</strong>`;
    headerRowEl.appendChild(c);
  });

  dayLabelEl.textContent=formatDateLabel(currentDate);
  if(dayPickerEl) dayPickerEl.value=dateIso;

  bodyEl.innerHTML="";
  workTimes.forEach(time=>{
    const row=document.createElement("div");
    row.className="cal-row";
    const timeCell=document.createElement("div");
    timeCell.className="cal-time-cell";
    timeCell.textContent=formatTimeFriendly(time);
    row.appendChild(timeCell);
    const mins=timeToMinutes(time);

    techs.forEach(tech=>{
      const cell=document.createElement("div");
      cell.className="cal-slot-cell";
      cell.dataset.tech=tech;
      cell.dataset.time=time;

      const sched=techSchedules[tech][dayName];
      if(!sched || sched.off){
        cell.classList.add("off-shift");
      }else{
        const s=timeToMinutes(sched.start),e=timeToMinutes(sched.end);
        if(mins<s || mins>=e) cell.classList.add("off-shift");
      }

      const inner=document.createElement("div");
      inner.className="cal-slot-inner";

      const cellEvents=todays.filter(ev=>
        ev.tech===tech &&
        ev.time===time &&
        (selectedDeptFilter==="All" || ev.dept===selectedDeptFilter || (ev.type==="timeoff" && selectedDeptFilter==="All"))
      );

      const hasTimeOffHere=todays.some(ev=>ev.type==="timeoff" && ev.tech===tech && ev.time===time);
      if(hasTimeOffHere){
        cell.classList.add("timeoff-block");
      }

      cellEvents.forEach(ev=>{
        if(ev.type==="timeoff"){
          const currentIndex=workTimes.indexOf(ev.time);
          const prevTime=currentIndex>0?workTimes[currentIndex-1]:null;
          const hasPrevTimeOff=prevTime
            ? todays.some(prevEv=>prevEv.type==="timeoff" && prevEv.tech===tech && prevEv.time===prevTime)
            : false;
          if(hasPrevTimeOff){
            return;
          }
        }

        const pill=document.createElement("div");
        let cls="event-pill ";
        if(ev.type==="timeoff") cls+="event-timeoff";
        else if(ev.dept==="Detailing") cls+="event-detailing";
        else if(ev.dept==="Tint") cls+="event-tint";
        else if(ev.dept==="PPF") cls+="event-ppf";
        else if(ev.dept==="Ceramic") cls+="event-ceramic";
        else if(ev.dept==="Electronics") cls+="event-electronics";
        pill.className=cls;
        pill.dataset.eventId=ev.id;

        let label=ev.label||ev.serviceName||"Job";
        if(ev.type==="job" && ev.customerName) label=`${ev.customerName} – ${label}`;
        const span=document.createElement("span");
        span.textContent=label;
        pill.appendChild(span);

        if(ev.type==="job"){
          if(ev.dealer){
            const b=document.createElement("span");
            b.className="small-badge";
            b.textContent="D";
            pill.appendChild(b);
          }
          if(ev.customerWaiting){
            const b=document.createElement("span");
            b.className="small-badge";
            b.textContent="W";
            pill.appendChild(b);
          }
          if(ev.rideNeeded){
            const b=document.createElement("span");
            b.className="small-badge";
            b.textContent="R";
            pill.appendChild(b);
          }
          if(ev.pickupDelivery){
            const b=document.createElement("span");
            b.className="small-badge";
            b.textContent="P/D";
            pill.appendChild(b);
          }
        }

        inner.appendChild(pill);
      });

      cell.appendChild(inner);
      row.appendChild(cell);
    });

    bodyEl.appendChild(row);
  });

  if(selectedSlot){
    const sel=`.cal-slot-cell[data-tech="${selectedSlot.tech}"][data-time="${selectedSlot.time}"]`;
    const c=bodyEl.querySelector(sel);
    if(c) c.classList.add("selected");
  }
  const selectedEvent=events.find(ev=>ev.id===selectedEventId);
  renderEventDetails(selectedEvent);
  renderDealerQueue();
}

// Slot selection
function setSelectedSlot(tech,time){
  selectedSlot={tech,time};
  bodyEl.querySelectorAll(".cal-slot-cell").forEach(c=>c.classList.remove("selected"));
  const sel=`.cal-slot-cell[data-tech="${tech}"][data-time="${time}"]`;
  const c=bodyEl.querySelector(sel);if(c)c.classList.add("selected");
  const iso=toISODate(currentDate);
  const dateInput=document.getElementById("datePicker");
  if(dateInput)dateInput.value=iso;

  ensureAtLeastOneServiceRow();
  const firstRow=serviceAssignmentsContainer.querySelector(".service-row");
  if(firstRow){
    const techSelect=firstRow.querySelector(".sa-tech");
    const timeSelect=firstRow.querySelector(".sa-time");
    if(techSelect) techSelect.value=tech;
    if(timeSelect) timeSelect.value=time;
  }

  if(statusEl)statusEl.textContent=`Selected ${tech} at ${time} on ${iso}.`;
  if(!editingJobGroupId){
    btnCreateAppointment.textContent="Save to Zapier";
  }else{
    btnCreateAppointment.textContent="Update Appointment";
  }
}

// Seed dummy events
function seedDummyEvents(){
  const todayIso=toISODate(currentDate);
  let idCounter=1;
  const base=[
    {tech:"William",dept:"Detailing",type:"job",label:"Full Detail – F-150",time:"09:00",dealer:false,customerName:"Smith"},
    {tech:"Limage",dept:"Detailing",type:"job",label:"Interior – Civic",time:"10:00",dealer:true,pickupDelivery:true,pickupTime:"08:30",deliveryTime:"17:00",customerName:"Zeigler"},
    {tech:"Matt",dept:"Tint",type:"job",label:"Full Tint – Model 3",time:"09:30",dealer:true,rideNeeded:true,rideTime:"09:00",customerWaiting:true,customerName:"Jones"},
    {tech:"Matt",dept:"PPF",type:"job",label:"Full Front – Supra",time:"12:00",dealer:false,customerName:"Taylor"},
    {tech:"William",dept:"Ceramic",type:"job",label:"5yr – Silverado",time:"14:00",dealer:false,customerName:"Clark"},
    {tech:"Fafa",dept:"Detailing",type:"job",label:"Quick Clean – CR-V",time:"15:00",dealer:false,customerName:"Lopez"},
    {tech:"Matt",dept:"Electronics",type:"job",label:"Remote Start – RAM",time:"11:00",dealer:true,pickupDelivery:true,pickupTime:"10:30",deliveryTime:"16:30",customerName:"Davis"},
    {tech:"William",dept:"Detailing",type:"timeoff",label:"Time Off",time:"13:00",notes:"Doctor appt"}
  ];
  events=base.map(e=>{
    const id="seed-"+(idCounter++);
    return {...e,id,date:todayIso,jobGroupId: e.type==="job" ? id : undefined};
  });
}

// Panels
function setPanel(mode){
  appointmentPanel.style.display=mode==="appointments"?"block":"none";
  timeOffPanel.style.display=mode==="timeoff"?"block":"none";
  schedulesPanel.style.display=mode==="schedules"?"block":"none";
  servicesPanel.style.display=mode==="services"?"block":"none";
  headerBtnAppointments.classList.toggle("active",mode==="appointments");
  headerBtnTimeOff.classList.toggle("active",mode==="timeoff");
  headerBtnSchedules.classList.toggle("active",mode==="schedules");
  headerBtnServices.classList.toggle("active",mode==="services");
}

// Schedules panel
function loadScheduleIntoForm(tech){
  days.forEach(d=>{
    const s=document.getElementById(`sched_${d}_start`);
    const e=document.getElementById(`sched_${d}_end`);
    const o=document.getElementById(`sched_${d}_off`);
    if(!tech){
      s.value="09:00";e.value="17:00";o.checked=false;s.disabled=false;e.disabled=false;
      return;
    }
    const cfg=techSchedules[tech][d];
    s.value=cfg.start;
    e.value=cfg.end;
    o.checked=cfg.off;
    s.disabled=cfg.off;
    e.disabled=cfg.off;
  });
}
function attachOffCheckboxHandlers(){
  days.forEach(d=>{
    const o=document.getElementById(`sched_${d}_off`);
    const s=document.getElementById(`sched_${d}_start`);
    const e=document.getElementById(`sched_${d}_end`);
    o.addEventListener("change",()=>{
      const off=o.checked;
      s.disabled=off;
      e.disabled=off;
    });
  });
}
function saveScheduleFromForm(){
  const tech=scheduleTechSelect.value;
  if(!tech){scheduleStatus.textContent="Choose a tech first.";return;}
  days.forEach(d=>{
    const s=document.getElementById(`sched_${d}_start`);
    const e=document.getElementById(`sched_${d}_end`);
    const o=document.getElementById(`sched_${d}_off`);
    techSchedules[tech][d]={start:s.value||"09:00",end:e.value||"17:00",off:o.checked};
  });
  saveSchedulesToStorage();
  scheduleStatus.textContent=`Schedule saved for ${tech}.`;
  renderCalendar();
}

// Time off logic
function saveTimeOff(){
  const tech=document.getElementById("timeOffTechnician").value;
  const startDate=document.getElementById("timeOffStartDate").value;
  const endDate=document.getElementById("timeOffEndDate").value||startDate;
  const startTime=document.getElementById("timeOffStartTime").value;
  const endTime=document.getElementById("timeOffEndTime").value;
  const allDay=document.getElementById("timeOffAllDay") ? document.getElementById("timeOffAllDay").checked : false;
  const notes=document.getElementById("timeOffNotes").value;
  if(!tech||!startDate){alert("Tech and start date are required.");return;}
  const start=new Date(startDate+"T00:00");
  const end=new Date(endDate+"T00:00");
  let cur=new Date(start);
  let idBase=Date.now();

  events=events.filter(ev=>{
    if(ev.type!=="timeoff" || ev.tech!==tech) return true;
    const evDate=new Date(ev.date+"T00:00");
    return evDate<start || evDate>end;
  });

  while(cur<=end){
    const dayIso=toISODate(cur);
    const dow=getDayName(cur);
    let times=[];
    if(!allDay && startTime && endTime){
      times=workTimes.filter(t=>{
        const m=timeToMinutes(t);
        return m>=timeToMinutes(startTime)&&m<timeToMinutes(endTime);
      });
    }else{
      const cfg=techSchedules[tech][dow];
      if(cfg.off){cur.setDate(cur.getDate()+1);continue;}
      times=workTimes.filter(t=>{
        const m=timeToMinutes(t);
        return m>=timeToMinutes(cfg.start)&&m<timeToMinutes(cfg.end);
      });
    }
    times.forEach(t=>{
      events.push({
        id:"to-"+(idBase++),
        type:"timeoff",
        tech,
        dept:null,
        label:"Time Off",
        date:dayIso,
        time:t,
        dealer:false,
        notes
      });
    });
    cur.setDate(cur.getDate()+1);
  }
  document.getElementById("timeOffForm").reset();
  renderCalendar();
}
function deleteTimeOff(){
  const tech=document.getElementById("timeOffTechnician").value;
  const startDate=document.getElementById("timeOffStartDate").value;
  const endDate=document.getElementById("timeOffEndDate").value||startDate;
  if(!tech || !startDate){alert("Tech and start date are required to delete time off.");return;}
  const start=new Date(startDate+"T00:00");
  const end=new Date(endDate+"T00:00");
  events=events.filter(ev=>{
    if(ev.type!=="timeoff" || ev.tech!==tech) return true;
    const evDate=new Date(ev.date+"T00:00");
    return evDate<start || evDate>end;
  });
  document.getElementById("timeOffForm").reset();
  renderCalendar();
}

// Appointment create/update
async function createOrUpdateAppointment(){
  const customerName=document.getElementById("inputCustomerName").value.trim();
  const phone=document.getElementById("inputCustomerPhone").value.trim();
  const email=document.getElementById("inputCustomerEmail").value.trim();
  const date=document.getElementById("datePicker").value;
  const dealer=document.getElementById("checkboxDealer").checked;
  const waiting=document.getElementById("checkboxCustomerWaiting").checked;
  const rideNeeded=document.getElementById("checkboxRideNeeded").checked;
  const rideTime=document.getElementById("inputRideTime").value;
  const pickupDelivery=document.getElementById("checkboxPickupDelivery").checked;
  const pickupTime=document.getElementById("inputPickupTime").value;
  const deliveryTime=document.getElementById("inputDeliveryTime").value;
  const notes=document.getElementById("inputNotes").value;

  const rawServices=getServiceAssignmentsFromForm();
  if(!rawServices.length){
    alert("Add at least one service/tech row.");
    return;
  }
  if(!date){
    alert("Appointment date is required.");
    return;
  }

  let missingDept=false,missingTech=false,missingTime=false;
  const services=rawServices.map(row=>{
    let {dept,serviceName,tech,time}=row;
    if(!dept) missingDept=true;
    if(!time) missingTime=true;
    if(!tech && dealer){
      tech="Dealer";
    }
    if(!tech) missingTech=true;
    return {dept,serviceName,tech,time};
  });

  if(missingDept || missingTech || missingTime){
    let msg="Each service row must have:";
    if(missingDept) msg+="\n- Service category";
    if(missingTech) msg+="\n- Technician (or check Dealer Job)";
    if(missingTime) msg+="\n- Time";
    alert(msg);
    return;
  }

  const groupId=editingJobGroupId || ("jobgrp-"+Date.now());
  const payloadType=editingJobGroupId?"update_appointment":"appointment";

  events=events.filter(ev=>ev.type!=="job" || (ev.jobGroupId||ev.id)!==groupId);

  services.forEach((svc,index)=>{
    const id=groupId+"-"+index+"-"+Date.now();
    events.push({
      id,
      jobGroupId:groupId,
      type:"job",
      tech:svc.tech,
      dept:svc.dept,
      serviceName:svc.serviceName,
      label:svc.serviceName||svc.dept,
      date,
      time:svc.time,
      customerName,
      phone,
      email,
      dealer,
      customerWaiting:waiting,
      rideNeeded,
      rideTime,
      pickupDelivery,
      pickupTime,
      deliveryTime,
      notes
    });
  });

  editingJobGroupId=groupId;
  currentDate=new Date(date+"T00:00");
  renderCalendar();
  if(statusEl)statusEl.textContent=payloadType==="update_appointment"
    ?"Appointment updated and sent to Zapier."
    :"Appointment created and sent to Zapier.";
  btnCreateAppointment.textContent="Update Appointment";

  try{
    await fetch(ZAPIER_WEBHOOK_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        type:payloadType,
        appointmentId:groupId,
        customerName,
        phone,
        email,
        date,
        dealer,
        customerWaiting:waiting,
        rideNeeded,
        rideTime,
        pickupDelivery,
        pickupTime,
        deliveryTime,
        notes,
        services:services
      })
    });
  }catch(e){
    console.error("Zapier error",e);
  }

  // clear form after save
  document.getElementById("appointmentForm").reset();
  clearServiceAssignments();
  ensureAtLeastOneServiceRow();
  selectedSlot=null;
  selectedEventId=null;
  editingJobGroupId=null;
  btnCreateAppointment.textContent="Save to Zapier";
}

// Delete appointment (entire group)
function deleteAppointment(){
  if(!editingJobGroupId){
    alert("Select an appointment from the calendar first.");
    return;
  }
  const groupKey=editingJobGroupId;
  events=events.filter(ev=>!(ev.type==="job" && (ev.jobGroupId||ev.id)===groupKey));
  selectedEventId=null;
  editingJobGroupId=null;
  document.getElementById("appointmentForm").reset();
  clearServiceAssignments();
  ensureAtLeastOneServiceRow();
  btnCreateAppointment.textContent="Save to Zapier";
  if(statusEl)statusEl.textContent="Appointment deleted.";
  renderCalendar();
  try{
    fetch(ZAPIER_WEBHOOK_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        type:"delete_appointment",
        appointmentId:groupKey
      })
    });
  }catch(e){
    console.error("Zapier error",e);
  }
}

// Clear appointment form manually
function clearAppointmentForm(){
  document.getElementById("appointmentForm").reset();
  clearServiceAssignments();
  ensureAtLeastOneServiceRow();
  selectedSlot=null;
  selectedEventId=null;
  editingJobGroupId=null;
  btnCreateAppointment.textContent="Save to Zapier";
  if(statusEl)statusEl.textContent="Cleared form.";
  renderCalendar();
}

// Clear time off form
function clearTimeOffForm(){
  document.getElementById("timeOffForm").reset();
}



function loadJobEventIntoForm(ev){
  setPanel("appointments");

  const groupKey=ev.jobGroupId||ev.id;
  editingJobGroupId=groupKey;
  btnCreateAppointment.textContent="Update Appointment";

  document.getElementById("inputCustomerName").value=ev.customerName||"";
  document.getElementById("inputCustomerPhone").value=ev.phone||"";
  document.getElementById("inputCustomerEmail").value=ev.email||"";
  document.getElementById("datePicker").value=ev.date||"";
  document.getElementById("checkboxDealer").checked=!!ev.dealer;
  document.getElementById("checkboxCustomerWaiting").checked=!!ev.customerWaiting;
  document.getElementById("checkboxRideNeeded").checked=!!ev.rideNeeded;
  document.getElementById("inputRideTime").value=ev.rideTime||"";
  document.getElementById("checkboxPickupDelivery").checked=!!ev.pickupDelivery;
  document.getElementById("inputPickupTime").value=ev.pickupTime||"";
  document.getElementById("inputDeliveryTime").value=ev.deliveryTime||"";
  document.getElementById("inputNotes").value=ev.notes||"";

  clearServiceAssignments();
  const groupEvents=events.filter(e=>e.type==="job" && (e.jobGroupId||e.id)===groupKey);
  if(groupEvents.length){
    groupEvents.forEach(gev=>{
      addServiceRow({
        dept:gev.dept||"",
        serviceName:gev.serviceName||"",
        tech:gev.tech||"",
        time:gev.time||""
      });
    });
  }else{
    ensureAtLeastOneServiceRow();
  }

  if(ev.date){
    currentDate=new Date(ev.date+"T00:00");
    renderCalendar();
  }
  if(statusEl)statusEl.textContent="Editing existing appointment.";
}

// Calendar clicks
bodyEl.addEventListener("click",e=>{
  const pill=e.target.closest(".event-pill");
  if(pill){
    const id=pill.dataset.eventId;
    selectedEventId=id;
    const ev=events.find(ev=>ev.id===id);
    renderEventDetails(ev);
    if(ev.type==="job"){
      loadJobEventIntoForm(ev);
    }else if(ev.type==="timeoff"){
      setPanel("timeoff");
      const tech=ev.tech||"";
      const thisDate=ev.date;
      document.getElementById("timeOffTechnician").value=tech;

      const techTimeOff=events.filter(x=>x.type==="timeoff" && x.tech===tech);
      const dateSet=Array.from(new Set(techTimeOff.map(x=>x.date))).sort();
      let startDate=thisDate;
      let endDate=thisDate;
      if(thisDate){
        const idxDate=dateSet.indexOf(thisDate);
        if(idxDate!==-1){
          let i=idxDate-1;
          while(i>=0){
            const prevDate=dateSet[i];
            const prev=new Date(prevDate+"T00:00");
            const cur=new Date(dateSet[i+1]+"T00:00");
            const diffDays=(cur-prev)/(1000*60*60*24);
            if(diffDays===1){
              startDate=prevDate;
              i--;
            }else break;
          }
          i=idxDate+1;
          while(i<dateSet.length){
            const prev=new Date(dateSet[i-1]+"T00:00");
            const cur=new Date(dateSet[i]+"T00:00");
            const diffDays=(cur-prev)/(1000*60*60*24);
            if(diffDays===1){
              endDate=dateSet[i];
              i++;
            }else break;
          }
        }
      }

      document.getElementById("timeOffStartDate").value=startDate||thisDate||"";
      document.getElementById("timeOffEndDate").value=endDate||thisDate||"";

      const sameDay=techTimeOff
        .filter(x=>x.date===thisDate)
        .sort((a,b)=>a.time.localeCompare(b.time));

      const startTimeEl2=document.getElementById("timeOffStartTime");
      const endTimeEl2=document.getElementById("timeOffEndTime");
      const allDayCheckbox2=document.getElementById("timeOffAllDay");
      let isAllDay=false;

      if(sameDay.length){
        const startTime=sameDay[0].time;
        const endTime=sameDay[sameDay.length-1].time;
        if(startTimeEl2) startTimeEl2.value=startTime;
        if(endTimeEl2) endTimeEl2.value=endTime;

        if(thisDate && tech && techSchedules[tech]){
          const dow=getDayName(new Date(thisDate+"T00:00"));
          const cfg=techSchedules[tech][dow];
          if(cfg && !cfg.off){
            const schedStartMin=timeToMinutes(cfg.start);
            const schedEndMin=timeToMinutes(cfg.end);
            const blockStartMin=timeToMinutes(startTime);
            const blockEndMin=timeToMinutes(endTime);
            if(blockStartMin===schedStartMin && blockEndMin===schedEndMin){
              isAllDay=true;
            }
          }
        }
      }else{
        if(startTimeEl2) startTimeEl2.value="";
        if(endTimeEl2) endTimeEl2.value="";
      }

      if(allDayCheckbox2){
        allDayCheckbox2.checked=isAllDay;
        const disabled=isAllDay;
        if(startTimeEl2) startTimeEl2.disabled=disabled;
        if(endTimeEl2) endTimeEl2.disabled=disabled;
      }

      document.getElementById("timeOffNotes").value=ev.notes||"";
      if(ev.date){
        currentDate=new Date(ev.date+"T00:00");
        renderCalendar();
      }
    }
    return;
  }
  const cell=e.target.closest(".cal-slot-cell");
  if(cell){
    setSelectedSlot(cell.dataset.tech,cell.dataset.time);
  }
});

dealerQueueListEl.addEventListener("click",e=>{
  const item=e.target.closest(".dealer-queue-item");
  if(!item) return;
  const id=item.dataset.eventId;
  const ev=events.find(ev=>ev.id===id);
  if(!ev) return;
  selectedEventId=id;
  renderEventDetails(ev);
  if(ev.type==="job"){
    loadJobEventIntoForm(ev);
  }
});

// Day navigation
document.getElementById("btnPrevDay").addEventListener("click",()=>{
  currentDate.setDate(currentDate.getDate()-1);
  renderCalendar();
});
document.getElementById("btnNextDay").addEventListener("click",()=>{
  currentDate.setDate(currentDate.getDate()+1);
  renderCalendar();
});

// Panel buttons
headerBtnAppointments.addEventListener("click",()=>setPanel("appointments"));
headerBtnTimeOff.addEventListener("click",()=>setPanel("timeoff"));
headerBtnSchedules.addEventListener("click",()=>setPanel("schedules"));
headerBtnServices.addEventListener("click",()=>{
  setPanel("services");
  renderServiceLibrary();
});

// Schedules panel
scheduleTechSelect.addEventListener("change",()=>{
  const tech=scheduleTechSelect.value;
  loadScheduleIntoForm(tech);
  scheduleStatus.textContent=tech?`Editing weekly schedule for ${tech}.`:"";
});
document.getElementById("btnSaveSchedules").addEventListener("click",saveScheduleFromForm);

// Time off buttons
document.getElementById("btnSaveTimeOff").addEventListener("click",saveTimeOff);
document.getElementById("btnClearTimeOff").addEventListener("click",clearTimeOffForm);
document.getElementById("btnDeleteTimeOff").addEventListener("click",deleteTimeOff);

// All-day toggle
const allDayCheckbox=document.getElementById("timeOffAllDay");
const startTimeEl=document.getElementById("timeOffStartTime");
const endTimeEl=document.getElementById("timeOffEndTime");
if(allDayCheckbox){
  allDayCheckbox.addEventListener("change",()=>{
    const disabled=allDayCheckbox.checked;
    if(startTimeEl) startTimeEl.disabled=disabled;
    if(endTimeEl) endTimeEl.disabled=disabled;
  });
}

// Appointment buttons
btnCreateAppointment.addEventListener("click",createOrUpdateAppointment);
document.getElementById("btnClear").addEventListener("click",clearAppointmentForm);
btnDeleteAppointment.addEventListener("click",deleteAppointment);

// Add service row button
btnAddServiceRow.addEventListener("click",()=>addServiceRow());

// Custom Date Picker
function buildDatePickerGrid(){
  dpGrid.innerHTML="";
  const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];
  dpMonthLabel.textContent=monthNames[dpMonth]+" "+dpYear;
  const dayNames=["Su","Mo","Tu","We","Th","Fr","Sa"];
  dayNames.forEach(d=>{
    const cell=document.createElement("div");
    cell.className="date-picker-cell day-name";
    cell.textContent=d;
    dpGrid.appendChild(cell);
  });
  const firstDay=new Date(dpYear,dpMonth,1);
  const startDow=firstDay.getDay();
  const daysInMonth=new Date(dpYear,dpMonth+1,0).getDate();
  for(let i=0;i<startDow;i++){
    const cell=document.createElement("div");
    cell.className="date-picker-cell disabled";
    cell.textContent="";
    dpGrid.appendChild(cell);
  }
  const today=new Date();
  const todayIso=toISODate(today);
  const currentValue=dpActiveInput?parseISODate(dpActiveInput.value):null;
  const currentValueIso=currentValue?toISODate(currentValue):null;
  for(let day=1;day<=daysInMonth;day++){
    const cell=document.createElement("div");
    cell.className="date-picker-cell day";
    cell.textContent=day;
    const cellDate=new Date(dpYear,dpMonth,day);
    const iso=toISODate(cellDate);
    if(iso===todayIso) cell.classList.add("today");
    if(iso===currentValueIso) cell.classList.add("selected");
    cell.addEventListener("click",()=>{
      if(!dpActiveInput) return;
      dpActiveInput.value=iso;
      if(dpActiveInput.id==="dayPicker" || dpActiveInput.id==="datePicker"){
        currentDate=cellDate;
        renderCalendar();
      }
      hideDatePicker();
    });
    dpGrid.appendChild(cell);
  }
}
function showDatePickerForInput(input){
  dpActiveInput=input;
  const existing=parseISODate(input.value)||currentDate;
  dpYear=existing.getFullYear();
  dpMonth=existing.getMonth();
  buildDatePickerGrid();
  const rect=input.getBoundingClientRect();
  const scrollY=window.scrollY||window.pageYOffset;
  const scrollX=window.scrollX||window.pageXOffset;
  dpPopup.style.top=(rect.bottom+scrollY+4)+"px";
  dpPopup.style.left=(rect.left+scrollX)+"px";
  dpPopup.style.display="block";
}
function hideDatePicker(){
  dpPopup.style.display="none";
  dpActiveInput=null;
}
document.querySelectorAll(".date-input").forEach(inp=>{
  inp.addEventListener("click",e=>{
    e.stopPropagation();
    showDatePickerForInput(inp);
  });
});
dpPrevMonth.addEventListener("click",e=>{
  e.stopPropagation();
  dpMonth--;
  if(dpMonth<0){dpMonth=11;dpYear--;}
  buildDatePickerGrid();
});
dpNextMonth.addEventListener("click",e=>{
  e.stopPropagation();
  dpMonth++;
  if(dpMonth>11){dpMonth=0;dpYear++;}
  buildDatePickerGrid();
});
document.addEventListener("click",e=>{
  if(dpPopup.style.display==="none") return;
  if(dpPopup.contains(e.target)) return;
  if(dpActiveInput && dpActiveInput.contains(e.target)) return;
  hideDatePicker();
});

// Init
// Init
initTimeDropdowns();
attachOffCheckboxHandlers();
loadSchedulesFromStorage();
loadServicePackagesFromStorage();
renderDeptChips();              // <-- NEW
seedDummyEvents();
ensureAtLeastOneServiceRow();
refreshAllServiceAssignmentRows();
renderCalendar();

</script>
</body>
</html>

                                                                              
