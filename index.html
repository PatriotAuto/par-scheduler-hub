<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Patriot Auto Restyling – Scheduler Hub v1.3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --par-navy:#050b18;--par-navy-soft:#0b1f33;--par-red:#e30613;--par-light:#f5f7fb;
      --par-border:#2b3950;--par-text:#fdfdfd;--par-muted:#9ca7c0;
      --dept-tint:#e53935;--dept-ppf:#2962ff;--dept-ceramic:#00c853;--dept-detail:#ffb300;--dept-electronics:#ab47bc;--timeoff:#8d8d8d;
      --grid-bg:#f2f4fb;--grid-header-bg:#e3e7f1;--grid-border-strong:rgba(0,0,0,.25);--grid-border-light:rgba(0,0,0,.15);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystem,"Segoe UI",sans-serif;}
    body{margin:0;background:radial-gradient(circle at top,#101b2e,#02040a);color:var(--par-text);}
    .page{min-height:100vh;display:flex;flex-direction:column;}
    header{padding:16px 24px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;gap:16px;background:linear-gradient(90deg,#050b18,#0a1727);}
    header .title{display:flex;flex-direction:column;gap:2px;}
    header .title h1{margin:0;font-size:20px;letter-spacing:.08em;text-transform:uppercase;}
    header .title span{font-size:12px;color:var(--par-muted);}
    .header-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .header-btn{border-radius:999px;border:1px solid rgba(255,255,255,.25);background:rgba(227,6,19,.12);color:#fff;padding:6px 12px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;cursor:pointer;}
    .header-btn.active{background:rgba(227,6,19,.3);}
    .header-btn:hover{background:rgba(227,6,19,.25);}
    .main{flex:1;display:flex;min-height:0;}
    .left{flex:1.4;border-right:1px solid rgba(255,255,255,.08);background:#e6e9f3;padding:14px;display:flex;flex-direction:column;gap:10px;min-width:0;}
    .right{flex:1;background:radial-gradient(circle at top right,#121b2d,#050915);padding:16px;min-width:0;display:flex;flex-direction:column;gap:10px;}
    .left-top-row{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;}
    .chips{display:flex;flex-wrap:wrap;gap:6px;}
    .chip{border-radius:999px;padding:4px 10px;font-size:11px;border:1px solid rgba(0,0,0,.1);background:rgba(255,255,255,.9);color:#374151;display:inline-flex;align-items:center;gap:6px;cursor:pointer;}
    .chip.active{border-color:var(--par-red);background:rgba(227,6,19,.08);color:#111827;}
    .chip .dot{width:8px;height:8px;border-radius:50%;}
    .dot-detail{background:var(--dept-detail);} .dot-tint{background:var(--dept-tint);} .dot-ppf{background:var(--dept-ppf);}
    .dot-ceramic{background:var(--dept-ceramic);} .dot-electronics{background:var(--dept-electronics);} .dot-timeoff{background:var(--timeoff);}
    .date-controls{display:flex;flex-direction:column;align-items:flex-end;gap:4px;font-size:12px;color:#4b5563;}
    .date-row{display:flex;align-items:center;gap:6px;}
    .nav-btn{border-radius:999px;border:1px solid rgba(0,0,0,.2);background:#fff;color:#111827;padding:4px 8px;font-size:11px;cursor:pointer;}
    .nav-btn:hover{background:#f3f4f6;}
    .date-label{font-size:12px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:#111827;}
    #dayPicker{border-radius:999px;border:1px solid rgba(0,0,0,.2);background:#fff;color:#111827;font-size:11px;padding:4px 8px;cursor:pointer;}
    .cal-wrapper{flex:1;border-radius:12px;background:var(--grid-bg);border:3px solid var(--grid-border-strong);display:flex;flex-direction:column;overflow:hidden;min-height:260px;box-shadow:0 12px 24px rgba(15,23,42,.25);}
    .cal-header-row{display:grid;grid-template-columns:60px repeat(6,1fr);font-size:11px;padding:4px 4px 6px;border-bottom:3px solid var(--grid-border-strong);background:var(--grid-header-bg);}
    .cal-header-cell{text-align:center;font-weight:600;color:#111827;}
    .cal-body{flex:1;overflow:auto;position:relative;}
    .cal-row{display:grid;grid-template-columns:60px repeat(6,1fr);border-bottom:2px solid var(--grid-border-light);font-size:11px;background:linear-gradient(to right,rgba(255,255,255,.9),rgba(255,255,255,.9));height:32px;}
    .cal-row:nth-child(2n){background:linear-gradient(to right,rgba(249,250,251,.95),rgba(249,250,251,.95));}
    .cal-time-cell{padding:2px 4px;text-align:right;color:#4b5563;font-weight:500;background:#e5e7eb;border-right:2px solid var(--grid-border-strong);}
    .cal-slot-cell{border-left:2px solid var(--grid-border-light);position:relative;cursor:pointer;background:transparent;transition:background .12s,box-shadow .12s,transform .05s;overflow:hidden;}
    .cal-slot-cell:hover{background:rgba(227,6,19,.06);box-shadow:inset 0 0 0 1px rgba(227,6,19,.35);}
    .cal-slot-cell.selected{background:rgba(227,6,19,.1);box-shadow:inset 0 0 0 2px rgba(227,6,19,.8);transform:translateY(-1px);}
    .cal-slot-cell.off-shift{background:repeating-linear-gradient(45deg,rgba(15,23,42,.02),rgba(15,23,42,.02) 4px,rgba(15,23,42,.07) 4px,rgba(15,23,42,.07) 8px);}
    .cal-slot-cell.blocked-slot{background:linear-gradient(to right, rgba(227,6,19,0.08), rgba(227,6,19,0.14));}
    .cal-slot-inner{padding:1px 4px;height:100%;display:flex;align-items:center;gap:2px;overflow:hidden;}
    .blocked-preview{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:10px;background:rgba(255,255,255,.9);color:#111827;font-size:10px;box-shadow:0 1px 2px rgba(15,23,42,.18);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .blocked-preview .blocked-text{max-width:140px;overflow:hidden;text-overflow:ellipsis;}
    .cal-slot-cell.timeoff-block{
      background:linear-gradient(to right, rgba(141,141,141,0.25), rgba(141,141,141,0.35));
    }
    .cal-slot-cell:hover{background:rgba(227,6,19,.06);box-shadow:inset 0 0 0 1px rgba(227,6,19,.35);}
    .cal-slot-cell.selected{background:rgba(227,6,19,.1);box-shadow:inset 0 0 0 2px rgba(227,6,19,.8);transform:translateY(-1px);}
    .cal-slot-cell.off-shift{background:repeating-linear-gradient(45deg,rgba(15,23,42,.02),rgba(15,23,42,.02) 4px,rgba(15,23,42,.07) 4px,rgba(15,23,42,.07) 8px);}
    .cal-slot-cell.blocked-slot{background:linear-gradient(to right, rgba(227,6,19,0.08), rgba(227,6,19,0.14));}
    .cal-slot-inner{padding:1px 4px;height:100%;display:flex;align-items:center;gap:2px;overflow:hidden;}
    .blocked-preview{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:10px;background:rgba(255,255,255,.9);color:#111827;font-size:10px;box-shadow:0 1px 2px rgba(15,23,42,.18);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .blocked-preview .blocked-text{max-width:140px;overflow:hidden;text-overflow:ellipsis;}
    .cal-slot-cell.timeoff-block{
      background:linear-gradient(to right, rgba(141,141,141,0.25), rgba(141,141,141,0.35));
    }
        .cal-slot-cell.shop-closed{
      background:repeating-linear-gradient(
        45deg,
        rgba(220,38,38,0.06),
        rgba(220,38,38,0.06) 4px,
        rgba(220,38,38,0.16) 4px,
        rgba(220,38,38,0.16) 8px
      );
    }

    .event-pill{border-radius:999px;padding:1px 6px;font-size:10px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;box-shadow:0 1px 2px rgba(15,23,42,.25);display:inline-flex;align-items:center;gap:3px;}
    .event-detailing{background:var(--dept-detail);}
    .event-tint{background:var(--dept-tint);color:#fff;}
    .event-ppf{background:var(--dept-ppf);color:#fff;}
    .event-ceramic{background:var(--dept-ceramic);}
    .event-electronics{background:var(--dept-electronics);color:#fff;}
    .event-timeoff{background:var(--timeoff);color:#fff;}
    .event-bubble{position:absolute;border-radius:12px;padding:8px 10px;font-size:11px;font-weight:600;box-shadow:0 6px 16px rgba(15,23,42,.25);display:flex;flex-direction:column;gap:6px;cursor:pointer;transition:transform .05s,box-shadow .08s;line-height:1.2;border:1px solid rgba(0,0,0,.15);z-index:10;}
    .event-bubble:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(15,23,42,.32);}
    .event-bubble .bubble-top{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
    .event-bubble .bubble-title{font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .event-bubble .bubble-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:10px;}
    .event-bubble .bubble-row{display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:10px;font-weight:500;}
    .event-status-icon{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;font-size:10px;font-weight:700;color:#111827;background:#fef3c7;}
    .event-status-icon.scheduled{background:#fef3c7;color:#92400e;}
    .event-status-icon.checkin{background:#dbeafe;color:#1e3a8a;}
    .event-status-icon.completed{background:#dcfce7;color:#166534;}
    .event-status-icon.cancelled{background:#fee2e2;color:#991b1b;}
    .event-status-icon.noshow{background:#ede9fe;color:#4c1d95;}
    .service-progress-icon{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:6px;font-size:10px;font-weight:800;border:1px solid rgba(0,0,0,.12);background:#fff;color:#111827;}
    .service-progress-icon.queue{background:#fff7ed;color:#b45309;}
    .service-progress-icon.started{background:#e0f2fe;color:#075985;}
    .service-progress-icon.done{background:#dcfce7;color:#166534;}
    .invoice-icon{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;font-size:11px;font-weight:800;}
    .invoice-icon.pending{background:#fef3c7;color:#b45309;}
    .invoice-icon.paid{background:#dcfce7;color:#15803d;}
    .status-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:10px;border:1px solid rgba(0,0,0,.1);background:#fff;color:#111827;}
    .status-summary{display:flex;align-items:center;gap:6px;flex-wrap:wrap;min-height:24px;}
    .status-summary-note{font-size:10px;color:#6b7280;}
    .small-badge{font-size:9px;padding:0 4px;border-radius:999px;background:rgba(0,0,0,.2);color:#f9fafb;text-transform:uppercase;}
    .cal-legend{margin:6px 8px 4px;display:flex;flex-wrap:wrap;gap:8px;font-size:10px;color:#4b5563;}
    .legend-item{display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,.8);border-radius:999px;padding:2px 8px;border:1px solid rgba(0,0,0,.06);}
    .event-pill{border-radius:999px;padding:1px 6px;font-size:10px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;box-shadow:0 1px 2px rgba(15,23,42,.25);display:inline-flex;align-items:center;gap:3px;}
    .event-detailing{background:var(--dept-detail);}
    .event-tint{background:var(--dept-tint);color:#fff;}
    .event-ppf{background:var(--dept-ppf);color:#fff;}
    .event-ceramic{background:var(--dept-ceramic);}
    .event-electronics{background:var(--dept-electronics);color:#fff;}
    .event-timeoff{background:var(--timeoff);color:#fff;}
    .event-status-icon{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;font-size:10px;font-weight:700;color:#111827;background:#fef3c7;}
    .event-status-icon.scheduled{background:#fef3c7;color:#92400e;}
    .event-status-icon.checkin{background:#dbeafe;color:#1e3a8a;}
    .event-status-icon.completed{background:#dcfce7;color:#166534;}
    .event-status-icon.cancelled{background:#fee2e2;color:#991b1b;}
    .event-status-icon.noshow{background:#ede9fe;color:#4c1d95;}
    .service-progress-icon{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:6px;font-size:10px;font-weight:800;border:1px solid rgba(0,0,0,.12);background:#fff;color:#111827;}
    .service-progress-icon.queue{background:#fff7ed;color:#b45309;}
    .service-progress-icon.started{background:#e0f2fe;color:#075985;}
    .service-progress-icon.done{background:#dcfce7;color:#166534;}
    .invoice-icon{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;font-size:11px;font-weight:800;}
    .invoice-icon.pending{background:#fef3c7;color:#b45309;}
    .invoice-icon.paid{background:#dcfce7;color:#15803d;}
    .status-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:10px;border:1px solid rgba(0,0,0,.1);background:#fff;color:#111827;}
    .status-summary{display:flex;align-items:center;gap:6px;flex-wrap:wrap;min-height:24px;}
    .status-summary-note{font-size:10px;color:#6b7280;}
    .small-badge{font-size:9px;padding:0 4px;border-radius:999px;background:rgba(0,0,0,.2);color:#f9fafb;text-transform:uppercase;}
    .cal-legend{margin:6px 8px 4px;display:flex;flex-wrap:wrap;gap:8px;font-size:10px;color:#4b5563;}
    .legend-item{display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,.8);border-radius:999px;padding:2px 8px;border:1px solid rgba(0,0,0,.06);}
    .bottom-info-row{display:flex;gap:10px;padding:6px 8px 8px;border-top:1px solid rgba(0,0,0,.12);background:#e5e7f3;}
    .dealer-queue,.event-details{
      flex:1;
      background:#f9fafb;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.1);
      padding:6px 8px;
      font-size:11px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .dealer-queue{color:#000;}
    .dealer-queue-title,.event-details-title{font-weight:700;text-transform:uppercase;letter-spacing:.08em;font-size:10px;color:#111827;}
    .dealer-queue-empty,.event-details-empty{font-size:10px;color:#6b7280;font-style:italic;}
    .dealer-queue-item{padding:4px 6px;border-radius:6px;background:#eef2ff;border:1px solid rgba(79,70,229,.3);display:flex;justify-content:space-between;align-items:center;gap:6px;}
    .dq-badge{
      padding:1px 5px;
      border-radius:999px;
      background:#e5e7eb;
      color:#000;
      font-size:9px;
      text-transform:uppercase;
    }
    .event-details-row{display:flex;justify-content:space-between;gap:6px;}
    .event-details-label{font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:#6b7280;}
    .event-details-value{font-size:11px;color:#111827;font-weight:500;}
    .panel-title{font-size:13px;text-transform:uppercase;letter-spacing:.14em;color:var(--par-muted);}
    .panel-divider{height:1px;background:linear-gradient(90deg,rgba(255,255,255,.06),rgba(227,6,19,.6),rgba(255,255,255,.06));margin:4px 0 8px;}
    form{display:flex;flex-direction:column;gap:10px;flex:1;overflow-y:auto;padding-right:4px;}
    label{font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:var(--par-muted);}
    input,select,textarea{width:100%;border-radius:8px;border:1px solid var(--par-border);background:rgba(10,18,38,.95);color:var(--par-text);font-size:13px;padding:8px 10px;outline:none;}
    input:focus,select:focus,textarea:focus{border-color:var(--par-red);box-shadow:0 0 0 1px rgba(227,6,19,.3);}
    input.date-input{cursor:pointer;}
    textarea{min-height:60px;resize:vertical;}
    .field-group{display:flex;flex-direction:column;gap:6px;}
    .field-row{display:flex;gap:8px;}
    .service-row{align-items:flex-end;flex-wrap:wrap;}
    .field-row .field-group{flex:1;}
    .inline-checkbox{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--par-muted);}
    .inline-checkbox input[type=checkbox]{width:auto;}
    .status{font-size:11px;min-height:16px;color:var(--par-muted);}
    .actions{display:flex;gap:10px;margin-top:6px;flex-wrap:wrap;}
    .btn{border-radius:8px;padding:10px 14px;border:none;cursor:pointer;font-weight:600;text-transform:uppercase;letter-spacing:.06em;}
    .btn-primary{background:var(--par-red);color:#fff;flex:1;}
    .btn-clear{background:#263040;color:var(--par-muted);}
    .btn-danger{background:#7f1d1d;color:#fee2e2;}
    .btn-danger:hover{background:#991b1b;}
    .timeoff-note{font-size:11px;color:var(--par-muted);}
    .weekly-card{margin-top:8px;border-radius:10px;border:1px solid rgba(255,255,255,.12);padding:8px 10px;background:rgba(3,10,25,.9);display:flex;flex-direction:column;gap:6px;}
    .week-row{display:grid;grid-template-columns:90px 1fr 1fr 90px;gap:8px;align-items:center;font-size:12px;}
    .week-row-label{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--par-muted);}
    .week-row select{background:rgba(10,18,38,.95);border-radius:6px;border:1px solid var(--par-border);color:var(--par-text);font-size:12px;padding:4px 6px;}
    .week-row-off{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--par-muted);}
    @media(max-width:1000px){
      .main{flex-direction:column;}
      .left{border-right:none;border-bottom:1px solid rgba(255,255,255,.08);}
    }
    @media(max-width:768px){
      header{
        padding:12px 14px;
        flex-direction:column;
        align-items:flex-start;
        gap:8px;
      }
      .header-actions{
        width:100%;
        justify-content:flex-start;
        flex-wrap:wrap;
      }
      .left,.right{
        padding:10px;
      }
      .chips{
        width:100%;
      }
      .cal-wrapper{
        min-height:220px;
        overflow-x:auto;
      }
      .cal-header-row,
      .cal-row{
        min-width:650px;
        height:32px;
      }
      .bottom-info-row{
        flex-direction:column;
      }
      .dealer-queue,.event-details{
        width:100%;
      }
      .btn{
        padding:9px 10px;
        font-size:11px;
      }
      input,select,textarea{
        font-size:12px;
        padding:7px 9px;
      }
    }

    /* Appointment pop-up */
    .popup-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.65);z-index:1500;padding:12px;}
    .popup-card{background:#0b1324;border:1px solid rgba(255,255,255,.12);border-radius:12px;max-width:520px;width:100%;box-shadow:0 18px 40px rgba(0,0,0,.45);color:#f9fafb;display:flex;flex-direction:column;}
    .popup-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08);}
    .popup-title{display:flex;flex-direction:column;gap:4px;}
    .popup-title h3{margin:0;font-size:16px;letter-spacing:.08em;text-transform:uppercase;}
    .popup-title span{font-size:12px;color:var(--par-muted);}
    .popup-actions{display:flex;align-items:center;gap:8px;}
    .icon-button{border:none;background:rgba(255,255,255,.08);color:#f9fafb;border-radius:8px;padding:6px 10px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;font-weight:600;letter-spacing:.04em;}
    .icon-button:hover{background:rgba(227,6,19,.22);}
    .popup-body{padding:12px 14px;display:flex;flex-direction:column;gap:10px;}
    .popup-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .popup-badge{padding:4px 8px;border-radius:8px;background:rgba(255,255,255,.08);font-size:11px;display:inline-flex;align-items:center;gap:6px;}
    .popup-list{border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:10px;background:rgba(5,11,24,.6);display:flex;flex-direction:column;gap:6px;}
    .popup-list-item{display:flex;justify-content:space-between;gap:10px;align-items:center;font-size:12px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,.04);}
    .popup-list-item select{min-width:130px;}
    .popup-close{border:none;background:none;color:var(--par-muted);font-size:18px;cursor:pointer;}

    /* Custom date picker */
    }

    /* Appointment pop-up */
    .popup-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.65);z-index:1500;padding:12px;}
    .popup-card{background:#0b1324;border:1px solid rgba(255,255,255,.12);border-radius:12px;max-width:520px;width:100%;box-shadow:0 18px 40px rgba(0,0,0,.45);color:#f9fafb;display:flex;flex-direction:column;}
    .popup-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08);}
    .popup-title{display:flex;flex-direction:column;gap:4px;}
    .popup-title h3{margin:0;font-size:16px;letter-spacing:.08em;text-transform:uppercase;}
    .popup-title span{font-size:12px;color:var(--par-muted);}
    .popup-actions{display:flex;align-items:center;gap:8px;}
    .icon-button{border:none;background:rgba(255,255,255,.08);color:#f9fafb;border-radius:8px;padding:6px 10px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;font-weight:600;letter-spacing:.04em;}
    .icon-button:hover{background:rgba(227,6,19,.22);}
    .popup-body{padding:12px 14px;display:flex;flex-direction:column;gap:10px;}
    .popup-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .popup-badge{padding:4px 8px;border-radius:8px;background:rgba(255,255,255,.08);font-size:11px;display:inline-flex;align-items:center;gap:6px;}
    .popup-list{border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:10px;background:rgba(5,11,24,.6);display:flex;flex-direction:column;gap:6px;}
    .popup-list-item{display:flex;justify-content:space-between;gap:10px;align-items:center;font-size:12px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,.04);}
    .popup-list-item select{min-width:130px;}
    .popup-close{border:none;background:none;color:var(--par-muted);font-size:18px;cursor:pointer;}

    /* Custom date picker */
    .date-picker-popup{
      position:absolute;
      z-index:1000;
      width:230px;
      background:#111827;
      color:#f9fafb;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.15);
      box-shadow:0 12px 25px rgba(15,23,42,.6);
      padding:8px;
      font-size:12px;
      display:none;
    }
    .date-picker-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
    }
    .date-picker-header button{
      border:none;
      background:rgba(15,23,42,.8);
      color:#e5e7eb;
      border-radius:999px;
      padding:2px 6px;
      cursor:pointer;
      font-size:11px;
    }
    .date-picker-month{
      font-weight:600;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-size:11px;
    }
    .date-picker-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:2px;
    }
    .date-picker-cell{
      text-align:center;
      padding:4px 0;
      border-radius:6px;
      cursor:pointer;
    }
    .date-picker-cell.disabled{
      color:#6b7280;
      cursor:default;
    }
    .date-picker-cell.day-name{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#9ca3af;
      cursor:default;
    }
    .date-picker-cell.day{
      background:rgba(15,23,42,.9);
    }
    .date-picker-cell.day:hover{
      background:rgba(227,6,19,.6);
    }
    .date-picker-cell.selected{
      background:var(--par-red);
      font-weight:700;
    }
    .date-picker-cell.today{
      border:1px solid var(--par-red);
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <div class="title">
      <h1>PATRIOT AUTO RESTYLING</h1>
      <span>Internal Scheduler Hub · Daily Tech View</span>
    </div>
    <div class="header-actions">
      <button id="btnAppointmentsPanel" class="header-btn active">Appointments</button>
      <button id="btnTimeOffPanel" class="header-btn">Tech Time Off</button>
      <button id="btnSchedulesPanel" class="header-btn">Tech Schedules</button>
      <button id="btnServicesPanel" class="header-btn">Services</button>
    </div>
  </header>

  <div class="main">
    <div class="left">
      <div class="left-top-row">
        <div class="chips" id="chipsContainer"></div>
        
        <div class="date-controls">
          <div class="date-row">
            <button class="nav-btn" id="btnPrevDay">◀</button>
            <span class="date-label" id="dayLabel">Today</span>
            <button class="nav-btn" id="btnNextDay">▶</button>
          </div>
          <div class="date-row">
            <span style="font-size:10px;">Jump to date:</span>
            <input type="text" id="dayPicker" class="date-input" placeholder="YYYY-MM-DD" readonly />
          </div>
        </div>
      </div>

      <div class="cal-wrapper">
        <div class="cal-header-row" id="calHeaderRow"></div>
        <div class="cal-body" id="calBody"></div>
        <div class="cal-legend">
          <span class="legend-item"><span class="dot dot-detail"></span>Detailing</span>
          <span class="legend-item"><span class="dot dot-tint"></span>Tint</span>
          <span class="legend-item"><span class="dot dot-ppf"></span>PPF</span>
          <span class="legend-item"><span class="dot dot-ceramic"></span>Ceramic</span>
          <span class="legend-item"><span class="dot dot-electronics"></span>Electronics</span>
          <span class="legend-item"><span class="dot dot-timeoff"></span>Tech Time Off</span>
        </div>
        <div class="bottom-info-row">
          <div class="dealer-queue">
            <div class="dealer-queue-title">Dealer Queue (Today)</div>
            <div id="dealerQueueList" class="dealer-queue-empty">No dealer jobs queued for this day.</div>
          </div>
          <div class="event-details">
            <div class="event-details-title">Appointment Details</div>
            <div id="eventDetails" class="event-details-empty">Click an appointment pill to view details. Click again to edit.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="right">
      <!-- Appointments -->
      <div id="appointmentPanel">
        <div class="panel-title">Create / Edit Appointment</div>
        <div class="panel-divider"></div>
        <form id="appointmentForm" onsubmit="return false;">
          <div class="field-row">
            <div class="field-group">
              <label>Customer / Dealer Name</label>
              <input id="inputCustomerName" placeholder="Search or enter name" />
            </div>
            <div class="field-group">
              <label>&nbsp;</label>
              <div class="inline-checkbox">
                <input type="checkbox" id="checkboxDealer" />
                <span>Dealer Job (Dealer Queue)</span>
              </div>
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Phone</label>
              <input id="inputCustomerPhone" placeholder="(555) 123-4567" />
            </div>
            <div class="field-group">
              <label>Email</label>
              <input type="email" id="inputCustomerEmail" placeholder="email@example.com" />
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Appointment Date</label>
              <input type="text" id="datePicker" class="date-input" placeholder="YYYY-MM-DD" readonly />
            </div>
            <div class="field-group">
              <label>&nbsp;</label>
              <div class="inline-checkbox">
                <input type="checkbox" id="checkboxCustomerWaiting" />
                <span>Customer Waiting</span>
              </div>
            </div>
          </div>

          <div class="field-group">
            <label>Service & Technician Assignments</label>
            <div id="serviceAssignments"></div>
            <button type="button" class="btn btn-clear" id="btnAddServiceRow" style="margin-top:6px;">+ Add Service</button>
          </div>

          <div class="field-row">
            <div class="field-group">
              <label>Ride / Pickup Options</label>
              <div class="inline-checkbox">
                <input type="checkbox" id="checkboxRideNeeded" />
                <span>Ride Needed</span>
              </div>
              <div class="field-group">
                <label style="font-size:10px;text-transform:none;letter-spacing:0;">Ride Time</label>
                <select id="inputRideTime"></select>
              </div>
              <div class="inline-checkbox">
                <input type="checkbox" id="checkboxPickupDelivery" />
                <span>Pickup / Delivery</span>
              </div>
            </div>
            <div class="field-group">
              <label>Pickup / Delivery Times</label>
              <div class="field-group">
                <label style="font-size:10px;text-transform:none;letter-spacing:0;">Pickup Time</label>
                <select id="inputPickupTime"></select>
              </div>
              <div class="field-group">
                <label style="font-size:10px;text-transform:none;letter-spacing:0;">Delivery Time</label>
                <select id="inputDeliveryTime"></select>
              </div>
            </div>
          </div>
<div class="field-group">
  <label>Notes</label>
  <textarea id="inputNotes" placeholder="Deposit paid? Keys in drop box?"></textarea>
</div>

<div class="field-group">
  <label>Status &amp; Billing</label>
  <div id="statusSummary" class="status-summary"></div>
  <div class="timeoff-note">Update status or billing from the appointment pop-up.</div>
  <select id="inputStatus" style="display:none;" disabled>
    <option value="Scheduled">Scheduled</option>
    <option value="Check In">Check In</option>
    <option value="Cancelled">Cancelled</option>
    <option value="No Show">No Show</option>
    <option value="Completed">Completed</option>
  </select>
  <div style="display:none;">
    <input type="checkbox" id="checkboxInvoiced" />
    <input type="checkbox" id="checkboxPaid" />
  </div>
</div>

<div class="inline-checkbox" style="margin-top:4px;">
  <input type="checkbox" id="checkboxOverrideClosed" />
  <span>Override shop hours & holidays for this booking</span>
</div>
<div class="field-group">
  <label>Notes</label>
  <textarea id="inputNotes" placeholder="Deposit paid? Keys in drop box?"></textarea>
</div>

<div class="field-group">
  <label>Status &amp; Billing</label>
  <div id="statusSummary" class="status-summary"></div>
  <div class="timeoff-note">Update status or billing from the appointment pop-up.</div>
  <select id="inputStatus" style="display:none;" disabled>
    <option value="Scheduled">Scheduled</option>
    <option value="Check In">Check In</option>
    <option value="Cancelled">Cancelled</option>
    <option value="No Show">No Show</option>
    <option value="Completed">Completed</option>
  </select>
  <div style="display:none;">
    <input type="checkbox" id="checkboxInvoiced" />
    <input type="checkbox" id="checkboxPaid" />
  </div>
</div>

<div class="inline-checkbox" style="margin-top:4px;">
  <input type="checkbox" id="checkboxOverrideClosed" />
  <span>Override shop hours & holidays for this booking</span>
</div>

<div class="status" id="statusText">Click a tech/time slot on the left or pick a date here to start. Click an existing pill to edit.</div>

          <div class="actions">
            <button type="button" class="btn btn-clear" id="btnClear">Clear</button>
            <button type="button" class="btn btn-danger" id="btnDeleteAppointment">Delete</button>
            <button type="button" class="btn btn-primary" id="btnCreateAppointment">Save to Zapier</button>
          </div>
        </form>
      </div>

      <!-- Time off -->
      <div id="timeOffPanel" style="display:none;">
        <div class="panel-title">Tech Time Off</div>
        <div class="panel-divider"></div>
        <form id="timeOffForm" onsubmit="return false;">
          <div class="field-row">
            <div class="field-group">
              <label>Technician</label>
              <select id="timeOffTechnician">
                <option value="">Select tech</option>
                <option>William</option><option>Limage</option><option>Kaiden</option><option>Luke</option><option>Fafa</option><option>Matt</option>
              </select>
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Start Date</label>
              <input type="text" id="timeOffStartDate" class="date-input" placeholder="YYYY-MM-DD" readonly />
            </div>
            <div class="field-group">
              <label>End Date</label>
              <input type="text" id="timeOffEndDate" class="date-input" placeholder="YYYY-MM-DD" readonly />
            </div>
          </div>

          <div class="field-row">
            <div class="field-group">
              <label>&nbsp;</label>
              <div class="inline-checkbox">
                <input type="checkbox" id="timeOffAllDay" />
                <span>All day (block full working hours for each date)</span>
              </div>
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Start Time</label>
              <select id="timeOffStartTime"></select>
            </div>
            <div class="field-group">
              <label>End Time</label>
              <select id="timeOffEndTime"></select>
            </div>
          </div>
          <div class="field-group">
            <label>Notes</label>
            <textarea id="timeOffNotes" placeholder="Reason for time off (optional)"></textarea>
          </div>
          <div class="timeoff-note">Leave Start/End Time empty to block the full working day for the date range.</div>
          <div class="actions">
            <button type="button" class="btn btn-clear" id="btnClearTimeOff">Clear</button>
            <button type="button" class="btn btn-danger" id="btnDeleteTimeOff">Delete Time Off</button>
            <button type="button" class="btn btn-primary" id="btnSaveTimeOff">Save Time Off</button>
          </div>
        </form>
      </div>

      <!-- Tech schedules -->
      <div id="schedulesPanel" style="display:none;">
        <div class="panel-title">Tech Schedules</div>
        <div class="panel-divider"></div>
        <form id="schedulesForm" onsubmit="return false;">
          <div class="field-group">
            <label>Select Technician</label>
            <select id="scheduleTechSelect">
              <option value="">Choose tech</option>
              <option>William</option><option>Limage</option><option>Kaiden</option><option>Luke</option><option>Fafa</option><option>Matt</option>
            </select>
          </div>
          <div class="weekly-card">
            <div class="week-row">
              <div class="week-row-label">Monday</div>
              <select id="sched_Monday_start"></select>
              <select id="sched_Monday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Monday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Tuesday</div>
              <select id="sched_Tuesday_start"></select>
              <select id="sched_Tuesday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Tuesday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Wednesday</div>
              <select id="sched_Wednesday_start"></select>
              <select id="sched_Wednesday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Wednesday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Thursday</div>
              <select id="sched_Thursday_start"></select>
              <select id="sched_Thursday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Thursday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Friday</div>
              <select id="sched_Friday_start"></select>
              <select id="sched_Friday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Friday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Saturday</div>
              <select id="sched_Saturday_start"></select>
              <select id="sched_Saturday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Saturday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Sunday</div>
              <select id="sched_Sunday_start"></select>
              <select id="sched_Sunday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Sunday_off" /><span>Off?</span></div>
            </div>
          </div>
          <div class="timeoff-note">These hours control which parts of the grid show as off-shift for each tech, per weekday. (Saved in this browser.)</div>
          <div class="actions">
            <button type="button" class="btn btn-primary" id="btnSaveSchedules">Save Tech Schedule</button>
          </div>
                    <!-- ⬇️ BEGIN SHOP HOURS & HOLIDAYS BLOCK ⬇️ -->
          <div class="panel-divider" style="margin-top:12px;"></div>
          <div class="panel-title" style="font-size:11px;">Shop Hours</div>

          <div class="weekly-card" id="officeHoursCard">
            <div class="week-row">
              <div class="week-row-label">Monday</div>
              <select id="office_Monday_open"></select>
              <select id="office_Monday_close"></select>
              <div class="week-row-off"><input type="checkbox" id="office_Monday_closed" /><span>Closed?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Tuesday</div>
              <select id="office_Tuesday_open"></select>
              <select id="office_Tuesday_close"></select>
              <div class="week-row-off"><input type="checkbox" id="office_Tuesday_closed" /><span>Closed?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Wednesday</div>
              <select id="office_Wednesday_open"></select>
              <select id="office_Wednesday_close"></select>
              <div class="week-row-off"><input type="checkbox" id="office_Wednesday_closed" /><span>Closed?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Thursday</div>
              <select id="office_Thursday_open"></select>
              <select id="office_Thursday_close"></select>
              <div class="week-row-off"><input type="checkbox" id="office_Thursday_closed" /><span>Closed?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Friday</div>
              <select id="office_Friday_open"></select>
              <select id="office_Friday_close"></select>
              <div class="week-row-off"><input type="checkbox" id="office_Friday_closed" /><span>Closed?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Saturday</div>
              <select id="office_Saturday_open"></select>
              <select id="office_Saturday_close"></select>
              <div class="week-row-off"><input type="checkbox" id="office_Saturday_closed" /><span>Closed?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Sunday</div>
              <select id="office_Sunday_open"></select>
              <select id="office_Sunday_close"></select>
              <div class="week-row-off"><input type="checkbox" id="office_Sunday_closed" /><span>Closed?</span></div>
            </div>
          </div>

          <div class="panel-title" style="font-size:11px;margin-top:8px;">Shop Holidays</div>
          <div class="weekly-card">
            <div class="week-row" style="grid-template-columns:120px 1fr 120px;">
              <div class="week-row-label">Add Holiday</div>
              <input id="holidayDateInput" class="date-input" placeholder="YYYY-MM-DD" readonly />
              <input id="holidayLabelInput" placeholder="e.g., New Year's Day" />
            </div>
            <div class="actions" style="margin-top:4px;">
              <button type="button" class="btn btn-primary" id="btnAddHoliday">Add Holiday</button>
            </div>
            <div class="timeoff-note" style="margin-top:4px;">These dates are treated as fully closed unless overridden on an appointment.</div>
            <div id="holidayList" class="timeoff-note" style="margin-top:6px;">No holidays configured.</div>
          </div>
          <!-- ⬆️ END SHOP HOURS & HOLIDAYS BLOCK ⬆️ -->

          <div class="status" id="scheduleStatus"></div>
        </form>
      </div>

      <!-- Services library -->
      <div id="servicesPanel" style="display:none;">
        <div class="panel-title">Service Library</div>
        <div class="panel-divider"></div>
        <form id="servicesForm" onsubmit="return false;">
          <div class="field-group">
            <label>Service Categories & Packages</label>
            <div id="serviceCategoriesList"></div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Add New Category</label>
              <input id="inputNewCategoryName" placeholder="e.g., Accessories" />
            </div>
            <div class="field-group" style="align-self:flex-end;">
              <button type="button" class="btn btn-primary" id="btnAddCategory">Add Category</button>
            </div>
          </div>
          <div class="timeoff-note">These services are saved in this browser and power the dropdowns in the appointment form.</div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Custom Date Picker element -->
<div id="datePickerPopup" class="date-picker-popup">
  <div class="date-picker-header">
    <button type="button" id="dpPrevMonth">◀</button>
    <div class="date-picker-month" id="dpMonthLabel">MONTH YYYY</div>
    <button type="button" id="dpNextMonth">▶</button>
  </div>
  <div class="date-picker-grid" id="dpGrid"></div>
</div>

<!-- Appointment pop-up -->
<div id="appointmentPopup" class="popup-backdrop">
  <div class="popup-card">
    <div class="popup-header">
      <div class="popup-title">
        <h3 id="popupTitle">Appointment</h3>
        <span id="popupSubtitle"></span>
      </div>
      <div class="popup-actions">
        <div class="status-chip" id="popupStatusChip">
          <span class="event-status-icon scheduled" id="popupStatusIcon">●</span>
          <span id="popupStatusLabel">Scheduled</span>
        </div>
        <button class="icon-button" id="btnUnlockEditing">✏️ Edit</button>
        <button class="popup-close" id="btnClosePopup">✕</button>
      </div>
    </div>
    <div class="popup-body">
      <div class="popup-row">
        <label style="font-size:11px;letter-spacing:.08em;">Status</label>
        <select id="popupStatusSelect" style="flex:1;max-width:200px;">
          <option>Scheduled</option>
          <option>Check In</option>
          <option>Cancelled</option>
          <option>No Show</option>
          <option>Completed</option>
        </select>
      </div>
      <div class="popup-row">
        <label style="font-size:11px;letter-spacing:.08em;">Billing</label>
        <div class="inline-checkbox" style="color:#f9fafb;">
          <input type="checkbox" id="popupInvoiced" />
          <span>Invoiced <span class="invoice-icon pending" style="margin-left:4px;">$</span></span>
        </div>
        <div class="inline-checkbox" style="color:#f9fafb;">
          <input type="checkbox" id="popupPaid" />
          <span>Paid <span class="invoice-icon paid" style="margin-left:4px;">$</span></span>
        </div>
      </div>
      <div class="popup-row" id="popupQuickFlags"></div>
      <div class="popup-list" id="popupServicesList"></div>
    </div>
  </div>
</div>

<script>
<div id="datePickerPopup" class="date-picker-popup">
  <div class="date-picker-header">
    <button type="button" id="dpPrevMonth">◀</button>
    <div class="date-picker-month" id="dpMonthLabel">MONTH YYYY</div>
    <button type="button" id="dpNextMonth">▶</button>
  </div>
  <div class="date-picker-grid" id="dpGrid"></div>
</div>

<!-- Appointment pop-up -->
<div id="appointmentPopup" class="popup-backdrop">
  <div class="popup-card">
    <div class="popup-header">
      <div class="popup-title">
        <h3 id="popupTitle">Appointment</h3>
        <span id="popupSubtitle"></span>
      </div>
      <div class="popup-actions">
        <div class="status-chip" id="popupStatusChip">
          <span class="event-status-icon scheduled" id="popupStatusIcon">●</span>
          <span id="popupStatusLabel">Scheduled</span>
        </div>
        <button class="icon-button" id="btnUnlockEditing">✏️ Edit</button>
        <button class="popup-close" id="btnClosePopup">✕</button>
      </div>
    </div>
    <div class="popup-body">
      <div class="popup-row">
        <label style="font-size:11px;letter-spacing:.08em;">Status</label>
        <select id="popupStatusSelect" style="flex:1;max-width:200px;">
          <option>Scheduled</option>
          <option>Check In</option>
          <option>Cancelled</option>
          <option>No Show</option>
          <option>Completed</option>
        </select>
      </div>
      <div class="popup-row">
        <label style="font-size:11px;letter-spacing:.08em;">Billing</label>
        <div class="inline-checkbox" style="color:#f9fafb;">
          <input type="checkbox" id="popupInvoiced" />
          <span>Invoiced <span class="invoice-icon pending" style="margin-left:4px;">$</span></span>
        </div>
        <div class="inline-checkbox" style="color:#f9fafb;">
          <input type="checkbox" id="popupPaid" />
          <span>Paid <span class="invoice-icon paid" style="margin-left:4px;">$</span></span>
        </div>
      </div>
      <div class="popup-row" id="popupQuickFlags"></div>
      <div class="popup-list" id="popupServicesList"></div>
    </div>
  </div>
</div>

<script>
const techs=["William","Limage","Kaiden","Luke","Fafa","Matt"];
const days=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
const workTimes=["08:00","08:30","09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30","18:00"];

const defaultServicePackages={
  "Detailing":[
    {name:"Interior Detail",minutes:150,price:275},
    {name:"Exterior Detail",minutes:120,price:225},
    {name:"Full Detail",minutes:210,price:450},
    {name:"Quick Clean",minutes:60,price:120}
  ],
  "Tint":[
    {name:"Front Windows Only",minutes:60,price:180},
    {name:"Full Tint",minutes:120,price:380},
    {name:"Windshield Tint",minutes:90,price:220}
  ],
  "PPF":[{name:"Full Front PPF",minutes:240,price:1600}],
  "Ceramic":[
    {name:"1 Year Coating",minutes:150,price:650},
    {name:"3 Year Coating",minutes:210,price:1100},
    {name:"5 Year Coating",minutes:240,price:1400}
  ],
  "Electronics":[
    {name:"Remote Start",minutes:120,price:450},
    {name:"Remote Start + Security",minutes:150,price:650}
  ]
};
let servicePackages={};

function normalizeServiceList(list){
  if(!Array.isArray(list)) return [];
  return list.map(item=>{
    if(typeof item==="string"){
      return {name:item,minutes:90,price:0};
    }
    const minutes=Math.max(15,parseInt(item.minutes,10)||90);
    const price=parseFloat(item.price)||0;
    return {name:item.name||"Unnamed Service",minutes,price};
  });
}

function normalizeServicePackages(raw){
  const cleaned={};
  Object.keys(raw||{}).forEach(cat=>{
    cleaned[cat]=normalizeServiceList(raw[cat]);
  });
  return cleaned;
}
const defaultServicePackages={
  "Detailing":[
    {name:"Interior Detail",minutes:150,price:275},
    {name:"Exterior Detail",minutes:120,price:225},
    {name:"Full Detail",minutes:210,price:450},
    {name:"Quick Clean",minutes:60,price:120}
  ],
  "Tint":[
    {name:"Front Windows Only",minutes:60,price:180},
    {name:"Full Tint",minutes:120,price:380},
    {name:"Windshield Tint",minutes:90,price:220}
  ],
  "PPF":[{name:"Full Front PPF",minutes:240,price:1600}],
  "Ceramic":[
    {name:"1 Year Coating",minutes:150,price:650},
    {name:"3 Year Coating",minutes:210,price:1100},
    {name:"5 Year Coating",minutes:240,price:1400}
  ],
  "Electronics":[
    {name:"Remote Start",minutes:120,price:450},
    {name:"Remote Start + Security",minutes:150,price:650}
  ]
};
let servicePackages={};

function normalizeServiceList(list){
  if(!Array.isArray(list)) return [];
  return list.map(item=>{
    if(typeof item==="string"){
      return {name:item,minutes:90,price:0};
    }
    const minutes=Math.max(15,parseInt(item.minutes,10)||90);
    const price=parseFloat(item.price)||0;
    return {name:item.name||"Unnamed Service",minutes,price};
  });
}

function normalizeServicePackages(raw){
  const cleaned={};
  Object.keys(raw||{}).forEach(cat=>{
    cleaned[cat]=normalizeServiceList(raw[cat]);
  });
  return cleaned;
}

function normalizeServiceList(list){
  if(!Array.isArray(list)) return [];
  return list.map(item=>{
    if(typeof item==="string"){
      return {name:item,minutes:90,price:0};
    }
    const minutes=Math.max(15,parseInt(item.minutes,10)||90);
    const price=parseFloat(item.price)||0;
    return {name:item.name||"Unnamed Service",minutes,price};
  });
}

function normalizeServicePackages(raw){
  const cleaned={};
  Object.keys(raw||{}).forEach(cat=>{
    cleaned[cat]=normalizeServiceList(raw[cat]);
  });
  return cleaned;
}

const ZAPIER_WEBHOOK_URL="https://hooks.zapier.com/hooks/catch/23565840/uzuiw0k/";
// Global shop hours (open/close per weekday) + holidays
let officeHours = {};
let shopHolidays = []; // array of { date: "YYYY-MM-DD", label: "New Year's Day" }

let storageAvailable=true;
try{
  const testKey="__patriot_test";
  window.localStorage.setItem(testKey,"1");
  window.localStorage.removeItem(testKey);
}catch(e){
  storageAvailable=false;
}

let techSchedules={};
let events=[];
let currentDate=new Date();currentDate.setHours(0,0,0,0);
let selectedDeptFilter="All";
let selectedSlot=null;
let selectedEventId=null;
let editingJobGroupId=null;
let appointmentLocked=false;
let techSchedules={};
let events=[];
let currentDate=new Date();currentDate.setHours(0,0,0,0);
let selectedDeptFilter="All";
let selectedSlot=null;
let selectedEventId=null;
let editingJobGroupId=null;
let appointmentLocked=false;

// DOM refs
const headerBtnAppointments=document.getElementById("btnAppointmentsPanel");
const headerBtnTimeOff=document.getElementById("btnTimeOffPanel");
const headerBtnSchedules=document.getElementById("btnSchedulesPanel");
const headerBtnServices=document.getElementById("btnServicesPanel");
const appointmentPanel=document.getElementById("appointmentPanel");
const timeOffPanel=document.getElementById("timeOffPanel");
const schedulesPanel=document.getElementById("schedulesPanel");
const servicesPanel=document.getElementById("servicesPanel");
const headerRowEl=document.getElementById("calHeaderRow");
const bodyEl=document.getElementById("calBody");
const dayLabelEl=document.getElementById("dayLabel");
const dayPickerEl=document.getElementById("dayPicker");
const statusEl=document.getElementById("statusText");
const dealerQueueListEl=document.getElementById("dealerQueueList");
const eventDetailsEl=document.getElementById("eventDetails");
const scheduleTechSelect=document.getElementById("scheduleTechSelect");
const scheduleStatus=document.getElementById("scheduleStatus");
const btnCreateAppointment=document.getElementById("btnCreateAppointment");
const btnDeleteAppointment=document.getElementById("btnDeleteAppointment");
const statusField=document.getElementById("inputStatus");
const checkboxInvoiced=document.getElementById("checkboxInvoiced");
const checkboxPaid=document.getElementById("checkboxPaid");
const statusSummary=document.getElementById("statusSummary");

const appointmentPopup=document.getElementById("appointmentPopup");
const popupStatusSelect=document.getElementById("popupStatusSelect");
const popupStatusIcon=document.getElementById("popupStatusIcon");
const popupStatusLabel=document.getElementById("popupStatusLabel");
const popupStatusChip=document.getElementById("popupStatusChip");
const popupTitle=document.getElementById("popupTitle");
const popupSubtitle=document.getElementById("popupSubtitle");
const popupServicesList=document.getElementById("popupServicesList");
const popupQuickFlags=document.getElementById("popupQuickFlags");
const popupInvoiced=document.getElementById("popupInvoiced");
const popupPaid=document.getElementById("popupPaid");
const btnUnlockEditing=document.getElementById("btnUnlockEditing");
const btnClosePopup=document.getElementById("btnClosePopup");
const statusEl=document.getElementById("statusText");
const dealerQueueListEl=document.getElementById("dealerQueueList");
const eventDetailsEl=document.getElementById("eventDetails");
const scheduleTechSelect=document.getElementById("scheduleTechSelect");
const scheduleStatus=document.getElementById("scheduleStatus");
const btnCreateAppointment=document.getElementById("btnCreateAppointment");
const btnDeleteAppointment=document.getElementById("btnDeleteAppointment");
const statusField=document.getElementById("inputStatus");
const checkboxInvoiced=document.getElementById("checkboxInvoiced");
const checkboxPaid=document.getElementById("checkboxPaid");
const statusSummary=document.getElementById("statusSummary");

const appointmentPopup=document.getElementById("appointmentPopup");
const popupStatusSelect=document.getElementById("popupStatusSelect");
const popupStatusIcon=document.getElementById("popupStatusIcon");
const popupStatusLabel=document.getElementById("popupStatusLabel");
const popupStatusChip=document.getElementById("popupStatusChip");
const popupTitle=document.getElementById("popupTitle");
const popupSubtitle=document.getElementById("popupSubtitle");
const popupServicesList=document.getElementById("popupServicesList");
const popupQuickFlags=document.getElementById("popupQuickFlags");
const popupInvoiced=document.getElementById("popupInvoiced");
const popupPaid=document.getElementById("popupPaid");
const btnUnlockEditing=document.getElementById("btnUnlockEditing");
const btnClosePopup=document.getElementById("btnClosePopup");

// Service assignments container
const serviceAssignmentsContainer=document.getElementById("serviceAssignments");
const btnAddServiceRow=document.getElementById("btnAddServiceRow");

// Services library refs
const serviceCategoriesList=document.getElementById("serviceCategoriesList");
const inputNewCategoryName=document.getElementById("inputNewCategoryName");
const btnAddCategory=document.getElementById("btnAddCategory");

// Custom date picker refs
const dpPopup=document.getElementById("datePickerPopup");
const dpGrid=document.getElementById("dpGrid");
const dpMonthLabel=document.getElementById("dpMonthLabel");
const dpPrevMonth=document.getElementById("dpPrevMonth");
const dpNextMonth=document.getElementById("dpNextMonth");
let dpActiveInput=null;
let dpYear=null;
let dpMonth=null;

function toISODate(d){return d.toISOString().slice(0,10);}
function getDayName(d){return d.toLocaleDateString("en-US",{weekday:"long"});}
function formatDateLabel(d){
  const dow=d.toLocaleDateString(undefined,{weekday:"short"}).toUpperCase();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  const y=d.getFullYear();
  return `${dow} ${m}/${day}/${y}`;
}
function timeToMinutes(t){if(!t)return null;const [h,m]=t.split(":").map(Number);return h*60+m;}
function formatTimeFriendly(t){
  if(!t) return "";
  const [hStr,mStr]=t.split(":");
  let h=parseInt(hStr,10), m=parseInt(mStr,10);
  const ampm=h>=12?"PM":"AM";
  if(h===0) h=12; else if(h>12) h-=12;
  return h+":"+(m<10?"0"+m:m)+" "+ampm;
}
function parseISODate(str){
  if(!str) return null;
  const m=str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return null;
  const year=parseInt(m[1],10),month=parseInt(m[2],10)-1,day=parseInt(m[3],10);
  const d=new Date(year,month,day);
  if(isNaN(d.getTime())) return null;
  return d;
}

function minutesToTime(total){
  const h=String(Math.floor(total/60)).padStart(2,"0");
  const m=String(total%60).padStart(2,"0");
  return `${h}:${m}`;
}

function addMinutesToTime(time,minutes){
  const base=timeToMinutes(time)||0;
  return minutesToTime(base+minutes);
}

function statusMeta(status){
  const map={
    "Scheduled":{className:"scheduled",icon:"●"},
    "Check In":{className:"checkin",icon:"⧗"},
    "Cancelled":{className:"cancelled",icon:"✖"},
    "No Show":{className:"noshow",icon:"⚠"},
    "Completed":{className:"completed",icon:"✔"}
  };
  return map[status]||map["Scheduled"];
}

function serviceProgressMeta(status){
  const map={
    "In Queue":{className:"queue",icon:"⏳"},
    "Started":{className:"started",icon:"▶"},
    "Completed":{className:"done",icon:"✔"}
  };
  return map[status]||map["In Queue"];
}

function minutesToTime(total){
  const h=String(Math.floor(total/60)).padStart(2,"0");
  const m=String(total%60).padStart(2,"0");
  return `${h}:${m}`;
}

function addMinutesToTime(time,minutes){
  const base=timeToMinutes(time)||0;
  return minutesToTime(base+minutes);
}

function statusMeta(status){
  const map={
    "Scheduled":{className:"scheduled",icon:"●"},
    "Check In":{className:"checkin",icon:"⧗"},
    "Cancelled":{className:"cancelled",icon:"✖"},
    "No Show":{className:"noshow",icon:"⚠"},
    "Completed":{className:"completed",icon:"✔"}
  };
  return map[status]||map["Scheduled"];
}

function serviceProgressMeta(status){
  const map={
    "In Queue":{className:"queue",icon:"⏳"},
    "Started":{className:"started",icon:"▶"},
    "Completed":{className:"done",icon:"✔"}
  };
  return map[status]||map["In Queue"];
}

function minutesToTime(total){
  const h=String(Math.floor(total/60)).padStart(2,"0");
  const m=String(total%60).padStart(2,"0");
  return `${h}:${m}`;
}

function addMinutesToTime(time,minutes){
  const base=timeToMinutes(time)||0;
  return minutesToTime(base+minutes);
}

function statusMeta(status){
  const map={
    "Scheduled":{className:"scheduled",icon:"●"},
    "Check In":{className:"checkin",icon:"⧗"},
    "Cancelled":{className:"cancelled",icon:"✖"},
    "No Show":{className:"noshow",icon:"⚠"},
    "Completed":{className:"completed",icon:"✔"}
  };
  return map[status]||map["Scheduled"];
}

// Time dropdowns
function populateTimeSelect(selectEl,allowEmpty=true){
  if(!selectEl) return;
  selectEl.innerHTML="";
  if(allowEmpty){
    const ph=document.createElement("option");ph.value="";ph.textContent="--";selectEl.appendChild(ph);
  }
  workTimes.forEach(t=>{
    const opt=document.createElement("option");opt.value=t;opt.textContent=formatTimeFriendly(t);selectEl.appendChild(opt);
  });
}
function initTimeDropdowns(){
  populateTimeSelect(document.getElementById("inputRideTime"));
  populateTimeSelect(document.getElementById("inputPickupTime"));
  populateTimeSelect(document.getElementById("inputDeliveryTime"));
  populateTimeSelect(document.getElementById("timeOffStartTime"));
  populateTimeSelect(document.getElementById("timeOffEndTime"));
  days.forEach(d=>{
    populateTimeSelect(document.getElementById(`sched_${d}_start`),false);
    populateTimeSelect(document.getElementById(`sched_${d}_end`),false);
  });
}
  // Office hours dropdowns
  days.forEach(d=>{
    populateTimeSelect(document.getElementById(`office_${d}_open`), false);
    populateTimeSelect(document.getElementById(`office_${d}_close`), false);
  });

// Tech schedules storage
function initDefaultSchedules(){
  techs.forEach(t=>{
    techSchedules[t]={};
    days.forEach(d=>{
      const weekend=(d==="Saturday"||d==="Sunday");
      techSchedules[t][d]={start:"09:00",end:"17:00",off:weekend};
    });
  });
}
function loadSchedulesFromStorage(){
  if(!storageAvailable){initDefaultSchedules();return;}
  const raw=localStorage.getItem("patriotTechSchedules");
  if(!raw){initDefaultSchedules();return;}
  try{
    const parsed=JSON.parse(raw);
    techSchedules={};
    techs.forEach(t=>{
      techSchedules[t]={};
      days.forEach(d=>{
        const v=(parsed[t] && parsed[t][d])||null;
        if(v){techSchedules[t][d]=v;}
        else{
          const weekend=(d==="Saturday"||d==="Sunday");
          techSchedules[t][d]={start:"09:00",end:"17:00",off:weekend};
        }
      });
    });
  }catch(e){
    console.error("Failed to parse saved schedules",e);
    initDefaultSchedules();
  }
}
function saveSchedulesToStorage(){
  if(!storageAvailable) return;
  localStorage.setItem("patriotTechSchedules",JSON.stringify(techSchedules));
}
// ----- Shop hours (global) -----
function initDefaultOfficeHours(){
  days.forEach(d=>{
    const weekend = (d==="Saturday" || d==="Sunday");
    officeHours[d] = {
      open: weekend ? "09:00" : "09:00",
      close: weekend ? "15:00" : "17:00",
      closed: weekend
    };
  });
}

function loadOfficeHoursFromStorage(){
  if(!storageAvailable){
    initDefaultOfficeHours();
    return;
  }
  const raw = localStorage.getItem("patriotOfficeHours");
  if(!raw){
    initDefaultOfficeHours();
    return;
  }
  try{
    const parsed = JSON.parse(raw);
    officeHours = {};
    days.forEach(d=>{
      const v = parsed[d] || null;
      if(v){
        officeHours[d] = v;
      }else{
        officeHours[d] = { open:"09:00", close:"17:00", closed:false };
      }
    });
  }catch(e){
    console.error("Failed to parse office hours",e);
    initDefaultOfficeHours();
  }
}

function saveOfficeHoursToStorage(){
  if(!storageAvailable) return;
  localStorage.setItem("patriotOfficeHours", JSON.stringify(officeHours));
}

// ----- Shop holidays -----
function loadShopHolidaysFromStorage(){
  if(!storageAvailable){
    shopHolidays = [];
    return;
  }
  const raw = localStorage.getItem("patriotShopHolidays");
  if(!raw){
    shopHolidays = [];
    return;
  }
  try{
    const parsed = JSON.parse(raw);
    shopHolidays = Array.isArray(parsed) ? parsed : [];
  }catch(e){
    console.error("Failed to parse shop holidays",e);
    shopHolidays = [];
  }
}

function saveShopHolidaysToStorage(){
  if(!storageAvailable) return;
  localStorage.setItem("patriotShopHolidays", JSON.stringify(shopHolidays));
}

// Service packages storage
function loadServicePackagesFromStorage(){
  if(!storageAvailable){
    servicePackages=normalizeServicePackages(defaultServicePackages);
    return;
  }
  const raw=localStorage.getItem("patriotServicePackages");
  if(!raw){
    servicePackages=normalizeServicePackages(defaultServicePackages);
    return;
  }
  try{
    const parsed=JSON.parse(raw);
    if(parsed && typeof parsed==="object"){
      servicePackages=normalizeServicePackages(parsed);
    }else{
      servicePackages=normalizeServicePackages(defaultServicePackages);
    }
  }catch(e){
    console.error("Failed to parse saved service packages",e);
    servicePackages=normalizeServicePackages(defaultServicePackages);
  }
}

function setAppointmentFormLocked(locked){
  appointmentLocked=locked;
  const form=document.getElementById("appointmentForm");
  if(!form) return;
  const controls=form.querySelectorAll("input, select, textarea, button");
  controls.forEach(el=>{
    if(el.id==="btnClear") return;
    el.disabled=locked;
  });
  form.querySelectorAll(".service-row button").forEach(btn=>btn.disabled=locked);
  if(btnCreateAppointment) btnCreateAppointment.disabled=locked;
  if(btnDeleteAppointment) btnDeleteAppointment.disabled=locked;
  if(btnAddServiceRow) btnAddServiceRow.disabled=locked;
}

function setPopupEditable(enabled){
  if(popupStatusSelect) popupStatusSelect.disabled=!enabled;
  if(popupInvoiced) popupInvoiced.disabled=!enabled;
  if(popupPaid) popupPaid.disabled=!enabled;
  if(btnUnlockEditing) btnUnlockEditing.textContent=enabled?"Editing" : "✏️ Edit";
}

function getCurrentStatusState(){
  const status=statusField?statusField.value||"Scheduled":"Scheduled";
  const paid=!!(checkboxPaid&&checkboxPaid.checked);
  const invoiced=paid?true:!!(checkboxInvoiced&&checkboxInvoiced.checked);
  return {status,invoiced,paid};
}

function updateStatusSummaryDisplay(){
  if(!statusSummary) return;
  const {status,invoiced,paid}=getCurrentStatusState();
  statusSummary.innerHTML="";
  const meta=statusMeta(status);
  const chip=document.createElement("div");
  chip.className=`status-chip`;
  const icon=document.createElement("span");
  icon.className=`event-status-icon ${meta.className}`;
  icon.textContent=meta.icon;
  const text=document.createElement("span");
  text.textContent=status;
  chip.appendChild(icon);
  chip.appendChild(text);
  statusSummary.appendChild(chip);

  if(invoiced||paid){
    const dollar=document.createElement("span");
    dollar.className=`invoice-icon ${paid?"paid":"pending"}`;
    dollar.textContent="$";
    statusSummary.appendChild(dollar);
  }
}

function setStatusState(status,invoiced,paid){
  if(statusField) statusField.value=status||"Scheduled";
  if(checkboxPaid) checkboxPaid.checked=!!paid;
  if(checkboxInvoiced) checkboxInvoiced.checked=!!invoiced||!!paid;
  syncPopupFromStatusFields();
}

function syncPopupFromStatusFields(){
  const {status,invoiced,paid}=getCurrentStatusState();
  if(popupStatusSelect) popupStatusSelect.value=status;
  if(popupInvoiced) popupInvoiced.checked=invoiced;
  if(popupPaid) popupPaid.checked=paid;
  const meta=statusMeta(status);
  if(popupStatusIcon){
    popupStatusIcon.className=`event-status-icon ${meta.className}`;
    popupStatusIcon.textContent=meta.icon;
  }
  if(popupStatusLabel) popupStatusLabel.textContent=status;
  updateStatusSummaryDisplay();
}

function applyMetaToGroup(status,invoiced,paid){
  if(paid) invoiced=true;
  if(!editingJobGroupId) return;
  events=events.map(ev=>{
    if(ev.type==="job" && (ev.jobGroupId||ev.id)===editingJobGroupId){
      return {...ev,status,invoiced,paid};
    }
    return ev;
  });
  renderCalendar();
}

function syncServiceProgressToForm(groupEvents){
  const map=new Map();
  groupEvents.forEach(ev=>map.set(ev.id, ev.serviceProgress||"In Queue"));
  document.querySelectorAll(".service-row").forEach(row=>{
    const prog=row.querySelector(".sa-progress");
    if(!prog) return;
    const id=row.dataset.eventId;
    if(id && map.has(id)){
      prog.value=map.get(id);
    }
  });
}

function autoAdvanceServiceProgress(groupId){
  const groupEvents=events
    .filter(ev=>ev.type==="job" && (ev.jobGroupId||ev.id)===groupId)
    .map(ev=>({
      ...ev,
      serviceProgress:ev.serviceProgress||"In Queue"
    }))
    .sort((a,b)=>timeToMinutes(a.time)-timeToMinutes(b.time));
  if(!groupEvents.length) return;

  const ensureStartedIndex=groupEvents.findIndex(ev=>ev.serviceProgress!=="Completed");
  if(ensureStartedIndex!==-1 && !groupEvents.some(ev=>ev.serviceProgress==="Started")){
    const target=groupEvents[ensureStartedIndex];
    events=events.map(ev=>ev.id===target.id?{...ev,serviceProgress:"Started"}:ev);
  }

  groupEvents.forEach((ev,idx)=>{
    if(ev.serviceProgress==="Completed"){
      const next=groupEvents[idx+1];
      if(next && next.serviceProgress==="In Queue"){
        events=events.map(e=>e.id===next.id?{...e,serviceProgress:"Started"}:e);
      }
    }
  });

  const refreshed=events.filter(ev=>ev.type==="job" && (ev.jobGroupId||ev.id)===groupId);
  const allDone=refreshed.length>0 && refreshed.every(ev=>(ev.serviceProgress||"In Queue")==="Completed");
  if(allDone){
    setStatusState("Completed",checkboxInvoiced.checked,checkboxPaid.checked);
    applyMetaToGroup("Completed",checkboxInvoiced.checked,checkboxPaid.checked);
  }
}

function updateServiceProgress(groupId,eventId,newStatus){
  events=events.map(ev=>{
    if(ev.id===eventId){
      return {...ev,serviceProgress:newStatus};
    }
    return ev;
  });
  autoAdvanceServiceProgress(groupId);
  const groupEvents=events.filter(ev=>ev.type==="job" && (ev.jobGroupId||ev.id)===groupId);
  syncServiceProgressToForm(groupEvents);
  buildPopupServices(groupEvents, groupId);
  renderCalendar();
}

function buildPopupServices(groupEvents, groupId){
  if(!popupServicesList) return;
  popupServicesList.innerHTML="";
  const sorted=[...groupEvents].sort((a,b)=>timeToMinutes(a.time)-timeToMinutes(b.time));
  sorted.forEach(gev=>{
    const row=document.createElement("div");
    row.className="popup-list-item";

    const left=document.createElement("div");
    left.style.display="flex";
    left.style.alignItems="center";
    left.style.gap="8px";
    const progMeta=serviceProgressMeta(gev.serviceProgress||"In Queue");
    const progIcon=document.createElement("span");
    progIcon.className=`service-progress-icon ${progMeta.className}`;
    progIcon.textContent=progMeta.icon;
    left.appendChild(progIcon);

    const info=document.createElement("div");
    info.style.display="flex";
    info.style.flexDirection="column";
    info.style.gap="2px";
    const endTime=addMinutesToTime(gev.time,gev.minutes||90);
    info.innerHTML=`<strong>${gev.serviceName||gev.label||"Service"}</strong><span style="color:#9ca3af;">${gev.tech} · ${gev.time}–${endTime} · ${gev.minutes||90} mins</span>`;
    left.appendChild(info);

    const price=document.createElement("div");
    price.textContent=`$${(gev.price||0).toFixed(2)}`;
    price.style.fontWeight="700";

    const select=document.createElement("select");
    ["In Queue","Started","Completed"].forEach(val=>{
      const o=document.createElement("option");o.value=val;o.textContent=val;select.appendChild(o);
    });
    select.value=gev.serviceProgress||"In Queue";
    select.addEventListener("change",()=>{
      updateServiceProgress(groupId||gev.jobGroupId||gev.id, gev.id, select.value);
    });

    row.appendChild(left);
    row.appendChild(price);
    row.appendChild(select);
    popupServicesList.appendChild(row);
  });
}

function setPopupFlags(ev){
  if(!popupQuickFlags) return;
  popupQuickFlags.innerHTML="";
  const flags=[];
  if(ev.dealer) flags.push("Dealer Job");
  if(ev.customerWaiting) flags.push("Waiting");
  if(ev.rideNeeded) flags.push("Ride Needed");
  if(ev.pickupDelivery) flags.push("Pickup / Delivery");
  flags.forEach(f=>{
    const badge=document.createElement("div");
    badge.className="popup-badge";
    badge.textContent=f;
    popupQuickFlags.appendChild(badge);
  });
}

function openAppointmentPopup(ev){
  if(!appointmentPopup || ev.type!=="job") return;
  const groupId=ev.jobGroupId||ev.id;
  const groupEvents=events.filter(e=>e.type==="job" && (e.jobGroupId||e.id)===groupId);
  popupTitle.textContent=ev.customerName||"Appointment";
  const endTime=addMinutesToTime(ev.time,ev.minutes||90);
  popupSubtitle.textContent=`${ev.date} · ${ev.time}–${endTime}`;
  const status=ev.status||"Scheduled";
  const invoiced=!!ev.invoiced;
  const paid=!!ev.paid;
  setStatusState(status,invoiced,paid);
  if(popupStatusChip) popupStatusChip.className=`status-chip`;
  autoAdvanceServiceProgress(groupId);
  buildPopupServices(groupEvents, groupId);
  setPopupFlags(ev);
  appointmentPopup.style.display="flex";
  setPopupEditable(true);
}

function closeAppointmentPopup(){
  if(appointmentPopup) appointmentPopup.style.display="none";
}
function loadServicePackagesFromStorage(){
  if(!storageAvailable){
    servicePackages=normalizeServicePackages(defaultServicePackages);
    return;
  }
  const raw=localStorage.getItem("patriotServicePackages");
  if(!raw){
    servicePackages=normalizeServicePackages(defaultServicePackages);
    return;
  }
  try{
    const parsed=JSON.parse(raw);
    if(parsed && typeof parsed==="object"){
      servicePackages=normalizeServicePackages(parsed);
    }else{
      servicePackages=normalizeServicePackages(defaultServicePackages);
    }
  }catch(e){
    console.error("Failed to parse saved service packages",e);
    servicePackages=normalizeServicePackages(defaultServicePackages);
  }
}

function setAppointmentFormLocked(locked){
  appointmentLocked=locked;
  const form=document.getElementById("appointmentForm");
  if(!form) return;
  const controls=form.querySelectorAll("input, select, textarea, button");
  controls.forEach(el=>{
    if(el.id==="btnClear") return;
    el.disabled=locked;
  });
  form.querySelectorAll(".service-row button").forEach(btn=>btn.disabled=locked);
  if(btnCreateAppointment) btnCreateAppointment.disabled=locked;
  if(btnDeleteAppointment) btnDeleteAppointment.disabled=locked;
  if(btnAddServiceRow) btnAddServiceRow.disabled=locked;
}

function setPopupEditable(enabled){
  if(popupStatusSelect) popupStatusSelect.disabled=!enabled;
  if(popupInvoiced) popupInvoiced.disabled=!enabled;
  if(popupPaid) popupPaid.disabled=!enabled;
  if(btnUnlockEditing) btnUnlockEditing.textContent=enabled?"Editing" : "✏️ Edit";
}

function getCurrentStatusState(){
  const status=statusField?statusField.value||"Scheduled":"Scheduled";
  const paid=!!(checkboxPaid&&checkboxPaid.checked);
  const invoiced=paid?true:!!(checkboxInvoiced&&checkboxInvoiced.checked);
  return {status,invoiced,paid};
}

function updateStatusSummaryDisplay(){
  if(!statusSummary) return;
  const {status,invoiced,paid}=getCurrentStatusState();
  statusSummary.innerHTML="";
  const meta=statusMeta(status);
  const chip=document.createElement("div");
  chip.className=`status-chip`;
  const icon=document.createElement("span");
  icon.className=`event-status-icon ${meta.className}`;
  icon.textContent=meta.icon;
  const text=document.createElement("span");
  text.textContent=status;
  chip.appendChild(icon);
  chip.appendChild(text);
  statusSummary.appendChild(chip);

  if(invoiced||paid){
    const dollar=document.createElement("span");
    dollar.className=`invoice-icon ${paid?"paid":"pending"}`;
    dollar.textContent="$";
    statusSummary.appendChild(dollar);
  }
}

function setStatusState(status,invoiced,paid){
  if(statusField) statusField.value=status||"Scheduled";
  if(checkboxPaid) checkboxPaid.checked=!!paid;
  if(checkboxInvoiced) checkboxInvoiced.checked=!!invoiced||!!paid;
  syncPopupFromStatusFields();
}

function syncPopupFromStatusFields(){
  const {status,invoiced,paid}=getCurrentStatusState();
  if(popupStatusSelect) popupStatusSelect.value=status;
  if(popupInvoiced) popupInvoiced.checked=invoiced;
  if(popupPaid) popupPaid.checked=paid;
  const meta=statusMeta(status);
  if(popupStatusIcon){
    popupStatusIcon.className=`event-status-icon ${meta.className}`;
    popupStatusIcon.textContent=meta.icon;
  }
  if(popupStatusLabel) popupStatusLabel.textContent=status;
  updateStatusSummaryDisplay();
}

function applyMetaToGroup(status,invoiced,paid){
  if(paid) invoiced=true;
  if(!editingJobGroupId) return;
  events=events.map(ev=>{
    if(ev.type==="job" && (ev.jobGroupId||ev.id)===editingJobGroupId){
      return {...ev,status,invoiced,paid};
    }
    return ev;
  });
  renderCalendar();
}

function syncServiceProgressToForm(groupEvents){
  const map=new Map();
  groupEvents.forEach(ev=>map.set(ev.id, ev.serviceProgress||"In Queue"));
  document.querySelectorAll(".service-row").forEach(row=>{
    const prog=row.querySelector(".sa-progress");
    if(!prog) return;
    const id=row.dataset.eventId;
    if(id && map.has(id)){
      prog.value=map.get(id);
    }
  });
}

function autoAdvanceServiceProgress(groupId){
  const groupEvents=events
    .filter(ev=>ev.type==="job" && (ev.jobGroupId||ev.id)===groupId)
    .map(ev=>({
      ...ev,
      serviceProgress:ev.serviceProgress||"In Queue"
    }))
    .sort((a,b)=>timeToMinutes(a.time)-timeToMinutes(b.time));
  if(!groupEvents.length) return;

  const ensureStartedIndex=groupEvents.findIndex(ev=>ev.serviceProgress!=="Completed");
  if(ensureStartedIndex!==-1 && !groupEvents.some(ev=>ev.serviceProgress==="Started")){
    const target=groupEvents[ensureStartedIndex];
    events=events.map(ev=>ev.id===target.id?{...ev,serviceProgress:"Started"}:ev);
  }

  groupEvents.forEach((ev,idx)=>{
    if(ev.serviceProgress==="Completed"){
      const next=groupEvents[idx+1];
      if(next && next.serviceProgress==="In Queue"){
        events=events.map(e=>e.id===next.id?{...e,serviceProgress:"Started"}:e);
      }
    }
  });

  const refreshed=events.filter(ev=>ev.type==="job" && (ev.jobGroupId||ev.id)===groupId);
  const allDone=refreshed.length>0 && refreshed.every(ev=>(ev.serviceProgress||"In Queue")==="Completed");
  if(allDone){
    setStatusState("Completed",checkboxInvoiced.checked,checkboxPaid.checked);
    applyMetaToGroup("Completed",checkboxInvoiced.checked,checkboxPaid.checked);
  }
}

function updateServiceProgress(groupId,eventId,newStatus){
  events=events.map(ev=>{
    if(ev.id===eventId){
      return {...ev,serviceProgress:newStatus};
    }
    return ev;
  });
  autoAdvanceServiceProgress(groupId);
  const groupEvents=events.filter(ev=>ev.type==="job" && (ev.jobGroupId||ev.id)===groupId);
  syncServiceProgressToForm(groupEvents);
  buildPopupServices(groupEvents, groupId);
  renderCalendar();
}

function buildPopupServices(groupEvents, groupId){
  if(!popupServicesList) return;
  popupServicesList.innerHTML="";
  const sorted=[...groupEvents].sort((a,b)=>timeToMinutes(a.time)-timeToMinutes(b.time));
  sorted.forEach(gev=>{
    const row=document.createElement("div");
    row.className="popup-list-item";

    const left=document.createElement("div");
    left.style.display="flex";
    left.style.alignItems="center";
    left.style.gap="8px";
    const progMeta=serviceProgressMeta(gev.serviceProgress||"In Queue");
    const progIcon=document.createElement("span");
    progIcon.className=`service-progress-icon ${progMeta.className}`;
    progIcon.textContent=progMeta.icon;
    left.appendChild(progIcon);

    const info=document.createElement("div");
    info.style.display="flex";
    info.style.flexDirection="column";
    info.style.gap="2px";
    const endTime=addMinutesToTime(gev.time,gev.minutes||90);
    info.innerHTML=`<strong>${gev.serviceName||gev.label||"Service"}</strong><span style="color:#9ca3af;">${gev.tech} · ${gev.time}–${endTime} · ${gev.minutes||90} mins</span>`;
    left.appendChild(info);

    const price=document.createElement("div");
    price.textContent=`$${(gev.price||0).toFixed(2)}`;
    price.style.fontWeight="700";

    const select=document.createElement("select");
    ["In Queue","Started","Completed"].forEach(val=>{
      const o=document.createElement("option");o.value=val;o.textContent=val;select.appendChild(o);
    });
    select.value=gev.serviceProgress||"In Queue";
    select.disabled=appointmentLocked;
    select.addEventListener("change",()=>{
      updateServiceProgress(groupId||gev.jobGroupId||gev.id, gev.id, select.value);
    });

    row.appendChild(left);
    row.appendChild(price);
    row.appendChild(select);
    popupServicesList.appendChild(row);
  });
}

function setPopupFlags(ev){
  if(!popupQuickFlags) return;
  popupQuickFlags.innerHTML="";
  const flags=[];
  if(ev.dealer) flags.push("Dealer Job");
  if(ev.customerWaiting) flags.push("Waiting");
  if(ev.rideNeeded) flags.push("Ride Needed");
  if(ev.pickupDelivery) flags.push("Pickup / Delivery");
  flags.forEach(f=>{
    const badge=document.createElement("div");
    badge.className="popup-badge";
    badge.textContent=f;
    popupQuickFlags.appendChild(badge);
  });
}

function openAppointmentPopup(ev){
  if(!appointmentPopup || ev.type!=="job") return;
  const groupId=ev.jobGroupId||ev.id;
  const groupEvents=events.filter(e=>e.type==="job" && (e.jobGroupId||e.id)===groupId);
  popupTitle.textContent=ev.customerName||"Appointment";
  const endTime=addMinutesToTime(ev.time,ev.minutes||90);
  popupSubtitle.textContent=`${ev.date} · ${ev.time}–${endTime}`;
  const status=ev.status||"Scheduled";
  const invoiced=!!ev.invoiced;
  const paid=!!ev.paid;
  setStatusState(status,invoiced,paid);
  if(popupStatusChip) popupStatusChip.className=`status-chip`;
  autoAdvanceServiceProgress(groupId);
  buildPopupServices(groupEvents, groupId);
  setPopupFlags(ev);
  appointmentPopup.style.display="flex";
  setPopupEditable(false);
}

function closeAppointmentPopup(){
  if(appointmentPopup) appointmentPopup.style.display="none";
}
function saveServicePackagesToStorage(){
  if(!storageAvailable) return;
  localStorage.setItem("patriotServicePackages",JSON.stringify(servicePackages));
}

// Service helpers (per-row)
function populateServiceOptionsForSelect(deptSelect,serviceSelect,selectedValue){
  serviceSelect.innerHTML="";
  const ph=document.createElement("option");ph.value="";ph.textContent="Select service";serviceSelect.appendChild(ph);
  const dept=deptSelect.value;
  if(dept && servicePackages[dept]){
    servicePackages[dept].forEach(svc=>{
      const name=svc.name||svc;
      const o=document.createElement("option");
      o.value=name;o.textContent=name;
      serviceSelect.appendChild(o);
    });
  }
  if(selectedValue) serviceSelect.value=selectedValue;
}

function findServiceDefaults(dept,name){
  const list=servicePackages[dept]||[];
  return list.find(s=>s.name===name)||null;
}
function populateServiceOptionsForSelect(deptSelect,serviceSelect,selectedValue){
  serviceSelect.innerHTML="";
  const ph=document.createElement("option");ph.value="";ph.textContent="Select service";serviceSelect.appendChild(ph);
  const dept=deptSelect.value;
  if(dept && servicePackages[dept]){
    servicePackages[dept].forEach(svc=>{
      const name=svc.name||svc;
      const o=document.createElement("option");
      o.value=name;o.textContent=name;
      serviceSelect.appendChild(o);
    });
  }
  if(selectedValue) serviceSelect.value=selectedValue;
}

function findServiceDefaults(dept,name){
  const list=servicePackages[dept]||[];
  return list.find(s=>s.name===name)||null;
}

function findServiceDefaults(dept,name){
  const list=servicePackages[dept]||[];
  return list.find(s=>s.name===name)||null;
}

// Service assignment rows
function addServiceRow(initial){
  const row=document.createElement("div");
  row.className="field-row service-row";

  const deptGroup=document.createElement("div");
  deptGroup.className="field-group";
  const deptSelect=document.createElement("select");
  deptSelect.className="sa-dept";
  const deptPh=document.createElement("option");deptPh.value="";deptPh.textContent="Service Category";deptSelect.appendChild(deptPh);
  Object.keys(servicePackages).sort().forEach(key=>{
    const opt=document.createElement("option");opt.value=key;opt.textContent=key;deptSelect.appendChild(opt);
  });
  deptGroup.appendChild(deptSelect);

  const svcGroup=document.createElement("div");
  svcGroup.className="field-group";
  const svcSelect=document.createElement("select");
  svcSelect.className="sa-service";
  const svcPh=document.createElement("option");svcPh.value="";svcPh.textContent="Select service";svcSelect.appendChild(svcPh);
  svcGroup.appendChild(svcSelect);

  const techGroup=document.createElement("div");
  techGroup.className="field-group";
  const techSelect=document.createElement("select");
  techSelect.className="sa-tech";
  const techPh=document.createElement("option");techPh.value="";techPh.textContent="Assign tech";techSelect.appendChild(techPh);
  const optDealer=document.createElement("option");optDealer.value="Dealer";optDealer.textContent="Dealer";techSelect.appendChild(optDealer);
  techs.forEach(t=>{
    const o=document.createElement("option");o.value=t;o.textContent=t;techSelect.appendChild(o);
  });
  techGroup.appendChild(techSelect);

  const timeGroup=document.createElement("div");
  timeGroup.className="field-group";
  const timeSelect=document.createElement("select");
  timeSelect.className="sa-time";
  populateTimeSelect(timeSelect,true);
  timeGroup.appendChild(timeSelect);

  const durationGroup=document.createElement("div");
  durationGroup.className="field-group";
  durationGroup.style.gap="2px";
  const durationLabel=document.createElement("label");
  durationLabel.style.fontSize="10px";
  durationLabel.style.textTransform="none";
  durationLabel.style.letterSpacing="0";
  durationLabel.textContent="Est. Duration (mins)";
  const durationInput=document.createElement("input");
  durationInput.type="number";
  durationInput.min="15";
  durationInput.step="15";
  durationInput.placeholder="Est. mins";
  durationInput.className="sa-minutes";
  durationInput.value="90";
  durationGroup.appendChild(durationLabel);
  durationGroup.appendChild(durationInput);

  const priceGroup=document.createElement("div");
  priceGroup.className="field-group";
  priceGroup.style.gap="2px";
  const priceLabel=document.createElement("label");
  priceLabel.style.fontSize="10px";
  priceLabel.style.textTransform="none";
  priceLabel.style.letterSpacing="0";
  priceLabel.textContent="Price ($)";
  const priceInput=document.createElement("input");
  priceInput.type="number";
  priceInput.min="0";
  priceInput.step="1";
  priceInput.placeholder="Price";
  priceInput.className="sa-price";
  priceInput.value="0";
  priceGroup.appendChild(priceLabel);
  priceGroup.appendChild(priceInput);

  const progressInput=document.createElement("input");
  progressInput.type="hidden";
  progressInput.className="sa-progress";
  progressInput.value="In Queue";

  const removeBtn=document.createElement("button");
  removeBtn.type="button";
  removeBtn.textContent="✕";
  const timeGroup=document.createElement("div");
  timeGroup.className="field-group";
  const timeSelect=document.createElement("select");
  timeSelect.className="sa-time";
  populateTimeSelect(timeSelect,true);
  timeGroup.appendChild(timeSelect);

  const durationGroup=document.createElement("div");
  durationGroup.className="field-group";
  const durationLabel=document.createElement("label");
  durationLabel.style.fontSize="10px";
  durationLabel.style.textTransform="none";
  durationLabel.style.letterSpacing="0";
  durationLabel.textContent="Est. Duration (mins)";
  const durationInput=document.createElement("input");
  durationInput.type="number";
  durationInput.min="15";
  durationInput.step="15";
  durationInput.placeholder="Est. mins";
  durationInput.className="sa-minutes";
  durationInput.value="90";
  durationGroup.appendChild(durationLabel);
  durationGroup.appendChild(durationInput);

  const priceGroup=document.createElement("div");
  priceGroup.className="field-group";
  const priceLabel=document.createElement("label");
  priceLabel.style.fontSize="10px";
  priceLabel.style.textTransform="none";
  priceLabel.style.letterSpacing="0";
  priceLabel.textContent="Price ($)";
  const priceInput=document.createElement("input");
  priceInput.type="number";
  priceInput.min="0";
  priceInput.step="1";
  priceInput.placeholder="Price";
  priceInput.className="sa-price";
  priceInput.value="0";
  priceGroup.appendChild(priceLabel);
  priceGroup.appendChild(priceInput);

  const progressInput=document.createElement("input");
  progressInput.type="hidden";
  progressInput.className="sa-progress";
  progressInput.value="In Queue";

  const removeBtn=document.createElement("button");
  removeBtn.type="button";
  removeBtn.textContent="✕";
  removeBtn.className="btn btn-clear";
  removeBtn.style.padding="4px 8px";
  removeBtn.addEventListener("click",()=>{
    row.remove();
    if(serviceAssignmentsContainer.children.length===0){
      addServiceRow();
    }
  });

  row.appendChild(deptGroup);
  row.appendChild(svcGroup);
  row.appendChild(techGroup);
  row.appendChild(timeGroup);
  row.appendChild(durationGroup);
  row.appendChild(priceGroup);
  row.appendChild(progressInput);
  row.appendChild(removeBtn);
  serviceAssignmentsContainer.appendChild(row);

  deptSelect.addEventListener("change",()=>{
    populateServiceOptionsForSelect(deptSelect,svcSelect,null);
    durationInput.value="";
    priceInput.value="";
  });

  svcSelect.addEventListener("change",()=>{
    const defaults=findServiceDefaults(deptSelect.value,svcSelect.value);
    if(defaults){
      durationInput.value=defaults.minutes||90;
      priceInput.value=defaults.price||0;
    }
  });

  if(initial){
    if(initial.dept){
      deptSelect.value=initial.dept;
      populateServiceOptionsForSelect(deptSelect,svcSelect,initial.serviceName||"");
    }
    if(initial.tech) techSelect.value=initial.tech;
    if(initial.time) timeSelect.value=initial.time;
    if(initial.minutes) durationInput.value=initial.minutes;
    if(typeof initial.price!=="undefined") priceInput.value=initial.price;
    if(initial.serviceProgress) progressInput.value=initial.serviceProgress;
    if(initial.id) row.dataset.eventId=initial.id;
  }
}
  row.appendChild(deptGroup);
  row.appendChild(svcGroup);
  row.appendChild(techGroup);
  row.appendChild(timeGroup);
  row.appendChild(durationGroup);
  row.appendChild(priceGroup);
  row.appendChild(progressInput);
  row.appendChild(removeBtn);
  serviceAssignmentsContainer.appendChild(row);

  deptSelect.addEventListener("change",()=>{
    populateServiceOptionsForSelect(deptSelect,svcSelect,null);
    durationInput.value="";
    priceInput.value="";
  });

  svcSelect.addEventListener("change",()=>{
    const defaults=findServiceDefaults(deptSelect.value,svcSelect.value);
    if(defaults){
      durationInput.value=defaults.minutes||90;
      priceInput.value=defaults.price||0;
    }
  });

  if(initial){
    if(initial.dept){
      deptSelect.value=initial.dept;
      populateServiceOptionsForSelect(deptSelect,svcSelect,initial.serviceName||"");
    }
    if(initial.tech) techSelect.value=initial.tech;
    if(initial.time) timeSelect.value=initial.time;
    if(initial.minutes) durationInput.value=initial.minutes;
    if(typeof initial.price!=="undefined") priceInput.value=initial.price;
    if(initial.serviceProgress) progressInput.value=initial.serviceProgress;
    if(initial.id) row.dataset.eventId=initial.id;
  }
}

function clearServiceAssignments(){
  serviceAssignmentsContainer.innerHTML="";
}
function ensureAtLeastOneServiceRow(){
  if(serviceAssignmentsContainer.children.length===0){
    addServiceRow();
  }
}
function refreshAllServiceAssignmentRows(){
  const rows=document.querySelectorAll(".service-row");
  rows.forEach(row=>{
    const deptSelect=row.querySelector(".sa-dept");
    const svcSelect=row.querySelector(".sa-service");
    const prevDept=deptSelect.value;
    const prevSvc=svcSelect.value;
    const minutesInput=row.querySelector(".sa-minutes");
    const priceInput=row.querySelector(".sa-price");
    const prevMinutes=minutesInput.value;
    const prevPrice=priceInput.value;
    const progressInput=row.querySelector(".sa-progress");
    const prevProgress=progressInput?.value||"In Queue";

    deptSelect.innerHTML="";
    const deptPh=document.createElement("option");deptPh.value="";deptPh.textContent="Service Category";deptSelect.appendChild(deptPh);
    Object.keys(servicePackages).sort().forEach(key=>{
      const opt=document.createElement("option");opt.value=key;opt.textContent=key;deptSelect.appendChild(opt);
    });
    if(prevDept && servicePackages[prevDept]) deptSelect.value=prevDept;

    populateServiceOptionsForSelect(deptSelect,svcSelect,prevSvc);
    minutesInput.value=prevMinutes;
    priceInput.value=prevPrice;
    if(progressInput) progressInput.value=prevProgress;
  });
}
function getServiceAssignmentsFromForm(){
  const rows=serviceAssignmentsContainer.querySelectorAll(".service-row");
  const result=[];
  rows.forEach(row=>{
    const dept=row.querySelector(".sa-dept")?.value||"";
    const serviceName=row.querySelector(".sa-service")?.value||"";
    const tech=row.querySelector(".sa-tech")?.value||"";
    const time=row.querySelector(".sa-time")?.value||"";
    const minutes=parseInt(row.querySelector(".sa-minutes")?.value||"0",10)||90;
    const price=parseFloat(row.querySelector(".sa-price")?.value||"0")||0;
    const serviceProgress=row.querySelector(".sa-progress")?.value||"In Queue";
    if(!dept && !serviceName && !tech && !time) return;
    result.push({dept,serviceName,tech,time,minutes,price,serviceProgress});
  });
  return result;
}
  rows.forEach(row=>{
    const deptSelect=row.querySelector(".sa-dept");
    const svcSelect=row.querySelector(".sa-service");
    const prevDept=deptSelect.value;
    const prevSvc=svcSelect.value;
    const minutesInput=row.querySelector(".sa-minutes");
    const priceInput=row.querySelector(".sa-price");
    const prevMinutes=minutesInput.value;
    const prevPrice=priceInput.value;
    const progressInput=row.querySelector(".sa-progress");
    const prevProgress=progressInput?.value||"In Queue";

    deptSelect.innerHTML="";
    const deptPh=document.createElement("option");deptPh.value="";deptPh.textContent="Service Category";deptSelect.appendChild(deptPh);
    Object.keys(servicePackages).sort().forEach(key=>{
      const opt=document.createElement("option");opt.value=key;opt.textContent=key;deptSelect.appendChild(opt);
    });
    if(prevDept && servicePackages[prevDept]) deptSelect.value=prevDept;

    populateServiceOptionsForSelect(deptSelect,svcSelect,prevSvc);
    minutesInput.value=prevMinutes;
    priceInput.value=prevPrice;
    if(progressInput) progressInput.value=prevProgress;
  });
}
function getServiceAssignmentsFromForm(){
  const rows=serviceAssignmentsContainer.querySelectorAll(".service-row");
  const result=[];
  rows.forEach(row=>{
    const dept=row.querySelector(".sa-dept")?.value||"";
    const serviceName=row.querySelector(".sa-service")?.value||"";
    const tech=row.querySelector(".sa-tech")?.value||"";
    const time=row.querySelector(".sa-time")?.value||"";
    const minutes=parseInt(row.querySelector(".sa-minutes")?.value||"0",10)||90;
    const price=parseFloat(row.querySelector(".sa-price")?.value||"0")||0;
    const serviceProgress=row.querySelector(".sa-progress")?.value||"In Queue";
    if(!dept && !serviceName && !tech && !time) return;
    result.push({dept,serviceName,tech,time,minutes,price,serviceProgress});
  });
  return result;
}

// Services library rendering & actions
function renderServiceLibrary(){
  serviceCategoriesList.innerHTML="";
  const cats=Object.keys(servicePackages).sort();
  if(!cats.length){
    const empty=document.createElement("div");
    empty.className="timeoff-note";
    empty.textContent="No categories yet. Add a new one below.";
    serviceCategoriesList.appendChild(empty);
    return;
  }
  cats.forEach(cat=>{
    const card=document.createElement("div");
    card.style.border="1px solid rgba(255,255,255,0.12)";
    card.style.borderRadius="8px";
    card.style.padding="8px";
    card.style.marginBottom="6px";
    card.style.background="rgba(3,10,25,0.9)";

    const header=document.createElement("div");
    header.style.display="flex";
    header.style.justifyContent="space-between";
    header.style.alignItems="center";

    const title=document.createElement("div");
    title.textContent=cat;
    title.style.fontWeight="600";
    title.style.fontSize="12px";

    const delBtn=document.createElement("button");
    delBtn.type="button";
    delBtn.textContent="Delete Category";
    delBtn.className="btn btn-clear";
    delBtn.style.padding="4px 8px";
    delBtn.style.fontSize="10px";
    delBtn.addEventListener("click",()=>{
      if(!confirm(`Delete category "${cat}" and all its services?`)) return;
      delete servicePackages[cat];
      saveServicePackagesToStorage();
      renderServiceLibrary();
      refreshAllServiceAssignmentRows();
      renderDeptChips();
    });

    header.appendChild(title);
    header.appendChild(delBtn);
    card.appendChild(header);

    const svcList=document.createElement("div");
    svcList.className="popup-list";
    (servicePackages[cat]||[]).forEach((svc,idx)=>{
      const row=document.createElement("div");
      row.className="popup-list-item";

      const info=document.createElement("div");
      info.style.display="flex";
      info.style.flexDirection="column";
      info.style.gap="2px";
      info.innerHTML=`<strong>${svc.name}</strong><span style="color:#9ca3af;">${svc.minutes} mins · $${svc.price}</span>`;

      const controls=document.createElement("div");
      controls.style.display="flex";
      controls.style.gap="6px";
      controls.style.alignItems="center";

      const minutesInput=document.createElement("input");
      minutesInput.type="number";
      minutesInput.min="15";
      minutesInput.step="15";
      minutesInput.value=svc.minutes||90;
      minutesInput.style.width="70px";
      minutesInput.title="Estimated minutes";

      const priceInput=document.createElement("input");
      priceInput.type="number";
      priceInput.min="0";
      priceInput.step="1";
      priceInput.value=svc.price||0;
      priceInput.style.width="70px";
      priceInput.title="Price";

      const removeBtn=document.createElement("button");
      removeBtn.type="button";
      removeBtn.textContent="✕";
      removeBtn.className="btn btn-clear";
      removeBtn.style.padding="4px 8px";

      function persist(){
        const newMinutes=Math.max(15,parseInt(minutesInput.value,10)||90);
        const newPrice=parseFloat(priceInput.value)||0;
        servicePackages[cat][idx]={...svc,minutes:newMinutes,price:newPrice};
        saveServicePackagesToStorage();
        refreshAllServiceAssignmentRows();
        renderCalendar();
        renderServiceLibrary();
      }

      minutesInput.addEventListener("change",persist);
      priceInput.addEventListener("change",persist);

      removeBtn.addEventListener("click",()=>{
        if(!servicePackages[cat]) return;
        servicePackages[cat].splice(idx,1);
        saveServicePackagesToStorage();
        refreshAllServiceAssignmentRows();
        renderServiceLibrary();
        renderDeptChips();
      });

      controls.appendChild(minutesInput);
      controls.appendChild(priceInput);
      controls.appendChild(removeBtn);

      row.appendChild(info);
      row.appendChild(controls);
      svcList.appendChild(row);
    });
    card.appendChild(svcList);

    const addRow=document.createElement("div");
    addRow.style.display="grid";
    addRow.style.gridTemplateColumns="1fr 80px 80px auto";
    addRow.style.gap="6px";
    addRow.style.marginTop="6px";

    const input=document.createElement("input");
    input.type="text";
    input.placeholder="Add service";

    const minsInput=document.createElement("input");
    minsInput.type="number";
    minsInput.min="15";
    minsInput.step="15";
    minsInput.placeholder="Mins";

    const priceInput=document.createElement("input");
    priceInput.type="number";
    priceInput.min="0";
    priceInput.step="1";
    priceInput.placeholder="Price";

    const addBtn=document.createElement("button");
    addBtn.type="button";
    addBtn.textContent="Add";
    addBtn.className="btn btn-primary";
    addBtn.style.padding="6px 10px";
    addBtn.style.fontSize="11px";
    addBtn.addEventListener("click",()=>{
      const val=input.value.trim();
      const minsVal=Math.max(15,parseInt(minsInput.value,10)||90);
      const priceVal=parseFloat(priceInput.value)||0;
      if(!val) return;
      if(!servicePackages[cat]) servicePackages[cat]=[];
      if(servicePackages[cat].some(s=>s.name===val)){
        alert("Service already exists in this category.");
        return;
      }
      servicePackages[cat].push({name:val,minutes:minsVal,price:priceVal});
      saveServicePackagesToStorage();
      renderServiceLibrary();
      refreshAllServiceAssignmentRows();
      renderDeptChips();
    });

    addRow.appendChild(input);
    addRow.appendChild(minsInput);
    addRow.appendChild(priceInput);
    addRow.appendChild(addBtn);
    card.appendChild(addRow);

    serviceCategoriesList.appendChild(card);
  });
}
    serviceCategoriesList.appendChild(empty);
    return;
  }
  cats.forEach(cat=>{
    const card=document.createElement("div");
    card.style.border="1px solid rgba(255,255,255,0.12)";
    card.style.borderRadius="8px";
    card.style.padding="8px";
    card.style.marginBottom="6px";
    card.style.background="rgba(3,10,25,0.9)";

    const header=document.createElement("div");
    header.style.display="flex";
    header.style.justifyContent="space-between";
    header.style.alignItems="center";

    const title=document.createElement("div");
    title.textContent=cat;
    title.style.fontWeight="600";
    title.style.fontSize="12px";

    const delBtn=document.createElement("button");
    delBtn.type="button";
    delBtn.textContent="Delete Category";
    delBtn.className="btn btn-clear";
    delBtn.style.padding="4px 8px";
    delBtn.style.fontSize="10px";
    delBtn.addEventListener("click",()=>{
      if(!confirm(`Delete category "${cat}" and all its services?`)) return;
      delete servicePackages[cat];
      saveServicePackagesToStorage();
      renderServiceLibrary();
      refreshAllServiceAssignmentRows();
      renderDeptChips();
    });

    header.appendChild(title);
    header.appendChild(delBtn);
    card.appendChild(header);

    const svcList=document.createElement("div");
    svcList.className="popup-list";
    (servicePackages[cat]||[]).forEach((svc,idx)=>{
      const row=document.createElement("div");
      row.className="popup-list-item";

      const info=document.createElement("div");
      info.style.display="flex";
      info.style.flexDirection="column";
      info.style.gap="2px";
      info.innerHTML=`<strong>${svc.name}</strong><span style="color:#9ca3af;">${svc.minutes} mins · $${svc.price}</span>`;

      const controls=document.createElement("div");
      controls.style.display="flex";
      controls.style.gap="6px";
      controls.style.alignItems="center";

      const minutesInput=document.createElement("input");
      minutesInput.type="number";
      minutesInput.min="15";
      minutesInput.step="15";
      minutesInput.value=svc.minutes||90;
      minutesInput.style.width="70px";
      minutesInput.title="Estimated minutes";

      const priceInput=document.createElement("input");
      priceInput.type="number";
      priceInput.min="0";
      priceInput.step="1";
      priceInput.value=svc.price||0;
      priceInput.style.width="70px";
      priceInput.title="Price";

      const removeBtn=document.createElement("button");
      removeBtn.type="button";
      removeBtn.textContent="✕";
      removeBtn.className="btn btn-clear";
      removeBtn.style.padding="4px 8px";

      function persist(){
        const newMinutes=Math.max(15,parseInt(minutesInput.value,10)||90);
        const newPrice=parseFloat(priceInput.value)||0;
        servicePackages[cat][idx]={...svc,minutes:newMinutes,price:newPrice};
        saveServicePackagesToStorage();
        refreshAllServiceAssignmentRows();
        renderCalendar();
        renderServiceLibrary();
      }

      minutesInput.addEventListener("change",persist);
      priceInput.addEventListener("change",persist);

      removeBtn.addEventListener("click",()=>{
        if(!servicePackages[cat]) return;
        servicePackages[cat].splice(idx,1);
        saveServicePackagesToStorage();
        refreshAllServiceAssignmentRows();
        renderServiceLibrary();
        renderDeptChips();
      });

      controls.appendChild(minutesInput);
      controls.appendChild(priceInput);
      controls.appendChild(removeBtn);

      row.appendChild(info);
      row.appendChild(controls);
      svcList.appendChild(row);
    });
    card.appendChild(svcList);

    const addRow=document.createElement("div");
    addRow.style.display="grid";
    addRow.style.gridTemplateColumns="1fr 80px 80px auto";
    addRow.style.gap="6px";
    addRow.style.marginTop="6px";

    const input=document.createElement("input");
    input.type="text";
    input.placeholder="Add service";

    const minsInput=document.createElement("input");
    minsInput.type="number";
    minsInput.min="15";
    minsInput.step="15";
    minsInput.placeholder="Mins";

    const priceInput=document.createElement("input");
    priceInput.type="number";
    priceInput.min="0";
    priceInput.step="1";
    priceInput.placeholder="Price";

    const addBtn=document.createElement("button");
    addBtn.type="button";
    addBtn.textContent="Add";
    addBtn.className="btn btn-primary";
    addBtn.style.padding="6px 10px";
    addBtn.style.fontSize="11px";
    addBtn.addEventListener("click",()=>{
      const val=input.value.trim();
      const minsVal=Math.max(15,parseInt(minsInput.value,10)||90);
      const priceVal=parseFloat(priceInput.value)||0;
      if(!val) return;
      if(!servicePackages[cat]) servicePackages[cat]=[];
      if(servicePackages[cat].some(s=>s.name===val)){
        alert("Service already exists in this category.");
        return;
      }
      servicePackages[cat].push({name:val,minutes:minsVal,price:priceVal});
      saveServicePackagesToStorage();
      renderServiceLibrary();
      refreshAllServiceAssignmentRows();
      renderDeptChips();
    });

    addRow.appendChild(input);
    addRow.appendChild(minsInput);
    addRow.appendChild(priceInput);
    addRow.appendChild(addBtn);
    card.appendChild(addRow);

    serviceCategoriesList.appendChild(card);
  });
}

btnAddCategory.addEventListener("click",()=>{
  const name=inputNewCategoryName.value.trim();
  if(!name) return;
  if(servicePackages[name]){
    alert("That category already exists.");
    return;
  }
  servicePackages[name]=[];
  saveServicePackagesToStorage();
  inputNewCategoryName.value="";
  renderServiceLibrary();
  refreshAllServiceAssignmentRows();
  renderDeptChips();         // <-- NEW
});


// Events utilities
function getEventsForDay(dateIso){return events.filter(ev=>ev.date===dateIso);}
function generateDeptColor(dept) {
  let hash = 0;
  for (let i = 0; i < dept.length; i++) {
    hash = dept.charCodeAt(i) + ((hash << 5) - hash);
  }
  const hue = Math.abs(hash) % 360;
  return `hsl(${hue}, 70%, 55%)`;
}
function isShopClosedAt(dateIso, time){
  const d = parseISODate(dateIso);
  if(!d) return false;
  const dow = getDayName(d);

  // Holiday?
  if(shopHolidays.some(h=>h.date===dateIso)) return true;

  const cfg = officeHours[dow];
  if(!cfg || cfg.closed) return true;

  const mins = timeToMinutes(time);
  const openMin = timeToMinutes(cfg.open);
  const closeMin = timeToMinutes(cfg.close);
  return (mins < openMin || mins >= closeMin);
}

function renderDeptChips() {
  const container = document.getElementById("chipsContainer");
  if (!container) return;

  container.innerHTML = "";

  // "All" chip
  const allChip = document.createElement("div");
  allChip.className = "chip active";
  allChip.dataset.dept = "All";
  allChip.innerHTML = `<span class="dot" style="background:#000;"></span>All`;
  container.appendChild(allChip);

  // One chip per service category from servicePackages
  const categories = Object.keys(servicePackages).sort();

  categories.forEach(cat => {
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.dataset.dept = cat;

    const color = generateDeptColor(cat);

    chip.innerHTML = `
      <span class="dot" style="background:${color};"></span>${cat}
    `;

    container.appendChild(chip);
  });

  // Chip click handling
  container.querySelectorAll(".chip").forEach(ch => {
    ch.addEventListener("click", () => {
      container.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
      ch.classList.add("active");

      selectedDeptFilter = ch.dataset.dept;
      renderCalendar();
    });
  });
}

function renderDealerQueue(){
  const dateIso=toISODate(currentDate);
  const todays=getEventsForDay(dateIso).filter(ev=>ev.type==="job" && ev.tech==="Dealer");
  if(!todays.length){
    dealerQueueListEl.className="dealer-queue-empty";
    dealerQueueListEl.textContent="No dealer jobs queued for this day.";
    return;
  }
  dealerQueueListEl.className="";
  dealerQueueListEl.innerHTML="";
  todays.sort((a,b)=>a.time.localeCompare(b.time)).forEach(ev=>{
    const item=document.createElement("div");
    item.className="dealer-queue-item";
    item.dataset.eventId=ev.id;
    item.style.cursor="pointer";

    const main=document.createElement("div");
    main.style.display="flex";
    main.style.flexDirection="column";
    main.style.gap="2px";

    const t=document.createElement("span");
    t.textContent=ev.time;
    t.style.fontWeight="600";
    main.appendChild(t);

    const n=document.createElement("span");
    n.textContent=(ev.customerName||"Dealer Job");
    main.appendChild(n);

    const s=document.createElement("span");
    s.textContent=`${ev.dept||""} · ${ev.serviceName||ev.label||""}`;
    s.style.fontSize="10px";
    main.appendChild(s);

    const badges=document.createElement("div");
    badges.style.display="flex";
    badges.style.flexDirection="column";
    badges.style.gap="2px";
    badges.style.alignItems="flex-end";

    const db=document.createElement("div");
    db.className="dq-badge";
    db.textContent="Dealer";
    badges.appendChild(db);

    if(ev.customerWaiting){
      const b=document.createElement("div");
      b.className="dq-badge";
      b.textContent="Waiting";
      badges.appendChild(b);
    }
    if(ev.rideNeeded){
      const b=document.createElement("div");
      b.className="dq-badge";
      b.textContent="Ride";
      badges.appendChild(b);
    }
    if(ev.pickupDelivery){
      const b=document.createElement("div");
      b.className="dq-badge";
      b.textContent="Pickup/Delivery";
      badges.appendChild(b);
    }

    item.appendChild(main);
    item.appendChild(badges);
    dealerQueueListEl.appendChild(item);
  });
}

function renderEventDetails(ev){
  if(!ev){
    eventDetailsEl.className="event-details-empty";
    eventDetailsEl.textContent="Click an appointment pill to view details. Click again to edit.";
    return;
  }
  eventDetailsEl.className="";
  eventDetailsEl.innerHTML="";
  function row(label,val){
    const r=document.createElement("div");
    r.className="event-details-row";
    const l=document.createElement("div");
    l.className="event-details-label";
    l.textContent=label;
    const v=document.createElement("div");
    v.className="event-details-value";
    v.textContent=val||"—";
    r.appendChild(l);
    r.appendChild(v);
    eventDetailsEl.appendChild(r);
  }
  if(ev.type==="job"){
    row("Type","Appointment");
    const groupKey=ev.jobGroupId||ev.id;
    const groupEvents=events.filter(x=>x.type==="job" && (x.jobGroupId||x.id)===groupKey);
    const totalPrice=groupEvents.reduce((sum,x)=>sum+(x.price||0),0);
    const totalMinutes=groupEvents.reduce((sum,x)=>sum+(x.minutes||0),0);
    const statusText=`${ev.status||"Scheduled"}`+(ev.paid?" · Paid":ev.invoiced?" · Invoiced":"");
    row("Status",statusText);
    row("Customer",ev.customerName||"");
    if(groupEvents.length>1){
      const summary=groupEvents.map(x=>{
        const base=`${x.dept||""}${x.serviceName?" – "+x.serviceName:""}`;
        const techPart=x.tech?` (${x.tech} @ ${x.time||""})`:"";
        return base+techPart;
      }).join(" | ");
      row("Services",summary);
    }else{
      row("Dept / Service",`${ev.dept||""}${ev.serviceName?" · "+ev.serviceName:""}`);
    }
    row("Estimated",`${totalMinutes||0} mins · $${totalPrice.toFixed(2)}`);
  }else{
    row("Type","Time Off");
    row("Tech",ev.tech||"");
    row("Note",ev.notes||"");
  }
  if(ev.type==="job"){
    row("Type","Appointment");
    const groupKey=ev.jobGroupId||ev.id;
    const groupEvents=events.filter(x=>x.type==="job" && (x.jobGroupId||x.id)===groupKey);
    const totalPrice=groupEvents.reduce((sum,x)=>sum+(x.price||0),0);
    const totalMinutes=groupEvents.reduce((sum,x)=>sum+(x.minutes||0),0);
    const statusText=`${ev.status||"Scheduled"}`+(ev.paid?" · Paid":ev.invoiced?" · Invoiced":"");
    row("Status",statusText);
    row("Customer",ev.customerName||"");
    if(groupEvents.length>1){
      const summary=groupEvents.map(x=>{
        const base=`${x.dept||""}${x.serviceName?" – "+x.serviceName:""}`;
        const techPart=x.tech?` (${x.tech} @ ${x.time||""})`:"";
        return base+techPart;
      }).join(" | ");
      row("Services",summary);
    }else{
      row("Dept / Service",`${ev.dept||""}${ev.serviceName?" · "+ev.serviceName:""}`);
    }
    row("Estimated",`${totalMinutes||0} mins · $${totalPrice.toFixed(2)}`);
  }else{
    row("Type","Time Off");
    row("Tech",ev.tech||"");
    row("Note",ev.notes||"");
  }
  row("Tech",ev.tech||"");
  row("Date",ev.date||"");
  row("Time",ev.time||"");
  if(ev.type==="job"){
    row("Dealer",ev.dealer?"Yes":"No");
    row("Customer Waiting",ev.customerWaiting?"Yes":"No");
    row("Ride Needed",ev.rideNeeded?"Yes":"No");
    row("Ride Time",ev.rideTime||"");
    let pdVal=ev.pickupDelivery?"Yes":"No";
    if(ev.pickupDelivery){
      const p=ev.pickupTime?`Pickup: ${ev.pickupTime}`:"";
      const d=ev.deliveryTime?`Delivery: ${ev.deliveryTime}`:"";
      pdVal=[p,d].filter(Boolean).join(" · ")||"Yes";
    }
    row("Pickup/Delivery",pdVal);
    row("Notes",ev.notes||"");
  }
}

// Calendar rendering
  function renderCalendar(){
    const dateIso=toISODate(currentDate);
    const dayName=getDayName(currentDate);
  const todays=getEventsForDay(dateIso);
  const coverageMap=new Map();
  todays.forEach(ev=>{
    if(ev.type!=="job") return;
    if(!ev.serviceProgress) ev.serviceProgress="In Queue";
    if(selectedDeptFilter!=="All" && ev.dept!==selectedDeptFilter) return;
      const duration=ev.minutes||90;
      const startIdx=workTimes.indexOf(ev.time);
      if(startIdx===-1) return;
      const slotsNeeded=Math.max(1,Math.ceil(duration/30));
      for(let i=0;i<slotsNeeded;i++){
        const slot=workTimes[startIdx+i];
        if(!slot) break;
        const key=`${ev.tech}-${slot}`;
        if(!coverageMap.has(key)) coverageMap.set(key,[]);
        coverageMap.get(key).push(ev);
      }
    });

    headerRowEl.innerHTML="";
  function renderCalendar(){
    const dateIso=toISODate(currentDate);
    const dayName=getDayName(currentDate);
  const todays=getEventsForDay(dateIso);
  const coverageMap=new Map();
  todays.forEach(ev=>{
    if(ev.type!=="job") return;
    if(!ev.serviceProgress) ev.serviceProgress="In Queue";
    if(selectedDeptFilter!=="All" && ev.dept!==selectedDeptFilter) return;
      const duration=ev.minutes||90;
      const startIdx=workTimes.indexOf(ev.time);
      if(startIdx===-1) return;
      const slotsNeeded=Math.max(1,Math.ceil(duration/30));
      for(let i=0;i<slotsNeeded;i++){
        const slot=workTimes[startIdx+i];
        if(!slot) break;
        const key=`${ev.tech}-${slot}`;
        if(!coverageMap.has(key)) coverageMap.set(key,[]);
        coverageMap.get(key).push(ev);
      }
    });

    headerRowEl.innerHTML="";
  const timeHead=document.createElement("div");
  timeHead.className="cal-header-cell";
  timeHead.textContent="";
  headerRowEl.appendChild(timeHead);
  techs.forEach(t=>{
    const c=document.createElement("div");
    c.className="cal-header-cell";
    c.innerHTML=`<strong>${t}</strong>`;
    headerRowEl.appendChild(c);
  });

  dayLabelEl.textContent=formatDateLabel(currentDate);
  if(dayPickerEl) dayPickerEl.value=dateIso;

  bodyEl.innerHTML="";
  workTimes.forEach(time=>{
    const row=document.createElement("div");
    row.className="cal-row";
    const timeCell=document.createElement("div");
    timeCell.className="cal-time-cell";
    timeCell.textContent=formatTimeFriendly(time);
    row.appendChild(timeCell);
    const mins=timeToMinutes(time);

    techs.forEach(tech=>{
      const cell=document.createElement("div");
      cell.className="cal-slot-cell";
      cell.dataset.tech=tech;
      cell.dataset.time=time;

      const sched=techSchedules[tech][dayName];
      if(!sched || sched.off){
        cell.classList.add("off-shift");
      }else{
        const s=timeToMinutes(sched.start),e=timeToMinutes(sched.end);
        if(mins<s || mins>=e) cell.classList.add("off-shift");
      }
      // Shop closed logic (office hours + holidays)
      const dateIso = toISODate(currentDate);
      const officeCfg = officeHours[dayName];
      let shopClosed = false;

      // Holiday = always closed
      if(shopHolidays.some(h=>h.date===dateIso)){
        shopClosed = true;
      }else if(!officeCfg || officeCfg.closed){
        shopClosed = true;
      }else{
        const openMin = timeToMinutes(officeCfg.open);
        const closeMin = timeToMinutes(officeCfg.close);
        if(mins < openMin || mins >= closeMin){
          shopClosed = true;
        }
      }

        if(shopClosed){
          cell.classList.add("shop-closed");
        }

        const coverKey=`${tech}-${time}`;
        const coveringJobs=coverageMap.get(coverKey)||[];
        const hasStartHere=coveringJobs.some(ev=>ev.time===time);
        if(coveringJobs.length && !hasStartHere){
          cell.classList.add("blocked-slot");
        }

        const inner=document.createElement("div");
        inner.className="cal-slot-inner";

        // blocked slots simply show a continuous tinted span without duplicating pills

      const cellEvents=todays.filter(ev=>
        ev.tech===tech &&
        ev.time===time &&
        if(shopClosed){
          cell.classList.add("shop-closed");
        }

        const coverKey=`${tech}-${time}`;
        const coveringJobs=coverageMap.get(coverKey)||[];
        const hasStartHere=coveringJobs.some(ev=>ev.time===time);
        if(coveringJobs.length && !hasStartHere){
          cell.classList.add("blocked-slot");
        }

        const inner=document.createElement("div");
        inner.className="cal-slot-inner";

        if(coveringJobs.length && !hasStartHere){
          const previewJob=[...coveringJobs].sort((a,b)=>timeToMinutes(a.time)-timeToMinutes(b.time))[0];
          const diff=timeToMinutes(time)-timeToMinutes(previewJob.time);
          if(previewJob && diff===30){
            const preview=document.createElement("div");
            preview.className="blocked-preview";
            const meta=statusMeta(previewJob.status||"Scheduled");
            const icon=document.createElement("span");
            icon.className=`event-status-icon ${meta.className}`;
            icon.textContent=meta.icon;
            preview.appendChild(icon);

            const svcMeta=serviceProgressMeta(previewJob.serviceProgress||"In Queue");
            const svcIcon=document.createElement("span");
            svcIcon.className=`service-progress-icon ${svcMeta.className}`;
            svcIcon.textContent=svcMeta.icon;
            preview.appendChild(svcIcon);

            const text=document.createElement("span");
            text.className="blocked-text";
            const parts=[];
            if(previewJob.customerName) parts.push(previewJob.customerName);
            if(previewJob.serviceName||previewJob.label) parts.push(previewJob.serviceName||previewJob.label);
            text.textContent=parts.join(" • ")||"Booked";
            preview.appendChild(text);
            if(previewJob.invoiced||previewJob.paid){
              const dollar=document.createElement("span");
              dollar.className=`invoice-icon ${previewJob.paid?"paid":"pending"}`;
              dollar.textContent="$";
              preview.appendChild(dollar);
            }
            inner.appendChild(preview);
          }
        }

      const cellEvents=todays.filter(ev=>
        ev.tech===tech &&
        ev.time===time &&
        (selectedDeptFilter==="All" || ev.dept===selectedDeptFilter || (ev.type==="timeoff" && selectedDeptFilter==="All"))
      );

      const hasTimeOffHere=todays.some(ev=>ev.type==="timeoff" && ev.tech===tech && ev.time===time);
      if(hasTimeOffHere){
        cell.classList.add("timeoff-block");
      }

      cellEvents.forEach(ev=>{
        if(ev.type==="timeoff"){
          const currentIndex=workTimes.indexOf(ev.time);
          const prevTime=currentIndex>0?workTimes[currentIndex-1]:null;
          const hasPrevTimeOff=prevTime
            ? todays.some(prevEv=>prevEv.type==="timeoff" && prevEv.tech===tech && prevEv.time===prevTime)
            : false;
          if(hasPrevTimeOff){
            return;
          }
        }

        if(ev.type!=="job"){
          const pill=document.createElement("div");
          let cls="event-pill ";
          if(ev.type==="timeoff") cls+="event-timeoff";
          else if(ev.dept==="Detailing") cls+="event-detailing";
          else if(ev.dept==="Tint") cls+="event-tint";
          else if(ev.dept==="PPF") cls+="event-ppf";
          else if(ev.dept==="Ceramic") cls+="event-ceramic";
          else if(ev.dept==="Electronics") cls+="event-electronics";
          pill.className=cls;
          pill.dataset.eventId=ev.id;

          let label=ev.label||ev.serviceName||"Job";
          if(ev.type==="job" && ev.customerName) label=`${ev.customerName} – ${label}`;
          const span=document.createElement("span");
          span.textContent=label;
          pill.appendChild(span);

          inner.appendChild(pill);
        }
      });
      cellEvents.forEach(ev=>{
        if(ev.type==="timeoff"){
          const currentIndex=workTimes.indexOf(ev.time);
          const prevTime=currentIndex>0?workTimes[currentIndex-1]:null;
          const hasPrevTimeOff=prevTime
            ? todays.some(prevEv=>prevEv.type==="timeoff" && prevEv.tech===tech && prevEv.time===prevTime)
            : false;
          if(hasPrevTimeOff){
            return;
          }
        }

          const pill=document.createElement("div");
          let cls="event-pill ";
          if(ev.type==="timeoff") cls+="event-timeoff";
          else if(ev.dept==="Detailing") cls+="event-detailing";
          else if(ev.dept==="Tint") cls+="event-tint";
          else if(ev.dept==="PPF") cls+="event-ppf";
          else if(ev.dept==="Ceramic") cls+="event-ceramic";
          else if(ev.dept==="Electronics") cls+="event-electronics";
          pill.className=cls;
          pill.dataset.eventId=ev.id;

          let label=ev.label||ev.serviceName||"Job";
          if(ev.type==="job" && ev.customerName) label=`${ev.customerName} – ${label}`;
        if(ev.type==="job"){
          const meta=statusMeta(ev.status||"Scheduled");
          const statusSpan=document.createElement("span");
          statusSpan.className=`event-status-icon ${meta.className}`;
          statusSpan.textContent=meta.icon;
          pill.appendChild(statusSpan);

          const progMeta=serviceProgressMeta(ev.serviceProgress||"In Queue");
          const progSpan=document.createElement("span");
          progSpan.className=`service-progress-icon ${progMeta.className}`;
          progSpan.textContent=progMeta.icon;
          pill.appendChild(progSpan);
        }
        const span=document.createElement("span");
        span.textContent=label;
        pill.appendChild(span);

          if(ev.type==="job"){
            if(ev.invoiced || ev.paid){
              const dollar=document.createElement("span");
              dollar.className=`invoice-icon ${ev.paid?"paid":"pending"}`;
              dollar.textContent="$";
              pill.appendChild(dollar);
            }
            if(ev.dealer){
              const b=document.createElement("span");
              b.className="small-badge";
            b.textContent="D";
            pill.appendChild(b);
          }
          if(ev.customerWaiting){
            const b=document.createElement("span");
            b.className="small-badge";
            b.textContent="W";
            pill.appendChild(b);
          }
          if(ev.rideNeeded){
            const b=document.createElement("span");
            b.className="small-badge";
            b.textContent="R";
            pill.appendChild(b);
          }
          if(ev.pickupDelivery){
            const b=document.createElement("span");
            b.className="small-badge";
            b.textContent="P/D";
            pill.appendChild(b);
          }
        }

        inner.appendChild(pill);
      });

      cell.appendChild(inner);
      row.appendChild(cell);
    });

    bodyEl.appendChild(row);
  });

  // render full-span bubbles for job events
  const visibleJobs=todays.filter(ev=>ev.type==="job" && (selectedDeptFilter==="All" || ev.dept===selectedDeptFilter));
  visibleJobs.forEach(ev=>{
    const startCell=bodyEl.querySelector(`.cal-slot-cell[data-tech="${ev.tech}"][data-time="${ev.time}"]`);
    if(!startCell) return;
    const duration=ev.minutes||90;
    const slotsNeeded=Math.max(1,Math.ceil(duration/30));
    const cellHeight=startCell.offsetHeight||32;
    const bubbleHeight=Math.max(cellHeight,(cellHeight*slotsNeeded)-6);
    const bubble=document.createElement("div");
    let cls="event-bubble ";
    if(ev.dept==="Detailing") cls+="event-detailing";
    else if(ev.dept==="Tint") cls+="event-tint";
    else if(ev.dept==="PPF") cls+="event-ppf";
    else if(ev.dept==="Ceramic") cls+="event-ceramic";
    else if(ev.dept==="Electronics") cls+="event-electronics";
    bubble.className=cls;
    bubble.dataset.eventId=ev.id;
    bubble.style.top=`${startCell.offsetTop+3}px`;
    bubble.style.left=`${startCell.offsetLeft+3}px`;
    bubble.style.width=`${(startCell.offsetWidth||100)-6}px`;
    bubble.style.height=`${bubbleHeight}px`;

    const topRow=document.createElement("div");
    topRow.className="bubble-top";
    const meta=statusMeta(ev.status||"Scheduled");
    const statusSpan=document.createElement("span");
    statusSpan.className=`event-status-icon ${meta.className}`;
    statusSpan.textContent=meta.icon;
    topRow.appendChild(statusSpan);

    const progMeta=serviceProgressMeta(ev.serviceProgress||"In Queue");
    const progSpan=document.createElement("span");
    progSpan.className=`service-progress-icon ${progMeta.className}`;
    progSpan.textContent=progMeta.icon;
    topRow.appendChild(progSpan);

    const title=document.createElement("span");
    title.className="bubble-title";
    const label=ev.customerName?`${ev.customerName} – ${ev.serviceName||ev.label||"Job"}`:(ev.serviceName||ev.label||"Job");
    title.textContent=label;
    topRow.appendChild(title);
    bubble.appendChild(topRow);

    const bubbleMeta=document.createElement("div");
    bubbleMeta.className="bubble-meta";
    if(ev.invoiced||ev.paid){
      const dollar=document.createElement("span");
      dollar.className=`invoice-icon ${ev.paid?"paid":"pending"}`;
      dollar.textContent="$";
      bubbleMeta.appendChild(dollar);
    }
    if(ev.dealer){
      const b=document.createElement("span");
      b.className="small-badge";
      b.textContent="D";
      bubbleMeta.appendChild(b);
    }
    if(ev.customerWaiting){
      const b=document.createElement("span");
      b.className="small-badge";
      b.textContent="W";
      bubbleMeta.appendChild(b);
    }
    if(ev.rideNeeded){
      const b=document.createElement("span");
      b.className="small-badge";
      b.textContent="R";
      bubbleMeta.appendChild(b);
    }
    if(ev.pickupDelivery){
      const b=document.createElement("span");
      b.className="small-badge";
      b.textContent="P/D";
      bubbleMeta.appendChild(b);
    }
    if(bubbleMeta.childNodes.length){
      bubble.appendChild(bubbleMeta);
    }

    const preview=document.createElement("div");
    preview.className="bubble-row";
    preview.textContent=`${ev.serviceName||"Service"} · ${ev.time||""}`;
    bubble.appendChild(preview);

    bodyEl.appendChild(bubble);
  });

  if(selectedSlot){
    const sel=`.cal-slot-cell[data-tech="${selectedSlot.tech}"][data-time="${selectedSlot.time}"]`;
    const c=bodyEl.querySelector(sel);
    if(c) c.classList.add("selected");
  }
  const selectedEvent=events.find(ev=>ev.id===selectedEventId);
  renderEventDetails(selectedEvent);
  renderDealerQueue();
}

// Slot selection
  function setSelectedSlot(tech,time){
    selectedSlot={tech,time};
    if(!editingJobGroupId) setAppointmentFormLocked(false);
    bodyEl.querySelectorAll(".cal-slot-cell").forEach(c=>c.classList.remove("selected"));
  function setSelectedSlot(tech,time){
    selectedSlot={tech,time};
    if(!editingJobGroupId) setAppointmentFormLocked(false);
    bodyEl.querySelectorAll(".cal-slot-cell").forEach(c=>c.classList.remove("selected"));
  const sel=`.cal-slot-cell[data-tech="${tech}"][data-time="${time}"]`;
  const c=bodyEl.querySelector(sel);if(c)c.classList.add("selected");
  const iso=toISODate(currentDate);
  const dateInput=document.getElementById("datePicker");
  if(dateInput)dateInput.value=iso;

  ensureAtLeastOneServiceRow();
  const firstRow=serviceAssignmentsContainer.querySelector(".service-row");
  if(firstRow){
    const techSelect=firstRow.querySelector(".sa-tech");
    const timeSelect=firstRow.querySelector(".sa-time");
    if(techSelect) techSelect.value=tech;
    if(timeSelect) timeSelect.value=time;
  }

  if(statusEl)statusEl.textContent=`Selected ${tech} at ${time} on ${iso}.`;
  if(!editingJobGroupId){
    btnCreateAppointment.textContent="Save to Zapier";
  }else{
    btnCreateAppointment.textContent="Update Appointment";
  }
}

// Seed dummy events
function seedDummyEvents(){
  const todayIso=toISODate(currentDate);
  let idCounter=1;
    const base=[
      {tech:"William",dept:"Detailing",type:"job",serviceName:"Full Detail",label:"Full Detail – F-150",time:"09:00",minutes:210,price:450,status:"Scheduled",dealer:false,customerName:"Smith",serviceProgress:"In Queue"},
      {tech:"Limage",dept:"Detailing",type:"job",serviceName:"Interior Detail",label:"Interior – Civic",time:"10:00",minutes:150,price:275,status:"Scheduled",dealer:true,pickupDelivery:true,pickupTime:"08:30",deliveryTime:"17:00",customerName:"Zeigler",serviceProgress:"In Queue"},
      {tech:"Matt",dept:"Tint",type:"job",serviceName:"Full Tint",label:"Full Tint – Model 3",time:"09:30",minutes:120,price:380,status:"Scheduled",dealer:true,rideNeeded:true,rideTime:"09:00",customerWaiting:true,customerName:"Jones",serviceProgress:"In Queue"},
      {tech:"Matt",dept:"PPF",type:"job",serviceName:"Full Front PPF",label:"Full Front – Supra",time:"12:00",minutes:240,price:1600,status:"Scheduled",dealer:false,customerName:"Taylor",serviceProgress:"In Queue"},
      {tech:"William",dept:"Ceramic",type:"job",serviceName:"5 Year Coating",label:"5yr – Silverado",time:"14:00",minutes:240,price:1400,status:"Scheduled",dealer:false,customerName:"Clark",serviceProgress:"In Queue"},
      {tech:"Fafa",dept:"Detailing",type:"job",serviceName:"Quick Clean",label:"Quick Clean – CR-V",time:"15:00",minutes:60,price:120,status:"Scheduled",dealer:false,customerName:"Lopez",serviceProgress:"In Queue"},
      {tech:"Matt",dept:"Electronics",type:"job",serviceName:"Remote Start",label:"Remote Start – RAM",time:"11:00",minutes:120,price:450,status:"Scheduled",dealer:true,pickupDelivery:true,pickupTime:"10:30",deliveryTime:"16:30",customerName:"Davis",serviceProgress:"In Queue"},
      {tech:"William",dept:"Detailing",type:"timeoff",label:"Time Off",time:"13:00",notes:"Doctor appt"}
    ];
    events=base.map(e=>{
      const id="seed-"+(idCounter++);
      return {...e,id,date:todayIso,jobGroupId: e.type==="job" ? id : undefined};
    });
  }
    const base=[
      {tech:"William",dept:"Detailing",type:"job",serviceName:"Full Detail",label:"Full Detail – F-150",time:"09:00",minutes:210,price:450,status:"Scheduled",dealer:false,customerName:"Smith",serviceProgress:"In Queue"},
      {tech:"Limage",dept:"Detailing",type:"job",serviceName:"Interior Detail",label:"Interior – Civic",time:"10:00",minutes:150,price:275,status:"Scheduled",dealer:true,pickupDelivery:true,pickupTime:"08:30",deliveryTime:"17:00",customerName:"Zeigler",serviceProgress:"In Queue"},
      {tech:"Matt",dept:"Tint",type:"job",serviceName:"Full Tint",label:"Full Tint – Model 3",time:"09:30",minutes:120,price:380,status:"Scheduled",dealer:true,rideNeeded:true,rideTime:"09:00",customerWaiting:true,customerName:"Jones",serviceProgress:"In Queue"},
      {tech:"Matt",dept:"PPF",type:"job",serviceName:"Full Front PPF",label:"Full Front – Supra",time:"12:00",minutes:240,price:1600,status:"Scheduled",dealer:false,customerName:"Taylor",serviceProgress:"In Queue"},
      {tech:"William",dept:"Ceramic",type:"job",serviceName:"5 Year Coating",label:"5yr – Silverado",time:"14:00",minutes:240,price:1400,status:"Scheduled",dealer:false,customerName:"Clark",serviceProgress:"In Queue"},
      {tech:"Fafa",dept:"Detailing",type:"job",serviceName:"Quick Clean",label:"Quick Clean – CR-V",time:"15:00",minutes:60,price:120,status:"Scheduled",dealer:false,customerName:"Lopez",serviceProgress:"In Queue"},
      {tech:"Matt",dept:"Electronics",type:"job",serviceName:"Remote Start",label:"Remote Start – RAM",time:"11:00",minutes:120,price:450,status:"Scheduled",dealer:true,pickupDelivery:true,pickupTime:"10:30",deliveryTime:"16:30",customerName:"Davis",serviceProgress:"In Queue"},
      {tech:"William",dept:"Detailing",type:"timeoff",label:"Time Off",time:"13:00",notes:"Doctor appt"}
    ];
    events=base.map(e=>{
      const id="seed-"+(idCounter++);
      return {...e,id,date:todayIso,jobGroupId: e.type==="job" ? id : undefined};
    });
  }

// Panels
function setPanel(mode){
  appointmentPanel.style.display=mode==="appointments"?"block":"none";
  timeOffPanel.style.display=mode==="timeoff"?"block":"none";
  schedulesPanel.style.display=mode==="schedules"?"block":"none";
  servicesPanel.style.display=mode==="services"?"block":"none";
  headerBtnAppointments.classList.toggle("active",mode==="appointments");
  headerBtnTimeOff.classList.toggle("active",mode==="timeoff");
  headerBtnSchedules.classList.toggle("active",mode==="schedules");
  headerBtnServices.classList.toggle("active",mode==="services");
}

// Schedules panel
function loadScheduleIntoForm(tech){
  days.forEach(d=>{
    const s=document.getElementById(`sched_${d}_start`);
    const e=document.getElementById(`sched_${d}_end`);
    const o=document.getElementById(`sched_${d}_off`);
    if(!tech){
      s.value="09:00";e.value="17:00";o.checked=false;s.disabled=false;e.disabled=false;
      return;
    }
    const cfg=techSchedules[tech][d];
    s.value=cfg.start;
    e.value=cfg.end;
    o.checked=cfg.off;
    s.disabled=cfg.off;
    e.disabled=cfg.off;
  });
}
function attachOffCheckboxHandlers(){
  days.forEach(d=>{
    const o=document.getElementById(`sched_${d}_off`);
    const s=document.getElementById(`sched_${d}_start`);
    const e=document.getElementById(`sched_${d}_end`);
    o.addEventListener("change",()=>{
      const off=o.checked;
      s.disabled=off;
      e.disabled=off;
    });
  });
}
function loadOfficeHoursIntoForm(){
  days.forEach(d=>{
    const openEl = document.getElementById(`office_${d}_open`);
    const closeEl = document.getElementById(`office_${d}_close`);
    const closedEl = document.getElementById(`office_${d}_closed`);
    const cfg = officeHours[d] || { open:"09:00", close:"17:00", closed:false };

    if(openEl) openEl.value = cfg.open;
    if(closeEl) closeEl.value = cfg.close;
    if(closedEl){
      closedEl.checked = !!cfg.closed;
      const disabled = !!cfg.closed;
      if(openEl) openEl.disabled = disabled;
      if(closeEl) closeEl.disabled = disabled;
    }
  });
}

function attachOfficeClosedCheckboxHandlers(){
  days.forEach(d=>{
    const closedEl = document.getElementById(`office_${d}_closed`);
    const openEl = document.getElementById(`office_${d}_open`);
    const closeEl = document.getElementById(`office_${d}_close`);
    if(!closedEl) return;
    closedEl.addEventListener("change",()=>{
      const disabled = closedEl.checked;
      if(openEl) openEl.disabled = disabled;
      if(closeEl) closeEl.disabled = disabled;
    });
  });
}

function saveOfficeHoursFromForm(){
  days.forEach(d=>{
    const openEl = document.getElementById(`office_${d}_open`);
    const closeEl = document.getElementById(`office_${d}_close`);
    const closedEl = document.getElementById(`office_${d}_closed`);
    officeHours[d] = {
      open: openEl && openEl.value ? openEl.value : "09:00",
      close: closeEl && closeEl.value ? closeEl.value : "17:00",
      closed: !!(closedEl && closedEl.checked)
    };
  });
  saveOfficeHoursToStorage();
  renderCalendar();
}
function renderHolidayList(){
  const listEl = document.getElementById("holidayList");
  if(!listEl) return;
  if(!shopHolidays.length){
    listEl.textContent = "No holidays configured.";
    listEl.className = "timeoff-note";
    return;
  }
  listEl.innerHTML = "";
  shopHolidays
    .slice()
    .sort((a,b)=>a.date.localeCompare(b.date))
    .forEach((h,idx)=>{
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.justifyContent = "space-between";
      row.style.alignItems = "center";
      row.style.fontSize = "12px";
      row.style.padding = "2px 0";

      const left = document.createElement("div");
      left.textContent = `${h.date} – ${h.label || "Holiday"}`;

      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = "Remove";
      btn.className = "btn btn-clear";
      btn.style.padding = "4px 8px";
      btn.style.fontSize = "10px";
      btn.addEventListener("click",()=>{
        shopHolidays.splice(idx,1);
        saveShopHolidaysToStorage();
        renderHolidayList();
        renderCalendar();
      });

      row.appendChild(left);
      row.appendChild(btn);
      listEl.appendChild(row);
    });
}
const btnAddHoliday = document.getElementById("btnAddHoliday");
if(btnAddHoliday){
  btnAddHoliday.addEventListener("click",()=>{
    const dateEl = document.getElementById("holidayDateInput");
    const labelEl = document.getElementById("holidayLabelInput");
    const date = dateEl ? dateEl.value.trim() : "";
    const label = labelEl ? labelEl.value.trim() : "";
    if(!date){
      alert("Pick a holiday date first.");
      return;
    }
    if(shopHolidays.some(h=>h.date===date)){
      alert("That date is already in the holiday list.");
      return;
    }
    shopHolidays.push({date,label});
    saveShopHolidaysToStorage();
    renderHolidayList();
    renderCalendar();
    if(labelEl) labelEl.value = "";
  });
}

function saveScheduleFromForm(){
  const tech=scheduleTechSelect.value;
  if(!tech){scheduleStatus.textContent="Choose a tech first.";return;}
  days.forEach(d=>{
    const s=document.getElementById(`sched_${d}_start`);
    const e=document.getElementById(`sched_${d}_end`);
    const o=document.getElementById(`sched_${d}_off`);
    techSchedules[tech][d]={start:s.value||"09:00",end:e.value||"17:00",off:o.checked};
  });
  saveSchedulesToStorage();
  scheduleStatus.textContent=`Schedule saved for ${tech}.`;
  renderCalendar();
}

// Time off logic
function saveTimeOff(){
  const tech=document.getElementById("timeOffTechnician").value;
  const startDate=document.getElementById("timeOffStartDate").value;
  const endDate=document.getElementById("timeOffEndDate").value||startDate;
  const startTime=document.getElementById("timeOffStartTime").value;
  const endTime=document.getElementById("timeOffEndTime").value;
  const allDay=document.getElementById("timeOffAllDay") ? document.getElementById("timeOffAllDay").checked : false;
  const notes=document.getElementById("timeOffNotes").value;
  if(!tech||!startDate){alert("Tech and start date are required.");return;}
  const start=new Date(startDate+"T00:00");
  const end=new Date(endDate+"T00:00");
  let cur=new Date(start);
  let idBase=Date.now();

  events=events.filter(ev=>{
    if(ev.type!=="timeoff" || ev.tech!==tech) return true;
    const evDate=new Date(ev.date+"T00:00");
    return evDate<start || evDate>end;
  });

  while(cur<=end){
    const dayIso=toISODate(cur);
    const dow=getDayName(cur);
    let times=[];
    if(!allDay && startTime && endTime){
      times=workTimes.filter(t=>{
        const m=timeToMinutes(t);
        return m>=timeToMinutes(startTime)&&m<timeToMinutes(endTime);
      });
    }else{
      const cfg=techSchedules[tech][dow];
      if(cfg.off){cur.setDate(cur.getDate()+1);continue;}
      times=workTimes.filter(t=>{
        const m=timeToMinutes(t);
        return m>=timeToMinutes(cfg.start)&&m<timeToMinutes(cfg.end);
      });
    }
    times.forEach(t=>{
      events.push({
        id:"to-"+(idBase++),
        type:"timeoff",
        tech,
        dept:null,
        label:"Time Off",
        date:dayIso,
        time:t,
        dealer:false,
        notes
      });
    });
    cur.setDate(cur.getDate()+1);
  }
  document.getElementById("timeOffForm").reset();
  renderCalendar();
}
function deleteTimeOff(){
  const tech=document.getElementById("timeOffTechnician").value;
  const startDate=document.getElementById("timeOffStartDate").value;
  const endDate=document.getElementById("timeOffEndDate").value||startDate;
  if(!tech || !startDate){alert("Tech and start date are required to delete time off.");return;}
  const start=new Date(startDate+"T00:00");
  const end=new Date(endDate+"T00:00");
  events=events.filter(ev=>{
    if(ev.type!=="timeoff" || ev.tech!==tech) return true;
    const evDate=new Date(ev.date+"T00:00");
    return evDate<start || evDate>end;
  });
  document.getElementById("timeOffForm").reset();
  renderCalendar();
}

// Appointment create/update
async function createOrUpdateAppointment(){
  const overrideClosed = document.getElementById("checkboxOverrideClosed").checked;
  const customerName=document.getElementById("inputCustomerName").value.trim();
  const phone=document.getElementById("inputCustomerPhone").value.trim();
  const email=document.getElementById("inputCustomerEmail").value.trim();
  const date=document.getElementById("datePicker").value;
  const dayName=getDayName(new Date(date+"T00:00"));
  const dealer=document.getElementById("checkboxDealer").checked;
  const waiting=document.getElementById("checkboxCustomerWaiting").checked;
  const rideNeeded=document.getElementById("checkboxRideNeeded").checked;
  const rideTime=document.getElementById("inputRideTime").value;
  const pickupDelivery=document.getElementById("checkboxPickupDelivery").checked;
  const pickupTime=document.getElementById("inputPickupTime").value;
  const deliveryTime=document.getElementById("inputDeliveryTime").value;
  const notes=document.getElementById("inputNotes").value;
  const statusValue=statusField?statusField.value:"Scheduled";
  const invoiced=checkboxInvoiced.checked||checkboxPaid.checked;
  const paid=checkboxPaid.checked;

  const rawServices=getServiceAssignmentsFromForm();
  const phone=document.getElementById("inputCustomerPhone").value.trim();
  const email=document.getElementById("inputCustomerEmail").value.trim();
  const date=document.getElementById("datePicker").value;
  const dayName=getDayName(new Date(date+"T00:00"));
  const dealer=document.getElementById("checkboxDealer").checked;
  const waiting=document.getElementById("checkboxCustomerWaiting").checked;
  const rideNeeded=document.getElementById("checkboxRideNeeded").checked;
  const rideTime=document.getElementById("inputRideTime").value;
  const pickupDelivery=document.getElementById("checkboxPickupDelivery").checked;
  const pickupTime=document.getElementById("inputPickupTime").value;
  const deliveryTime=document.getElementById("inputDeliveryTime").value;
  const notes=document.getElementById("inputNotes").value;
  const statusValue=statusField?statusField.value:"Scheduled";
  const invoiced=checkboxInvoiced.checked||checkboxPaid.checked;
  const paid=checkboxPaid.checked;

  const rawServices=getServiceAssignmentsFromForm();
  if(!rawServices.length){
    alert("Add at least one service/tech row.");
    return;
  }
  if(!date){
    alert("Appointment date is required.");
    return;
  }

  let missingDept=false,missingTech=false,missingTime=false;
  const services=rawServices.map(row=>{
    let {dept,serviceName,tech,time,minutes,price}=row;
    if(!dept) missingDept=true;
    if(!time) missingTime=true;
    if(!tech && dealer){
      tech="Dealer";
    }
    if(!tech) missingTech=true;
    return {dept,serviceName,tech,time,minutes,price,serviceProgress};
  });
  if(!overrideClosed){
    const blocked = services.some(svc => {
      const endTime=addMinutesToTime(svc.time,svc.minutes||90);
      return isShopClosedAt(date, svc.time) || isShopClosedAt(date,endTime);
    });
    if(blocked){
      alert("One or more service times are outside shop hours or on a holiday. Check 'Override shop hours & holidays for this booking' if you want to schedule anyway.");
      return;
    }
  }

  if(!overrideClosed){
    const scheduleConflict=services.some(svc=>{
      const techCfg=techSchedules[svc.tech]?.[dayName];
      if(!techCfg || techCfg.off) return true;
      const startMin=timeToMinutes(svc.time);
      const endMin=startMin+(svc.minutes||90);
      return startMin<timeToMinutes(techCfg.start)||endMin>timeToMinutes(techCfg.end);
    });
    if(scheduleConflict){
      alert("One or more services exceed the assigned tech schedule. Adjust times or enable override.");
      return;
    }
  }
  let missingDept=false,missingTech=false,missingTime=false;
  const services=rawServices.map(row=>{
    let {dept,serviceName,tech,time,minutes,price}=row;
    if(!dept) missingDept=true;
    if(!time) missingTime=true;
    if(!tech && dealer){
      tech="Dealer";
    }
    if(!tech) missingTech=true;
    return {dept,serviceName,tech,time,minutes,price,serviceProgress};
  });
  if(!overrideClosed){
    const blocked = services.some(svc => {
      const endTime=addMinutesToTime(svc.time,svc.minutes||90);
      return isShopClosedAt(date, svc.time) || isShopClosedAt(date,endTime);
    });
    if(blocked){
      alert("One or more service times are outside shop hours or on a holiday. Check 'Override shop hours & holidays for this booking' if you want to schedule anyway.");
      return;
    }
  }

  if(!overrideClosed){
    const scheduleConflict=services.some(svc=>{
      const techCfg=techSchedules[svc.tech]?.[dayName];
      if(!techCfg || techCfg.off) return true;
      const startMin=timeToMinutes(svc.time);
      const endMin=startMin+(svc.minutes||90);
      return startMin<timeToMinutes(techCfg.start)||endMin>timeToMinutes(techCfg.end);
    });
    if(scheduleConflict){
      alert("One or more services exceed the assigned tech schedule. Adjust times or enable override.");
      return;
    }
  }

  if(!overrideClosed){
    const scheduleConflict=services.some(svc=>{
      const techCfg=techSchedules[svc.tech]?.[dayName];
      if(!techCfg || techCfg.off) return true;
      const startMin=timeToMinutes(svc.time);
      const endMin=startMin+(svc.minutes||90);
      return startMin<timeToMinutes(techCfg.start)||endMin>timeToMinutes(techCfg.end);
    });
    if(scheduleConflict){
      alert("One or more services exceed the assigned tech schedule. Adjust times or enable override.");
      return;
    }
  }

  if(missingDept || missingTech || missingTime){
    let msg="Each service row must have:";
    if(missingDept) msg+="\n- Service category";
    if(missingTech) msg+="\n- Technician (or check Dealer Job)";
    if(missingTime) msg+="\n- Time";
    alert(msg);
    return;
  }

  const groupId=editingJobGroupId || ("jobgrp-"+Date.now());
  const payloadType=editingJobGroupId?"update_appointment":"appointment";

  events=events.filter(ev=>ev.type!=="job" || (ev.jobGroupId||ev.id)!==groupId);

  services.forEach((svc,index)=>{
    const id=groupId+"-"+index+"-"+Date.now();
    events.push({
      id,
      jobGroupId:groupId,
      type:"job",
      tech:svc.tech,
      dept:svc.dept,
      serviceName:svc.serviceName,
      label:svc.serviceName||svc.dept||"Service",
      date,
      time:svc.time,
      minutes:svc.minutes||90,
      endTime:addMinutesToTime(svc.time,svc.minutes||90),
      price:svc.price||0,
      serviceProgress:svc.serviceProgress||"In Queue",
      status:statusValue,
      invoiced,
      paid,
      dealer,
      customerName,
      phone,
      email,
      customerWaiting:waiting,
      rideNeeded,
      rideTime,
      pickupDelivery,
      pickupTime,
      deliveryTime,
      notes,
      overrideClosed
    });
  });

  autoAdvanceServiceProgress(groupId);

  editingJobGroupId=groupId;
  currentDate=new Date(date+"T00:00");
  events=events.filter(ev=>ev.type!=="job" || (ev.jobGroupId||ev.id)!==groupId);

  services.forEach((svc,index)=>{
    const id=groupId+"-"+index+"-"+Date.now();
    events.push({
      id,
      jobGroupId:groupId,
      type:"job",
      tech:svc.tech,
      dept:svc.dept,
      serviceName:svc.serviceName,
      label:svc.serviceName||svc.dept||"Service",
      date,
      time:svc.time,
      minutes:svc.minutes||90,
      endTime:addMinutesToTime(svc.time,svc.minutes||90),
      price:svc.price||0,
      serviceProgress:svc.serviceProgress||"In Queue",
      status:statusValue,
      invoiced,
      paid,
      dealer,
      customerName,
      phone,
      email,
      customerWaiting:waiting,
      rideNeeded,
      rideTime,
      pickupDelivery,
      pickupTime,
      deliveryTime,
      notes,
      overrideClosed
    });
  });

  autoAdvanceServiceProgress(groupId);

  editingJobGroupId=groupId;
  currentDate=new Date(date+"T00:00");
  renderCalendar();
  if(statusEl)statusEl.textContent=payloadType==="update_appointment"
    ?"Appointment updated and sent to Zapier."
    :"Appointment created and sent to Zapier.";
  btnCreateAppointment.textContent="Update Appointment";

  try{
    await fetch(ZAPIER_WEBHOOK_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        type:payloadType,
        appointmentId:groupId,
        customerName,
        phone,
        email,
        date,
        dealer,
        customerWaiting:waiting,
        rideNeeded,
        rideTime,
        pickupDelivery,
        pickupTime,
        deliveryTime,
        notes,
        status:statusValue,
        invoiced,
        paid,
        services:services
      })
    });
        pickupDelivery,
        pickupTime,
        deliveryTime,
        notes,
        status:statusValue,
        invoiced,
        paid,
        services:services
      })
    });
  }catch(e){
    console.error("Zapier error",e);
  }

  // clear form after save
  document.getElementById("appointmentForm").reset();
  clearServiceAssignments();
  ensureAtLeastOneServiceRow();
  setStatusState("Scheduled",false,false);
  selectedSlot=null;
  selectedEventId=null;
  editingJobGroupId=null;
  btnCreateAppointment.textContent="Save to Zapier";
  setAppointmentFormLocked(false);
  setPopupEditable(false);
  closeAppointmentPopup();
}
  document.getElementById("appointmentForm").reset();
  clearServiceAssignments();
  ensureAtLeastOneServiceRow();
  setStatusState("Scheduled",false,false);
  selectedSlot=null;
  selectedEventId=null;
  editingJobGroupId=null;
  btnCreateAppointment.textContent="Save to Zapier";
  setAppointmentFormLocked(false);
  setPopupEditable(false);
  closeAppointmentPopup();
}

// Delete appointment (entire group)
function deleteAppointment(){
  if(!editingJobGroupId){
    alert("Select an appointment from the calendar first.");
    return;
  }
  const groupKey=editingJobGroupId;
  events=events.filter(ev=>!(ev.type==="job" && (ev.jobGroupId||ev.id)===groupKey));
  selectedEventId=null;
  editingJobGroupId=null;
  document.getElementById("appointmentForm").reset();
  clearServiceAssignments();
  ensureAtLeastOneServiceRow();
  setStatusState("Scheduled",false,false);
  btnCreateAppointment.textContent="Save to Zapier";
  if(statusEl)statusEl.textContent="Appointment deleted.";
  renderCalendar();
  setAppointmentFormLocked(false);
  setPopupEditable(false);
  closeAppointmentPopup();
  try{
    fetch(ZAPIER_WEBHOOK_URL,{
  document.getElementById("appointmentForm").reset();
  clearServiceAssignments();
  ensureAtLeastOneServiceRow();
  setStatusState("Scheduled",false,false);
  btnCreateAppointment.textContent="Save to Zapier";
  if(statusEl)statusEl.textContent="Appointment deleted.";
  renderCalendar();
  setAppointmentFormLocked(false);
  setPopupEditable(false);
  closeAppointmentPopup();
  try{
    fetch(ZAPIER_WEBHOOK_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        type:"delete_appointment",
        appointmentId:groupKey
      })
    });
  }catch(e){
    console.error("Zapier error",e);
  }
}

// Clear appointment form manually
function clearAppointmentForm(){
  document.getElementById("appointmentForm").reset();
  clearServiceAssignments();
  ensureAtLeastOneServiceRow();
  setStatusState("Scheduled",false,false);
  selectedSlot=null;
  selectedEventId=null;
  editingJobGroupId=null;
  btnCreateAppointment.textContent="Save to Zapier";
  if(statusEl)statusEl.textContent="Cleared form.";
  renderCalendar();
  setAppointmentFormLocked(false);
  setPopupEditable(false);
  closeAppointmentPopup();
}
function clearAppointmentForm(){
  document.getElementById("appointmentForm").reset();
  clearServiceAssignments();
  ensureAtLeastOneServiceRow();
  setStatusState("Scheduled",false,false);
  selectedSlot=null;
  selectedEventId=null;
  editingJobGroupId=null;
  btnCreateAppointment.textContent="Save to Zapier";
  if(statusEl)statusEl.textContent="Cleared form.";
  renderCalendar();
  setAppointmentFormLocked(false);
  setPopupEditable(false);
  closeAppointmentPopup();
}

// Clear time off form
function clearTimeOffForm(){
  document.getElementById("timeOffForm").reset();
}



function loadJobEventIntoForm(ev){
  setPanel("appointments");

  const groupKey=ev.jobGroupId||ev.id;
  editingJobGroupId=groupKey;
  btnCreateAppointment.textContent="Update Appointment";

  document.getElementById("inputCustomerName").value=ev.customerName||"";
  document.getElementById("inputCustomerPhone").value=ev.phone||"";
  document.getElementById("inputCustomerEmail").value=ev.email||"";
  document.getElementById("datePicker").value=ev.date||"";
  document.getElementById("checkboxDealer").checked=!!ev.dealer;
  document.getElementById("checkboxCustomerWaiting").checked=!!ev.customerWaiting;
  document.getElementById("checkboxRideNeeded").checked=!!ev.rideNeeded;
  document.getElementById("inputRideTime").value=ev.rideTime||"";
  document.getElementById("checkboxPickupDelivery").checked=!!ev.pickupDelivery;
  document.getElementById("inputPickupTime").value=ev.pickupTime||"";
  document.getElementById("inputDeliveryTime").value=ev.deliveryTime||"";
  document.getElementById("inputNotes").value=ev.notes||"";
  setStatusState(ev.status||"Scheduled",!!ev.invoiced||!!ev.paid,!!ev.paid);

  clearServiceAssignments();
  const groupEvents=events.filter(e=>e.type==="job" && (e.jobGroupId||e.id)===groupKey);
  if(groupEvents.length){
    groupEvents.forEach(gev=>{
      addServiceRow({
        dept:gev.dept||"",
        serviceName:gev.serviceName||"",
        tech:gev.tech||"",
        time:gev.time||"",
        minutes:gev.minutes||90,
        price:typeof gev.price!=="undefined"?gev.price:0,
        serviceProgress:gev.serviceProgress||"In Queue",
        id:gev.id
      });
    });
  }else{
    ensureAtLeastOneServiceRow();
  }

  if(ev.date){
    currentDate=new Date(ev.date+"T00:00");
    renderCalendar();
  }
  if(statusEl)statusEl.textContent="Editing existing appointment.";
  setAppointmentFormLocked(true);
  setPopupEditable(false);
}
  document.getElementById("inputCustomerEmail").value=ev.email||"";
  document.getElementById("datePicker").value=ev.date||"";
  document.getElementById("checkboxDealer").checked=!!ev.dealer;
  document.getElementById("checkboxCustomerWaiting").checked=!!ev.customerWaiting;
  document.getElementById("checkboxRideNeeded").checked=!!ev.rideNeeded;
  document.getElementById("inputRideTime").value=ev.rideTime||"";
  document.getElementById("checkboxPickupDelivery").checked=!!ev.pickupDelivery;
  document.getElementById("inputPickupTime").value=ev.pickupTime||"";
  document.getElementById("inputDeliveryTime").value=ev.deliveryTime||"";
  document.getElementById("inputNotes").value=ev.notes||"";
  setStatusState(ev.status||"Scheduled",!!ev.invoiced||!!ev.paid,!!ev.paid);

  clearServiceAssignments();
  const groupEvents=events.filter(e=>e.type==="job" && (e.jobGroupId||e.id)===groupKey);
  if(groupEvents.length){
    groupEvents.forEach(gev=>{
      addServiceRow({
        dept:gev.dept||"",
        serviceName:gev.serviceName||"",
        tech:gev.tech||"",
        time:gev.time||"",
        minutes:gev.minutes||90,
        price:typeof gev.price!=="undefined"?gev.price:0,
        serviceProgress:gev.serviceProgress||"In Queue",
        id:gev.id
      });
    });
  }else{
    ensureAtLeastOneServiceRow();
  }

  if(ev.date){
    currentDate=new Date(ev.date+"T00:00");
    renderCalendar();
  }
  if(statusEl)statusEl.textContent="Editing existing appointment.";
  setAppointmentFormLocked(true);
  setPopupEditable(false);
}

// Calendar clicks
bodyEl.addEventListener("click",e=>{
  const pill=e.target.closest(".event-bubble, .event-pill");
  if(pill){
    const id=pill.dataset.eventId;
    selectedEventId=id;
    const ev=events.find(ev=>ev.id===id);
    renderEventDetails(ev);
    if(ev.type==="job"){
      loadJobEventIntoForm(ev);
      openAppointmentPopup(ev);
    }else if(ev.type==="timeoff"){
      setPanel("timeoff");
    if(ev.type==="job"){
      loadJobEventIntoForm(ev);
      openAppointmentPopup(ev);
    }else if(ev.type==="timeoff"){
      setPanel("timeoff");
      const tech=ev.tech||"";
      const thisDate=ev.date;
      document.getElementById("timeOffTechnician").value=tech;

      const techTimeOff=events.filter(x=>x.type==="timeoff" && x.tech===tech);
      const dateSet=Array.from(new Set(techTimeOff.map(x=>x.date))).sort();
      let startDate=thisDate;
      let endDate=thisDate;
      if(thisDate){
        const idxDate=dateSet.indexOf(thisDate);
        if(idxDate!==-1){
          let i=idxDate-1;
          while(i>=0){
            const prevDate=dateSet[i];
            const prev=new Date(prevDate+"T00:00");
            const cur=new Date(dateSet[i+1]+"T00:00");
            const diffDays=(cur-prev)/(1000*60*60*24);
            if(diffDays===1){
              startDate=prevDate;
              i--;
            }else break;
          }
          i=idxDate+1;
          while(i<dateSet.length){
            const prev=new Date(dateSet[i-1]+"T00:00");
            const cur=new Date(dateSet[i]+"T00:00");
            const diffDays=(cur-prev)/(1000*60*60*24);
            if(diffDays===1){
              endDate=dateSet[i];
              i++;
            }else break;
          }
        }
      }

      document.getElementById("timeOffStartDate").value=startDate||thisDate||"";
      document.getElementById("timeOffEndDate").value=endDate||thisDate||"";

      const sameDay=techTimeOff
        .filter(x=>x.date===thisDate)
        .sort((a,b)=>a.time.localeCompare(b.time));

      const startTimeEl2=document.getElementById("timeOffStartTime");
      const endTimeEl2=document.getElementById("timeOffEndTime");
      const allDayCheckbox2=document.getElementById("timeOffAllDay");
      let isAllDay=false;

      if(sameDay.length){
        const startTime=sameDay[0].time;
        const endTime=sameDay[sameDay.length-1].time;
        if(startTimeEl2) startTimeEl2.value=startTime;
        if(endTimeEl2) endTimeEl2.value=endTime;

        if(thisDate && tech && techSchedules[tech]){
          const dow=getDayName(new Date(thisDate+"T00:00"));
          const cfg=techSchedules[tech][dow];
          if(cfg && !cfg.off){
            const schedStartMin=timeToMinutes(cfg.start);
            const schedEndMin=timeToMinutes(cfg.end);
            const blockStartMin=timeToMinutes(startTime);
            const blockEndMin=timeToMinutes(endTime);
            if(blockStartMin===schedStartMin && blockEndMin===schedEndMin){
              isAllDay=true;
            }
          }
        }
      }else{
        if(startTimeEl2) startTimeEl2.value="";
        if(endTimeEl2) endTimeEl2.value="";
      }

      if(allDayCheckbox2){
        allDayCheckbox2.checked=isAllDay;
        const disabled=isAllDay;
        if(startTimeEl2) startTimeEl2.disabled=disabled;
        if(endTimeEl2) endTimeEl2.disabled=disabled;
      }

      document.getElementById("timeOffNotes").value=ev.notes||"";
      if(ev.date){
        currentDate=new Date(ev.date+"T00:00");
        renderCalendar();
      }
    }
    return;
  }
  const cell=e.target.closest(".cal-slot-cell");
  if(cell){
    setSelectedSlot(cell.dataset.tech,cell.dataset.time);
  }
});

dealerQueueListEl.addEventListener("click",e=>{
  const item=e.target.closest(".dealer-queue-item");
  if(!item) return;
  const id=item.dataset.eventId;
  const ev=events.find(ev=>ev.id===id);
  if(!ev) return;
  selectedEventId=id;
  renderEventDetails(ev);
  if(ev.type==="job"){
    loadJobEventIntoForm(ev);
    openAppointmentPopup(ev);
  }
});
  if(ev.type==="job"){
    loadJobEventIntoForm(ev);
    openAppointmentPopup(ev);
  }
});

// Day navigation
document.getElementById("btnPrevDay").addEventListener("click",()=>{
  currentDate.setDate(currentDate.getDate()-1);
  renderCalendar();
});
document.getElementById("btnNextDay").addEventListener("click",()=>{
  currentDate.setDate(currentDate.getDate()+1);
  renderCalendar();
});

// Panel buttons
headerBtnAppointments.addEventListener("click",()=>setPanel("appointments"));
headerBtnTimeOff.addEventListener("click",()=>setPanel("timeoff"));
headerBtnSchedules.addEventListener("click",()=>setPanel("schedules"));
headerBtnServices.addEventListener("click",()=>{
  setPanel("services");
  renderServiceLibrary();
});

// Schedules panel
scheduleTechSelect.addEventListener("change",()=>{
  const tech=scheduleTechSelect.value;
  loadScheduleIntoForm(tech);
  scheduleStatus.textContent=tech?`Editing weekly schedule for ${tech}.`:"";
});
document.getElementById("btnSaveSchedules").addEventListener("click",saveScheduleFromForm);

// Time off buttons
document.getElementById("btnSaveTimeOff").addEventListener("click",saveTimeOff);
document.getElementById("btnClearTimeOff").addEventListener("click",clearTimeOffForm);
document.getElementById("btnDeleteTimeOff").addEventListener("click",deleteTimeOff);

// All-day toggle
const allDayCheckbox=document.getElementById("timeOffAllDay");
const startTimeEl=document.getElementById("timeOffStartTime");
const endTimeEl=document.getElementById("timeOffEndTime");
if(allDayCheckbox){
  allDayCheckbox.addEventListener("change",()=>{
    const disabled=allDayCheckbox.checked;
    if(startTimeEl) startTimeEl.disabled=disabled;
    if(endTimeEl) endTimeEl.disabled=disabled;
  });
}

// Appointment buttons
btnCreateAppointment.addEventListener("click",createOrUpdateAppointment);
document.getElementById("btnClear").addEventListener("click",clearAppointmentForm);
btnDeleteAppointment.addEventListener("click",deleteAppointment);

// Appointment popup controls
if(btnUnlockEditing){
  btnUnlockEditing.addEventListener("click",()=>{
    setAppointmentFormLocked(false);
    closeAppointmentPopup();
  });
}
if(btnClosePopup){
  btnClosePopup.addEventListener("click",closeAppointmentPopup);
}
if(appointmentPopup){
  appointmentPopup.addEventListener("click",e=>{
    if(e.target===appointmentPopup) closeAppointmentPopup();
  });
}
if(popupStatusSelect){
  popupStatusSelect.addEventListener("change",()=>{
    setStatusState(popupStatusSelect.value,checkboxInvoiced.checked,checkboxPaid.checked);
    applyMetaToGroup(popupStatusSelect.value,checkboxInvoiced.checked,checkboxPaid.checked);
  });
}
if(popupInvoiced){
  popupInvoiced.addEventListener("change",()=>{
    const invoiced=popupInvoiced.checked||popupPaid.checked;
    setStatusState(statusField.value||"Scheduled",invoiced,checkboxPaid.checked);
    applyMetaToGroup(statusField.value||"Scheduled",checkboxInvoiced.checked,checkboxPaid.checked);
  });
}
if(popupPaid){
  popupPaid.addEventListener("change",()=>{
    const paid=popupPaid.checked;
    const invoiced=popupInvoiced.checked||paid;
    setStatusState(statusField.value||"Scheduled",invoiced,paid);
    applyMetaToGroup(statusField.value||"Scheduled",checkboxInvoiced.checked,checkboxPaid.checked);
  });
}

// Appointment popup controls
if(btnUnlockEditing){
  btnUnlockEditing.addEventListener("click",()=>{
    setAppointmentFormLocked(false);
    setPopupEditable(true);
  });
}
if(btnClosePopup){
  btnClosePopup.addEventListener("click",closeAppointmentPopup);
}
if(appointmentPopup){
  appointmentPopup.addEventListener("click",e=>{
    if(e.target===appointmentPopup) closeAppointmentPopup();
  });
}
if(popupStatusSelect){
  popupStatusSelect.addEventListener("change",()=>{
    if(appointmentLocked) return;
    setStatusState(popupStatusSelect.value,checkboxInvoiced.checked,checkboxPaid.checked);
    applyMetaToGroup(popupStatusSelect.value,checkboxInvoiced.checked,checkboxPaid.checked);
  });
}
if(popupInvoiced){
  popupInvoiced.addEventListener("change",()=>{
    if(appointmentLocked) return;
    const invoiced=popupInvoiced.checked||popupPaid.checked;
    setStatusState(statusField.value||"Scheduled",invoiced,checkboxPaid.checked);
    applyMetaToGroup(statusField.value||"Scheduled",checkboxInvoiced.checked,checkboxPaid.checked);
  });
}
if(popupPaid){
  popupPaid.addEventListener("change",()=>{
    if(appointmentLocked) return;
    const paid=popupPaid.checked;
    const invoiced=popupInvoiced.checked||paid;
    setStatusState(statusField.value||"Scheduled",invoiced,paid);
    applyMetaToGroup(statusField.value||"Scheduled",checkboxInvoiced.checked,checkboxPaid.checked);
  });
}

// Appointment popup controls
if(btnUnlockEditing){
  btnUnlockEditing.addEventListener("click",()=>{
    setAppointmentFormLocked(false);
    setPopupEditable(true);
  });
}
if(btnClosePopup){
  btnClosePopup.addEventListener("click",closeAppointmentPopup);
}
if(appointmentPopup){
  appointmentPopup.addEventListener("click",e=>{
    if(e.target===appointmentPopup) closeAppointmentPopup();
  });
}
if(popupStatusSelect){
  popupStatusSelect.addEventListener("change",()=>{
    if(appointmentLocked) return;
    setStatusState(popupStatusSelect.value,checkboxInvoiced.checked,checkboxPaid.checked);
    applyMetaToGroup(popupStatusSelect.value,checkboxInvoiced.checked,checkboxPaid.checked);
  });
}
if(popupInvoiced){
  popupInvoiced.addEventListener("change",()=>{
    if(appointmentLocked) return;
    const invoiced=popupInvoiced.checked||popupPaid.checked;
    setStatusState(statusField.value||"Scheduled",invoiced,checkboxPaid.checked);
    applyMetaToGroup(statusField.value||"Scheduled",checkboxInvoiced.checked,checkboxPaid.checked);
  });
}
if(popupPaid){
  popupPaid.addEventListener("change",()=>{
    if(appointmentLocked) return;
    const paid=popupPaid.checked;
    const invoiced=popupInvoiced.checked||paid;
    setStatusState(statusField.value||"Scheduled",invoiced,paid);
    applyMetaToGroup(statusField.value||"Scheduled",checkboxInvoiced.checked,checkboxPaid.checked);
  });
}

// Add service row button
btnAddServiceRow.addEventListener("click",()=>addServiceRow());

// Custom Date Picker
function buildDatePickerGrid(){
  dpGrid.innerHTML="";
  const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];
  dpMonthLabel.textContent=monthNames[dpMonth]+" "+dpYear;
  const dayNames=["Su","Mo","Tu","We","Th","Fr","Sa"];
  dayNames.forEach(d=>{
    const cell=document.createElement("div");
    cell.className="date-picker-cell day-name";
    cell.textContent=d;
    dpGrid.appendChild(cell);
  });
  const firstDay=new Date(dpYear,dpMonth,1);
  const startDow=firstDay.getDay();
  const daysInMonth=new Date(dpYear,dpMonth+1,0).getDate();
  for(let i=0;i<startDow;i++){
    const cell=document.createElement("div");
    cell.className="date-picker-cell disabled";
    cell.textContent="";
    dpGrid.appendChild(cell);
  }
  const today=new Date();
  const todayIso=toISODate(today);
  const currentValue=dpActiveInput?parseISODate(dpActiveInput.value):null;
  const currentValueIso=currentValue?toISODate(currentValue):null;
  for(let day=1;day<=daysInMonth;day++){
    const cell=document.createElement("div");
    cell.className="date-picker-cell day";
    cell.textContent=day;
    const cellDate=new Date(dpYear,dpMonth,day);
    const iso=toISODate(cellDate);
    if(iso===todayIso) cell.classList.add("today");
    if(iso===currentValueIso) cell.classList.add("selected");
    cell.addEventListener("click",()=>{
      if(!dpActiveInput) return;
      dpActiveInput.value=iso;
      if(dpActiveInput.id==="dayPicker" || dpActiveInput.id==="datePicker"){
        currentDate=cellDate;
        renderCalendar();
      }
      hideDatePicker();
    });
    dpGrid.appendChild(cell);
  }
}
function showDatePickerForInput(input){
  dpActiveInput=input;
  const existing=parseISODate(input.value)||currentDate;
  dpYear=existing.getFullYear();
  dpMonth=existing.getMonth();
  buildDatePickerGrid();
  const rect=input.getBoundingClientRect();
  const scrollY=window.scrollY||window.pageYOffset;
  const scrollX=window.scrollX||window.pageXOffset;
  dpPopup.style.top=(rect.bottom+scrollY+4)+"px";
  dpPopup.style.left=(rect.left+scrollX)+"px";
  dpPopup.style.display="block";
}
function hideDatePicker(){
  dpPopup.style.display="none";
  dpActiveInput=null;
}
document.querySelectorAll(".date-input").forEach(inp=>{
  inp.addEventListener("click",e=>{
    e.stopPropagation();
    showDatePickerForInput(inp);
  });
});
dpPrevMonth.addEventListener("click",e=>{
  e.stopPropagation();
  dpMonth--;
  if(dpMonth<0){dpMonth=11;dpYear--;}
  buildDatePickerGrid();
});
dpNextMonth.addEventListener("click",e=>{
  e.stopPropagation();
  dpMonth++;
  if(dpMonth>11){dpMonth=0;dpYear++;}
  buildDatePickerGrid();
});
document.addEventListener("click",e=>{
  if(dpPopup.style.display==="none") return;
  if(dpPopup.contains(e.target)) return;
  if(dpActiveInput && dpActiveInput.contains(e.target)) return;
  hideDatePicker();
});

// Init
// Init
initTimeDropdowns();
attachOffCheckboxHandlers();
loadSchedulesFromStorage();
loadOfficeHoursFromStorage();
loadShopHolidaysFromStorage();
loadServicePackagesFromStorage();
renderDeptChips();
loadOfficeHoursIntoForm();
attachOfficeClosedCheckboxHandlers();
renderHolidayList();
seedDummyEvents();
ensureAtLeastOneServiceRow();
refreshAllServiceAssignmentRows();
setStatusState("Scheduled",false,false);
setAppointmentFormLocked(false);
renderCalendar();
loadShopHolidaysFromStorage();
loadServicePackagesFromStorage();
renderDeptChips();
loadOfficeHoursIntoForm();
attachOfficeClosedCheckboxHandlers();
renderHolidayList();
seedDummyEvents();
ensureAtLeastOneServiceRow();
refreshAllServiceAssignmentRows();
setStatusState("Scheduled",false,false);
setAppointmentFormLocked(false);
renderCalendar();


</script>
</body>
</html>

                                                                              
