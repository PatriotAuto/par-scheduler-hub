<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Patriot Scheduler â€“ Users</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --navy: #0b1f33;
      --red: #e30613;
      --bg: #f5f7fb;
      --muted: #5b667c;
    }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background: var(--bg); color: #0f172a; }
    header { background: linear-gradient(90deg, #050b18, #0a1727); color: #fff; padding: 14px 18px; display: flex; justify-content: space-between; align-items: center; }
    header h1 { margin: 0; font-size: 18px; letter-spacing: 0.06em; text-transform: uppercase; }
    header .subtitle { font-size: 12px; color: rgba(255,255,255,0.75); margin-top: 2px; }
    .header-actions { display: flex; gap: 8px; }
    .btn { border: none; border-radius: 8px; padding: 10px 14px; background: var(--red); color: #fff; cursor: pointer; font-weight: 600; }
    .btn.secondary { background: rgba(255,255,255,0.12); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
    .btn.small { padding: 6px 10px; font-size: 13px; }
    main { padding: 18px; max-width: 1100px; margin: 0 auto; display: flex; flex-direction: column; gap: 16px; }
    .card { background: #fff; border-radius: 12px; box-shadow: 0 6px 18px rgba(15,23,42,0.12); padding: 16px; border: 1px solid rgba(0,0,0,0.06); }
    .card h2 { margin: 0 0 8px; font-size: 18px; }
    .card p { margin: 0 0 12px; color: var(--muted); }
    form { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px 12px; align-items: end; }
    label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 6px; color: #0f172a; }
    input, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 14px; }
    .switch-row { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; font-size: 14px; }
    th { background: #f1f5f9; font-size: 13px; text-transform: uppercase; letter-spacing: 0.04em; color: #475569; }
    .user-actions-cell {
      text-align: right;
      white-space: nowrap;
    }

    .user-action-btn {
      display: inline-block;
      padding: 6px 14px;
      margin-left: 6px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
    }

    .user-action-setpw {
      background: #fef3c7;
      color: #92400e;
    }

    .user-action-setpw:hover {
      background: #fde68a;
    }

    .user-action-reset {
      background: #e5f0ff;
      color: #1f2937;
    }

    .user-action-reset:hover {
      background: #d0e4ff;
    }

    .user-action-toggle {
      background: #0b1220; /* dark navy to match your Deactivate pill */
      color: #ffffff;
    }

    .user-action-toggle:hover {
      background: #111827;
    }

    .user-role-pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: #e0f2ff;
      color: #0b4f91;
      font-size: 12px;
      font-weight: 500;
    }

    .user-status-pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }

    .user-status-active {
      background: #d1fae5;
      color: #065f46;
    }

    .user-status-inactive {
      background: #fee2e2;
      color: #991b1b;
    }
    .notice { background: #fff7ed; border: 1px solid #fed7aa; padding: 10px 12px; border-radius: 10px; color: #92400e; font-size: 14px; }
    #status { min-height: 18px; font-size: 14px; color: #475569; }
  </style>
  <script src="auth.js"></script>
</head>
<body>
  <header>
    <div>
      <h1>Users Admin</h1>
      <div class="subtitle">Manage access for Patriot Scheduler</div>
    </div>
    <div class="header-actions">
      <button class="btn secondary" id="logoutBtn">Log Out</button>
    </div>
  </header>

  <nav>
    <a href="index.html">Calendar</a>
    <a href="services.html">Services</a>
    <a href="customers.html">Customers</a>

    <span id="navLinksExtra"></span>
  </nav>

  <script>
    (function () {
      var user = getStoredUser();

      var html = '<a href="change-password.html" style="margin-left:10px;">Change Password</a>';

      if (user && ['owner','admin'].includes(String(user.role || '').toLowerCase())) {
        html += '<a href="users.html" style="margin-left:10px;">Users</a>';
      }

      var extraEl = document.getElementById('navLinksExtra');
      if (extraEl) {
        extraEl.innerHTML = html;
      }
    })();
  </script>
  <main>
    <div class="card">
      <h2>Create user</h2>
      <p>Add a new teammate. A temporary password will be shown once.</p>
      <form id="createForm">
        <div>
          <label for="email">Email</label>
          <input type="email" id="email" required placeholder="name@example.com" autocomplete="email" />
        </div>
        <div>
          <label for="name">Name</label>
          <input type="text" id="name" required placeholder="Full name" />
        </div>
        <div>
          <label for="role">Role</label>
          <select id="role">
            <option value="user">User</option>
            <option value="admin">Admin</option>
            <option value="owner">Owner</option>
          </select>
        </div>
        <div class="switch-row">
          <input type="checkbox" id="active" checked />
          <label for="active">Active immediately</label>
        </div>
        <div>
          <button type="submit" class="btn">Create User</button>
        </div>
      </form>
      <div id="status"></div>
    </div>

    <div class="card">
      <h2>Users</h2>
      <p>Reset passwords, change roles, or deactivate users.</p>
      <div class="notice" id="permissionNotice" style="display:none;">You need admin or owner access to manage users.</div>
      <div class="table-wrap">
        <table id="usersTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Updated</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-tbody"></tbody>
        </table>
      </div>
    </div>
  </main>
  <script>
    if (!ensureLoggedIn()) {
      throw new Error('Not logged in');
    }
    const currentUser = getAuthUser();
    if (!currentUser || !currentUser.role || ['owner','admin'].indexOf(String(currentUser.role).toLowerCase()) === -1) {
      alert('Access denied. Admin/Owner only.');
      window.location.href = 'index.html';
    }
    const tableBody = document.getElementById('users-tbody');
    const statusDiv = document.getElementById('status');
    const notice = document.getElementById('permissionNotice');

    if (!currentUser || !['admin', 'owner'].includes((currentUser.role || '').toLowerCase())) {
      notice.style.display = 'block';
    }

    document.getElementById('logoutBtn').addEventListener('click', logoutAndRedirect);

    document.getElementById('createForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      setStatus('Creating user...');
      try {
        const payload = {
          email: document.getElementById('email').value.trim(),
          name: document.getElementById('name').value.trim(),
          role: document.getElementById('role').value,
          is_active: document.getElementById('active').checked
        };

        const res = await apiGet('users.create', payload);
        if (!res.success) throw new Error(res.message || 'Failed');
        loadUsers();
        setStatus('User created. Temporary password: ' + res.tempPassword);
        e.target.reset();
        document.getElementById('active').checked = true;
      } catch (err) {
        console.error(err);
        setStatus('Error creating user: ' + err.message, true);
      }
    });

    function renderUsers(users) {
      const tbody = document.getElementById('users-tbody');
      if (!tbody) return;

      tbody.innerHTML = '';

      users.forEach(function (user) {
        const tr = document.createElement('tr');

        // Compute some labels
        const roleLabel = user.role || '';
        const isActive = !(String(user.is_active).toLowerCase() === 'false' || String(user.is_active).toLowerCase() === '0');
        const statusLabel = isActive ? 'Active' : 'Inactive';
        const updatedAt = user.updated_at || '';

        tr.innerHTML = `
          <td>${user.name || ''}</td>
          <td>${user.email || ''}</td>
          <td>
            <span class="user-role-pill">${roleLabel}</span>
          </td>
          <td>
            <span class="user-status-pill ${isActive ? 'user-status-active' : 'user-status-inactive'}">
              ${statusLabel}
            </span>
          </td>
          <td>${updatedAt}</td>
          <td class="user-actions-cell">
            <button
              class="user-action-btn user-action-setpw"
              data-id="${user.id || ''}"
              data-email="${user.email || ''}"
            >
              Set Password
            </button>
            <button
              class="user-action-btn user-action-reset"
              data-email="${user.email || ''}"
            >
              Reset Password
            </button>
            <button
              class="user-action-btn user-action-toggle"
              data-id="${user.id || ''}"
              data-active="${isActive ? 'true' : 'false'}"
            >
              ${isActive ? 'Deactivate' : 'Activate'}
            </button>
          </td>
        `;

        tbody.appendChild(tr);
      });

      attachUserActionHandlers();
    }

    function attachUserActionHandlers() {
      // Set Password buttons (admin chooses a custom password)
      document.querySelectorAll('.user-action-setpw').forEach(function (btn) {
        btn.addEventListener('click', function () {
          const email = btn.getAttribute('data-email') || '';
          const id = btn.getAttribute('data-id') || '';

          if (!email && !id) {
            alert('Missing user id/email.');
            return;
          }

          const newPassword = prompt('Enter a new password for ' + (email || 'this user') + ':');
          if (!newPassword) {
            // Cancelled or empty
            return;
          }

          const confirmPassword = prompt('Confirm the new password:');
          if (newPassword !== confirmPassword) {
            alert('Passwords do not match. Try again.');
            return;
          }

          if (!confirm('Set this new password for ' + (email || 'this user') + '?')) {
            return;
          }

          apiGet('users.setPassword', {
            id: id,
            email: email,
            newPassword: newPassword
          })
            .then(function (data) {
              if (!data || !data.success) {
                console.error('Set password failed:', data);
                alert('Failed to set password: ' + (data && data.message ? data.message : 'Unknown error'));
                return;
              }

              alert('Password updated successfully for ' + (email || 'this user') + '.');
            })
            .catch(function (err) {
              console.error('Set password error:', err);
              alert('Failed to set password: ' + err.message);
            });
        });
      });

      // Reset password buttons
      document.querySelectorAll('.user-action-reset').forEach(function (btn) {
        btn.addEventListener('click', function () {
          const email = btn.getAttribute('data-email');
          if (!email) {
            alert('Missing email for this user.');
            return;
          }

          if (!confirm('Reset password for ' + email + ' and generate a new temporary password?')) {
            return;
          }

          apiGet('users.resetPassword', { email: email })
            .then(function (data) {
              if (!data || !data.success) {
                console.error('Reset password failed:', data);
                alert('Failed to reset password: ' + (data && data.message ? data.message : 'Unknown error'));
                return;
              }

              // Show the temp password so the admin can give it to the user
              const temp = data.tempPassword || '(no tempPassword returned)';
              alert('Temporary password for ' + email + ':\n\n' + temp + '\n\nAsk the user to log in and change it.');
            })
            .catch(function (err) {
              console.error('Reset password error:', err);
              alert('Failed to reset password: ' + err.message);
            });
        });
      });

      // Activate / Deactivate buttons
      document.querySelectorAll('.user-action-toggle').forEach(function (btn) {
        btn.addEventListener('click', function () {
          const id = btn.getAttribute('data-id');
          const activeAttr = btn.getAttribute('data-active');
          const currentlyActive = activeAttr === 'true';

          if (!id) {
            alert('Missing user id.');
            return;
          }

          const newActive = !currentlyActive;
          const actionLabel = newActive ? 'activate' : 'deactivate';

          if (!confirm('Are you sure you want to ' + actionLabel + ' this user?')) {
            return;
          }

          apiGet('users.setActive', {
            id: id,
            is_active: newActive ? 'true' : 'false'
          })
            .then(function (data) {
              if (!data || !data.success) {
                console.error('Set active failed:', data);
                alert('Failed to update user status: ' + (data && data.message ? data.message : 'Unknown error'));
                return;
              }

              // Reload users to refresh the table
              loadUsers();
            })
            .catch(function (err) {
              console.error('Set active error:', err);
              alert('Failed to update user status: ' + err.message);
            });
        });
      });
    }

    function showError(msg) {
      const message = msg || 'Failed to load users';
      console.error(message);
      tableBody.innerHTML = `<tr><td colspan="6">${message}</td></tr>`;
      setStatus(message, true);
    }

    function loadUsers() {
      tableBody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';

      const tokenStr = getAuthToken();
      const currentUser = getAuthUser();

      if (!tokenStr || !currentUser) {
        showError('You are not logged in.');
        return;
      }

      if (!currentUser.role || (currentUser.role !== 'owner' && currentUser.role !== 'admin')) {
        showError('You do not have permission to view users.');
        return;
      }

      apiGet('users.list')
        .then(function (data) {
          console.log('users.list response:', data);
          if (!data || !data.success) {
            const msg = (data && (data.message || data.error)) || 'Failed to load users';
            throw new Error(msg);
          }
          renderUsers(data.users || []);
        })
        .catch(function (err) {
          console.error('Failed to load users:', err);
          showError('Failed to load users: ' + err.message);
        });
    }

    function setStatus(msg, isError) {
      statusDiv.textContent = msg || '';
      statusDiv.style.color = isError ? '#b3261e' : '#475569';
    }

    loadUsers();
  </script>
</body>
</html>
