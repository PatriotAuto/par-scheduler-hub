<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Change Password - Patriot Scheduler</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 400px; margin: 40px auto; }
    label { display: block; margin-top: 10px; }
    input { width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box; }
    button { margin-top: 16px; padding: 10px; width: 100%; }
    .error { color: #b00020; margin-top: 10px; }
    .success { color: #007700; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Change Password</h2>

  <form id="changeForm">
    <label>
      Current password
      <input type="password" id="oldPassword" autocomplete="current-password">
    </label>

    <label>
      New password
      <input type="password" id="newPassword" autocomplete="new-password">
    </label>

    <label>
      Confirm new password
      <input type="password" id="confirmPassword" autocomplete="new-password">
    </label>

    <button type="submit" id="changeBtn">Update Password</button>
  </form>

  <div id="message"></div>

  <script src="auth.js"></script> <!-- your shared auth helpers -->
  <script>
    // Make sure user is logged in
    if (!ensureLoggedIn()) {
      throw new Error('Not logged in');
    }

    const API_URL = window.API_URL || 'YOUR_APPS_SCRIPT_EXEC_URL_HERE';

    const form = document.getElementById('changeForm');
    const msgEl = document.getElementById('message');
    const btn = document.getElementById('changeBtn');

    function showMessage(text, type) {
      msgEl.textContent = text;
      msgEl.className = type === 'error' ? 'error' : 'success';
    }

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      msgEl.textContent = '';

      const oldPw = document.getElementById('oldPassword').value;
      const newPw = document.getElementById('newPassword').value;
      const confirmPw = document.getElementById('confirmPassword').value;

      if (!oldPw || !newPw || !confirmPw) {
        showMessage('All fields are required.', 'error');
        return;
      }
      if (newPw !== confirmPw) {
        showMessage('New passwords do not match.', 'error');
        return;
      }
      if (newPw.length < 8) {
        showMessage('Password must be at least 8 characters.', 'error');
        return;
      }

      btn.disabled = true;

      fetch(API_URL, {
        method: 'POST',
        headers: buildAuthHeaders(),
        body: JSON.stringify({
          action: 'auth.changePassword',
          oldPassword: oldPw,
          newPassword: newPw,
          confirmPassword: confirmPw
        })
      })
      .then(function (res) { return res.json(); })
      .then(function (data) {
        if (!data || !data.success) {
          showMessage((data && data.message) || 'Failed to change password.', 'error');
          btn.disabled = false;
          return;
        }

        showMessage('Password updated. Please log in again.', 'success');

        // Optional: log out and redirect to login
        localStorage.removeItem('ps_token');
        localStorage.removeItem('ps_user');
        setTimeout(function () {
          window.location.href = 'login.html';
        }, 2000);
      })
      .catch(function (err) {
        console.error(err);
        showMessage('Error contacting server.', 'error');
        btn.disabled = false;
      });
    });
  </script>
</body>
</html>
