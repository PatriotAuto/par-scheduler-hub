<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Patriot Auto Restyling – Scheduler Hub v1.8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --par-navy:#050b18;--par-navy-soft:#0b1f33;--par-red:#e30613;--par-light:#f5f7fb;
      --par-border:#2b3950;--par-text:#fdfdfd;--par-muted:#9ca7c0;
      --dept-tint:#e53935;--dept-ppf:#2962ff;--dept-ceramic:#00c853;--dept-detail:#ffb300;--dept-electronics:#ab47bc;--timeoff:#8d8d8d;
      --grid-bg:#f2f4fb;--grid-header-bg:#e3e7f1;--grid-border-strong:rgba(0,0,0,.25);--grid-border-light:rgba(0,0,0,.15);
      --slot-height:32px;
      --tech-count:6;
      --cal-col-min:140px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystem,"Segoe UI",sans-serif;}
    body{margin:0;background:radial-gradient(circle at top,#101b2e,#02040a);color:var(--par-text);}
    .page{min-height:100vh;display:flex;flex-direction:column;}
    header{padding:16px 24px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;gap:16px;background:linear-gradient(90deg,#050b18,#0a1727);}
    header .title{display:flex;flex-direction:column;gap:2px;}
    header .title h1{margin:0;font-size:20px;letter-spacing:.08em;text-transform:uppercase;}
    header .title span{font-size:12px;color:var(--par-muted);}
    .header-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .header-btn{border-radius:999px;border:1px solid rgba(255,255,255,.25);background:rgba(227,6,19,.12);color:#fff;padding:6px 12px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;cursor:pointer;}
    .header-btn.active{background:rgba(227,6,19,.3);}
    .header-btn:hover{background:rgba(227,6,19,.25);}
    .main{flex:1;display:flex;min-height:0;}
    .left{flex:1.4;border-right:1px solid rgba(255,255,255,.08);background:#e6e9f3;padding:14px;display:flex;flex-direction:column;gap:10px;min-width:0;}
    .right{flex:1;background:radial-gradient(circle at top right,#121b2d,#050915);padding:16px;min-width:0;display:flex;flex-direction:column;gap:10px;}
    .left-top-row{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;}
    .chips{display:flex;flex-wrap:wrap;gap:6px;}
    .chip{border-radius:999px;padding:4px 10px;font-size:11px;border:1px solid rgba(0,0,0,.1);background:rgba(255,255,255,.9);color:#374151;display:inline-flex;align-items:center;gap:6px;cursor:pointer;}
    .chip.active{border-color:var(--par-red);background:rgba(227,6,19,.08);color:#111827;}
    .chip .dot{width:8px;height:8px;border-radius:50%;}
    .dot-detail{background:var(--dept-detail);} .dot-tint{background:var(--dept-tint);} .dot-ppf{background:var(--dept-ppf);}
    .dot-ceramic{background:var(--dept-ceramic);} .dot-electronics{background:var(--dept-electronics);} .dot-timeoff{background:var(--timeoff);}
    .date-controls{display:flex;flex-direction:column;align-items:flex-end;gap:4px;font-size:12px;color:#4b5563;}
    .date-row{display:flex;align-items:center;gap:6px;}
    .nav-btn{border-radius:999px;border:1px solid rgba(0,0,0,.2);background:#fff;color:#111827;padding:4px 8px;font-size:11px;cursor:pointer;}
    .nav-btn:hover{background:#f3f4f6;}
    .date-label{font-size:12px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:#111827;}
    #dayPicker{border-radius:999px;border:1px solid rgba(0,0,0,.2);background:#fff;color:#111827;font-size:11px;padding:4px 8px;cursor:pointer;}
    .cal-wrapper{flex:1;border-radius:12px;background:var(--grid-bg);border:3px solid var(--grid-border-strong);display:flex;flex-direction:column;overflow:hidden;min-height:260px;box-shadow:0 12px 24px rgba(15,23,42,.25);}
    .cal-scroll{flex:1;display:flex;flex-direction:column;overflow:auto;}
    .cal-header-row{display:grid;grid-template-columns:60px repeat(var(--tech-count),minmax(var(--cal-col-min),1fr));font-size:11px;padding:4px 4px 6px;border-bottom:3px solid var(--grid-border-strong);background:var(--grid-header-bg);position:sticky;top:0;z-index:5;min-width:calc(60px + var(--tech-count)*var(--cal-col-min));}
    .cal-header-cell{text-align:center;font-weight:600;color:#111827;}
    .cal-body{flex:1;display:flex;flex-direction:column;min-height:0;}
    .cal-row{display:grid;grid-template-columns:60px repeat(var(--tech-count),minmax(var(--cal-col-min),1fr));border-bottom:2px solid var(--grid-border-light);font-size:11px;background:linear-gradient(to right,rgba(255,255,255,.9),rgba(255,255,255,.9));height:var(--slot-height,32px);min-width:calc(60px + var(--tech-count)*var(--cal-col-min));}
    .cal-row:nth-child(2n){background:linear-gradient(to right,rgba(249,250,251,.95),rgba(249,250,251,.95));}
    .cal-time-cell{padding:2px 4px;text-align:right;color:#4b5563;font-weight:500;background:#e5e7eb;border-right:2px solid var(--grid-border-strong);}
    .cal-slot-cell{border-left:2px solid var(--grid-border-light);position:relative;cursor:pointer;background:transparent;transition:background .12s,box-shadow .12s,transform .05s;overflow:visible;}
    .cal-slot-cell:hover{background:rgba(227,6,19,.06);box-shadow:inset 0 0 0 1px rgba(227,6,19,.35);}
    .cal-slot-cell.selected{background:rgba(227,6,19,.1);box-shadow:inset 0 0 0 2px rgba(227,6,19,.8);transform:translateY(-1px);}
    .cal-slot-cell.off-shift{background:repeating-linear-gradient(45deg,rgba(15,23,42,.02),rgba(15,23,42,.02) 4px,rgba(15,23,42,.07) 4px,rgba(15,23,42,.07) 8px);}
    .cal-slot-cell.blocked-slot{background:linear-gradient(to right, rgba(227,6,19,0.08), rgba(227,6,19,0.14));}
    .cal-slot-inner{padding:1px 4px;height:100%;display:flex;align-items:center;gap:2px;overflow:hidden;}
    .blocked-preview{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:10px;background:rgba(255,255,255,.9);color:#111827;font-size:10px;box-shadow:0 1px 2px rgba(15,23,42,.18);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .blocked-preview .blocked-text{max-width:140px;overflow:hidden;text-overflow:ellipsis;}
    .cal-slot-cell.timeoff-block{
      background:linear-gradient(to right, rgba(141,141,141,0.25), rgba(141,141,141,0.35));
    }
        .cal-slot-cell.shop-closed{
      background:repeating-linear-gradient(
        45deg,
        rgba(220,38,38,0.06),
        rgba(220,38,38,0.06) 4px,
        rgba(220,38,38,0.16) 4px,
        rgba(220,38,38,0.16) 8px
      );
    }

    .event-pill{border-radius:999px;padding:1px 6px;font-size:10px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;box-shadow:0 1px 2px rgba(15,23,42,.25);display:inline-flex;align-items:center;gap:3px;}
    .event-bubble{position:absolute;left:2px;right:2px;top:2px;display:flex;flex-direction:column;gap:6px;padding:8px;border-radius:10px;color:#0b1324;background:rgba(255,255,255,.96);box-shadow:0 6px 16px rgba(0,0,0,.28);border:1px solid rgba(0,0,0,.08);overflow:hidden;}
    .event-bubble .bubble-header{display:flex;flex-direction:column;gap:4px;}
    .event-bubble .bubble-title{font-weight:700;font-size:12px;color:#0f172a;}
    .event-bubble .bubble-sub{font-size:11px;color:#1f2937;}
    .event-bubble .bubble-sub.muted{color:#6b7280;font-weight:600;}
    .event-bubble .bubble-icons{display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:10px;}
    .event-bubble .bubble-foot{margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:6px;}
    .event-bubble .bubble-foot-left{display:flex;align-items:center;gap:4px;flex-wrap:wrap;}
    .event-bubble .bubble-foot .bubble-time{font-size:11px;font-weight:700;color:#0f172a;}
    .event-detailing{background:var(--dept-detail);}
    .event-tint{background:var(--dept-tint);color:#fff;}
    .event-ppf{background:var(--dept-ppf);color:#fff;}
    .event-ceramic{background:var(--dept-ceramic);}
    .event-electronics{background:var(--dept-electronics);color:#fff;}
    .event-bubble.event-detailing{border-left:5px solid var(--dept-detail);}
    .event-bubble.event-tint{border-left:5px solid var(--dept-tint);}
    .event-bubble.event-ppf{border-left:5px solid var(--dept-ppf);}
    .event-bubble.event-ceramic{border-left:5px solid var(--dept-ceramic);}
    .event-bubble.event-electronics{border-left:5px solid var(--dept-electronics);}
    .event-timeoff{background:var(--timeoff);color:#fff;}
    .event-status-icon{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;font-size:10px;font-weight:700;color:#111827;background:#fef3c7;}
    .event-status-icon.scheduled{background:#fef3c7;color:#92400e;}
    .event-status-icon.checkin{background:#dbeafe;color:#1e3a8a;}
    .event-status-icon.completed{background:#dcfce7;color:#166534;}
    .event-status-icon.cancelled{background:#fee2e2;color:#991b1b;}
    .event-status-icon.noshow{background:#ede9fe;color:#4c1d95;}
    .service-progress-icon{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:6px;font-size:10px;font-weight:800;border:1px solid rgba(0,0,0,.12);background:#fff;color:#111827;}
    .service-progress-icon.queue{background:#fff7ed;color:#b45309;}
    .service-progress-icon.started{background:#e0f2fe;color:#075985;}
    .service-progress-icon.done{background:#dcfce7;color:#166534;}
    .invoice-icon{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;font-size:11px;font-weight:800;}
    .invoice-icon.pending{background:#fef3c7;color:#b45309;}
    .invoice-icon.paid{background:#dcfce7;color:#15803d;}
    .status-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:10px;border:1px solid rgba(0,0,0,.1);background:#fff;color:#111827;}
    .status-summary{display:flex;align-items:center;gap:6px;flex-wrap:wrap;min-height:24px;}
    .status-summary-note{font-size:10px;color:#6b7280;}
    .small-badge{font-size:9px;padding:0 4px;border-radius:999px;background:rgba(0,0,0,.2);color:#f9fafb;text-transform:uppercase;}
    .cal-legend{margin:6px 8px 4px;display:flex;flex-wrap:wrap;gap:8px;font-size:10px;color:#4b5563;}
    .legend-item{display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,.8);border-radius:999px;padding:2px 8px;border:1px solid rgba(0,0,0,.06);}
    .bottom-info-row{display:flex;gap:10px;padding:6px 8px 8px;border-top:1px solid rgba(0,0,0,.12);background:#e5e7f3;}
    .dealer-queue{
      flex:1;
      background:#f9fafb;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.1);
      padding:6px 8px;
      font-size:11px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .dealer-queue{color:#000;}
    .dealer-queue-title{font-weight:700;text-transform:uppercase;letter-spacing:.08em;font-size:10px;color:#111827;}
    .dealer-queue-empty{font-size:10px;color:#6b7280;font-style:italic;}
    .dealer-queue-item{padding:4px 6px;border-radius:6px;background:#eef2ff;border:1px solid rgba(79,70,229,.3);display:flex;justify-content:space-between;align-items:center;gap:6px;}
    .dq-badge{
      padding:1px 5px;
      border-radius:999px;
      background:#e5e7eb;
      color:#000;
      font-size:9px;
      text-transform:uppercase;
    }
    .panel-title{font-size:13px;text-transform:uppercase;letter-spacing:.14em;color:var(--par-muted);}
    .panel-divider{height:1px;background:linear-gradient(90deg,rgba(255,255,255,.06),rgba(227,6,19,.6),rgba(255,255,255,.06));margin:4px 0 8px;}
    form{display:flex;flex-direction:column;gap:10px;flex:1;overflow-y:auto;padding-right:4px;}
    label{font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:var(--par-muted);}
    input,select,textarea{width:100%;border-radius:8px;border:1px solid var(--par-border);background:rgba(10,18,38,.95);color:var(--par-text);font-size:13px;padding:8px 10px;outline:none;}
    input:focus,select:focus,textarea:focus{border-color:var(--par-red);box-shadow:0 0 0 1px rgba(227,6,19,.3);}
    input.date-input{cursor:pointer;}
    textarea{min-height:60px;resize:vertical;}
    .field-group{display:flex;flex-direction:column;gap:6px;}
    .field-row{display:flex;gap:8px;}
    .field-row .field-group{flex:1;}
    .service-row{display:grid;grid-template-columns:1.1fr 1.1fr 1fr 1fr .9fr .9fr 70px;gap:8px;align-items:end;}
    .service-row .btn{align-self:end;width:100%;}
    .input-actions{display:flex;gap:6px;align-items:center;}
    .input-actions input{flex:1;}
    .icon-button.subtle{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.15);padding:7px 10px;font-size:11px;}
    .icon-button.subtle:hover{background:rgba(227,6,19,.18);}
    .field-note{font-size:11px;color:var(--par-muted);}
    .inline-checkbox{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--par-muted);}
    .inline-checkbox input[type=checkbox]{width:auto;}
    .status{font-size:11px;min-height:16px;color:var(--par-muted);}
    .actions{display:flex;gap:10px;margin-top:6px;flex-wrap:wrap;}
    .btn{border-radius:8px;padding:10px 14px;border:none;cursor:pointer;font-weight:600;text-transform:uppercase;letter-spacing:.06em;}
    .btn-primary{background:var(--par-red);color:#fff;flex:1;}
    .btn-clear{background:#263040;color:var(--par-muted);}
    .btn-danger{background:#7f1d1d;color:#fee2e2;}
    .btn-danger:hover{background:#991b1b;}
    .timeoff-note{font-size:11px;color:var(--par-muted);}
    .weekly-card{margin-top:8px;border-radius:10px;border:1px solid rgba(255,255,255,.12);padding:8px 10px;background:rgba(3,10,25,.9);display:flex;flex-direction:column;gap:6px;}
    .week-row{display:grid;grid-template-columns:90px 1fr 1fr 90px;gap:8px;align-items:center;font-size:12px;}
    .week-row-label{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--par-muted);}
    .week-row select{background:rgba(10,18,38,.95);border-radius:6px;border:1px solid var(--par-border);color:var(--par-text);font-size:12px;padding:4px 6px;}
    .week-row-off{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--par-muted);}
    @media(max-width:1000px){
      .main{flex-direction:column;}
      .left{border-right:none;border-bottom:1px solid rgba(255,255,255,.08);}
    }
    @media(max-width:768px){
      header{
        padding:12px 14px;
        flex-direction:column;
        align-items:flex-start;
        gap:8px;
      }
      .header-actions{
        width:100%;
        justify-content:flex-start;
        flex-wrap:wrap;
      }
      .left,.right{
        padding:10px;
      }
      .chips{
        width:100%;
      }
      .cal-wrapper{
        min-height:220px;
      }
      .cal-scroll{
        overflow:auto;
      }
      .cal-header-row,
      .cal-row{
        min-width:calc(60px + var(--tech-count)*var(--cal-col-min));
        height:32px;
      }
      .service-row{
        grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
        align-items:start;
      }
      .service-row .btn{
        margin-top:4px;
        width:100%;
      }
      .bottom-info-row{
        flex-direction:column;
      }
      .dealer-queue{
        width:100%;
      }
      .btn{
        padding:9px 10px;
        font-size:11px;
      }
      input,select,textarea{
        font-size:12px;
        padding:7px 9px;
      }
    }
    @media(max-width:540px){
      .service-row{
        grid-template-columns:1fr;
      }
      .service-row .field-group{min-width:0;}
    }

    /* Appointment pop-up */
    .popup-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.65);z-index:1500;padding:12px;}
    .popup-card{background:#0b1324;border:1px solid rgba(255,255,255,.12);border-radius:12px;max-width:520px;width:100%;box-shadow:0 18px 40px rgba(0,0,0,.45);color:#f9fafb;display:flex;flex-direction:column;}
    .popup-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08);}
    .popup-title{display:flex;flex-direction:column;gap:4px;}
    .popup-title h3{margin:0;font-size:16px;letter-spacing:.08em;text-transform:uppercase;}
    .popup-title span{font-size:12px;color:var(--par-muted);}
    .popup-actions{display:flex;align-items:center;gap:8px;}
    .icon-button{border:none;background:rgba(255,255,255,.08);color:#f9fafb;border-radius:8px;padding:6px 10px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;font-weight:600;letter-spacing:.04em;}
    .icon-button:hover{background:rgba(227,6,19,.22);}
    .popup-body{padding:12px 14px;display:flex;flex-direction:column;gap:10px;}
    .popup-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .popup-badge{padding:4px 8px;border-radius:8px;background:rgba(255,255,255,.08);font-size:11px;display:inline-flex;align-items:center;gap:6px;}
    .popup-list{border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:10px;background:rgba(5,11,24,.6);display:flex;flex-direction:column;gap:6px;}
    .popup-list-item{display:flex;justify-content:space-between;gap:10px;align-items:center;font-size:12px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,.04);}
    .popup-list-item select{min-width:130px;}
    .popup-close{border:none;background:none;color:var(--par-muted);font-size:18px;cursor:pointer;}

    /* Custom date picker */
    .date-picker-popup{
      position:absolute;
      z-index:1000;
      width:230px;
      background:#111827;
      color:#f9fafb;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.15);
      box-shadow:0 12px 25px rgba(15,23,42,.6);
      padding:8px;
      font-size:12px;
      display:none;
    }
    .date-picker-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
    }
    .date-picker-header button{
      border:none;
      background:rgba(15,23,42,.8);
      color:#e5e7eb;
      border-radius:999px;
      padding:2px 6px;
      cursor:pointer;
      font-size:11px;
    }
    .date-picker-month{
      font-weight:600;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-size:11px;
    }
    .date-picker-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:2px;
    }
    .date-picker-cell{
      text-align:center;
      padding:4px 0;
      border-radius:6px;
      cursor:pointer;
    }
    .date-picker-cell.disabled{
      color:#6b7280;
      cursor:default;
    }
    .date-picker-cell.day-name{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#9ca3af;
      cursor:default;
    }
    .date-picker-cell.day{
      background:rgba(15,23,42,.9);
    }
    .date-picker-cell.day:hover{
      background:rgba(227,6,19,.6);
    }
    .date-picker-cell.selected{
      background:var(--par-red);
      font-weight:700;
    }
    .date-picker-cell.today{
      border:1px solid var(--par-red);
    }

#customer-database.card {
  background: #ffffff;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  margin-bottom: 24px;
  overflow: hidden;
}

#customer-database .card-header {
  padding: 16px 20px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
}

#customer-database .card-header h2 {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
}

#customer-database .card-body {
  padding: 16px 20px 20px;
}

.customer-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  justify-content: space-between;
  align-items: flex-end;
  margin-bottom: 16px;
}

.customer-search {
  flex: 1 1 240px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.customer-search input {
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid #d1d5db;
  font-size: 0.95rem;
}

.customer-form {
  display: none;
  padding: 12px 12px 16px;
  margin-bottom: 16px;
  border-radius: 8px;
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  gap: 10px;
}

.customer-form .form-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 8px;
}

.customer-form .form-field {
  flex: 1 1 180px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.customer-form .form-field-full {
  flex: 1 1 100%;
}

.customer-form label {
  font-size: 0.85rem;
  color: #4b5563;
}

.customer-form input,
.customer-form textarea {
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid #d1d5db;
  font-size: 0.95rem;
}

.customer-form textarea {
  resize: vertical;
}

.required {
  color: #dc2626;
  margin-left: 2px;
}

.form-actions {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

.btn-primary,
.btn-secondary {
  border-radius: 6px;
  padding: 8px 14px;
  font-size: 0.9rem;
  border: none;
  cursor: pointer;
}

.btn-primary {
  background: #2563eb;
  color: #ffffff;
}

.btn-primary:hover {
  background: #1d4ed8;
}

.btn-secondary {
  background: #e5e7eb;
  color: #111827;
}

.btn-secondary:hover {
  background: #d1d5db;
}

.table-wrapper {
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  overflow: hidden;
}

#customerTable {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}

#customerTable thead {
  background: #f3f4f6;
}

#customerTable th,
#customerTable td {
  padding: 8px 10px;
  border-bottom: 1px solid #e5e7eb;
  vertical-align: top;
}

#customerTable tbody tr:hover {
  background: #f9fafb;
}

#customerTable td:last-child {
  text-align: right;
}

.empty-state {
  padding: 12px 10px;
  text-align: center;
  font-size: 0.9rem;
  color: #6b7280;
}

.btn-sm {
  padding: 4px 8px;
  font-size: 0.8rem;
}

.customer-history {
  margin-top: 16px;
}

.customer-history h3 {
  margin: 0 0 8px;
  font-size: 1rem;
  font-weight: 600;
  color: #111827;
}

#customerHistory .table-wrapper {
  margin-top: 4px;
  display: none; /* hidden until we have data */
}

.global-search {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
}

.global-search input {
  flex: 1 1 auto;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid #d1d5db;
  font-size: 0.9rem;
}

.btn-global-search {
  padding: 6px 12px;
  font-size: 0.85rem;
}

/* Overlay */

.global-search-overlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: none;
}

.global-search-overlay-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(15, 23, 42, 0.45);
}

.global-search-modal {
  position: relative;
  margin: 40px auto;
  max-width: 900px;
  max-height: 80vh;
  background: #ffffff;
  border-radius: 10px;
  box-shadow: 0 10px 40px rgba(15, 23, 42, 0.3);
  padding: 16px 18px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.global-search-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.global-search-modal-header h2 {
  margin: 0;
  font-size: 1.1rem;
  font-weight: 600;
}

.global-search-summary {
  font-size: 0.85rem;
  color: #6b7280;
  margin-bottom: 8px;
}

.global-search-sections {
  display: flex;
  flex: 1 1 auto;
  gap: 12px;
  overflow: auto;
}

.global-search-section {
  flex: 1 1 260px;
  min-width: 0;
}

.global-search-section h3 {
  margin: 0 0 4px;
  font-size: 0.9rem;
  font-weight: 600;
  color: #111827;
}

.search-modal {
  background: #ffffff !important;
  color: #000000 !important;
  padding: 25px !important;
  border-radius: 12px !important;
  max-width: 800px !important;
  width: 90% !important;
}

.search-modal h2,
.search-modal h3,
.search-modal h4,
.search-modal p,
.search-modal span,
.search-modal div {
  color: #000 !important;
}

.search-result-entry {
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  margin-bottom: 10px;
  background: #f5f5f5;
}

.search-result-entry:hover {
  background: #e9e9e9;
}

.search-result-entry .title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 4px;
  color: #000 !important;
}

.search-result-entry .details {
  font-size: 14px;
  line-height: 1.3;
  color: #333 !important;
}

.search-modal-overlay {
  background: rgba(0,0,0,0.55) !important;
}

/* Reuse lookup-list styles already defined, but ensure scroll */

.global-search-section .lookup-list {
  max-height: 230px;
  overflow-y: auto;
}

/* Appointments table inside modal */

#globalSearchAppointmentsTableWrapper {
  display: none;
}

#globalSearchAppointmentsTable {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.8rem;
}

#globalSearchAppointmentsTable th,
#globalSearchAppointmentsTable td {
  padding: 6px 8px;
  border-bottom: 1px solid #e5e7eb;
}

#globalSearchAppointmentsTable tbody tr:hover {
  background: #f9fafb;
}

/* PAR logo inside the header */
.par-logo-container {
  display: flex;
  align-items: center;
  gap: 8px;
}

.par-logo {
  height: 40px;
  object-fit: contain;
}
</style>
</head>
<body>
  <div class="page">
    <header>
      <div class="title">
        <div class="par-logo-container">
          <img
            src="assets/img/FullLogo_Transparent_NoBuffer (1).png"
            alt="Patriot Auto Restyling Logo"
            class="par-logo"
          />
        </div>
        <span>Internal Scheduler Hub · Daily Tech View</span>
      </div>
      <div class="header-actions">
        <a href="index.html" id="btnAppointmentsPanel" class="header-btn nav-button">Calendar</a>
        <a href="customers.html" id="btnCustomersNav" class="header-btn nav-button">Customers</a>
        <a href="tech-time-off.html" id="btnTimeOffPanel" class="header-btn nav-button">Tech Time Off</a>
        <a href="holidays.html" id="btnHolidaysNav" class="header-btn nav-button">Holidays</a>
        <a href="tech-schedules.html" id="btnSchedulesPanel" class="header-btn nav-button">Tech Schedules</a>
        <a href="services.html" id="btnServicesPanel" class="header-btn nav-button active">Services</a>
        <button id="btnRefreshFromCloud" class="header-btn">Refresh From Cloud</button>
      </div>
    </header>

    <div id="globalSearchBar" class="global-search">
      <input
        id="globalSearchInput"
        type="text"
        placeholder="Search by name, phone, email, VIN, or stock #..."
        autocomplete="off"
      />
      <button id="globalSearchButton" type="button" class="btn btn-primary btn-global-search">
        Search
      </button>
    </div>

    <h1 class="page-title" style="padding: 16px 24px 0; margin: 0;">Services</h1>

    <div class="main">
    <div class="left" style="display:none;">
      <div class="left-top-row">
        <div class="chips" id="chipsContainer"></div>
        
        <div class="date-controls">
          <div class="date-row">
            <button class="nav-btn" id="btnPrevDay">◀</button>
            <span class="date-label" id="dayLabel">Today</span>
            <button class="nav-btn" id="btnNextDay">▶</button>
          </div>
          <div class="date-row">
            <span style="font-size:10px;">Jump to date:</span>
            <input type="text" id="dayPicker" class="date-input" placeholder="YYYY-MM-DD" readonly />
          </div>
        </div>
      </div>

      <div class="cal-wrapper">
        <div class="cal-legend" aria-label="Status legend">
          <span class="legend-item"><span class="event-status-icon scheduled">S</span>Scheduled</span>
          <span class="legend-item"><span class="event-status-icon checkin">I</span>Check In</span>
          <span class="legend-item"><span class="event-status-icon completed">C</span>Completed</span>
          <span class="legend-item"><span class="event-status-icon cancelled">X</span>Cancelled</span>
          <span class="legend-item"><span class="event-status-icon noshow">N</span>No Show</span>
          <span class="legend-item"><span class="service-progress-icon queue">⏳</span>In Queue</span>
          <span class="legend-item"><span class="service-progress-icon started">▶</span>Started</span>
          <span class="legend-item"><span class="service-progress-icon done">✔</span>Completed</span>
          <span class="legend-item"><span class="invoice-icon pending">$</span>Invoiced</span>
          <span class="legend-item"><span class="invoice-icon paid">$</span>Paid</span>
        </div>
        <div class="cal-scroll">
          <div class="cal-header-row" id="calHeaderRow"></div>
          <div class="cal-body" id="calBody"></div>
        </div>
        <div class="cal-legend">
          <span class="legend-item"><span class="dot dot-detail"></span>Detailing</span>
          <span class="legend-item"><span class="dot dot-tint"></span>Tint</span>
          <span class="legend-item"><span class="dot dot-ppf"></span>PPF</span>
          <span class="legend-item"><span class="dot dot-ceramic"></span>Ceramic</span>
          <span class="legend-item"><span class="dot dot-electronics"></span>Electronics</span>
          <span class="legend-item"><span class="dot dot-timeoff"></span>Tech Time Off</span>
        </div>
        <div class="bottom-info-row">
          <div class="dealer-queue">
            <div class="dealer-queue-title">Dealer Queue (Today)</div>
            <div id="dealerQueueList" class="dealer-queue-empty">No dealer jobs queued for this day.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="right">
      <!-- Appointments -->
      <div id="appointmentPanel" style="display:none;">
        <div class="panel-title">Create / Edit Appointment</div>
        <div class="panel-divider"></div>
        <form id="appointmentForm" onsubmit="return false;">
          <div class="field-row">
            <div class="field-group">
              <label>Customer First Name</label>
              <input id="inputCustomerFirstName" placeholder="First name" />
            </div>
            <div class="field-group">
              <label>Customer Last Name</label>
              <input id="inputCustomerLastName" placeholder="Last name" />
            </div>
            <div class="field-group">
              <label>&nbsp;</label>
              <div class="inline-checkbox">
                <input type="checkbox" id="checkboxDealer" />
                <span>Dealer Job (Dealer Queue)</span>
              </div>
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Phone</label>
              <input id="inputCustomerPhone" placeholder="(555) 123-4567" />
            </div>
            <div class="field-group">
              <label>Email</label>
              <input type="email" id="inputCustomerEmail" placeholder="email@example.com" />
            </div>
          </div>
          <div class="field-row">
            <div class="field-group" style="flex:1.4;">
              <label>VIN</label>
              <div class="input-actions">
                <input id="inputVin" placeholder="Scan or enter VIN" maxlength="17" />
                <button type="button" class="icon-button subtle" id="btnVinScan">VIN Scan</button>
              </div>
              <div class="field-note" id="vinHelperText">Scan VIN to auto-fill year, make, and model.</div>
            </div>
            <div class="field-group">
              <label>Stock #</label>
              <input id="inputStockNumber" placeholder="Inventory ID" />
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Year</label>
              <input id="inputVehicleYear" placeholder="YYYY" maxlength="4" />
            </div>
            <div class="field-group">
              <label>Make</label>
              <input id="inputVehicleMake" placeholder="Manufacturer" />
            </div>
            <div class="field-group">
              <label>Model</label>
              <input id="inputVehicleModel" placeholder="Model" />
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Appointment Date</label>
              <input type="text" id="datePicker" class="date-input" placeholder="YYYY-MM-DD" readonly />
            </div>
            <div class="field-group">
              <label>&nbsp;</label>
              <div class="inline-checkbox">
                <input type="checkbox" id="checkboxCustomerWaiting" />
                <span>Customer Waiting</span>
              </div>
            </div>
          </div>

          <div class="field-group">
            <label>Service & Technician Assignments</label>
            <div id="serviceAssignments"></div>
            <button type="button" class="btn btn-clear" id="btnAddServiceRow" style="margin-top:6px;">+ Add Service</button>
          </div>

          <div class="field-row">
            <div class="field-group">
              <label>Ride / Pickup Options</label>
              <div class="inline-checkbox">
                <input type="checkbox" id="checkboxRideNeeded" />
                <span>Ride Needed</span>
              </div>
              <div class="field-group">
                <label style="font-size:10px;text-transform:none;letter-spacing:0;">Ride Time</label>
                <select id="inputRideTime"></select>
              </div>
              <div class="inline-checkbox">
                <input type="checkbox" id="checkboxPickupDelivery" />
                <span>Pickup / Delivery</span>
              </div>
            </div>
            <div class="field-group">
              <label>Pickup / Delivery Times</label>
              <div class="field-group">
                <label style="font-size:10px;text-transform:none;letter-spacing:0;">Pickup Time</label>
                <select id="inputPickupTime"></select>
              </div>
              <div class="field-group">
                <label style="font-size:10px;text-transform:none;letter-spacing:0;">Delivery Time</label>
                <select id="inputDeliveryTime"></select>
              </div>
            </div>
          </div>
<div class="field-group">
  <label>Notes</label>
  <textarea id="inputNotes" placeholder="Deposit paid? Keys in drop box?"></textarea>
</div>

<div class="field-group">
  <label>Status &amp; Billing</label>
  <div id="statusSummary" class="status-summary"></div>
  <div class="timeoff-note">Update status or billing from the appointment pop-up.</div>
  <select id="inputStatus" style="display:none;" disabled>
    <option value="Scheduled">Scheduled</option>
    <option value="Check In">Check In</option>
    <option value="Cancelled">Cancelled</option>
    <option value="No Show">No Show</option>
    <option value="Completed">Completed</option>
  </select>
  <div style="display:none;">
    <input type="checkbox" id="checkboxInvoiced" />
    <input type="checkbox" id="checkboxPaid" />
  </div>
</div>

<div class="inline-checkbox" style="margin-top:4px;">
  <input type="checkbox" id="checkboxOverrideClosed" />
  <span>Override shop hours & holidays for this booking</span>
</div>

<div class="status" id="statusText">Click a tech/time slot on the left or pick a date here to start. Click an existing pill to edit.</div>

          <div class="actions">
            <button type="button" class="btn btn-clear" id="btnClear">Clear</button>
            <button type="button" class="btn btn-danger" id="btnDeleteAppointment">Delete</button>
            <button type="button" class="btn btn-primary" id="btnCreateAppointment">Save Appointment</button>
          </div>
        </form>
      </div>

      <!-- Time off -->
      <div id="timeOffPanel" style="display:none;">
        <div class="panel-title">Tech Time Off</div>
        <div class="panel-divider"></div>
        <form id="timeOffForm" onsubmit="return false;">
          <div class="field-row">
            <div class="field-group">
              <label>Technician</label>
              <select id="timeOffTechnician">
                <option value="">Select tech</option>
                <option>William</option><option>Limage</option><option>Kaiden</option><option>Luke</option><option>Fafa</option><option>Matt</option>
              </select>
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Start Date</label>
              <input type="text" id="timeOffStartDate" class="date-input" placeholder="YYYY-MM-DD" readonly />
            </div>
            <div class="field-group">
              <label>End Date</label>
              <input type="text" id="timeOffEndDate" class="date-input" placeholder="YYYY-MM-DD" readonly />
            </div>
          </div>

          <div class="field-row">
            <div class="field-group">
              <label>&nbsp;</label>
              <div class="inline-checkbox">
                <input type="checkbox" id="timeOffAllDay" />
                <span>All day (block full working hours for each date)</span>
              </div>
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Start Time</label>
              <select id="timeOffStartTime"></select>
            </div>
            <div class="field-group">
              <label>End Time</label>
              <select id="timeOffEndTime"></select>
            </div>
          </div>
          <div class="field-group">
            <label>Notes</label>
            <textarea id="timeOffNotes" placeholder="Reason for time off (optional)"></textarea>
          </div>
          <div class="timeoff-note">Leave Start/End Time empty to block the full working day for the date range.</div>
          <div class="actions">
            <button type="button" class="btn btn-clear" id="btnClearTimeOff">Clear</button>
            <button type="button" class="btn btn-danger" id="btnDeleteTimeOff">Delete Time Off</button>
            <button type="button" class="btn btn-primary" id="btnSaveTimeOff">Save Time Off</button>
          </div>
        </form>
      </div>

      <!-- Tech schedules -->
      <div id="schedulesPanel" style="display:none;">
        <div class="panel-title">Tech Schedules</div>
        <div class="panel-divider"></div>
        <form id="schedulesForm" onsubmit="return false;">
          <div class="field-group">
            <label>Select Technician</label>
            <select id="scheduleTechSelect">
              <option value="">Choose tech</option>
              <option>William</option><option>Limage</option><option>Kaiden</option><option>Luke</option><option>Fafa</option><option>Matt</option>
            </select>
          </div>
          <div class="weekly-card">
            <div class="week-row">
              <div class="week-row-label">Monday</div>
              <select id="sched_Monday_start"></select>
              <select id="sched_Monday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Monday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Tuesday</div>
              <select id="sched_Tuesday_start"></select>
              <select id="sched_Tuesday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Tuesday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Wednesday</div>
              <select id="sched_Wednesday_start"></select>
              <select id="sched_Wednesday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Wednesday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Thursday</div>
              <select id="sched_Thursday_start"></select>
              <select id="sched_Thursday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Thursday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Friday</div>
              <select id="sched_Friday_start"></select>
              <select id="sched_Friday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Friday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Saturday</div>
              <select id="sched_Saturday_start"></select>
              <select id="sched_Saturday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Saturday_off" /><span>Off?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Sunday</div>
              <select id="sched_Sunday_start"></select>
              <select id="sched_Sunday_end"></select>
              <div class="week-row-off"><input type="checkbox" id="sched_Sunday_off" /><span>Off?</span></div>
            </div>
          </div>
          <div class="timeoff-note">These hours control which parts of the grid show as off-shift for each tech, per weekday. (Saved in this browser.)</div>
          <div class="actions">
            <button type="button" class="btn btn-primary" id="btnSaveSchedules">Save Tech Schedule</button>
          </div>
                    <!-- ⬇️ BEGIN SHOP HOURS & HOLIDAYS BLOCK ⬇️ -->
          <div class="panel-divider" style="margin-top:12px;"></div>
          <div class="panel-title" style="font-size:11px;">Shop Hours</div>

          <div class="weekly-card" id="officeHoursCard">
            <div class="week-row">
              <div class="week-row-label">Monday</div>
              <select id="office_Monday_open"></select>
              <select id="office_Monday_close"></select>
              <div class="week-row-off"><input type="checkbox" id="office_Monday_closed" /><span>Closed?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Tuesday</div>
              <select id="office_Tuesday_open"></select>
              <select id="office_Tuesday_close"></select>
              <div class="week-row-off"><input type="checkbox" id="office_Tuesday_closed" /><span>Closed?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Wednesday</div>
              <select id="office_Wednesday_open"></select>
              <select id="office_Wednesday_close"></select>
              <div class="week-row-off"><input type="checkbox" id="office_Wednesday_closed" /><span>Closed?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Thursday</div>
              <select id="office_Thursday_open"></select>
              <select id="office_Thursday_close"></select>
              <div class="week-row-off"><input type="checkbox" id="office_Thursday_closed" /><span>Closed?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Friday</div>
              <select id="office_Friday_open"></select>
              <select id="office_Friday_close"></select>
              <div class="week-row-off"><input type="checkbox" id="office_Friday_closed" /><span>Closed?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Saturday</div>
              <select id="office_Saturday_open"></select>
              <select id="office_Saturday_close"></select>
              <div class="week-row-off"><input type="checkbox" id="office_Saturday_closed" /><span>Closed?</span></div>
            </div>
            <div class="week-row">
              <div class="week-row-label">Sunday</div>
              <select id="office_Sunday_open"></select>
              <select id="office_Sunday_close"></select>
              <div class="week-row-off"><input type="checkbox" id="office_Sunday_closed" /><span>Closed?</span></div>
            </div>
          </div>

          <div class="panel-title" style="font-size:11px;margin-top:8px;">Shop Holidays</div>
          <div class="weekly-card">
            <div class="week-row" style="grid-template-columns:120px 1fr 120px;">
              <div class="week-row-label">Add Holiday</div>
              <input id="holidayDateInput" class="date-input" placeholder="YYYY-MM-DD" readonly />
              <input id="holidayLabelInput" placeholder="e.g., New Year's Day" />
            </div>
            <div class="actions" style="margin-top:4px;">
              <button type="button" class="btn btn-primary" id="btnAddHoliday">Add Holiday</button>
            </div>
            <div class="timeoff-note" style="margin-top:4px;">These dates are treated as fully closed unless overridden on an appointment.</div>
            <div id="holidayList" class="timeoff-note" style="margin-top:6px;">No holidays configured.</div>
          </div>
          <!-- ⬆️ END SHOP HOURS & HOLIDAYS BLOCK ⬆️ -->

          <div class="status" id="scheduleStatus"></div>
        </form>
      </div>

      <!-- Services library -->
      <div id="servicesPanel" style="display:block;">
        <div class="panel-title">Service Library</div>
        <div class="panel-divider"></div>
        <form id="servicesForm" onsubmit="return false;">
          <div class="field-group">
            <label>Service Categories & Packages</label>
            <div id="serviceCategoriesList"></div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Add New Category</label>
              <input id="inputNewCategoryName" placeholder="e.g., Accessories" />
            </div>
            <div class="field-group" style="align-self:flex-end;">
              <button type="button" class="btn btn-primary" id="btnAddCategory">Add Category</button>
            </div>
          </div>
          <div class="timeoff-note">These services are saved in this browser and power the dropdowns in the appointment form.</div>
        </form>
      </div>

      <section id="customer-database" class="card">
        <header class="card-header">
          <h2>Customer Database</h2>
        </header>

        <div class="card-body">
          <div class="customer-controls">
            <div class="customer-search">
              <label for="customerSearchInput">Search customers</label>
              <input
                id="customerSearchInput"
                type="text"
                placeholder="Search by name, phone, or email..."
              />
            </div>
            <button id="customerNewBtn" type="button" class="btn-primary">
              + New Customer
            </button>
          </div>

          <form id="customerForm" class="customer-form">
            <input type="hidden" id="customerId" />

            <div class="form-row">
              <div class="form-field">
                <label for="customerFirstName">First Name<span class="required">*</span></label>
                <input id="customerFirstName" type="text" required />
              </div>
              <div class="form-field">
                <label for="customerLastName">Last Name<span class="required">*</span></label>
                <input id="customerLastName" type="text" required />
              </div>
            </div>

            <div class="form-row">
              <div class="form-field">
                <label for="customerPhone">Phone<span class="required">*</span></label>
                <input id="customerPhone" type="tel" placeholder="555-555-5555" required />
              </div>
              <div class="form-field">
                <label for="customerEmail">Email</label>
                <input id="customerEmail" type="email" placeholder="name@example.com" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-field form-field-full">
                <label for="customerNotes">Notes</label>
                <textarea id="customerNotes" rows="2" placeholder="Vehicle info, preferences, etc."></textarea>
              </div>
            </div>

            <div class="form-row">
              <div class="form-field">
                <label>
                  <input type="checkbox" id="customerMarketingOptIn" />
                  Marketing Opt-in (email)
                </label>
              </div>
              <div class="form-field">
                <label>
                  <input type="checkbox" id="customerSmsOptIn" />
                  SMS Opt-in
                </label>
              </div>
              <div class="form-field">
                <label for="customerExternalId">External Client ID</label>
                <input id="customerExternalId" type="text" placeholder="Existing system ID" />
              </div>
            </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary" id="customerSaveBtn">Save Customer</button>
            <button type="button" class="btn-secondary" id="customerCancelBtn">Cancel</button>
          </div>
        </form>

        <div id="customerHistory" class="customer-history">
          <h3>Past Appointments</h3>
          <div id="customerHistoryEmpty" class="empty-state">
            No past appointments found for this customer.
          </div>
          <div class="table-wrapper">
            <table id="customerHistoryTable">
              <thead>
                <tr>
                  <th style="width: 15%">Date</th>
                  <th style="width: 10%">Time</th>
                  <th style="width: 25%">Vehicle</th>
                  <th style="width: 25%">Services</th>
                  <th style="width: 15%">Status</th>
                  <th style="width: 10%">Tech</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="table-wrapper">
          <table id="customerTable">
            <thead>
              <tr>
                <th style="width: 20%">Name</th>
                <th style="width: 15%">Phone</th>
                <th style="width: 25%">Email</th>
                <th style="width: 20%">Notes</th>
                <th style="width: 10%">Marketing</th>
                <th style="width: 10%; text-align: right;">Actions</th>
              </tr>
            </thead>
            <tbody id="customerTableBody"></tbody>
          </table>
            <div id="customerEmptyState" class="empty-state">
              No customers yet. Add your first customer using the form above.
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- Custom Date Picker element -->
<div id="datePickerPopup" class="date-picker-popup">
  <div class="date-picker-header">
    <button type="button" id="dpPrevMonth">◀</button>
    <div class="date-picker-month" id="dpMonthLabel">MONTH YYYY</div>
    <button type="button" id="dpNextMonth">▶</button>
  </div>
  <div class="date-picker-grid" id="dpGrid"></div>
</div>

<!-- Appointment pop-up -->
<div id="appointmentPopup" class="popup-backdrop">
  <div class="popup-card">
    <div class="popup-header">
      <div class="popup-title">
        <h3 id="popupTitle">Appointment</h3>
        <span id="popupSubtitle"></span>
      </div>
      <div class="popup-actions">
        <div class="status-chip" id="popupStatusChip">
          <span class="event-status-icon scheduled" id="popupStatusIcon">S</span>
          <span id="popupStatusLabel">Scheduled</span>
        </div>
        <button class="icon-button" id="btnUnlockEditing">✏️ Edit</button>
        <button class="popup-close" id="btnClosePopup">✕</button>
      </div>
    </div>
    <div class="popup-body">
      <div class="popup-row">
        <label style="font-size:11px;letter-spacing:.08em;">Status</label>
        <select id="popupStatusSelect" style="flex:1;max-width:200px;">
          <option>Scheduled</option>
          <option>Check In</option>
          <option>Cancelled</option>
          <option>No Show</option>
          <option>Completed</option>
        </select>
      </div>
      <div class="popup-row">
        <label style="font-size:11px;letter-spacing:.08em;">Billing</label>
        <div class="inline-checkbox" style="color:#f9fafb;">
          <input type="checkbox" id="popupInvoiced" />
          <span>Invoiced <span class="invoice-icon pending" style="margin-left:4px;">$</span></span>
        </div>
        <div class="inline-checkbox" style="color:#f9fafb;">
          <input type="checkbox" id="popupPaid" />
          <span>Paid <span class="invoice-icon paid" style="margin-left:4px;">$</span></span>
        </div>
      </div>
      <div class="popup-row" id="popupQuickFlags"></div>
      <div class="popup-list" id="popupServicesList"></div>
    </div>
  </div>
</div>

<div id="globalSearchOverlay" class="global-search-overlay search-modal-overlay" style="display:none;">
  <div class="global-search-overlay-backdrop"></div>
  <div class="global-search-modal search-modal">
    <div class="global-search-modal-header">
      <h2>Search Results</h2>
      <button type="button" id="globalSearchCloseButton" class="btn-xs">Close</button>
    </div>

    <div id="globalSearchSummary" class="global-search-summary"></div>

    <div class="global-search-sections">
      <section class="global-search-section">
        <h3>Customers</h3>
        <div id="globalSearchCustomersEmpty" class="empty-state">
          No customers found for this search.
        </div>
        <ul id="globalSearchCustomersList" class="lookup-list"></ul>
      </section>

      <section class="global-search-section">
        <h3>Appointments</h3>
        <div id="globalSearchAppointmentsEmpty" class="empty-state">
          No appointments found for this search.
        </div>
        <div class="table-wrapper" id="globalSearchAppointmentsTableWrapper">
          <table id="globalSearchAppointmentsTable">
            <thead>
              <tr>
                <th style="width: 18%;">Date</th>
                <th style="width: 12%;">Time</th>
                <th style="width: 25%;">Customer</th>
                <th style="width: 25%;">Vehicle</th>
                <th style="width: 20%;">Services</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="global-search-section">
        <h3>Invoices</h3>
        <div id="globalSearchInvoicesEmpty" class="empty-state">
          No invoices found (invoices not wired yet).
        </div>
        <ul id="globalSearchInvoicesList" class="lookup-list"></ul>
      </section>
    </div>
  </div>
</div>

<script>
const techs=["William","Limage","Kaiden","Luke","Fafa","Matt"];
document.documentElement.style.setProperty("--tech-count",techs.length);
const days=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
const workTimes=["08:00","08:30","09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30","18:00"];

const defaultServicePackages={
  "Detailing":[
    {name:"Interior Detail",minutes:150,price:275},
    {name:"Exterior Detail",minutes:120,price:225},
    {name:"Full Detail",minutes:210,price:450},
    {name:"Quick Clean",minutes:60,price:120}
  ],
  "Tint":[
    {name:"Front Windows Only",minutes:60,price:180},
    {name:"Full Tint",minutes:120,price:380},
    {name:"Windshield Tint",minutes:90,price:220}
  ],
  "PPF":[{name:"Full Front PPF",minutes:240,price:1600}],
  "Ceramic":[
    {name:"1 Year Coating",minutes:150,price:650},
    {name:"3 Year Coating",minutes:210,price:1100},
    {name:"5 Year Coating",minutes:240,price:1400}
  ],
  "Electronics":[
    {name:"Remote Start",minutes:120,price:450},
    {name:"Remote Start + Security",minutes:150,price:650}
  ]
};
let servicePackages={};

function normalizeServiceList(list){
  if(!Array.isArray(list)) return [];
  return list.map(item=>{
    if(typeof item==="string"){
      return {name:item,minutes:90,price:0};
    }
    const minutes=Math.max(15,parseInt(item.minutes,10)||90);
    const price=parseFloat(item.price)||0;
    return {name:item.name||"Unnamed Service",minutes,price};
  });
}

function normalizeServicePackages(raw){
  const cleaned={};
  Object.keys(raw||{}).forEach(cat=>{
    cleaned[cat]=normalizeServiceList(raw[cat]);
  });
  return cleaned;
}

function normalizeServiceList(list){
  if(!Array.isArray(list)) return [];
  return list.map(item=>{
    if(typeof item==="string"){
      return {name:item,minutes:90,price:0};
    }
    const minutes=Math.max(15,parseInt(item.minutes,10)||90);
    const price=parseFloat(item.price)||0;
    return {name:item.name||"Unnamed Service",minutes,price};
  });
}

function normalizeServicePackages(raw){
  const cleaned={};
  Object.keys(raw||{}).forEach(cat=>{
    cleaned[cat]=normalizeServiceList(raw[cat]);
  });
  return cleaned;
}

function normalizeServiceList(list){
  if(!Array.isArray(list)) return [];
  return list.map(item=>{
    if(typeof item==="string"){
      return {name:item,minutes:90,price:0};
    }
    const minutes=Math.max(15,parseInt(item.minutes,10)||90);
    const price=parseFloat(item.price)||0;
    return {name:item.name||"Unnamed Service",minutes,price};
  });
}

function normalizeServicePackages(raw){
  const cleaned={};
  Object.keys(raw||{}).forEach(cat=>{
    cleaned[cat]=normalizeServiceList(raw[cat]);
  });
  return cleaned;
}

const GOOGLE_BACKEND_URL = "https://script.google.com/macros/s/AKfycbzfTUv9h_3U4RYFZgH7HH_mybySDGrva75urTpyYE5bXDyfuFTrwBIL2kqgthFbzjmb/exec";
// Global shop hours (open/close per weekday) + holidays
let officeHours = {};
let shopHolidays = []; // array of { date: "YYYY-MM-DD", label: "New Year's Day" }

let storageAvailable=true;
try{
  const testKey="__patriot_test";
  window.localStorage.setItem(testKey,"1");
  window.localStorage.removeItem(testKey);
}catch(e){
  storageAvailable=false;
}

let techSchedules={};
let events=[];
let currentDate=new Date();currentDate.setHours(0,0,0,0);
let selectedDeptFilter="All";
let selectedSlot=null;
let editingJobGroupId=null;
let appointmentLocked=false;
let isEditingAppointmentForm=false;

// Auto-refresh + idle tracking
let lastAutoRefreshTime=0;
let lastUserInteractionTime=Date.now();
const AUTO_REFRESH_INTERVAL_MS=60000;  // 60 seconds between checks
const AUTO_IDLE_THRESHOLD_MS=20000;    // user must be idle 20s before refresh
const GLOBAL_SEARCH_DEBOUNCE_MS=400;
let globalSearchTimer=null;

document.addEventListener("DOMContentLoaded",function(){
  if(typeof setupAppointmentSmartLookup==="function"){
    setupAppointmentSmartLookup();
  }
  setupGlobalSearchBar();
});

// DOM refs
const headerBtnAppointments=document.getElementById("btnAppointmentsPanel");
const headerBtnTimeOff=document.getElementById("btnTimeOffPanel");
const headerBtnSchedules=document.getElementById("btnSchedulesPanel");
const headerBtnServices=document.getElementById("btnServicesPanel");
const btnRefreshFromCloud=document.getElementById("btnRefreshFromCloud");
const appointmentPanel=document.getElementById("appointmentPanel");
const timeOffPanel=document.getElementById("timeOffPanel");
const schedulesPanel=document.getElementById("schedulesPanel");
const servicesPanel=document.getElementById("servicesPanel");
const headerRowEl=document.getElementById("calHeaderRow");
const bodyEl=document.getElementById("calBody");
const dayLabelEl=document.getElementById("dayLabel");
const dayPickerEl=document.getElementById("dayPicker");
const statusEl=document.getElementById("statusText");
const dealerQueueListEl=document.getElementById("dealerQueueList");
const scheduleTechSelect=document.getElementById("scheduleTechSelect");
const scheduleStatus=document.getElementById("scheduleStatus");
const btnCreateAppointment=document.getElementById("btnCreateAppointment");
const btnDeleteAppointment=document.getElementById("btnDeleteAppointment");
const statusField=document.getElementById("inputStatus");
const checkboxInvoiced=document.getElementById("checkboxInvoiced");
const checkboxPaid=document.getElementById("checkboxPaid");
const statusSummary=document.getElementById("statusSummary");
const vinInput=document.getElementById("inputVin");
const stockNumberInput=document.getElementById("inputStockNumber");
const vehicleYearInput=document.getElementById("inputVehicleYear");
const vehicleMakeInput=document.getElementById("inputVehicleMake");
const vehicleModelInput=document.getElementById("inputVehicleModel");
const vinHelperText=document.getElementById("vinHelperText");
const btnVinScan=document.getElementById("btnVinScan");
const defaultVinHelperText="Scan VIN to auto-fill year, make, and model.";

const appointmentPopup=document.getElementById("appointmentPopup");
const popupStatusSelect=document.getElementById("popupStatusSelect");
const popupStatusIcon=document.getElementById("popupStatusIcon");
const popupStatusLabel=document.getElementById("popupStatusLabel");
const popupStatusChip=document.getElementById("popupStatusChip");
const popupTitle=document.getElementById("popupTitle");
const popupSubtitle=document.getElementById("popupSubtitle");
const popupServicesList=document.getElementById("popupServicesList");
const popupQuickFlags=document.getElementById("popupQuickFlags");
const popupInvoiced=document.getElementById("popupInvoiced");
const popupPaid=document.getElementById("popupPaid");
const btnUnlockEditing=document.getElementById("btnUnlockEditing");
const btnClosePopup=document.getElementById("btnClosePopup");

// Service assignments container
const serviceAssignmentsContainer=document.getElementById("serviceAssignments");
const btnAddServiceRow=document.getElementById("btnAddServiceRow");

// Services library refs
const serviceCategoriesList=document.getElementById("serviceCategoriesList");
const inputNewCategoryName=document.getElementById("inputNewCategoryName");
const btnAddCategory=document.getElementById("btnAddCategory");

// Custom date picker refs
const dpPopup=document.getElementById("datePickerPopup");
const dpGrid=document.getElementById("dpGrid");
const dpMonthLabel=document.getElementById("dpMonthLabel");
const dpPrevMonth=document.getElementById("dpPrevMonth");
const dpNextMonth=document.getElementById("dpNextMonth");
let dpActiveInput=null;
let dpYear=null;
let dpMonth=null;

function toISODate(d){return d.toISOString().slice(0,10);}
function getDayName(d){return d.toLocaleDateString("en-US",{weekday:"long"});}
function formatDateLabel(d){
  const dow=d.toLocaleDateString(undefined,{weekday:"short"}).toUpperCase();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  const y=d.getFullYear();
  return `${dow} ${m}/${day}/${y}`;
}
function timeToMinutes(t){if(!t)return null;const [h,m]=t.split(":").map(Number);return h*60+m;}
function formatTimeFriendly(t){
  if(!t) return "";
  const [hStr,mStr]=t.split(":");
  let h=parseInt(hStr,10), m=parseInt(mStr,10);
  const ampm=h>=12?"PM":"AM";
  if(h===0) h=12; else if(h>12) h-=12;
  return h+":"+(m<10?"0"+m:m)+" "+ampm;
}
function formatCustomerName(evOrFirst,last){
  if(typeof evOrFirst==="object"){
    const ev=evOrFirst||{};
    const formatted=[ev.customerFirstName,ev.customerLastName].filter(Boolean).join(" ").trim();
    return formatted||ev.customerName||"";
  }
  return [evOrFirst,last].filter(Boolean).join(" ").trim();
}
function sanitizeVin(value){
  return (value||"").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,17);
}
function decodeVinYear(vin){
  if(!vin || vin.length<10) return "";
  const yearCode=vin[9];
  const map=[
    "A","B","C","D","E","F","G","H","J","K","L","M","N","P","R","S","T","V","W","X","Y",
    "1","2","3","4","5","6","7","8","9"
  ];
  const idx=map.indexOf(yearCode);
  if(idx===-1) return "";
  const baseYear=1980+idx;
  const cycle=Math.floor((new Date().getFullYear()-baseYear)/30);
  return baseYear+Math.max(0,cycle*30);
}
function decodeVinToVehicle(vin){
  const cleaned=sanitizeVin(vin);
  if(cleaned.length<10) return null;
  const wmi=cleaned.slice(0,3);
  const makeMap={
    "1FT":"Ford","1FA":"Ford","1C6":"RAM","1C4":"Chrysler","5YJ":"Tesla","3GC":"Chevrolet","1GC":"Chevrolet",
    "JT2":"Toyota","JTD":"Toyota","2HK":"Honda","19X":"Honda","1HG":"Honda","JHM":"Honda","KM8":"Hyundai",
    "1N4":"Nissan","JM1":"Mazda","WVW":"Volkswagen"
  };
  const modelMap={
    "1FT":"F-150","3GC":"Silverado","1GC":"Silverado","JT2":"Supra","JTD":"Camry","2HK":"CR-V","19X":"Civic",
    "1HG":"Accord","JHM":"Accord","5YJ":"Model 3","1C6":"1500","KM8":"Tucson","1N4":"Altima","JM1":"Mazda3",
    "WVW":"Jetta","1FA":"Mustang"
  };
  const year=decodeVinYear(cleaned);
  const make=makeMap[wmi]||"";
  const model=modelMap[wmi]||"";
  if(!year && !make && !model) return null;
  return {year:String(year||""),make,model};
}
function parseISODate(str){
  if(!str) return null;
  const m=str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return null;
  const year=parseInt(m[1],10),month=parseInt(m[2],10)-1,day=parseInt(m[3],10);
  const d=new Date(year,month,day);
  if(isNaN(d.getTime())) return null;
  return d;
}

function minutesToTime(total){
  const h=String(Math.floor(total/60)).padStart(2,"0");
  const m=String(total%60).padStart(2,"0");
  return `${h}:${m}`;
}

function addMinutesToTime(time,minutes){
  const base=timeToMinutes(time)||0;
  return minutesToTime(base+minutes);
}

function statusMeta(status){
  const map={
    "Scheduled":{className:"scheduled",icon:"S"},
    "Check In":{className:"checkin",icon:"I"},
    "Cancelled":{className:"cancelled",icon:"X"},
    "No Show":{className:"noshow",icon:"N"},
    "Completed":{className:"completed",icon:"C"}
  };
  return map[status]||map["Scheduled"];
}

function serviceProgressMeta(status){
  const map={
    "In Queue":{className:"queue",icon:"⏳"},
    "Started":{className:"started",icon:"▶"},
    "Completed":{className:"done",icon:"✔"}
  };
  return map[status]||map["In Queue"];
}
function updateVinHelper(message){
  if(vinHelperText) vinHelperText.textContent=message||defaultVinHelperText;
}
function applyVinDecodeAndHelper(vin){
  const cleaned=sanitizeVin(vin|| (vinInput?vinInput.value:""));
  if(vinInput) vinInput.value=cleaned;
  const decoded=decodeVinToVehicle(cleaned);
  if(decoded){
    if(vehicleYearInput) vehicleYearInput.value=decoded.year||"";
    if(vehicleMakeInput) vehicleMakeInput.value=decoded.make||"";
    if(vehicleModelInput) vehicleModelInput.value=decoded.model||"";
  }else if(!cleaned){
    if(vehicleYearInput) vehicleYearInput.value="";
    if(vehicleMakeInput) vehicleMakeInput.value="";
    if(vehicleModelInput) vehicleModelInput.value="";
  }
  const len=cleaned.length;
  const vehicleSummary=decoded? [decoded.year,decoded.make,decoded.model].filter(Boolean).join(" "):"";
  const suffix=vehicleSummary?` • ${vehicleSummary}`:"";
  updateVinHelper(len?`VIN captured (${len}/17)${suffix}.`:defaultVinHelperText);
  return cleaned;
}
function sanitizeVinInput(){
  if(!vinInput) return "";
  const cleaned=sanitizeVin(vinInput.value);
  vinInput.value=cleaned;
  return cleaned;
}

function minutesToTime(total){
  const h=String(Math.floor(total/60)).padStart(2,"0");
  const m=String(total%60).padStart(2,"0");
  return `${h}:${m}`;
}

function addMinutesToTime(time,minutes){
  const base=timeToMinutes(time)||0;
  return minutesToTime(base+minutes);
}

function statusMeta(status){
  const map={
    "Scheduled":{className:"scheduled",icon:"●"},
    "Check In":{className:"checkin",icon:"⧗"},
    "Cancelled":{className:"cancelled",icon:"✖"},
    "No Show":{className:"noshow",icon:"⚠"},
    "Completed":{className:"completed",icon:"✔"}
  };
  return map[status]||map["Scheduled"];
}

function serviceProgressMeta(status){
  const map={
    "In Queue":{className:"queue",icon:"⏳"},
    "Started":{className:"started",icon:"▶"},
    "Completed":{className:"done",icon:"✔"}
  };
  return map[status]||map["In Queue"];
}

function minutesToTime(total){
  const h=String(Math.floor(total/60)).padStart(2,"0");
  const m=String(total%60).padStart(2,"0");
  return `${h}:${m}`;
}

function addMinutesToTime(time,minutes){
  const base=timeToMinutes(time)||0;
  return minutesToTime(base+minutes);
}

function statusMeta(status){
  const map={
    "Scheduled":{className:"scheduled",icon:"●"},
    "Check In":{className:"checkin",icon:"⧗"},
    "Cancelled":{className:"cancelled",icon:"✖"},
    "No Show":{className:"noshow",icon:"⚠"},
    "Completed":{className:"completed",icon:"✔"}
  };
  return map[status]||map["Scheduled"];
}

// Time dropdowns
function populateTimeSelect(selectEl,allowEmpty=true){
  if(!selectEl) return;
  selectEl.innerHTML="";
  if(allowEmpty){
    const ph=document.createElement("option");ph.value="";ph.textContent="--";selectEl.appendChild(ph);
  }
  workTimes.forEach(t=>{
    const opt=document.createElement("option");opt.value=t;opt.textContent=formatTimeFriendly(t);selectEl.appendChild(opt);
  });
}
function initTimeDropdowns(){
  populateTimeSelect(document.getElementById("inputRideTime"));
  populateTimeSelect(document.getElementById("inputPickupTime"));
  populateTimeSelect(document.getElementById("inputDeliveryTime"));
  populateTimeSelect(document.getElementById("timeOffStartTime"));
  populateTimeSelect(document.getElementById("timeOffEndTime"));
  days.forEach(d=>{
    populateTimeSelect(document.getElementById(`sched_${d}_start`),false);
    populateTimeSelect(document.getElementById(`sched_${d}_end`),false);
  });
}
  // Office hours dropdowns
  days.forEach(d=>{
    populateTimeSelect(document.getElementById(`office_${d}_open`), false);
    populateTimeSelect(document.getElementById(`office_${d}_close`), false);
  });

// Tech schedules storage
function initDefaultSchedules(){
  techs.forEach(t=>{
    techSchedules[t]={};
    days.forEach(d=>{
      const weekend=(d==="Saturday"||d==="Sunday");
      techSchedules[t][d]={start:"09:00",end:"17:00",off:weekend};
    });
  });
}
function loadSchedulesFromStorage(){
  if(!storageAvailable){initDefaultSchedules();return;}
  const raw=localStorage.getItem("patriotTechSchedules");
  if(!raw){initDefaultSchedules();return;}
  try{
    const parsed=JSON.parse(raw);
    techSchedules={};
    techs.forEach(t=>{
      techSchedules[t]={};
      days.forEach(d=>{
        const v=(parsed[t] && parsed[t][d])||null;
        if(v){techSchedules[t][d]=v;}
        else{
          const weekend=(d==="Saturday"||d==="Sunday");
          techSchedules[t][d]={start:"09:00",end:"17:00",off:weekend};
        }
      });
    });
  }catch(e){
    console.error("Failed to parse saved schedules",e);
    initDefaultSchedules();
  }
}
function saveSchedulesToStorage(){
  if(!storageAvailable) return;
  localStorage.setItem("patriotTechSchedules",JSON.stringify(techSchedules));
}
// ----- Shop hours (global) -----
function initDefaultOfficeHours(){
  days.forEach(d=>{
    const weekend = (d==="Saturday" || d==="Sunday");
    officeHours[d] = {
      open: weekend ? "09:00" : "09:00",
      close: weekend ? "15:00" : "17:00",
      closed: weekend
    };
  });
}

function loadOfficeHoursFromStorage(){
  if(!storageAvailable){
    initDefaultOfficeHours();
    return;
  }
  const raw = localStorage.getItem("patriotOfficeHours");
  if(!raw){
    initDefaultOfficeHours();
    return;
  }
  try{
    const parsed = JSON.parse(raw);
    officeHours = {};
    days.forEach(d=>{
      const v = parsed[d] || null;
      if(v){
        officeHours[d] = v;
      }else{
        officeHours[d] = { open:"09:00", close:"17:00", closed:false };
      }
    });
  }catch(e){
    console.error("Failed to parse office hours",e);
    initDefaultOfficeHours();
  }
}

function saveOfficeHoursToStorage(){
  if(!storageAvailable) return;
  localStorage.setItem("patriotOfficeHours", JSON.stringify(officeHours));
}

// ----- Shop holidays -----
function loadShopHolidaysFromStorage(){
  if(!storageAvailable){
    shopHolidays = [];
    return;
  }
  const raw = localStorage.getItem("patriotShopHolidays");
  if(!raw){
    shopHolidays = [];
    return;
  }
  try{
    const parsed = JSON.parse(raw);
    shopHolidays = Array.isArray(parsed) ? parsed : [];
  }catch(e){
    console.error("Failed to parse shop holidays",e);
    shopHolidays = [];
  }
}

function saveShopHolidaysToStorage(){
  if(!storageAvailable) return;
  localStorage.setItem("patriotShopHolidays", JSON.stringify(shopHolidays));
}

// Service packages storage
function loadServicePackagesFromStorage(){
  if(!storageAvailable){
    servicePackages=normalizeServicePackages(defaultServicePackages);
    return;
  }
  const raw=localStorage.getItem("patriotServicePackages");
  if(!raw){
    servicePackages=normalizeServicePackages(defaultServicePackages);
    return;
  }
  try{
    const parsed=JSON.parse(raw);
    if(parsed && typeof parsed==="object"){
      servicePackages=normalizeServicePackages(parsed);
    }else{
      servicePackages=normalizeServicePackages(defaultServicePackages);
    }
  }catch(e){
    console.error("Failed to parse saved service packages",e);
    servicePackages=normalizeServicePackages(defaultServicePackages);
  }
}

function setAppointmentFormLocked(locked){
  appointmentLocked=locked;
  const form=document.getElementById("appointmentForm");
  if(!form) return;
  const controls=form.querySelectorAll("input, select, textarea, button");
  controls.forEach(el=>{
    if(el.id==="btnClear") return;
    el.disabled=locked;
  });
  form.querySelectorAll(".service-row button").forEach(btn=>btn.disabled=locked);
  if(btnCreateAppointment) btnCreateAppointment.disabled=locked;
  if(btnDeleteAppointment) btnDeleteAppointment.disabled=locked;
  if(btnAddServiceRow) btnAddServiceRow.disabled=locked;
}

function setPopupEditable(enabled){
  // Popup status, invoiced, paid, and per-service progress remain editable at all times
  // to allow quick corrections without unlocking the main form.
  if(popupStatusSelect) popupStatusSelect.disabled=false;
  if(popupInvoiced) popupInvoiced.disabled=false;
  if(popupPaid) popupPaid.disabled=false;
  if(btnUnlockEditing) btnUnlockEditing.textContent=enabled?"Editing in form" : "✏️ Edit in form";
}

function getCurrentStatusState(){
  const status=statusField?statusField.value||"Scheduled":"Scheduled";
  const paid=!!(checkboxPaid&&checkboxPaid.checked);
  const invoiced=paid?true:!!(checkboxInvoiced&&checkboxInvoiced.checked);
  return {status,invoiced,paid};
}

function updateStatusSummaryDisplay(){
  if(!statusSummary) return;
  const {status,invoiced,paid}=getCurrentStatusState();
  statusSummary.innerHTML="";
  const meta=statusMeta(status);
  const chip=document.createElement("div");
  chip.className=`status-chip`;
  const icon=document.createElement("span");
  icon.className=`event-status-icon ${meta.className}`;
  icon.textContent=meta.icon;
  const text=document.createElement("span");
  text.textContent=status;
  chip.appendChild(icon);
  chip.appendChild(text);
  statusSummary.appendChild(chip);

  if(invoiced||paid){
    const dollar=document.createElement("span");
    dollar.className=`invoice-icon ${paid?"paid":"pending"}`;
    dollar.textContent="$";
    statusSummary.appendChild(dollar);
  }
}

function setStatusState(status,invoiced,paid){
  if(statusField) statusField.value=status||"Scheduled";
  if(checkboxPaid) checkboxPaid.checked=!!paid;
  if(checkboxInvoiced) checkboxInvoiced.checked=!!invoiced||!!paid;
  syncPopupFromStatusFields();
}

function syncPopupFromStatusFields(){
  const {status,invoiced,paid}=getCurrentStatusState();
  if(popupStatusSelect) popupStatusSelect.value=status;
  if(popupInvoiced) popupInvoiced.checked=invoiced;
  if(popupPaid) popupPaid.checked=paid;
  const meta=statusMeta(status);
  if(popupStatusIcon){
    popupStatusIcon.className=`event-status-icon ${meta.className}`;
    popupStatusIcon.textContent=meta.icon;
  }
  if(popupStatusLabel) popupStatusLabel.textContent=status;
  updateStatusSummaryDisplay();
}

function applyMetaToGroup(status,invoiced,paid){
  if(paid) invoiced=true;
  if(!editingJobGroupId) return;
  events=events.map(ev=>{
    if(ev.type==="job" && (ev.jobGroupId||ev.id)===editingJobGroupId){
      return {...ev,status,invoiced,paid};
    }
    return ev;
  });
  renderCalendar();
}

function syncServiceProgressToForm(groupEvents){
  const map=new Map();
  groupEvents.forEach(ev=>map.set(ev.id, ev.serviceProgress||"In Queue"));
  document.querySelectorAll(".service-row").forEach(row=>{
    const prog=row.querySelector(".sa-progress");
    if(!prog) return;
    const id=row.dataset.eventId;
    if(id && map.has(id)){
      prog.value=map.get(id);
    }
  });
}

function rebalanceServiceProgress(groupId,{triggerAutoStart=false,keepInQueue=false}={}){
  const sorted=events
    .filter(ev=>ev.type==="job" && (ev.jobGroupId||ev.id)===groupId)
    .map(ev=>({
      ...ev,
      serviceProgress:ev.serviceProgress||"In Queue"
    }))
    .sort((a,b)=>timeToMinutes(a.time)-timeToMinutes(b.time));
  if(!sorted.length) return;

  const updates=new Map();
  let encounteredPending=false;
  sorted.forEach((ev,idx)=>{
    let current=ev.serviceProgress||"In Queue";
    if(encounteredPending){
      if(current==="Started") updates.set(ev.id,"In Queue");
      return;
    }
    if(current!=="Completed"){
      encounteredPending=true;
      const allPrevCompleted=idx>0 && sorted.slice(0,idx).every(x=>(x.serviceProgress||"In Queue")==="Completed");
      if(triggerAutoStart && allPrevCompleted && current==="In Queue" && !keepInQueue){
        updates.set(ev.id,"Started");
      }
    }
  });

  if(updates.size){
    events=events.map(ev=>updates.has(ev.id)?{...ev,serviceProgress:updates.get(ev.id)}:ev);
  }

  const refreshed=events.filter(ev=>ev.type==="job" && (ev.jobGroupId||ev.id)===groupId);
  const allDone=refreshed.length>0 && refreshed.every(ev=>(ev.serviceProgress||"In Queue")==="Completed");
  if(allDone){
    setStatusState("Completed",checkboxInvoiced.checked,checkboxPaid.checked);
    applyMetaToGroup("Completed",checkboxInvoiced.checked,checkboxPaid.checked);
  }
}

function updateServiceProgress(groupId,eventId,newStatus){
  events=events.map(ev=>{
    if(ev.id===eventId){
      return {...ev,serviceProgress:newStatus};
    }
    return ev;
  });
  rebalanceServiceProgress(groupId,{triggerAutoStart:newStatus==="Completed",keepInQueue:newStatus==="In Queue"});
  const groupEvents=events.filter(ev=>ev.type==="job" && (ev.jobGroupId||ev.id)===groupId);
  syncServiceProgressToForm(groupEvents);
  buildPopupServices(groupEvents, groupId);
  renderCalendar();
}

function buildPopupServices(groupEvents, groupId){
  if(!popupServicesList) return;
  popupServicesList.innerHTML="";
  const sorted=[...groupEvents].sort((a,b)=>timeToMinutes(a.time)-timeToMinutes(b.time));
  sorted.forEach(gev=>{
    const row=document.createElement("div");
    row.className="popup-list-item";

    const left=document.createElement("div");
    left.style.display="flex";
    left.style.alignItems="center";
    left.style.gap="8px";
    const progMeta=serviceProgressMeta(gev.serviceProgress||"In Queue");
    const progIcon=document.createElement("span");
    progIcon.className=`service-progress-icon ${progMeta.className}`;
    progIcon.textContent=progMeta.icon;
    left.appendChild(progIcon);

    const info=document.createElement("div");
    info.style.display="flex";
    info.style.flexDirection="column";
    info.style.gap="2px";
    const endTime=addMinutesToTime(gev.time,gev.minutes||90);
    info.innerHTML=`<strong>${gev.serviceName||gev.label||"Service"}</strong><span style="color:#9ca3af;">${gev.tech} · ${gev.time}–${endTime} · ${gev.minutes||90} mins</span>`;
    left.appendChild(info);

    const price=document.createElement("div");
    price.textContent=`$${(gev.price||0).toFixed(2)}`;
    price.style.fontWeight="700";

    const select=document.createElement("select");
    ["In Queue","Started","Completed"].forEach(val=>{
      const o=document.createElement("option");o.value=val;o.textContent=val;select.appendChild(o);
    });
    select.value=gev.serviceProgress||"In Queue";
    // Progress stays editable in the popup even when the main form is locked
    // so users can correct mistakes without unlocking the appointment form.
    select.disabled=false;
    select.addEventListener("change",()=>{
      updateServiceProgress(groupId||gev.jobGroupId||gev.id, gev.id, select.value);
    });

    row.appendChild(left);
    row.appendChild(price);
    row.appendChild(select);
    popupServicesList.appendChild(row);
  });
}

function setPopupFlags(ev){
  if(!popupQuickFlags) return;
  popupQuickFlags.innerHTML="";
  const flags=[];
  if(ev.dealer) flags.push("Dealer Job");
  if(ev.customerWaiting) flags.push("Waiting");
  if(ev.rideNeeded) flags.push("Ride Needed");
  if(ev.pickupDelivery) flags.push("Pickup / Delivery");
  flags.forEach(f=>{
    const badge=document.createElement("div");
    badge.className="popup-badge";
    badge.textContent=f;
    popupQuickFlags.appendChild(badge);
  });
}

function openAppointmentPopup(ev){
  if(!appointmentPopup || ev.type!=="job") return;
  const groupId=ev.jobGroupId||ev.id;
  const groupEvents=events.filter(e=>e.type==="job" && (e.jobGroupId||e.id)===groupId);
  popupTitle.textContent=formatCustomerName(ev)||"Appointment";
  const endTime=addMinutesToTime(ev.time,ev.minutes||90);
  popupSubtitle.textContent=`${ev.date} · ${ev.time}–${endTime}`;
  const status=ev.status||"Scheduled";
  const invoiced=!!ev.invoiced;
  const paid=!!ev.paid;
  setStatusState(status,invoiced,paid);
  if(popupStatusChip) popupStatusChip.className=`status-chip`;
  rebalanceServiceProgress(groupId,{triggerAutoStart:true});
  buildPopupServices(groupEvents, groupId);
  setPopupFlags(ev);
  appointmentPopup.style.display="flex";
  setPopupEditable(false);
}

function closeAppointmentPopup(){
  if(appointmentPopup) appointmentPopup.style.display="none";
}
function saveServicePackagesToStorage(){
  if(!storageAvailable) return;
  localStorage.setItem("patriotServicePackages",JSON.stringify(servicePackages));
}

// Service helpers (per-row)
function populateServiceOptionsForSelect(deptSelect,serviceSelect,selectedValue){
  serviceSelect.innerHTML="";
  const ph=document.createElement("option");ph.value="";ph.textContent="Select service";serviceSelect.appendChild(ph);
  const dept=deptSelect.value;
  if(dept && servicePackages[dept]){
    servicePackages[dept].forEach(svc=>{
      const name=svc.name||svc;
      const o=document.createElement("option");
      o.value=name;o.textContent=name;
      serviceSelect.appendChild(o);
    });
  }
  if(selectedValue) serviceSelect.value=selectedValue;
}

function findServiceDefaults(dept,name){
  const list=servicePackages[dept]||[];
  return list.find(s=>s.name===name)||null;
}

function findServiceDefaults(dept,name){
  const list=servicePackages[dept]||[];
  return list.find(s=>s.name===name)||null;
}

function findServiceDefaults(dept,name){
  const list=servicePackages[dept]||[];
  return list.find(s=>s.name===name)||null;
}

// Service assignment rows
function addServiceRow(initial){
  const row=document.createElement("div");
  row.className="field-row service-row";

  const deptGroup=document.createElement("div");
  deptGroup.className="field-group";
  const deptSelect=document.createElement("select");
  deptSelect.className="sa-dept";
  const deptPh=document.createElement("option");deptPh.value="";deptPh.textContent="Service Category";deptSelect.appendChild(deptPh);
  Object.keys(servicePackages).sort().forEach(key=>{
    const opt=document.createElement("option");opt.value=key;opt.textContent=key;deptSelect.appendChild(opt);
  });
  deptGroup.appendChild(deptSelect);

  const svcGroup=document.createElement("div");
  svcGroup.className="field-group";
  const svcSelect=document.createElement("select");
  svcSelect.className="sa-service";
  const svcPh=document.createElement("option");svcPh.value="";svcPh.textContent="Select service";svcSelect.appendChild(svcPh);
  svcGroup.appendChild(svcSelect);

  const techGroup=document.createElement("div");
  techGroup.className="field-group";
  const techSelect=document.createElement("select");
  techSelect.className="sa-tech";
  const techPh=document.createElement("option");techPh.value="";techPh.textContent="Assign tech";techSelect.appendChild(techPh);
  const optDealer=document.createElement("option");optDealer.value="Dealer";optDealer.textContent="Dealer";techSelect.appendChild(optDealer);
  techs.forEach(t=>{
    const o=document.createElement("option");o.value=t;o.textContent=t;techSelect.appendChild(o);
  });
  techGroup.appendChild(techSelect);

  const timeGroup=document.createElement("div");
  timeGroup.className="field-group";
  const timeSelect=document.createElement("select");
  timeSelect.className="sa-time";
  populateTimeSelect(timeSelect,true);
  timeGroup.appendChild(timeSelect);

  const durationGroup=document.createElement("div");
  durationGroup.className="field-group";
  const durationLabel=document.createElement("label");
  durationLabel.style.fontSize="10px";
  durationLabel.style.textTransform="none";
  durationLabel.style.letterSpacing="0";
  durationLabel.textContent="Est. Duration";
  const durationSelect=document.createElement("select");
  durationSelect.className="sa-minutes serviceMinutes";
  const durationOptions=[
    { value:"15", label:"0.25 hr (0:15)" },
    { value:"30", label:"0.5 hr (0:30)" },
    { value:"45", label:"0.75 hr (0:45)" },
    { value:"60", label:"1.0 hr" },
    { value:"75", label:"1.25 hr" },
    { value:"90", label:"1.5 hr" },
    { value:"105", label:"1.75 hr" },
    { value:"120", label:"2.0 hr" },
    { value:"150", label:"2.5 hr" },
    { value:"180", label:"3.0 hr" },
    { value:"210", label:"3.5 hr" },
    { value:"240", label:"4.0 hr" },
    { value:"270", label:"4.5 hr" },
    { value:"300", label:"5.0 hr" },
    { value:"330", label:"5.5 hr" },
    { value:"360", label:"6.0 hr" }
  ];
  durationOptions.forEach(opt=>{
    const o=document.createElement("option");
    o.value=opt.value;
    o.textContent=opt.label;
    durationSelect.appendChild(o);
  });
  durationSelect.value="90";
  durationGroup.appendChild(durationLabel);
  durationGroup.appendChild(durationSelect);

  const priceGroup=document.createElement("div");
  priceGroup.className="field-group";
  const priceLabel=document.createElement("label");
  priceLabel.style.fontSize="10px";
  priceLabel.style.textTransform="none";
  priceLabel.style.letterSpacing="0";
  priceLabel.textContent="Price ($)";
  const priceInput=document.createElement("input");
  priceInput.type="number";
  priceInput.min="0";
  priceInput.step="1";
  priceInput.placeholder="Price";
  priceInput.className="sa-price";
  priceInput.value="0";
  priceGroup.appendChild(priceLabel);
  priceGroup.appendChild(priceInput);

  const progressInput=document.createElement("input");
  progressInput.type="hidden";
  progressInput.className="sa-progress";
  progressInput.value="In Queue";

  const removeBtn=document.createElement("button");
  removeBtn.type="button";
  removeBtn.textContent="✕";
  removeBtn.className="btn btn-clear";
  removeBtn.style.padding="4px 8px";
  removeBtn.addEventListener("click",()=>{
    row.remove();
    if(serviceAssignmentsContainer.children.length===0){
      addServiceRow();
    }
  });

  row.appendChild(deptGroup);
  row.appendChild(svcGroup);
  row.appendChild(techGroup);
  row.appendChild(timeGroup);
  row.appendChild(durationGroup);
  row.appendChild(priceGroup);
  row.appendChild(progressInput);
  row.appendChild(removeBtn);
  serviceAssignmentsContainer.appendChild(row);

  deptSelect.addEventListener("change",()=>{
    populateServiceOptionsForSelect(deptSelect,svcSelect,null);
    durationSelect.value="90";
    priceInput.value="";
  });

  svcSelect.addEventListener("change",()=>{
    const defaults=findServiceDefaults(deptSelect.value,svcSelect.value);
    if(defaults){
      durationSelect.value=(defaults.minutes||90).toString();
      priceInput.value=defaults.price||0;
    }
  });

  if(initial){
    if(initial.dept){
      deptSelect.value=initial.dept;
      populateServiceOptionsForSelect(deptSelect,svcSelect,initial.serviceName||"");
    }
    if(initial.tech) techSelect.value=initial.tech;
    if(initial.time) timeSelect.value=initial.time;
    if(initial.minutes) durationSelect.value=initial.minutes;
    if(typeof initial.price!=="undefined") priceInput.value=initial.price;
    if(initial.serviceProgress) progressInput.value=initial.serviceProgress;
    if(initial.id) row.dataset.eventId=initial.id;
  }
}

function clearServiceAssignments(){
  serviceAssignmentsContainer.innerHTML="";
}
function ensureAtLeastOneServiceRow(){
  if(serviceAssignmentsContainer.children.length===0){
    addServiceRow();
  }
}
function refreshAllServiceAssignmentRows(){
  const rows=document.querySelectorAll(".service-row");
  rows.forEach(row=>{
    const deptSelect=row.querySelector(".sa-dept");
    const svcSelect=row.querySelector(".sa-service");
    const prevDept=deptSelect.value;
    const prevSvc=svcSelect.value;
    const minutesSelect=row.querySelector(".serviceMinutes");
    const priceInput=row.querySelector(".sa-price");
    const prevMinutes=minutesSelect?.value||"";
    const prevPrice=priceInput.value;
    const progressInput=row.querySelector(".sa-progress");
    const prevProgress=progressInput?.value||"In Queue";

    deptSelect.innerHTML="";
    const deptPh=document.createElement("option");deptPh.value="";deptPh.textContent="Service Category";deptSelect.appendChild(deptPh);
    Object.keys(servicePackages).sort().forEach(key=>{
      const opt=document.createElement("option");opt.value=key;opt.textContent=key;deptSelect.appendChild(opt);
    });
    if(prevDept && servicePackages[prevDept]) deptSelect.value=prevDept;

    populateServiceOptionsForSelect(deptSelect,svcSelect,prevSvc);
    if(minutesSelect && prevMinutes) minutesSelect.value=prevMinutes;
    priceInput.value=prevPrice;
    if(progressInput) progressInput.value=prevProgress;
  });
}
function getServiceAssignmentsFromForm(){
  const rows=serviceAssignmentsContainer.querySelectorAll(".service-row");
  const result=[];
  rows.forEach(row=>{
    const dept=row.querySelector(".sa-dept")?.value||"";
    const serviceName=row.querySelector(".sa-service")?.value||"";
    const tech=row.querySelector(".sa-tech")?.value||"";
    const time=row.querySelector(".sa-time")?.value||"";
    const minutesSelect=row.querySelector(".serviceMinutes");
    const minutes=minutesSelect?parseInt(minutesSelect.value,10)||0:0;
    const price=parseFloat(row.querySelector(".sa-price")?.value||"0")||0;
    const serviceProgress=row.querySelector(".sa-progress")?.value||"In Queue";
    if(!dept && !serviceName && !tech && !time) return;
    result.push({dept,serviceName,tech,time,minutes,price,serviceProgress});
  });
  return result;
}

// Services library rendering & actions
function renderServiceLibrary(){
  serviceCategoriesList.innerHTML="";
  const cats=Object.keys(servicePackages).sort();
  if(!cats.length){
    const empty=document.createElement("div");
    empty.className="timeoff-note";
    empty.textContent="No categories yet. Add a new one below.";
    serviceCategoriesList.appendChild(empty);
    return;
  }
  cats.forEach(cat=>{
    const card=document.createElement("div");
    card.style.border="1px solid rgba(255,255,255,0.12)";
    card.style.borderRadius="8px";
    card.style.padding="8px";
    card.style.marginBottom="6px";
    card.style.background="rgba(3,10,25,0.9)";

    const header=document.createElement("div");
    header.style.display="flex";
    header.style.justifyContent="space-between";
    header.style.alignItems="center";

    const title=document.createElement("div");
    title.textContent=cat;
    title.style.fontWeight="600";
    title.style.fontSize="12px";

    const delBtn=document.createElement("button");
    delBtn.type="button";
    delBtn.textContent="Delete Category";
    delBtn.className="btn btn-clear";
    delBtn.style.padding="4px 8px";
    delBtn.style.fontSize="10px";
    delBtn.addEventListener("click",()=>{
      if(!confirm(`Delete category "${cat}" and all its services?`)) return;
      delete servicePackages[cat];
      saveServicePackagesToStorage();
      renderServiceLibrary();
      refreshAllServiceAssignmentRows();
      renderDeptChips();
    });

    header.appendChild(title);
    header.appendChild(delBtn);
    card.appendChild(header);

    const svcList=document.createElement("div");
    svcList.className="popup-list";
    (servicePackages[cat]||[]).forEach((svc,idx)=>{
      const row=document.createElement("div");
      row.className="popup-list-item";

      const info=document.createElement("div");
      info.style.display="flex";
      info.style.flexDirection="column";
      info.style.gap="2px";
      info.innerHTML=`<strong>${svc.name}</strong><span style="color:#9ca3af;">${svc.minutes} mins · $${svc.price}</span>`;

      const controls=document.createElement("div");
      controls.style.display="flex";
      controls.style.gap="6px";
      controls.style.alignItems="center";

      const minutesInput=document.createElement("input");
      minutesInput.type="number";
      minutesInput.min="15";
      minutesInput.step="15";
      minutesInput.value=svc.minutes||90;
      minutesInput.style.width="70px";
      minutesInput.title="Estimated minutes";

      const priceInput=document.createElement("input");
      priceInput.type="number";
      priceInput.min="0";
      priceInput.step="1";
      priceInput.value=svc.price||0;
      priceInput.style.width="70px";
      priceInput.title="Price";

      const removeBtn=document.createElement("button");
      removeBtn.type="button";
      removeBtn.textContent="✕";
      removeBtn.className="btn btn-clear";
      removeBtn.style.padding="4px 8px";

      function persist(){
        const newMinutes=Math.max(15,parseInt(minutesInput.value,10)||90);
        const newPrice=parseFloat(priceInput.value)||0;
        servicePackages[cat][idx]={...svc,minutes:newMinutes,price:newPrice};
        saveServicePackagesToStorage();
        refreshAllServiceAssignmentRows();
        renderCalendar();
        renderServiceLibrary();
      }

      minutesInput.addEventListener("change",persist);
      priceInput.addEventListener("change",persist);

      removeBtn.addEventListener("click",()=>{
        if(!servicePackages[cat]) return;
        servicePackages[cat].splice(idx,1);
        saveServicePackagesToStorage();
        refreshAllServiceAssignmentRows();
        renderServiceLibrary();
        renderDeptChips();
      });

      controls.appendChild(minutesInput);
      controls.appendChild(priceInput);
      controls.appendChild(removeBtn);

      row.appendChild(info);
      row.appendChild(controls);
      svcList.appendChild(row);
    });
    card.appendChild(svcList);

    const addRow=document.createElement("div");
    addRow.style.display="grid";
    addRow.style.gridTemplateColumns="1fr 80px 80px auto";
    addRow.style.gap="6px";
    addRow.style.marginTop="6px";

    const input=document.createElement("input");
    input.type="text";
    input.placeholder="Add service";

    const minsInput=document.createElement("input");
    minsInput.type="number";
    minsInput.min="15";
    minsInput.step="15";
    minsInput.placeholder="Mins";

    const priceInput=document.createElement("input");
    priceInput.type="number";
    priceInput.min="0";
    priceInput.step="1";
    priceInput.placeholder="Price";

    const addBtn=document.createElement("button");
    addBtn.type="button";
    addBtn.textContent="Add";
    addBtn.className="btn btn-primary";
    addBtn.style.padding="6px 10px";
    addBtn.style.fontSize="11px";
    addBtn.addEventListener("click",()=>{
      const val=input.value.trim();
      const minsVal=Math.max(15,parseInt(minsInput.value,10)||90);
      const priceVal=parseFloat(priceInput.value)||0;
      if(!val) return;
      if(!servicePackages[cat]) servicePackages[cat]=[];
      if(servicePackages[cat].some(s=>s.name===val)){
        alert("Service already exists in this category.");
        return;
      }
      servicePackages[cat].push({name:val,minutes:minsVal,price:priceVal});
      saveServicePackagesToStorage();
      renderServiceLibrary();
      refreshAllServiceAssignmentRows();
      renderDeptChips();
    });

    addRow.appendChild(input);
    addRow.appendChild(minsInput);
    addRow.appendChild(priceInput);
    addRow.appendChild(addBtn);
    card.appendChild(addRow);

    serviceCategoriesList.appendChild(card);
  });
}

btnAddCategory.addEventListener("click",()=>{
  const name=inputNewCategoryName.value.trim();
  if(!name) return;
  if(servicePackages[name]){
    alert("That category already exists.");
    return;
  }
  servicePackages[name]=[];
  saveServicePackagesToStorage();
  inputNewCategoryName.value="";
  renderServiceLibrary();
  refreshAllServiceAssignmentRows();
  renderDeptChips();         // <-- NEW
});


// Events utilities
function getEventsForDay(dateIso){return events.filter(ev=>ev.date===dateIso);}
function generateDeptColor(dept) {
  let hash = 0;
  for (let i = 0; i < dept.length; i++) {
    hash = dept.charCodeAt(i) + ((hash << 5) - hash);
  }
  const hue = Math.abs(hash) % 360;
  return `hsl(${hue}, 70%, 55%)`;
}
function isShopClosedAt(dateIso, time){
  const d = parseISODate(dateIso);
  if(!d) return false;
  const dow = getDayName(d);

  // Holiday?
  if(shopHolidays.some(h=>h.date===dateIso)) return true;

  const cfg = officeHours[dow];
  if(!cfg || cfg.closed) return true;

  const mins = timeToMinutes(time);
  const openMin = timeToMinutes(cfg.open);
  const closeMin = timeToMinutes(cfg.close);
  return (mins < openMin || mins >= closeMin);
}

function renderDeptChips() {
  const container = document.getElementById("chipsContainer");
  if (!container) return;

  container.innerHTML = "";

  // "All" chip
  const allChip = document.createElement("div");
  allChip.className = "chip active";
  allChip.dataset.dept = "All";
  allChip.innerHTML = `<span class="dot" style="background:#000;"></span>All`;
  container.appendChild(allChip);

  // One chip per service category from servicePackages
  const categories = Object.keys(servicePackages).sort();

  categories.forEach(cat => {
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.dataset.dept = cat;

    const color = generateDeptColor(cat);

    chip.innerHTML = `
      <span class="dot" style="background:${color};"></span>${cat}
    `;

    container.appendChild(chip);
  });

  // Chip click handling
  container.querySelectorAll(".chip").forEach(ch => {
    ch.addEventListener("click", () => {
      container.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
      ch.classList.add("active");

      selectedDeptFilter = ch.dataset.dept;
      renderCalendar();
    });
  });
}

function renderDealerQueue(){
  const dateIso=toISODate(currentDate);
  const todays=getEventsForDay(dateIso).filter(ev=>ev.type==="job" && ev.tech==="Dealer");
  if(!todays.length){
    dealerQueueListEl.className="dealer-queue-empty";
    dealerQueueListEl.textContent="No dealer jobs queued for this day.";
    return;
  }
  dealerQueueListEl.className="";
  dealerQueueListEl.innerHTML="";
  todays.sort((a,b)=>a.time.localeCompare(b.time)).forEach(ev=>{
    const item=document.createElement("div");
    item.className="dealer-queue-item";
    item.dataset.eventId=ev.id;
    item.style.cursor="pointer";

    const main=document.createElement("div");
    main.style.display="flex";
    main.style.flexDirection="column";
    main.style.gap="2px";

    const t=document.createElement("span");
    t.textContent=ev.time;
    t.style.fontWeight="600";
    main.appendChild(t);

    const n=document.createElement("span");
    n.textContent=formatCustomerName(ev)||"Dealer Job";
    main.appendChild(n);

    const s=document.createElement("span");
    s.textContent=`${ev.dept||""} · ${ev.serviceName||ev.label||""}`;
    s.style.fontSize="10px";
    main.appendChild(s);

    const badges=document.createElement("div");
    badges.style.display="flex";
    badges.style.flexDirection="column";
    badges.style.gap="2px";
    badges.style.alignItems="flex-end";

    const db=document.createElement("div");
    db.className="dq-badge";
    db.textContent="Dealer";
    badges.appendChild(db);

    if(ev.customerWaiting){
      const b=document.createElement("div");
      b.className="dq-badge";
      b.textContent="Waiting";
      badges.appendChild(b);
    }
    if(ev.rideNeeded){
      const b=document.createElement("div");
      b.className="dq-badge";
      b.textContent="Ride";
      badges.appendChild(b);
    }
    if(ev.pickupDelivery){
      const b=document.createElement("div");
      b.className="dq-badge";
      b.textContent="Pickup/Delivery";
      badges.appendChild(b);
    }

    item.appendChild(main);
    item.appendChild(badges);
    dealerQueueListEl.appendChild(item);
  });
}

// Calendar rendering
  function renderCalendar(){
    const dateIso=toISODate(currentDate);
    const dayName=getDayName(currentDate);
  const todays=getEventsForDay(dateIso);
  const coverageMap=new Map();
  const slotHeightVal=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--slot-height"))||32;
  todays.forEach(ev=>{
    if(ev.type!=="job") return;
    if(!ev.serviceProgress) ev.serviceProgress="In Queue";
    if(selectedDeptFilter!=="All" && ev.dept!==selectedDeptFilter) return;
      const duration=ev.minutes||90;
      const startIdx=workTimes.indexOf(ev.time);
      if(startIdx===-1) return;
      const slotsNeeded=Math.max(1,Math.ceil(duration/30));
      for(let i=0;i<slotsNeeded;i++){
        const slot=workTimes[startIdx+i];
        if(!slot) break;
        const key=`${ev.tech}-${slot}`;
        if(!coverageMap.has(key)) coverageMap.set(key,[]);
        coverageMap.get(key).push(ev);
      }
    });

    headerRowEl.innerHTML="";
  const timeHead=document.createElement("div");
  timeHead.className="cal-header-cell";
  timeHead.textContent="";
  headerRowEl.appendChild(timeHead);
  techs.forEach(t=>{
    const c=document.createElement("div");
    c.className="cal-header-cell";
    c.innerHTML=`<strong>${t}</strong>`;
    headerRowEl.appendChild(c);
  });

  dayLabelEl.textContent=formatDateLabel(currentDate);
  if(dayPickerEl) dayPickerEl.value=dateIso;

  bodyEl.innerHTML="";
  workTimes.forEach(time=>{
    const row=document.createElement("div");
    row.className="cal-row";
    const timeCell=document.createElement("div");
    timeCell.className="cal-time-cell";
    timeCell.textContent=formatTimeFriendly(time);
    row.appendChild(timeCell);
    const mins=timeToMinutes(time);

    techs.forEach(tech=>{
      const cell=document.createElement("div");
      cell.className="cal-slot-cell";
      cell.dataset.tech=tech;
      cell.dataset.time=time;

      const sched=techSchedules[tech]?.[dayName];
      if(!sched || sched.off){
        cell.classList.add("off-shift");
      }else{
        const s=timeToMinutes(sched.start),e=timeToMinutes(sched.end);
        if(mins<s || mins>=e) cell.classList.add("off-shift");
      }
      // Shop closed logic (office hours + holidays)
      const dateIso = toISODate(currentDate);
      const officeCfg = officeHours[dayName];
      let shopClosed = false;

      // Holiday = always closed
      if(shopHolidays.some(h=>h.date===dateIso)){
        shopClosed = true;
      }else if(!officeCfg || officeCfg.closed){
        shopClosed = true;
      }else{
        const openMin = timeToMinutes(officeCfg.open);
        const closeMin = timeToMinutes(officeCfg.close);
        if(mins < openMin || mins >= closeMin){
          shopClosed = true;
        }
      }

        if(shopClosed){
          cell.classList.add("shop-closed");
        }

        const coverKey=`${tech}-${time}`;
        const coveringJobs=coverageMap.get(coverKey)||[];
        const hasStartHere=coveringJobs.some(ev=>ev.time===time);
        if(coveringJobs.length && !hasStartHere){
          cell.classList.add("blocked-slot");
        }

        const inner=document.createElement("div");
        inner.className="cal-slot-inner";

      const cellEvents=todays.filter(ev=>
        ev.tech===tech &&
        ev.time===time &&
        (selectedDeptFilter==="All" || ev.dept===selectedDeptFilter || (ev.type==="timeoff" && selectedDeptFilter==="All"))
      );

      const hasTimeOffHere=todays.some(ev=>ev.type==="timeoff" && ev.tech===tech && ev.time===time);
      if(hasTimeOffHere){
        cell.classList.add("timeoff-block");
      }

      cellEvents.forEach(ev=>{
        if(ev.type==="timeoff"){
          const currentIndex=workTimes.indexOf(ev.time);
          const prevTime=currentIndex>0?workTimes[currentIndex-1]:null;
          const hasPrevTimeOff=prevTime
            ? todays.some(prevEv=>prevEv.type==="timeoff" && prevEv.tech===tech && prevEv.time===prevTime)
            : false;
          if(hasPrevTimeOff){
            return;
          }
        }

        if(ev.type==="job"){
          const bubble=document.createElement("div");
          let cls="event-bubble ";
          if(ev.dept==="Detailing") cls+="event-detailing";
          else if(ev.dept==="Tint") cls+="event-tint";
          else if(ev.dept==="PPF") cls+="event-ppf";
          else if(ev.dept==="Ceramic") cls+="event-ceramic";
          else if(ev.dept==="Electronics") cls+="event-electronics";
          bubble.className=cls.trim();
          bubble.dataset.eventId=ev.id;

          const slotsNeeded=Math.max(1,Math.ceil((ev.minutes||90)/30));
          bubble.style.height=`calc(${slotsNeeded} * var(--slot-height, ${slotHeightVal}px) - 6px)`;

          const header=document.createElement("div");
          header.className="bubble-header";
          const title=document.createElement("div");
          title.className="bubble-title";
          title.textContent=ev.serviceName||ev.label||"Service";
          header.appendChild(title);
          const customerLabel=formatCustomerName(ev);
          if(customerLabel){
            const cust=document.createElement("div");
            cust.className="bubble-sub";
            cust.textContent=customerLabel;
            header.appendChild(cust);
          }
          const infoLine=document.createElement("div");
          infoLine.className="bubble-sub muted";
          const infoParts=[];
          if(ev.phone) infoParts.push(ev.phone);
          if(ev.time) infoParts.push(formatTimeFriendly(ev.time));
          infoLine.textContent=infoParts.join(" • ");
          header.appendChild(infoLine);

          bubble.appendChild(header);

          const foot=document.createElement("div");
          foot.className="bubble-foot";
          const footLeft=document.createElement("div");
          footLeft.className="bubble-foot-left";

          const meta=statusMeta(ev.status||"Scheduled");
          const statusSpan=document.createElement("span");
          statusSpan.className=`event-status-icon ${meta.className}`;
          statusSpan.textContent=meta.icon;
          footLeft.appendChild(statusSpan);

          const progMeta=serviceProgressMeta(ev.serviceProgress||"In Queue");
          const progSpan=document.createElement("span");
          progSpan.className=`service-progress-icon ${progMeta.className}`;
          progSpan.textContent=progMeta.icon;
          footLeft.appendChild(progSpan);

          if(ev.invoiced || ev.paid){
            const dollar=document.createElement("span");
            dollar.className=`invoice-icon ${ev.paid?"paid":"pending"}`;
            dollar.textContent="$";
            footLeft.appendChild(dollar);
          }

          if(ev.dealer){
            const b=document.createElement("span");
            b.className="small-badge";
            b.textContent="D";
            footLeft.appendChild(b);
          }
          if(ev.customerWaiting){
            const b=document.createElement("span");
            b.className="small-badge";
            b.textContent="W";
            footLeft.appendChild(b);
          }
          if(ev.rideNeeded){
            const b=document.createElement("span");
            b.className="small-badge";
            b.textContent="R";
            footLeft.appendChild(b);
          }
          if(ev.pickupDelivery){
            const b=document.createElement("span");
            b.className="small-badge";
            b.textContent="P/D";
            footLeft.appendChild(b);
          }

          foot.appendChild(footLeft);
          const startLabel=document.createElement("div");
          startLabel.className="bubble-time";
          startLabel.textContent=ev.time?formatTimeFriendly(ev.time):"";
          foot.appendChild(startLabel);

          bubble.appendChild(foot);
          inner.appendChild(bubble);
          return;
        }

          const pill=document.createElement("div");
          let cls="event-pill ";
          if(ev.type==="timeoff") cls+="event-timeoff";
          else if(ev.dept==="Detailing") cls+="event-detailing";
          else if(ev.dept==="Tint") cls+="event-tint";
          else if(ev.dept==="PPF") cls+="event-ppf";
          else if(ev.dept==="Ceramic") cls+="event-ceramic";
          else if(ev.dept==="Electronics") cls+="event-electronics";
          pill.className=cls;
          pill.dataset.eventId=ev.id;

          let label=ev.label||ev.serviceName||"Job";
          const pillName=formatCustomerName(ev);
          if(ev.type==="job" && pillName) label=`${pillName} – ${label}`;
        const span=document.createElement("span");
        span.textContent=label;
        pill.appendChild(span);

        inner.appendChild(pill);
      });

      cell.appendChild(inner);
      row.appendChild(cell);
    });

    bodyEl.appendChild(row);
  });

  if(selectedSlot){
    const sel=`.cal-slot-cell[data-tech="${selectedSlot.tech}"][data-time="${selectedSlot.time}"]`;
    const c=bodyEl.querySelector(sel);
    if(c) c.classList.add("selected");
  }
  renderDealerQueue();
}

// Slot selection
  function setSelectedSlot(tech,time){
    selectedSlot={tech,time};
    if(!editingJobGroupId) setAppointmentFormLocked(false);
    bodyEl.querySelectorAll(".cal-slot-cell").forEach(c=>c.classList.remove("selected"));
  const sel=`.cal-slot-cell[data-tech="${tech}"][data-time="${time}"]`;
  const c=bodyEl.querySelector(sel);if(c)c.classList.add("selected");
  const iso=toISODate(currentDate);
  const dateInput=document.getElementById("datePicker");
  if(dateInput)dateInput.value=iso;

  ensureAtLeastOneServiceRow();
  const firstRow=serviceAssignmentsContainer.querySelector(".service-row");
  if(firstRow){
    const techSelect=firstRow.querySelector(".sa-tech");
    const timeSelect=firstRow.querySelector(".sa-time");
    if(techSelect) techSelect.value=tech;
    if(timeSelect) timeSelect.value=time;
  }

  if(statusEl)statusEl.textContent=`Selected ${tech} at ${time} on ${iso}.`;
  if(!editingJobGroupId){
    btnCreateAppointment.textContent="Save Appointment";
  }else{
    btnCreateAppointment.textContent="Update Appointment";
  }

  isEditingAppointmentForm=true;
}

// Seed dummy events
function seedDummyEvents(){
  const todayIso=toISODate(currentDate);
  let idCounter=1;
    const base=[
      {tech:"William",dept:"Detailing",type:"job",serviceName:"Full Detail",label:"Full Detail – F-150",time:"09:00",minutes:210,price:450,status:"Scheduled",dealer:false,customerFirstName:"Alex",customerLastName:"Smith",customerName:"Alex Smith",vin:"1FTFW1E50PFA12345",stockNumber:"STK-101",vehicleYear:"2023",vehicleMake:"Ford",vehicleModel:"F-150",serviceProgress:"In Queue"},
      {tech:"Limage",dept:"Detailing",type:"job",serviceName:"Interior Detail",label:"Interior – Civic",time:"10:00",minutes:150,price:275,status:"Scheduled",dealer:true,pickupDelivery:true,pickupTime:"08:30",deliveryTime:"17:00",customerFirstName:"Dana",customerLastName:"Zeigler",customerName:"Dana Zeigler",vin:"19XFC2F59GE000111",stockNumber:"STK-102",vehicleYear:"2016",vehicleMake:"Honda",vehicleModel:"Civic",serviceProgress:"In Queue"},
      {tech:"Matt",dept:"Tint",type:"job",serviceName:"Full Tint",label:"Full Tint – Model 3",time:"09:30",minutes:120,price:380,status:"Scheduled",dealer:true,rideNeeded:true,rideTime:"09:00",customerWaiting:true,customerFirstName:"Chris",customerLastName:"Jones",customerName:"Chris Jones",vin:"5YJ3E1EA7KF317222",stockNumber:"STK-103",vehicleYear:"2019",vehicleMake:"Tesla",vehicleModel:"Model 3",serviceProgress:"In Queue"},
      {tech:"Matt",dept:"PPF",type:"job",serviceName:"Full Front PPF",label:"Full Front – Supra",time:"12:00",minutes:240,price:1600,status:"Scheduled",dealer:false,customerFirstName:"Taylor",customerLastName:"Kim",customerName:"Taylor Kim",vin:"JT2JA82J0R0000456",stockNumber:"STK-104",vehicleYear:"2024",vehicleMake:"Toyota",vehicleModel:"Supra",serviceProgress:"In Queue"},
      {tech:"William",dept:"Ceramic",type:"job",serviceName:"5 Year Coating",label:"5yr – Silverado",time:"14:00",minutes:240,price:1400,status:"Scheduled",dealer:false,customerFirstName:"Morgan",customerLastName:"Clark",customerName:"Morgan Clark",vin:"3GCUYDED2PG111888",stockNumber:"STK-105",vehicleYear:"2023",vehicleMake:"Chevrolet",vehicleModel:"Silverado",serviceProgress:"In Queue"},
      {tech:"Fafa",dept:"Detailing",type:"job",serviceName:"Quick Clean",label:"Quick Clean – CR-V",time:"15:00",minutes:60,price:120,status:"Scheduled",dealer:false,customerFirstName:"Jamie",customerLastName:"Lopez",customerName:"Jamie Lopez",vin:"2HKRW2H5XHH123321",stockNumber:"STK-106",vehicleYear:"2017",vehicleMake:"Honda",vehicleModel:"CR-V",serviceProgress:"In Queue"},
      {tech:"Matt",dept:"Electronics",type:"job",serviceName:"Remote Start",label:"Remote Start – RAM",time:"11:00",minutes:120,price:450,status:"Scheduled",dealer:true,pickupDelivery:true,pickupTime:"10:30",deliveryTime:"16:30",customerFirstName:"Robin",customerLastName:"Davis",customerName:"Robin Davis",vin:"1C6SRFMT3NN401234",stockNumber:"STK-107",vehicleYear:"2022",vehicleMake:"RAM",vehicleModel:"1500",serviceProgress:"In Queue"},
      {tech:"William",dept:"Detailing",type:"timeoff",label:"Time Off",time:"13:00",notes:"Doctor appt"}
    ];
    events=base.map(e=>{
      const id="seed-"+(idCounter++);
      return {...e,id,date:todayIso,jobGroupId: e.type==="job" ? id : undefined};
    });
  }

// Panels
function setPanel(mode){
  appointmentPanel.style.display=mode==="appointments"?"block":"none";
  timeOffPanel.style.display=mode==="timeoff"?"block":"none";
  schedulesPanel.style.display=mode==="schedules"?"block":"none";
  servicesPanel.style.display=mode==="services"?"block":"none";
  headerBtnAppointments.classList.toggle("active",mode==="appointments");
  headerBtnTimeOff.classList.toggle("active",mode==="timeoff");
  headerBtnSchedules.classList.toggle("active",mode==="schedules");
  headerBtnServices.classList.toggle("active",mode==="services");
}

// Schedules panel
function loadScheduleIntoForm(tech){
  days.forEach(d=>{
    const s=document.getElementById(`sched_${d}_start`);
    const e=document.getElementById(`sched_${d}_end`);
    const o=document.getElementById(`sched_${d}_off`);
    if(!tech){
      s.value="09:00";e.value="17:00";o.checked=false;s.disabled=false;e.disabled=false;
      return;
    }
    const cfg=techSchedules[tech]?.[d];
    const startVal = cfg && cfg.start ? cfg.start : "09:00";
    const endVal = cfg && cfg.end ? cfg.end : "17:00";
    const offVal = cfg ? cfg.off : false;
    s.value=startVal;
    e.value=endVal;
    o.checked=offVal;
    s.disabled=offVal;
    e.disabled=offVal;
  });
}
function attachOffCheckboxHandlers(){
  days.forEach(d=>{
    const o=document.getElementById(`sched_${d}_off`);
    const s=document.getElementById(`sched_${d}_start`);
    const e=document.getElementById(`sched_${d}_end`);
    o.addEventListener("change",()=>{
      const off=o.checked;
      s.disabled=off;
      e.disabled=off;
    });
  });
}
function loadOfficeHoursIntoForm(){
  days.forEach(d=>{
    const openEl = document.getElementById(`office_${d}_open`);
    const closeEl = document.getElementById(`office_${d}_close`);
    const closedEl = document.getElementById(`office_${d}_closed`);
    const cfg = officeHours[d] || { open:"09:00", close:"17:00", closed:false };

    if(openEl) openEl.value = cfg.open;
    if(closeEl) closeEl.value = cfg.close;
    if(closedEl){
      closedEl.checked = !!cfg.closed;
      const disabled = !!cfg.closed;
      if(openEl) openEl.disabled = disabled;
      if(closeEl) closeEl.disabled = disabled;
    }
  });
}

function attachOfficeClosedCheckboxHandlers(){
  days.forEach(d=>{
    const closedEl = document.getElementById(`office_${d}_closed`);
    const openEl = document.getElementById(`office_${d}_open`);
    const closeEl = document.getElementById(`office_${d}_close`);
    if(!closedEl) return;
    closedEl.addEventListener("change",()=>{
      const disabled = closedEl.checked;
      if(openEl) openEl.disabled = disabled;
      if(closeEl) closeEl.disabled = disabled;
    });
  });
}

function saveOfficeHoursFromForm(){
  days.forEach(d=>{
    const openEl = document.getElementById(`office_${d}_open`);
    const closeEl = document.getElementById(`office_${d}_close`);
    const closedEl = document.getElementById(`office_${d}_closed`);
    officeHours[d] = {
      open: openEl && openEl.value ? openEl.value : "09:00",
      close: closeEl && closeEl.value ? closeEl.value : "17:00",
      closed: !!(closedEl && closedEl.checked)
    };
  });
  saveOfficeHoursToStorage();
  renderCalendar();
}
function renderHolidayList(){
  const listEl = document.getElementById("holidayList");
  if(!listEl) return;
  if(!shopHolidays.length){
    listEl.textContent = "No holidays configured.";
    listEl.className = "timeoff-note";
    return;
  }
  listEl.innerHTML = "";
  shopHolidays
    .slice()
    .sort((a,b)=>a.date.localeCompare(b.date))
    .forEach((h,idx)=>{
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.justifyContent = "space-between";
      row.style.alignItems = "center";
      row.style.fontSize = "12px";
      row.style.padding = "2px 0";

      const left = document.createElement("div");
      left.textContent = `${h.date} – ${h.label || "Holiday"}`;

      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = "Remove";
      btn.className = "btn btn-clear";
      btn.style.padding = "4px 8px";
      btn.style.fontSize = "10px";
      btn.addEventListener("click",()=>{
        shopHolidays.splice(idx,1);
        saveShopHolidaysToStorage();
        renderHolidayList();
        renderCalendar();
      });

      row.appendChild(left);
      row.appendChild(btn);
      listEl.appendChild(row);
    });
}
const btnAddHoliday = document.getElementById("btnAddHoliday");
if(btnAddHoliday){
  btnAddHoliday.addEventListener("click",()=>{
    const dateEl = document.getElementById("holidayDateInput");
    const labelEl = document.getElementById("holidayLabelInput");
    const date = dateEl ? dateEl.value.trim() : "";
    const label = labelEl ? labelEl.value.trim() : "";
    if(!date){
      alert("Pick a holiday date first.");
      return;
    }
    if(shopHolidays.some(h=>h.date===date)){
      alert("That date is already in the holiday list.");
      return;
    }
    shopHolidays.push({date,label});
    saveShopHolidaysToStorage();
    renderHolidayList();
    renderCalendar();
    if(labelEl) labelEl.value = "";
  });
}

function saveScheduleFromForm(){
  const tech=scheduleTechSelect.value;
  if(!tech){scheduleStatus.textContent="Choose a tech first.";return;}
  days.forEach(d=>{
    const s=document.getElementById(`sched_${d}_start`);
    const e=document.getElementById(`sched_${d}_end`);
    const o=document.getElementById(`sched_${d}_off`);
    techSchedules[tech][d]={start:s.value||"09:00",end:e.value||"17:00",off:o.checked};
  });
  saveSchedulesToStorage();
  scheduleStatus.textContent=`Schedule saved for ${tech}.`;
  renderCalendar();
}

// Time off logic
function saveTimeOff(){
  const tech=document.getElementById("timeOffTechnician").value;
  const startDate=document.getElementById("timeOffStartDate").value;
  const endDate=document.getElementById("timeOffEndDate").value||startDate;
  const startTime=document.getElementById("timeOffStartTime").value;
  const endTime=document.getElementById("timeOffEndTime").value;
  const allDay=document.getElementById("timeOffAllDay") ? document.getElementById("timeOffAllDay").checked : false;
  const notes=document.getElementById("timeOffNotes").value;
  if(!tech||!startDate){alert("Tech and start date are required.");return;}
  const start=new Date(startDate+"T00:00");
  const end=new Date(endDate+"T00:00");
  let cur=new Date(start);
  let idBase=Date.now();

  events=events.filter(ev=>{
    if(ev.type!=="timeoff" || ev.tech!==tech) return true;
    const evDate=new Date(ev.date+"T00:00");
    return evDate<start || evDate>end;
  });

  while(cur<=end){
    const dayIso=toISODate(cur);
    const dow=getDayName(cur);
    let times=[];
    if(!allDay && startTime && endTime){
      times=workTimes.filter(t=>{
        const m=timeToMinutes(t);
        return m>=timeToMinutes(startTime)&&m<timeToMinutes(endTime);
      });
    }else{
      const cfg=techSchedules[tech][dow];
      if(cfg.off){cur.setDate(cur.getDate()+1);continue;}
      times=workTimes.filter(t=>{
        const m=timeToMinutes(t);
        return m>=timeToMinutes(cfg.start)&&m<timeToMinutes(cfg.end);
      });
    }
    times.forEach(t=>{
      events.push({
        id:"to-"+(idBase++),
        type:"timeoff",
        tech,
        dept:null,
        label:"Time Off",
        date:dayIso,
        time:t,
        dealer:false,
        notes
      });
    });
    cur.setDate(cur.getDate()+1);
  }
  document.getElementById("timeOffForm").reset();
  renderCalendar();
}
function deleteTimeOff(){
  const tech=document.getElementById("timeOffTechnician").value;
  const startDate=document.getElementById("timeOffStartDate").value;
  const endDate=document.getElementById("timeOffEndDate").value||startDate;
  if(!tech || !startDate){alert("Tech and start date are required to delete time off.");return;}
  const start=new Date(startDate+"T00:00");
  const end=new Date(endDate+"T00:00");
  events=events.filter(ev=>{
    if(ev.type!=="timeoff" || ev.tech!==tech) return true;
    const evDate=new Date(ev.date+"T00:00");
    return evDate<start || evDate>end;
  });
  document.getElementById("timeOffForm").reset();
  renderCalendar();
}

async function loadAppointmentsFromBackend(options = { replaceLocal: true }) {
  if (!GOOGLE_BACKEND_URL) return;

  try {
    console.log("loadAppointmentsFromBackend: fetching from backend...");

    const resp = await fetch(GOOGLE_BACKEND_URL + "?action=loadAppointments&ts=" + Date.now(), {
      method: "GET"
    });

    if (!resp.ok) {
      console.error("Backend GET failed:", resp.status, resp.statusText);
      return;
    }

    const data = await resp.json();
    console.log("Backend raw payload:", data);

    if (!data || !data.ok || !Array.isArray(data.rows)) {
      console.error("Unexpected backend payload shape", data);
      return;
    }

    const newEvents = [];

    data.rows.forEach(row => {
      // row.id, row.date, row.time, row.tech, row.customerName, row.vehicle, row.services, row.status, row.notes, row.overrideClosed
      let dateStr = row.date;
      if (typeof dateStr === "string") {
        // If it's like "2025-01-13T00:00:00.000Z", keep only the first 10 chars
        if (dateStr.length >= 10) {
          dateStr = dateStr.slice(0, 10);
        }
      }

      let timeStr = row.time;
      if (typeof timeStr === "string") {
        if (/^\d{2}:\d{2}$/.test(timeStr)) {
          // already HH:MM, leave as is
        } else {
          // Try to parse as a Date and extract HH:MM
          const dt = new Date(timeStr);
          if (!isNaN(dt.getTime())) {
            const hh = String(dt.getHours()).padStart(2, "0");
            const mm = String(dt.getMinutes()).padStart(2, "0");
            timeStr = `${hh}:${mm}`;
          }
        }
      }

      if (!dateStr || !timeStr || !row.tech) {
        console.warn("Skipping row with missing date/time/tech:", row);
        return;
      }

      let minutes = row.minutes ? parseInt(row.minutes, 10) : 90;
      if (Number.isNaN(minutes) || minutes <= 0) minutes = 90;
      const endTime = addMinutesToTime(timeStr, minutes);
      const servicesText = row.services || "";
      const invoiced = row.invoiced === "YES";
      const paid = row.paid === "YES";
      const dealer = row.dealer === "YES";
      const customerWaiting = row.customerWaiting === "YES";
      const rideNeeded = row.rideNeeded === "YES";
      const pickupDelivery = row.pickupDelivery === "YES";
      const overrideClosed = row.overrideClosed === "YES";

      newEvents.push({
        id: row.id || ("remote-" + dateStr + "-" + timeStr + "-" + row.tech),
        jobGroupId: row.id || null,
        type: "job",
        date: dateStr,
        time: timeStr,
        minutes,
        endTime,
        tech: row.tech || "",
        dept: row.dept || "",
        serviceName: servicesText,
        label: servicesText || "Service",
        price: 0,
        serviceProgress: row.serviceProgress || "In Queue",
        status: row.status || "Scheduled",
        invoiced,
        paid,
        dealer,
        customerFirstName: row.customerFirstName || "",
        customerLastName: row.customerLastName || "",
        customerName: ((row.customerFirstName || "") + " " + (row.customerLastName || "")).trim(),
        phone: row.phone || "",
        email: row.email || "",
        vin: row.vin || "",
        stockNumber: row.stockNumber || "",
        vehicleYear: row.vehicleYear || "",
        vehicleMake: row.vehicleMake || "",
        vehicleModel: row.vehicleModel || "",
        customerWaiting,
        rideNeeded,
        rideTime: row.rideTime || "",
        pickupDelivery,
        pickupTime: row.pickupTime || "",
        deliveryTime: row.deliveryTime || "",
        notes: row.notes || "",
        overrideClosed
      });
    });

    console.log("Loaded from backend:", newEvents.length, "events");
    if (newEvents.length > 0) {
      // Only replace local events if we actually have some from backend
      events = newEvents;
      if (typeof renderCalendar === "function") {
        renderCalendar();
      }
    } else {
      console.warn("Backend returned no valid events. Keeping local events unchanged.");
    }

  } catch (err) {
    console.error("Error loading appointments from backend", err);
  }
}

async function loadTechSchedulesFromBackend() {
  if (!GOOGLE_BACKEND_URL) return;
  try {
    const resp = await fetch(GOOGLE_BACKEND_URL + "?action=loadTechSchedules&ts=" + Date.now(), {
      method: "GET"
    });
    if (!resp.ok) return;
    const data = await resp.json();
    if (!data.ok || !Array.isArray(data.rows)) return;

    const mergedSchedules = JSON.parse(JSON.stringify(techSchedules || {}));
    data.rows.forEach(function(row) {
      var tech = row.tech;
      var weekday = row.weekday;
      if (!tech || !weekday) return;

      if (!mergedSchedules[tech]) mergedSchedules[tech] = {};

      var off = (row.off === "YES");
      mergedSchedules[tech][weekday] = {
        start: row.startTime || "",
        end: row.endTime || "",
        off: off
      };
    });

    techSchedules = mergedSchedules;

    const selectedTech = scheduleTechSelect?.value;
    if (selectedTech && techSchedules[selectedTech]) {
      loadScheduleIntoForm(selectedTech);
    }
    renderCalendar();
  } catch (err) {
    console.error("Error loading TechSchedules from backend", err);
  }
}

async function loadTechTimeOffFromBackend() {
  if (!GOOGLE_BACKEND_URL) return;
  try {
    const resp = await fetch(GOOGLE_BACKEND_URL + "?action=loadTechTimeOff&ts=" + Date.now(), {
      method: "GET"
    });
    if (!resp.ok) return;
    const data = await resp.json();
    if (!data.ok || !Array.isArray(data.rows)) return;

    events = events.filter(ev => ev.type !== "timeoff");
    let idBase = Date.now();

    data.rows.forEach(function(row) {
      const tech = row.tech || "";
      const date = row.date || "";
      if (!tech || !date) return;

      const dow = getDayName(new Date(date + "T00:00"));
      const allDay = row.allDay === "YES";
      const cfg = techSchedules[tech]?.[dow];

      let start = row.startTime || "";
      let end = row.endTime || "";

      if (allDay && cfg && !cfg.off) {
        start = cfg.start || start;
        end = cfg.end || end;
      }

      if (!start) start = (cfg && cfg.start) ? cfg.start : "09:00";
      if (!end) end = (cfg && cfg.end) ? cfg.end : "17:00";
      if (cfg && cfg.off) return;
      if (!start || !end) return;

      const times = workTimes.filter(t => {
        const m = timeToMinutes(t);
        return m >= timeToMinutes(start) && m < timeToMinutes(end);
      });

      times.forEach(t => {
        events.push({
          id: "to-" + (idBase++),
          type: "timeoff",
          tech,
          dept: null,
          label: "Time Off",
          date,
          time: t,
          dealer: false,
          notes: row.reason || ""
        });
      });
    });

    renderCalendar();
  } catch (err) {
    console.error("Error loading TechTimeOff from backend", err);
  }
}

async function loadHolidaysFromBackend() {
  if (!GOOGLE_BACKEND_URL) return;
  try {
    const resp = await fetch(GOOGLE_BACKEND_URL + "?action=loadHolidays&ts=" + Date.now(), {
      method: "GET"
    });
    if (!resp.ok) return;
    const data = await resp.json();
    if (!data.ok || !Array.isArray(data.rows)) return;

    shopHolidays = data.rows.map(function(row) {
      return {
        date: row.date,
        label: row.name || "",
        closedAllDay: (row.closedAllDay === "YES"),
        openTime: row.openTime || "",
        closeTime: row.closeTime || ""
      };
    });

    renderHolidayList();
    renderCalendar();
  } catch (err) {
    console.error("Error loading Holidays from backend", err);
  }
}

async function loadServicesFromBackend() {
  if (!GOOGLE_BACKEND_URL) return;
  try {
    const resp = await fetch(GOOGLE_BACKEND_URL + "?action=loadServices&ts=" + Date.now(), {
      method: "GET"
    });
    if (!resp.ok) return;
    const data = await resp.json();
    if (!data.ok || !Array.isArray(data.rows)) return;

    const rebuilt = {};

    data.rows.forEach(function(row) {
      if (row.active !== "YES") return;
      var cat = row.category || "General";
      if (!rebuilt[cat]) rebuilt[cat] = [];
      rebuilt[cat].push({
        name: row.serviceName || "",
        minutes: row.defaultMinutes ? Math.max(15, parseInt(row.defaultMinutes, 10) || 0) : 0,
        price: row.defaultPrice ? parseFloat(row.defaultPrice) || 0 : 0
      });
    });

    if (Object.keys(rebuilt).length) {
      servicePackages = normalizeServicePackages(rebuilt);
      renderServiceLibrary();
      refreshAllServiceAssignmentRows();
      renderDeptChips();
    }
  } catch (err) {
    console.error("Error loading Services from backend", err);
  }
}

function sendAppointmentToBackend(groupId, eventsForGroup){
  if (!GOOGLE_BACKEND_URL) return;
  if (!eventsForGroup || !eventsForGroup.length) return;

  // Use the first event in the group as the "primary" for shared fields
  const primary = eventsForGroup[0];

  // Build per-service payloads (one per bubble)
  const serviceEventsPayload = eventsForGroup.map(ev => {
    return {
      date: ev.date,
      time: ev.startTime || ev.time || "",
      tech: ev.tech || "",
      dept: ev.dept || "",
      services: ev.serviceName || ev.label || "",
      minutes: typeof ev.minutes === "number" ? ev.minutes : parseInt(ev.minutes||"0",10)||0,
      status: ev.status || primary.status || "",
      serviceProgress: ev.serviceProgress || primary.serviceProgress || "",
      invoiced: !!ev.invoiced,
      paid: !!ev.paid,
      dealer: !!ev.dealer,
      customerWaiting: !!ev.customerWaiting,
      rideNeeded: !!ev.rideNeeded,
      rideTime: ev.rideTime || primary.rideTime || "",
      pickupDelivery: !!ev.pickupDelivery,
      pickupTime: ev.pickupTime || primary.pickupTime || "",
      deliveryTime: ev.deliveryTime || primary.deliveryTime || "",
      notes: ev.notes || primary.notes || "",
      overrideClosed: !!ev.overrideClosed
    };
  });

  const payload = {
    // group-level id for this appointment
    id: groupId,

    // shared appointment fields (taken from the primary event)
    date: primary.date,
    time: primary.startTime || primary.time || "",
    tech: primary.tech || "",
    dept: primary.dept || "",
    customerFirstName: primary.customerFirstName || "",
    customerLastName: primary.customerLastName || "",
    phone: primary.phone || "",
    email: primary.email || "",
    vin: primary.vin || "",
    stockNumber: primary.stockNumber || "",
    vehicleYear: primary.vehicleYear || "",
    vehicleMake: primary.vehicleMake || "",
    vehicleModel: primary.vehicleModel || "",

    status: primary.status || "",
    serviceProgress: primary.serviceProgress || "",
    invoiced: !!primary.invoiced,
    paid: !!primary.paid,
    dealer: !!primary.dealer,
    customerWaiting: !!primary.customerWaiting,
    rideNeeded: !!primary.rideNeeded,
    rideTime: primary.rideTime || "",
    pickupDelivery: !!primary.pickupDelivery,
    pickupTime: primary.pickupTime || "",
    deliveryTime: primary.deliveryTime || "",
    notes: primary.notes || "",
    overrideClosed: !!primary.overrideClosed,

    // all per-service lines
    events: serviceEventsPayload
  };

  console.log("Sending to backend:", payload);

  try {
    fetch(GOOGLE_BACKEND_URL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify(payload)
    }).catch(err => {
      console.error("Failed to send appointment to backend", err);
    });
  } catch (e) {
    console.error("Error sending appointment to backend", e);
  }
}

function sendAppointmentDeleteToBackend(groupId) {
  if (!GOOGLE_BACKEND_URL) return;
  if (!groupId) return;

  var payload = {
    action: "delete",
    id: groupId
  };

  console.log("Sending delete to backend:", payload);

  try {
    fetch(GOOGLE_BACKEND_URL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify(payload)
    }).catch(function(err) {
      console.error("Failed to send delete to backend", err);
    });
  } catch (e) {
    console.error("Error sending delete to backend", e);
  }
}

function isUserEditingAppointment() {
  // Primary flag: explicitly set when the appointment form is in use
  if(typeof isEditingAppointmentForm!=="undefined" && isEditingAppointmentForm){
    return true;
  }

  // Also treat "editingJobGroupId" as editing if it exists
  if(typeof editingJobGroupId!="undefined" && editingJobGroupId){
    return true;
  }

  // If you have dragging/resizing flags, include them:
  if(typeof isDraggingAppointment!="undefined" && isDraggingAppointment){
    return true;
  }
  if(typeof isResizingAppointment!="undefined" && isResizingAppointment){
    return true;
  }

  return false;
}

function isSafeToAutoRefresh(){
  const now=Date.now();

  const idleTime=now-lastUserInteractionTime;
  if(idleTime<AUTO_IDLE_THRESHOLD_MS){
    return false;
  }

  if(isUserEditingAppointment()){
    return false;
  }

  return true;
}

function attachUserInteractionListeners(){
  const resetIdle=function(){
    lastUserInteractionTime=Date.now();
  };

  window.addEventListener("mousemove",resetIdle);
  window.addEventListener("mousedown",resetIdle);
  window.addEventListener("keydown",resetIdle);
  window.addEventListener("touchstart",resetIdle);
  window.addEventListener("wheel",resetIdle);
}

function maybeAutoRefreshFromBackend(){
  if(!GOOGLE_BACKEND_URL) return;

  const now=Date.now();

  if(now-lastAutoRefreshTime<AUTO_REFRESH_INTERVAL_MS){
    return;
  }

  lastAutoRefreshTime=now;

  if(!isSafeToAutoRefresh()){
    return;
  }

  if(typeof loadAppointmentsFromBackend==="function"){
    try{
      loadAppointmentsFromBackend({ replaceLocal:true });
    }catch(err){
      console.error("Auto-refresh from backend failed",err);
    }
  }
}

// Appointment create/update
async function createOrUpdateAppointment(){
  const overrideClosed = document.getElementById("checkboxOverrideClosed").checked;
  const customerFirstName=document.getElementById("inputCustomerFirstName").value.trim();
  const customerLastName=document.getElementById("inputCustomerLastName").value.trim();
  const customerName=formatCustomerName(customerFirstName,customerLastName)||(document.getElementById("checkboxDealer").checked?"Dealer Job":"");
  const phone=document.getElementById("inputCustomerPhone").value.trim();
  const email=document.getElementById("inputCustomerEmail").value.trim();
  const vin=sanitizeVinInput();
  const stockNumber=(stockNumberInput?.value||"").trim();
  const vehicleYear=(vehicleYearInput?.value||"").trim();
  const vehicleMake=(vehicleMakeInput?.value||"").trim();
  const vehicleModel=(vehicleModelInput?.value||"").trim();
  const date=document.getElementById("datePicker").value;
  const dayName=getDayName(new Date(date+"T00:00"));
  const dealer=document.getElementById("checkboxDealer").checked;
  const waiting=document.getElementById("checkboxCustomerWaiting").checked;
  const rideNeeded=document.getElementById("checkboxRideNeeded").checked;
  const rideTime=document.getElementById("inputRideTime").value;
  const pickupDelivery=document.getElementById("checkboxPickupDelivery").checked;
  const pickupTime=document.getElementById("inputPickupTime").value;
  const deliveryTime=document.getElementById("inputDeliveryTime").value;
  const notes=document.getElementById("inputNotes").value;
  const statusValue=statusField?statusField.value:"Scheduled";
  const invoiced=checkboxInvoiced.checked||checkboxPaid.checked;
  const paid=checkboxPaid.checked;

  const rawServices=getServiceAssignmentsFromForm();
  if(!rawServices.length){
    alert("Add at least one service/tech row.");
    return;
  }
  if(!date){
    alert("Appointment date is required.");
    return;
  }

  let missingDept=false,missingTech=false,missingTime=false;
  const services=rawServices.map(row=>{
    let {dept,serviceName,tech,time,minutes,price,serviceProgress}=row;
    if(!dept) missingDept=true;
    if(!time) missingTime=true;
    if(!tech && dealer){
      tech="Dealer";
    }
    if(!tech) missingTech=true;
    return {dept,serviceName,tech,time,minutes,price,serviceProgress};
  });
  if(!overrideClosed){
    const blocked = services.some(svc => {
      const endTime=addMinutesToTime(svc.time,svc.minutes||90);
      return isShopClosedAt(date, svc.time) || isShopClosedAt(date,endTime);
    });
    if(blocked){
      alert("One or more service times are outside shop hours or on a holiday. Check 'Override shop hours & holidays for this booking' if you want to schedule anyway.");
      return;
    }
  }

  if(!overrideClosed){
    const scheduleConflict=services.some(svc=>{
      const techCfg=techSchedules[svc.tech]?.[dayName];
      if(!techCfg || techCfg.off) return true;
      const startMin=timeToMinutes(svc.time);
      const endMin=startMin+(svc.minutes||90);
      return startMin<timeToMinutes(techCfg.start)||endMin>timeToMinutes(techCfg.end);
    });
    if(scheduleConflict){
      alert("One or more services exceed the assigned tech schedule. Adjust times or enable override.");
      return;
    }
  }

  if(!overrideClosed){
    const scheduleConflict=services.some(svc=>{
      const techCfg=techSchedules[svc.tech]?.[dayName];
      if(!techCfg || techCfg.off) return true;
      const startMin=timeToMinutes(svc.time);
      const endMin=startMin+(svc.minutes||90);
      return startMin<timeToMinutes(techCfg.start)||endMin>timeToMinutes(techCfg.end);
    });
    if(scheduleConflict){
      alert("One or more services exceed the assigned tech schedule. Adjust times or enable override.");
      return;
    }
  }

  if(!overrideClosed){
    const scheduleConflict=services.some(svc=>{
      const techCfg=techSchedules[svc.tech]?.[dayName];
      if(!techCfg || techCfg.off) return true;
      const startMin=timeToMinutes(svc.time);
      const endMin=startMin+(svc.minutes||90);
      return startMin<timeToMinutes(techCfg.start)||endMin>timeToMinutes(techCfg.end);
    });
    if(scheduleConflict){
      alert("One or more services exceed the assigned tech schedule. Adjust times or enable override.");
      return;
    }
  }

  if(missingDept || missingTech || missingTime){
    let msg="Each service row must have:";
    if(missingDept) msg+="\n- Service category";
    if(missingTech) msg+="\n- Technician (or check Dealer Job)";
    if(missingTime) msg+="\n- Time";
    alert(msg);
    return;
  }

  const groupId=editingJobGroupId || ("jobgrp-"+Date.now());
  const payloadType=editingJobGroupId?"update_appointment":"appointment";

  events=events.filter(ev=>ev.type!=="job" || (ev.jobGroupId||ev.id)!==groupId);

  services.forEach((svc,index)=>{
    const id=groupId+"-"+index+"-"+Date.now();
    events.push({
      id,
      jobGroupId:groupId,
      type:"job",
      tech:svc.tech,
      dept:svc.dept,
      serviceName:svc.serviceName,
      label:svc.serviceName||svc.dept||"Service",
      date,
      time:svc.time,
      minutes:svc.minutes||90,
      endTime:addMinutesToTime(svc.time,svc.minutes||90),
      price:svc.price||0,
      serviceProgress:svc.serviceProgress||"In Queue",
      status:statusValue,
      invoiced,
      paid,
      dealer,
      customerFirstName,
      customerLastName,
      customerName,
      phone,
      email,
      vin,
      stockNumber,
      vehicleYear,
      vehicleMake,
      vehicleModel,
      customerWaiting:waiting,
      rideNeeded,
      rideTime,
      pickupDelivery,
      pickupTime,
      deliveryTime,
      notes,
      overrideClosed
    });
  });

  rebalanceServiceProgress(groupId,{triggerAutoStart:true});

  editingJobGroupId=groupId;
  currentDate=new Date(date+"T00:00");
  renderCalendar();
  if(statusEl)statusEl.textContent=payloadType==="update_appointment"
    ?"Appointment updated."
    :"Appointment created.";
  btnCreateAppointment.textContent="Update Appointment";

  // clear form after save
  document.getElementById("appointmentForm").reset();
  updateVinHelper(defaultVinHelperText);
  clearServiceAssignments();
  ensureAtLeastOneServiceRow();
  setStatusState("Scheduled",false,false);
  selectedSlot=null;
  editingJobGroupId=null;
  btnCreateAppointment.textContent="Save Appointment";
  setAppointmentFormLocked(false);
  setPopupEditable(false);
  closeAppointmentPopup();

  const eventsForGroup=events.filter(ev=>ev.jobGroupId===groupId);
  sendAppointmentToBackend(groupId,eventsForGroup);
  isEditingAppointmentForm=false;
}

// Delete appointment (entire group)
function deleteAppointment(){
  if(!editingJobGroupId){
    alert("Select an appointment from the calendar first.");
    return;
  }
  const groupKey=editingJobGroupId;
  events=events.filter(ev=>!(ev.type==="job" && (ev.jobGroupId||ev.id)===groupKey));
  sendAppointmentDeleteToBackend(groupKey);
  editingJobGroupId=null;
  document.getElementById("appointmentForm").reset();
  updateVinHelper(defaultVinHelperText);
  clearServiceAssignments();
  ensureAtLeastOneServiceRow();
  setStatusState("Scheduled",false,false);
  btnCreateAppointment.textContent="Save Appointment";
  if(statusEl)statusEl.textContent="Appointment deleted.";
  renderCalendar();
  setAppointmentFormLocked(false);
  setPopupEditable(false);
  closeAppointmentPopup();
  isEditingAppointmentForm=false;
}

// Clear appointment form manually
function clearAppointmentForm(){
  document.getElementById("appointmentForm").reset();
  updateVinHelper(defaultVinHelperText);
  clearServiceAssignments();
  ensureAtLeastOneServiceRow();
  setStatusState("Scheduled",false,false);
  selectedSlot=null;
  editingJobGroupId=null;
  btnCreateAppointment.textContent="Save Appointment";
  if(statusEl)statusEl.textContent="Cleared form.";
  isEditingAppointmentForm=false;
  renderCalendar();
  setAppointmentFormLocked(false);
  setPopupEditable(false);
  closeAppointmentPopup();
}

// Clear time off form
function clearTimeOffForm(){
  document.getElementById("timeOffForm").reset();
}



function loadJobEventIntoForm(ev){
  setPanel("services");

  const groupKey=ev.jobGroupId||ev.id;
  editingJobGroupId=groupKey;
  btnCreateAppointment.textContent="Update Appointment";

  const firstInput=document.getElementById("inputCustomerFirstName");
  const lastInput=document.getElementById("inputCustomerLastName");
  const fallbackName=(ev.customerName||"").trim();
  const nameParts=fallbackName.split(" ");
  if(firstInput) firstInput.value=ev.customerFirstName||nameParts[0]||"";
  if(lastInput) lastInput.value=ev.customerLastName||nameParts.slice(1).join(" ")||"";
  document.getElementById("inputCustomerPhone").value=ev.phone||"";
  document.getElementById("inputCustomerEmail").value=ev.email||"";
  if(vinInput){
    vinInput.value=ev.vin||"";
    applyVinDecodeAndHelper(ev.vin||"");
  }
  if(stockNumberInput) stockNumberInput.value=ev.stockNumber||"";
  if(vehicleYearInput) vehicleYearInput.value=ev.vehicleYear||"";
  if(vehicleMakeInput) vehicleMakeInput.value=ev.vehicleMake||"";
  if(vehicleModelInput) vehicleModelInput.value=ev.vehicleModel||"";
  document.getElementById("datePicker").value=ev.date||"";
  document.getElementById("checkboxDealer").checked=!!ev.dealer;
  document.getElementById("checkboxCustomerWaiting").checked=!!ev.customerWaiting;
  document.getElementById("checkboxRideNeeded").checked=!!ev.rideNeeded;
  document.getElementById("inputRideTime").value=ev.rideTime||"";
  document.getElementById("checkboxPickupDelivery").checked=!!ev.pickupDelivery;
  document.getElementById("inputPickupTime").value=ev.pickupTime||"";
  document.getElementById("inputDeliveryTime").value=ev.deliveryTime||"";
  document.getElementById("inputNotes").value=ev.notes||"";
  setStatusState(ev.status||"Scheduled",!!ev.invoiced||!!ev.paid,!!ev.paid);

  clearServiceAssignments();
  const groupEvents=events.filter(e=>e.type==="job" && (e.jobGroupId||e.id)===groupKey);
  if(groupEvents.length){
    groupEvents.forEach(gev=>{
      addServiceRow({
        dept:gev.dept||"",
        serviceName:gev.serviceName||"",
        tech:gev.tech||"",
        time:gev.time||"",
        minutes:gev.minutes||90,
        price:typeof gev.price!=="undefined"?gev.price:0,
        serviceProgress:gev.serviceProgress||"In Queue",
        id:gev.id
      });
    });
  }else{
    ensureAtLeastOneServiceRow();
  }

  if(ev.date){
    currentDate=new Date(ev.date+"T00:00");
    renderCalendar();
  }
  if(statusEl)statusEl.textContent="Editing existing appointment.";
  setAppointmentFormLocked(true);
  setPopupEditable(false);
  isEditingAppointmentForm=true;
}

// Calendar clicks
bodyEl.addEventListener("click",e=>{
  const pill=e.target.closest(".event-pill, .event-bubble");
  if(pill){
    const id=pill.dataset.eventId;
    const ev=events.find(ev=>ev.id===id);
    if(!ev) return;
    if(ev.type==="job"){
      loadJobEventIntoForm(ev);
      openAppointmentPopup(ev);
    }else if(ev.type==="timeoff"){
      setPanel("timeoff");
      const tech=ev.tech||"";
      const thisDate=ev.date;
      document.getElementById("timeOffTechnician").value=tech;

      const techTimeOff=events.filter(x=>x.type==="timeoff" && x.tech===tech);
      const dateSet=Array.from(new Set(techTimeOff.map(x=>x.date))).sort();
      let startDate=thisDate;
      let endDate=thisDate;
      if(thisDate){
        const idxDate=dateSet.indexOf(thisDate);
        if(idxDate!==-1){
          let i=idxDate-1;
          while(i>=0){
            const prevDate=dateSet[i];
            const prev=new Date(prevDate+"T00:00");
            const cur=new Date(dateSet[i+1]+"T00:00");
            const diffDays=(cur-prev)/(1000*60*60*24);
            if(diffDays===1){
              startDate=prevDate;
              i--;
            }else break;
          }
          i=idxDate+1;
          while(i<dateSet.length){
            const prev=new Date(dateSet[i-1]+"T00:00");
            const cur=new Date(dateSet[i]+"T00:00");
            const diffDays=(cur-prev)/(1000*60*60*24);
            if(diffDays===1){
              endDate=dateSet[i];
              i++;
            }else break;
          }
        }
      }

      document.getElementById("timeOffStartDate").value=startDate||thisDate||"";
      document.getElementById("timeOffEndDate").value=endDate||thisDate||"";

      const sameDay=techTimeOff
        .filter(x=>x.date===thisDate)
        .sort((a,b)=>a.time.localeCompare(b.time));

      const startTimeEl2=document.getElementById("timeOffStartTime");
      const endTimeEl2=document.getElementById("timeOffEndTime");
      const allDayCheckbox2=document.getElementById("timeOffAllDay");
      let isAllDay=false;

      if(sameDay.length){
        const startTime=sameDay[0].time;
        const endTime=sameDay[sameDay.length-1].time;
        if(startTimeEl2) startTimeEl2.value=startTime;
        if(endTimeEl2) endTimeEl2.value=endTime;

        if(thisDate && tech && techSchedules[tech]){
          const dow=getDayName(new Date(thisDate+"T00:00"));
          const cfg=techSchedules[tech][dow];
          if(cfg && !cfg.off){
            const schedStartMin=timeToMinutes(cfg.start);
            const schedEndMin=timeToMinutes(cfg.end);
            const blockStartMin=timeToMinutes(startTime);
            const blockEndMin=timeToMinutes(endTime);
            if(blockStartMin===schedStartMin && blockEndMin===schedEndMin){
              isAllDay=true;
            }
          }
        }
      }else{
        if(startTimeEl2) startTimeEl2.value="";
        if(endTimeEl2) endTimeEl2.value="";
      }

      if(allDayCheckbox2){
        allDayCheckbox2.checked=isAllDay;
        const disabled=isAllDay;
        if(startTimeEl2) startTimeEl2.disabled=disabled;
        if(endTimeEl2) endTimeEl2.disabled=disabled;
      }

      document.getElementById("timeOffNotes").value=ev.notes||"";
      if(ev.date){
        currentDate=new Date(ev.date+"T00:00");
        renderCalendar();
      }
    }
    return;
  }
  const cell=e.target.closest(".cal-slot-cell");
  if(cell){
    setSelectedSlot(cell.dataset.tech,cell.dataset.time);
  }
});

dealerQueueListEl.addEventListener("click",e=>{
  const item=e.target.closest(".dealer-queue-item");
  if(!item) return;
  const id=item.dataset.eventId;
  const ev=events.find(ev=>ev.id===id);
  if(!ev) return;
  if(ev.type==="job"){
    loadJobEventIntoForm(ev);
    openAppointmentPopup(ev);
  }
});

// Day navigation
document.getElementById("btnPrevDay").addEventListener("click",()=>{
  currentDate.setDate(currentDate.getDate()-1);
  renderCalendar();
});
document.getElementById("btnNextDay").addEventListener("click",()=>{
  currentDate.setDate(currentDate.getDate()+1);
  renderCalendar();
});

// Panel buttons
headerBtnAppointments.addEventListener("click",()=>setPanel("appointments"));
headerBtnTimeOff.addEventListener("click",()=>setPanel("timeoff"));
headerBtnSchedules.addEventListener("click",()=>setPanel("schedules"));
headerBtnServices.addEventListener("click",()=>{
  setPanel("services");
  renderServiceLibrary();
});
if(btnRefreshFromCloud){
  btnRefreshFromCloud.addEventListener("click",()=>{
    loadAppointmentsFromBackend({ replaceLocal:true });
  });
}

// Schedules panel
scheduleTechSelect.addEventListener("change",()=>{
  const tech=scheduleTechSelect.value;
  loadScheduleIntoForm(tech);
  scheduleStatus.textContent=tech?`Editing weekly schedule for ${tech}.`:"";
});
document.getElementById("btnSaveSchedules").addEventListener("click",saveScheduleFromForm);

// Time off buttons
document.getElementById("btnSaveTimeOff").addEventListener("click",saveTimeOff);
document.getElementById("btnClearTimeOff").addEventListener("click",clearTimeOffForm);
document.getElementById("btnDeleteTimeOff").addEventListener("click",deleteTimeOff);

// All-day toggle
const allDayCheckbox=document.getElementById("timeOffAllDay");
const startTimeEl=document.getElementById("timeOffStartTime");
const endTimeEl=document.getElementById("timeOffEndTime");
if(allDayCheckbox){
  allDayCheckbox.addEventListener("change",()=>{
    const disabled=allDayCheckbox.checked;
    if(startTimeEl) startTimeEl.disabled=disabled;
    if(endTimeEl) endTimeEl.disabled=disabled;
  });
}

// VIN helpers
if(vinInput){
  vinInput.addEventListener("blur",()=>{
    applyVinDecodeAndHelper(sanitizeVinInput());
  });
}
if(btnVinScan){
  btnVinScan.addEventListener("click",()=>{
    const scanned=prompt("Scan or enter VIN value:","")||"";
    applyVinDecodeAndHelper(scanned);
  });
}

// Appointment buttons
btnCreateAppointment.addEventListener("click",createOrUpdateAppointment);
document.getElementById("btnClear").addEventListener("click",clearAppointmentForm);
btnDeleteAppointment.addEventListener("click",deleteAppointment);

// Appointment popup controls
if(btnUnlockEditing){
  btnUnlockEditing.addEventListener("click",()=>{
    setAppointmentFormLocked(false);
    setPopupEditable(true);
    closeAppointmentPopup();
  });
}
if(btnClosePopup){
  btnClosePopup.addEventListener("click",closeAppointmentPopup);
}
if(appointmentPopup){
  appointmentPopup.addEventListener("click",e=>{
    if(e.target===appointmentPopup) closeAppointmentPopup();
  });
}
if(popupStatusSelect){
  popupStatusSelect.addEventListener("change",()=>{
    setStatusState(popupStatusSelect.value,checkboxInvoiced.checked,checkboxPaid.checked);
    applyMetaToGroup(popupStatusSelect.value,checkboxInvoiced.checked,checkboxPaid.checked);
  });
}
if(popupInvoiced){
  popupInvoiced.addEventListener("change",()=>{
    const invoiced=popupInvoiced.checked||popupPaid.checked;
    setStatusState(statusField.value||"Scheduled",invoiced,checkboxPaid.checked);
    applyMetaToGroup(statusField.value||"Scheduled",checkboxInvoiced.checked,checkboxPaid.checked);
  });
}
if(popupPaid){
  popupPaid.addEventListener("change",()=>{
    const paid=popupPaid.checked;
    const invoiced=popupInvoiced.checked||paid;
    setStatusState(statusField.value||"Scheduled",invoiced,paid);
    applyMetaToGroup(statusField.value||"Scheduled",checkboxInvoiced.checked,checkboxPaid.checked);
  });
}

// Appointment popup controls
if(btnUnlockEditing){
  btnUnlockEditing.addEventListener("click",()=>{
    setAppointmentFormLocked(false);
    setPopupEditable(true);
  });
}
if(btnClosePopup){
  btnClosePopup.addEventListener("click",closeAppointmentPopup);
}
if(appointmentPopup){
  appointmentPopup.addEventListener("click",e=>{
    if(e.target===appointmentPopup) closeAppointmentPopup();
  });
}
if(popupStatusSelect){
  popupStatusSelect.addEventListener("change",()=>{
    if(appointmentLocked) return;
    setStatusState(popupStatusSelect.value,checkboxInvoiced.checked,checkboxPaid.checked);
    applyMetaToGroup(popupStatusSelect.value,checkboxInvoiced.checked,checkboxPaid.checked);
  });
}
if(popupInvoiced){
  popupInvoiced.addEventListener("change",()=>{
    if(appointmentLocked) return;
    const invoiced=popupInvoiced.checked||popupPaid.checked;
    setStatusState(statusField.value||"Scheduled",invoiced,checkboxPaid.checked);
    applyMetaToGroup(statusField.value||"Scheduled",checkboxInvoiced.checked,checkboxPaid.checked);
  });
}
if(popupPaid){
  popupPaid.addEventListener("change",()=>{
    if(appointmentLocked) return;
    const paid=popupPaid.checked;
    const invoiced=popupInvoiced.checked||paid;
    setStatusState(statusField.value||"Scheduled",invoiced,paid);
    applyMetaToGroup(statusField.value||"Scheduled",checkboxInvoiced.checked,checkboxPaid.checked);
  });
}

// Appointment popup controls
if(btnUnlockEditing){
  btnUnlockEditing.addEventListener("click",()=>{
    setAppointmentFormLocked(false);
    setPopupEditable(true);
  });
}
if(btnClosePopup){
  btnClosePopup.addEventListener("click",closeAppointmentPopup);
}
if(appointmentPopup){
  appointmentPopup.addEventListener("click",e=>{
    if(e.target===appointmentPopup) closeAppointmentPopup();
  });
}
if(popupStatusSelect){
  popupStatusSelect.addEventListener("change",()=>{
    if(appointmentLocked) return;
    setStatusState(popupStatusSelect.value,checkboxInvoiced.checked,checkboxPaid.checked);
    applyMetaToGroup(popupStatusSelect.value,checkboxInvoiced.checked,checkboxPaid.checked);
  });
}
if(popupInvoiced){
  popupInvoiced.addEventListener("change",()=>{
    if(appointmentLocked) return;
    const invoiced=popupInvoiced.checked||popupPaid.checked;
    setStatusState(statusField.value||"Scheduled",invoiced,checkboxPaid.checked);
    applyMetaToGroup(statusField.value||"Scheduled",checkboxInvoiced.checked,checkboxPaid.checked);
  });
}
if(popupPaid){
  popupPaid.addEventListener("change",()=>{
    if(appointmentLocked) return;
    const paid=popupPaid.checked;
    const invoiced=popupInvoiced.checked||paid;
    setStatusState(statusField.value||"Scheduled",invoiced,paid);
    applyMetaToGroup(statusField.value||"Scheduled",checkboxInvoiced.checked,checkboxPaid.checked);
  });
}

// Add service row button
btnAddServiceRow.addEventListener("click",()=>addServiceRow());

// Custom Date Picker
function buildDatePickerGrid(){
  dpGrid.innerHTML="";
  const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];
  dpMonthLabel.textContent=monthNames[dpMonth]+" "+dpYear;
  const dayNames=["Su","Mo","Tu","We","Th","Fr","Sa"];
  dayNames.forEach(d=>{
    const cell=document.createElement("div");
    cell.className="date-picker-cell day-name";
    cell.textContent=d;
    dpGrid.appendChild(cell);
  });
  const firstDay=new Date(dpYear,dpMonth,1);
  const startDow=firstDay.getDay();
  const daysInMonth=new Date(dpYear,dpMonth+1,0).getDate();
  for(let i=0;i<startDow;i++){
    const cell=document.createElement("div");
    cell.className="date-picker-cell disabled";
    cell.textContent="";
    dpGrid.appendChild(cell);
  }
  const today=new Date();
  const todayIso=toISODate(today);
  const currentValue=dpActiveInput?parseISODate(dpActiveInput.value):null;
  const currentValueIso=currentValue?toISODate(currentValue):null;
  for(let day=1;day<=daysInMonth;day++){
    const cell=document.createElement("div");
    cell.className="date-picker-cell day";
    cell.textContent=day;
    const cellDate=new Date(dpYear,dpMonth,day);
    const iso=toISODate(cellDate);
    if(iso===todayIso) cell.classList.add("today");
    if(iso===currentValueIso) cell.classList.add("selected");
    cell.addEventListener("click",()=>{
      if(!dpActiveInput) return;
      dpActiveInput.value=iso;
      if(dpActiveInput.id==="dayPicker" || dpActiveInput.id==="datePicker"){
        currentDate=cellDate;
        renderCalendar();
      }
      hideDatePicker();
    });
    dpGrid.appendChild(cell);
  }
}
function showDatePickerForInput(input){
  dpActiveInput=input;
  const existing=parseISODate(input.value)||currentDate;
  dpYear=existing.getFullYear();
  dpMonth=existing.getMonth();
  buildDatePickerGrid();
  const rect=input.getBoundingClientRect();
  const scrollY=window.scrollY||window.pageYOffset;
  const scrollX=window.scrollX||window.pageXOffset;
  dpPopup.style.top=(rect.bottom+scrollY+4)+"px";
  dpPopup.style.left=(rect.left+scrollX)+"px";
  dpPopup.style.display="block";
}
function hideDatePicker(){
  dpPopup.style.display="none";
  dpActiveInput=null;
}
document.querySelectorAll(".date-input").forEach(inp=>{
  inp.addEventListener("click",e=>{
    e.stopPropagation();
    showDatePickerForInput(inp);
  });
});
dpPrevMonth.addEventListener("click",e=>{
  e.stopPropagation();
  dpMonth--;
  if(dpMonth<0){dpMonth=11;dpYear--;}
  buildDatePickerGrid();
});
dpNextMonth.addEventListener("click",e=>{
  e.stopPropagation();
  dpMonth++;
  if(dpMonth>11){dpMonth=0;dpYear++;}
  buildDatePickerGrid();
});
document.addEventListener("click",e=>{
  if(dpPopup.style.display==="none") return;
  if(dpPopup.contains(e.target)) return;
  if(dpActiveInput && dpActiveInput.contains(e.target)) return;
  hideDatePicker();
});

if(typeof fillAppointmentFormFromCustomer!=="function"){
  window.fillAppointmentFormFromCustomer=function(c){
    if(!c) return;
    const firstNameEl=document.getElementById("inputCustomerFirstName");
    const lastNameEl=document.getElementById("inputCustomerLastName");
    const phoneEl=document.getElementById("inputCustomerPhone");
    const emailEl=document.getElementById("inputCustomerEmail");
    const vinEl=document.getElementById("inputVin");
    const stockEl=document.getElementById("inputStockNumber");
    const yearEl=document.getElementById("inputVehicleYear");
    const makeEl=document.getElementById("inputVehicleMake");
    const modelEl=document.getElementById("inputVehicleModel");
    const notesEl=document.getElementById("inputNotes");

    if(firstNameEl) firstNameEl.value=c.firstName||"";
    if(lastNameEl) lastNameEl.value=c.lastName||"";
    if(phoneEl) phoneEl.value=c.phone||"";
    if(emailEl) emailEl.value=c.email||"";
    if(vinEl) vinEl.value=c.vin||c.lastVehicleVIN||"";
    if(stockEl) stockEl.value=c.stockNumber||c.lastStockNumber||"";
    if(yearEl) yearEl.value=c.vehicleYear||c.lastVehicleYear||"";
    if(makeEl) makeEl.value=c.vehicleMake||c.lastVehicleMake||"";
    if(modelEl) modelEl.value=c.vehicleModel||c.lastVehicleModel||"";
    if(notesEl && c.notes) notesEl.value=c.notes;

    isEditingAppointmentForm=true;
    const formEl=document.getElementById("appointmentForm");
    if(formEl) formEl.scrollIntoView({behavior:"smooth",block:"start"});
  };
}

function setupGlobalSearchBar(){
  const input=document.getElementById("globalSearchInput");
  const button=document.getElementById("globalSearchButton");
  const overlay=document.getElementById("globalSearchOverlay");
  const closeBtn=document.getElementById("globalSearchCloseButton");

  if(!input || !button || !overlay || !closeBtn) return;

  input.addEventListener("input",function(){
    if(globalSearchTimer) clearTimeout(globalSearchTimer);
    const value=input.value.trim();
    if(!value){
      closeGlobalSearchOverlay();
      return;
    }
    globalSearchTimer=setTimeout(()=>runGlobalSearch(value),GLOBAL_SEARCH_DEBOUNCE_MS);
  });

  input.addEventListener("keydown",function(e){
    if(e.key==="Enter"){
      e.preventDefault();
      const value=input.value.trim();
      if(value){
        runGlobalSearch(value);
      }
    }
  });

  button.addEventListener("click",function(){
    const value=input.value.trim();
    if(value){
      runGlobalSearch(value);
    }
  });

  closeBtn.addEventListener("click",function(){
    closeGlobalSearchOverlay();
  });

  overlay.addEventListener("click",function(e){
    if(e.target===overlay || (e.target && e.target.classList && e.target.classList.contains("global-search-overlay-backdrop"))){
      closeGlobalSearchOverlay();
    }
  });
}

function openGlobalSearchOverlay(){
  const overlay=document.getElementById("globalSearchOverlay");
  if(overlay) overlay.style.display="block";
}

function closeGlobalSearchOverlay(){
  const overlay=document.getElementById("globalSearchOverlay");
  const summary=document.getElementById("globalSearchSummary");
  const customersEmpty=document.getElementById("globalSearchCustomersEmpty");
  const customersList=document.getElementById("globalSearchCustomersList");
  const apptsEmpty=document.getElementById("globalSearchAppointmentsEmpty");
  const apptsWrap=document.getElementById("globalSearchAppointmentsTableWrapper");
  const apptsBody=document.querySelector("#globalSearchAppointmentsTable tbody");
  const invEmpty=document.getElementById("globalSearchInvoicesEmpty");
  const invList=document.getElementById("globalSearchInvoicesList");

  if(overlay) overlay.style.display="none";
  if(summary) summary.textContent="";
  if(customersList) customersList.innerHTML="";
  if(customersEmpty) customersEmpty.style.display="block";
  if(apptsBody) apptsBody.innerHTML="";
  if(apptsEmpty) apptsEmpty.style.display="block";
  if(apptsWrap) apptsWrap.style.display="none";
  if(invList) invList.innerHTML="";
  if(invEmpty) invEmpty.style.display="block";
}

function runGlobalSearch(rawQuery){
  const query=(rawQuery||"").trim();
  if(!query){
    closeGlobalSearchOverlay();
    return;
  }

  const payload=buildGlobalSearchPayload(query);

  const summary=document.getElementById("globalSearchSummary");
  if(summary){
    summary.textContent='Searching for: "'+query+'"...';
  }

  fetch(CUSTOMER_API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"crm.smartLookup",
      payload:payload
    })
  })
    .then(response=>{
      if(!response.ok) throw new Error("Global search failed");
      return response.json();
    })
    .then(result=>{
      renderGlobalSearchResults(query,result);
    })
    .catch(err=>{
      console.error(err);
      const summaryEl=document.getElementById("globalSearchSummary");
      if(summaryEl){
        summaryEl.textContent="Error running search.";
      }
      openGlobalSearchOverlay();
    });
}

function buildGlobalSearchPayload(query){
  const q=query.trim();
  const payload={
    firstName:"",
    lastName:"",
    phone:"",
    email:"",
    vin:"",
    stockNumber:""
  };

  const isEmail=q.includes("@");
  const digitsOnly=q.replace(/\D+/g,"");
  const isMostlyDigits=digitsOnly.length>=Math.floor(q.length*0.6);
  const isVinLike=q.length>=11 && q.length<=20 && /^[A-Za-z0-9]+$/.test(q);

  if(isEmail){
    payload.email=q;
    return payload;
  }

  if(isVinLike){
    payload.vin=q.toUpperCase();
    return payload;
  }

  if(isMostlyDigits){
    payload.phone=q;
    payload.stockNumber=q;
    return payload;
  }

  const parts=q.split(/\s+/);
  if(parts.length>=2){
    payload.firstName=parts[0];
    payload.lastName=parts.slice(1).join(" ");
  }else{
    payload.lastName=q;
  }

  return payload;
}

function renderGlobalSearchResults(query,result){
  openGlobalSearchOverlay();

  const summary=document.getElementById("globalSearchSummary");
  const customersEmpty=document.getElementById("globalSearchCustomersEmpty");
  const customersList=document.getElementById("globalSearchCustomersList");
  const apptsEmpty=document.getElementById("globalSearchAppointmentsEmpty");
  const apptsWrap=document.getElementById("globalSearchAppointmentsTableWrapper");
  const apptsBody=document.querySelector("#globalSearchAppointmentsTable tbody");
  const invEmpty=document.getElementById("globalSearchInvoicesEmpty");
  const invList=document.getElementById("globalSearchInvoicesList");

  const customers=(result && Array.isArray(result.customers))?result.customers:[];
  const appointments=(result && Array.isArray(result.appointments))?result.appointments:[];
  const invoices=[];

  const lookupType=(result && result.lookupType)||"UNKNOWN";

  if(summary){
    const total=customers.length+appointments.length+invoices.length;
    if(total===0){
      summary.textContent='No matches found for "'+query+'". ('+lookupType+')';
    }else{
      summary.textContent='Found '+total+' results for "'+query+'". ('+lookupType+')';
    }
  }

  if(customersList) customersList.innerHTML="";
  if(!customers.length){
    if(customersEmpty) customersEmpty.style.display="block";
  }else{
    if(customersEmpty) customersEmpty.style.display="none";

    customers.forEach(c=>{
      const li=document.createElement("li");
      const fullName=[c.firstName,c.lastName].filter(Boolean).join(" ")||"(No name)";
      const phone=c.phone||"";
      const email=c.email||"";

      li.innerHTML=`
        <div class="search-result-entry">
          <div class="title">${escapeHtml(fullName)}</div>
          <div class="details">
            ${escapeHtml(phone)}<br>
            ${escapeHtml(email)}
          </div>
          <button type="button" class="btn btn-primary btn-xs" data-action="use-appointment">
            Use in Appointment
          </button>
        </div>
      `;

      const useBtn=li.querySelector('[data-action="use-appointment"]');
      if(useBtn){
        useBtn.addEventListener("click",function(){
          fillAppointmentFormFromCustomer(c);
        });
      }

      customersList.appendChild(li);
    });
  }

  if(apptsBody) apptsBody.innerHTML="";
  if(!appointments.length){
    if(apptsEmpty) apptsEmpty.style.display="block";
    if(apptsWrap) apptsWrap.style.display="none";
  }else{
    if(apptsEmpty) apptsEmpty.style.display="none";
    if(apptsWrap) apptsWrap.style.display="table";

    appointments.forEach(a=>{
      const tr=document.createElement("tr");

      const date=a.date||"";
      const time=a.time||a.startTime||"";
      const name=[
        a.customerFirstName||"",
        a.customerLastName||""
      ].filter(Boolean).join(" ");

      const vehicle=[
        a.vehicleYear||"",
        a.vehicleMake||"",
        a.vehicleModel||""
      ].filter(Boolean).join(" ")||(a.vin||"");

      const services=a.services||a.serviceName||"";

      tr.innerHTML=`
        <td>${escapeHtml(String(date))}</td>
        <td>${escapeHtml(String(time))}</td>
        <td>${escapeHtml(name)}</td>
        <td>${escapeHtml(vehicle)}</td>
        <td>${escapeHtml(services)}</td>
      `;

      tr.addEventListener("click",function(){
        fillAppointmentFormFromAppointment(a);
      });

      apptsBody.appendChild(tr);
    });
  }

  if(invList) invList.innerHTML="";
  if(invEmpty) invEmpty.style.display="block";
}

function fillAppointmentFormFromAppointment(a){
  const firstNameEl=document.getElementById("inputCustomerFirstName");
  const lastNameEl=document.getElementById("inputCustomerLastName");
  const phoneEl=document.getElementById("inputCustomerPhone");
  const emailEl=document.getElementById("inputCustomerEmail");
  const vinEl=document.getElementById("inputVin");
  const stockEl=document.getElementById("inputStockNumber");
  const yearEl=document.getElementById("inputVehicleYear");
  const makeEl=document.getElementById("inputVehicleMake");
  const modelEl=document.getElementById("inputVehicleModel");
  const notesEl=document.getElementById("inputNotes");

  if(firstNameEl) firstNameEl.value=a.customerFirstName||"";
  if(lastNameEl) lastNameEl.value=a.customerLastName||"";
  if(phoneEl) phoneEl.value=a.phone||"";
  if(emailEl) emailEl.value=a.email||"";
  if(vinEl) vinEl.value=a.vin||"";
  if(stockEl) stockEl.value=a.stockNumber||"";
  if(yearEl) yearEl.value=a.vehicleYear||"";
  if(makeEl) makeEl.value=a.vehicleMake||"";
  if(modelEl) modelEl.value=a.vehicleModel||"";
  if(notesEl && a.notes) notesEl.value=a.notes;

  const dateEl=document.getElementById("datePicker");
  if(dateEl && a.date) dateEl.value=a.date;

  isEditingAppointmentForm=true;
  closeGlobalSearchOverlay();
}

// Init
// Init
initTimeDropdowns();
attachOffCheckboxHandlers();
loadSchedulesFromStorage();
loadOfficeHoursFromStorage();
loadShopHolidaysFromStorage();
loadServicePackagesFromStorage();
renderDeptChips();
loadOfficeHoursIntoForm();
attachOfficeClosedCheckboxHandlers();
renderHolidayList();
seedDummyEvents();
ensureAtLeastOneServiceRow();
refreshAllServiceAssignmentRows();
setStatusState("Scheduled",false,false);
setAppointmentFormLocked(false);
updateVinHelper(defaultVinHelperText);
attachUserInteractionListeners();
// Load configuration from backend, overriding local defaults where available
loadTechSchedulesFromBackend();
loadTechTimeOffFromBackend();
loadHolidaysFromBackend();
loadServicesFromBackend();
renderCalendar();
loadAppointmentsFromBackend({ replaceLocal: true });
setInterval(maybeAutoRefreshFromBackend,15000);


</script>

<script>
  const CUSTOMER_API_URL = 'https://script.google.com/macros/s/AKfycbzfTUv9h_3U4RYFZgH7HH_mybySDGrva75urTpyYE5bXDyfuFTrwBIL2kqgthFbzjmb/exec';

  let customers = [];
  let filteredCustomers = [];

  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('customerSearchInput');
    const newBtn = document.getElementById('customerNewBtn');
    const form = document.getElementById('customerForm');
    const cancelBtn = document.getElementById('customerCancelBtn');

    if (!searchInput || !newBtn || !form || !cancelBtn) return;

    searchInput.addEventListener('input', handleSearchChange);
    newBtn.addEventListener('click', () => openCustomerForm());
    form.addEventListener('submit', handleCustomerSave);
    cancelBtn.addEventListener('click', resetCustomerForm);

    loadCustomersFromBackend();
  });

  async function loadCustomersFromBackend() {
    try {
      const url = CUSTOMER_API_URL + '?action=crm.listCustomers';
      const response = await fetch(url);
      if (!response.ok) throw new Error('Failed to fetch customers');
      const data = await response.json();
      customers = Array.isArray(data) ? data : [];
      filteredCustomers = customers.slice();
      renderCustomerTable();
    } catch (err) {
      console.error(err);
      alert('Error loading customers. Check console for details.');
    }
  }

  async function saveCustomerToBackend(customer) {
    const response = await fetch(CUSTOMER_API_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'crm.saveCustomer',
        payload: customer
      })
    });

    if (!response.ok) throw new Error('Failed to save customer');
    return await response.json();
  }

  async function deleteCustomerFromBackend(customerId) {
    const response = await fetch(CUSTOMER_API_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'crm.deleteCustomer',
        payload: { id: customerId }
      })
    });

    if (!response.ok) throw new Error('Failed to delete customer');
    return await response.json();
  }

  function renderCustomerTable() {
    const tbody = document.getElementById('customerTableBody');
    const emptyState = document.getElementById('customerEmptyState');
    if (!tbody || !emptyState) return;

    tbody.innerHTML = '';

    if (!filteredCustomers.length) {
      emptyState.style.display = 'block';
      return;
    }

    emptyState.style.display = 'none';

    filteredCustomers.forEach(customer => {
      const tr = document.createElement('tr');

      const fullName = [customer.firstName, customer.lastName]
        .filter(Boolean)
        .join(' ');

      const marketingText = [
        customer.marketingOptIn ? 'Email' : '',
        customer.smsOptIn ? 'SMS' : ''
      ].filter(Boolean).join(' / ');

      tr.innerHTML = `
        <td>${escapeHtml(fullName)}</td>
        <td>${escapeHtml(customer.phone || '')}</td>
        <td>${escapeHtml(customer.email || '')}</td>
        <td>${escapeHtml(customer.notes || '')}</td>
        <td>${escapeHtml(marketingText || '')}</td>
        <td>
          <button type="button" class="btn-secondary btn-sm" data-action="edit">Edit</button>
          <button type="button" class="btn-secondary btn-sm" data-action="delete" style="margin-left:4px;">Delete</button>
        </td>
      `;

      const editBtn = tr.querySelector('[data-action="edit"]');
      const deleteBtn = tr.querySelector('[data-action="delete"]');

      editBtn.addEventListener('click', () => openCustomerForm(customer));
      deleteBtn.addEventListener('click', () => handleCustomerDelete(customer.id));

      tbody.appendChild(tr);
    });
  }

  function loadCustomerAppointments(customer) {
    const historySection = document.getElementById('customerHistory');
    const tbody = document.querySelector('#customerHistoryTable tbody');
    const empty = document.getElementById('customerHistoryEmpty');
    const tableWrapper = document.querySelector('#customerHistory .table-wrapper');

    if (!historySection || !tbody || !empty || !tableWrapper) return;

    // Clear current history state
    tbody.innerHTML = '';
    empty.style.display = 'block';
    tableWrapper.style.display = 'none';
    historySection.style.display = 'block';

    if (!customer) {
      // no customer selected
      return;
    }

    const phone = customer.phone || '';
    const email = customer.email || '';

    if (!phone && !email) {
      // nothing to search by, leave empty state
      return;
    }

    const params = new URLSearchParams();
    params.set('action', 'crm.listCustomerAppointments');
    if (phone) params.set('phone', phone);
    if (email) params.set('email', email);

    fetch(CUSTOMER_API_URL + '?' + params.toString())
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to load appointments');
        }
        return response.json();
      })
      .then(data => {
        const appts = Array.isArray(data) ? data : [];
        renderCustomerAppointments(appts);
      })
      .catch(err => {
        console.error(err);
        // keep empty state visible; no alert needed
      });
  }

  function renderCustomerAppointments(appts) {
    const tbody = document.querySelector('#customerHistoryTable tbody');
    const empty = document.getElementById('customerHistoryEmpty');
    const tableWrapper = document.querySelector('#customerHistory .table-wrapper');

    if (!tbody || !empty || !tableWrapper) return;

    tbody.innerHTML = '';

    if (!appts.length) {
      empty.style.display = 'block';
      tableWrapper.style.display = 'none';
      return;
    }

    empty.style.display = 'none';
    tableWrapper.style.display = 'table'; // show table when we have data

    appts.forEach(appt => {
      const tr = document.createElement('tr');

      const date = appt.date || '';
      const time = appt.time || appt.startTime || '';
      const vehicle = [
        appt.vehicleYear || '',
        appt.vehicleMake || '',
        appt.vehicleModel || ''
      ].filter(Boolean).join(' ') || (appt.vin || '');

      const services = appt.services || appt.serviceName || '';
      const status = appt.status || '';
      const tech = appt.tech || '';

      tr.innerHTML = `
        <td>${escapeHtml(String(date))}</td>
        <td>${escapeHtml(String(time))}</td>
        <td>${escapeHtml(vehicle)}</td>
        <td>${escapeHtml(services)}</td>
        <td>${escapeHtml(status)}</td>
        <td>${escapeHtml(tech)}</td>
      `;

      tbody.appendChild(tr);
    });
  }

  function clearCustomerAppointmentsHistory() {
    const historySection = document.getElementById('customerHistory');
    const tbody = document.querySelector('#customerHistoryTable tbody');
    const empty = document.getElementById('customerHistoryEmpty');
    const tableWrapper = document.querySelector('#customerHistory .table-wrapper');

    if (!historySection || !tbody || !empty || !tableWrapper) return;

    tbody.innerHTML = '';
    empty.style.display = 'block';
    tableWrapper.style.display = 'none';
    // You can hide the whole section if no customer is selected:
    // historySection.style.display = 'none';
  }

  function handleSearchChange(event) {
    const term = event.target.value.trim().toLowerCase();
    if (!term) {
      filteredCustomers = customers.slice();
      renderCustomerTable();
      return;
    }

    filteredCustomers = customers.filter(c => {
      const name = `${c.firstName || ''} ${c.lastName || ''}`.toLowerCase();
      const phone = (c.phone || '').toLowerCase();
      const email = (c.email || '').toLowerCase();
      return (
        name.includes(term) ||
        phone.includes(term) ||
        email.includes(term)
      );
    });

    renderCustomerTable();
  }

  function openCustomerForm(customer) {
    const form = document.getElementById('customerForm');
    if (!form) return;

    form.style.display = 'block';

    if (customer) {
      document.getElementById('customerId').value = customer.id || '';
      document.getElementById('customerFirstName').value = customer.firstName || '';
      document.getElementById('customerLastName').value = customer.lastName || '';
      document.getElementById('customerPhone').value = customer.phone || '';
      document.getElementById('customerEmail').value = customer.email || '';
      document.getElementById('customerNotes').value = customer.notes || '';
      document.getElementById('customerMarketingOptIn').checked = !!customer.marketingOptIn;
      document.getElementById('customerSmsOptIn').checked = !!customer.smsOptIn;
      document.getElementById('customerExternalId').value = customer.externalClientId || '';
      document.getElementById('customerSaveBtn').textContent = 'Update Customer';

      loadCustomerAppointments(customer);
    } else {
      resetCustomerFormFields();
      document.getElementById('customerSaveBtn').textContent = 'Save Customer';
      clearCustomerAppointmentsHistory();
    }

    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function resetCustomerForm() {
    const form = document.getElementById('customerForm');
    if (!form) return;

    resetCustomerFormFields();
    form.style.display = 'none';
    clearCustomerAppointmentsHistory();
  }

  function resetCustomerFormFields() {
    const ids = [
      'customerId',
      'customerFirstName',
      'customerLastName',
      'customerPhone',
      'customerEmail',
      'customerNotes',
      'customerExternalId'
    ];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });

    const marketing = document.getElementById('customerMarketingOptIn');
    const sms = document.getElementById('customerSmsOptIn');
    if (marketing) marketing.checked = false;
    if (sms) sms.checked = false;
  }

  async function handleCustomerSave(event) {
    event.preventDefault();

    const id = document.getElementById('customerId').value || null;
    const firstName = document.getElementById('customerFirstName').value.trim();
    const lastName = document.getElementById('customerLastName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    const email = document.getElementById('customerEmail').value.trim();
    const notes = document.getElementById('customerNotes').value.trim();
    const marketingOptIn = document.getElementById('customerMarketingOptIn').checked;
    const smsOptIn = document.getElementById('customerSmsOptIn').checked;
    const externalClientId = document.getElementById('customerExternalId').value.trim();

    if (!firstName || !lastName || !phone) {
      alert('First name, last name, and phone are required.');
      return;
    }

    const customer = {
      id,
      firstName,
      lastName,
      phone,
      email,
      notes,
      marketingOptIn,
      smsOptIn,
      externalClientId
    };

    try {
      const saved = await saveCustomerToBackend(customer);

      if (id) {
        const index = customers.findIndex(c => c.id === id);
        if (index !== -1) customers[index] = saved;
      } else {
        customers.push(saved);
      }

      const searchInput = document.getElementById('customerSearchInput');
      const term = (searchInput && searchInput.value || '').trim().toLowerCase();
      if (term && searchInput) {
        handleSearchChange({ target: searchInput });
      } else {
        filteredCustomers = customers.slice();
        renderCustomerTable();
      }

      resetCustomerForm();
    } catch (err) {
      console.error(err);
      alert('Error saving customer. Check console for details.');
    }
  }

  async function handleCustomerDelete(customerId) {
    if (!customerId) return;
    const confirmDelete = confirm('Delete this customer? This cannot be undone.');
    if (!confirmDelete) return;

    try {
      await deleteCustomerFromBackend(customerId);
      customers = customers.filter(c => c.id !== customerId);
      filteredCustomers = filteredCustomers.filter(c => c.id !== customerId);
      renderCustomerTable();
    } catch (err) {
      console.error(err);
      alert('Error deleting customer. Check console for details.');
    }
  }

  function escapeHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }
</script>
</body>
</html>

         
